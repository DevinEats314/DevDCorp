(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{1323:function(e,t,r){var n=r(2),o=Math.hypot,l=Math.abs,c=Math.sqrt;n({target:"Math",stat:!0,arity:2,forced:!!o&&o(1/0,NaN)!==1/0},{hypot:function(e,t){for(var r,div,n=0,i=0,o=arguments.length,h=0;i<o;)h<(r=l(arguments[i++]))?(n=n*(div=h/r)*div+1,h=r):n+=r>0?(div=r/h)*div:r;return h===1/0?1/0:h*c(n)}})},282:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var n=r(107);var o=r(134);function l(e){return function(e){if(Array.isArray(e))return Object(n.a)(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Object(o.a)(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}},301:function(e,t,r){var n=r(2),o=r(303),l=r(108);n({target:"Array",proto:!0},{fill:o}),l("fill")},303:function(e,t,r){"use strict";var n=r(24),o=r(83),l=r(32);e.exports=function(e){for(var t=n(this),r=l(t),c=arguments.length,h=o(c>1?arguments[1]:void 0,r),d=c>2?arguments[2]:void 0,f=void 0===d?r:o(d,r);f>h;)t[h++]=e;return t}},304:function(e,t,r){"use strict";var n=r(2),o=r(4),l=r(33),c=r(24),h=r(32),d=r(206),f=r(13),v=r(3),m=r(205),y=r(138),k=r(311),E=r(312),T=r(86),S=r(313),L=[],A=o(L.sort),R=o(L.push),D=v((function(){L.sort(void 0)})),w=v((function(){L.sort(null)})),I=y("sort"),C=!v((function(){if(T)return T<70;if(!(k&&k>3)){if(E)return!0;if(S)return S<603;var code,e,t,r,n="";for(code=65;code<76;code++){switch(e=String.fromCharCode(code),code){case 66:case 69:case 70:case 72:t=3;break;case 68:case 71:t=4;break;default:t=2}for(r=0;r<47;r++)L.push({k:e+r,v:t})}for(L.sort((function(a,b){return b.v-a.v})),r=0;r<L.length;r++)e=L[r].k.charAt(0),n.charAt(n.length-1)!==e&&(n+=e);return"DGBEFHACIJK"!==n}}));n({target:"Array",proto:!0,forced:D||!w||!I||!C},{sort:function(e){void 0!==e&&l(e);var t=c(this);if(C)return void 0===e?A(t):A(t,e);var r,n,o=[],v=h(t);for(n=0;n<v;n++)n in t&&R(o,t[n]);for(m(o,function(e){return function(t,r){return void 0===r?-1:void 0===t?1:void 0!==e?+e(t,r)||0:f(t)>f(r)?1:-1}}(e)),r=h(o),n=0;n<r;)t[n]=o[n++];for(;n<v;)d(t,n++);return t}})},333:function(e,t,r){"use strict";var n=r(2),o=r(4),l=r(50),c=r(211),h=r(207),d=r(3),f=RangeError,v=String,m=Math.floor,y=o(h),k=o("".slice),E=o(1..toFixed),T=function(e,t,r){return 0===t?r:t%2==1?T(e,t-1,r*e):T(e*e,t/2,r)},S=function(data,e,t){for(var r=-1,n=t;++r<6;)n+=e*data[r],data[r]=n%1e7,n=m(n/1e7)},L=function(data,e){for(var t=6,r=0;--t>=0;)r+=data[t],data[t]=m(r/e),r=r%e*1e7},A=function(data){for(var e=6,s="";--e>=0;)if(""!==s||0===e||0!==data[e]){var t=v(data[e]);s=""===s?t:s+y("0",7-t.length)+t}return s};n({target:"Number",proto:!0,forced:d((function(){return"0.000"!==E(8e-5,3)||"1"!==E(.9,0)||"1.25"!==E(1.255,2)||"1000000000000000128"!==E(0xde0b6b3a7640080,0)}))||!d((function(){E({})}))},{toFixed:function(e){var t,r,n,o,h=c(this),d=l(e),data=[0,0,0,0,0,0],m="",E="0";if(d<0||d>20)throw f("Incorrect fraction digits");if(h!=h)return"NaN";if(h<=-1e21||h>=1e21)return v(h);if(h<0&&(m="-",h=-h),h>1e-21)if(r=(t=function(e){for(var t=0,r=e;r>=4096;)t+=12,r/=4096;for(;r>=2;)t+=1,r/=2;return t}(h*T(2,69,1))-69)<0?h*T(2,-t,1):h/T(2,t,1),r*=4503599627370496,(t=52-t)>0){for(S(data,0,r),n=d;n>=7;)S(data,1e7,0),n-=7;for(S(data,T(10,n,1),0),n=t-1;n>=23;)L(data,1<<23),n-=23;L(data,1<<n),S(data,1,1),L(data,2),E=A(data)}else S(data,0,r),S(data,1<<-t,0),E=A(data)+y("0",d);return E=d>0?m+((o=E.length)<=d?"0."+y("0",d-o)+E:k(E,0,o-d)+"."+k(E,o-d)):m+E}})},422:function(e,t,r){"use strict";var n=r(2),o=r(65).findIndex,l=r(108),c="findIndex",h=!0;c in[]&&Array(1)[c]((function(){h=!1})),n({target:"Array",proto:!0,forced:h},{findIndex:function(e){return o(this,e,arguments.length>1?arguments[1]:void 0)}}),l(c)},474:function(e,t,r){"use strict";var n;function o(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,i){return function(e){if(Array.isArray(e))return e}(e)||function(e,i){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,n,o,l,c=[],h=!0,d=!1;try{if(o=(t=t.call(e)).next,0===i){if(Object(t)!==t)return;h=!1}else for(;!(h=(r=o.call(t)).done)&&(c.push(r.value),c.length!==i);h=!0);}catch(e){d=!0,n=e}finally{try{if(!h&&null!=t.return&&(l=t.return(),Object(l)!==l))return}finally{if(d)throw n}}return c}}(e,i)||c(e,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){if(e){if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var base=f(e,t);if(base){var desc=Object.getOwnPropertyDescriptor(base,t);return desc.get?desc.get.call(arguments.length<3?e:r):desc.value}},d.apply(this,arguments)}function f(object,e){for(;!Object.prototype.hasOwnProperty.call(object,e)&&null!==(object=A(object)););return object}function v(e){var t="function"==typeof Map?new Map:void 0;return v=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return m(e,arguments,A(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),k(n,e)},v(e)}function m(e,t,r){return m=L()?Reflect.construct.bind():function(e,t,r){var a=[null];a.push.apply(a,t);var n=new(Function.bind.apply(e,a));return r&&k(n,r.prototype),n},m.apply(null,arguments)}function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function k(e,p){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,p){return e.__proto__=p,e},k(e,p)}function E(e){var t=L();return function(){var r,n=A(e);if(t){var o=A(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return T(this,r)}}function T(e,t){if(t&&("object"===_(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return S(e)}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function L(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function A(e){return A=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},A(e)}function R(e,t,r){return(t=C(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function w(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,C(r.key),r)}}function I(e,t,r){return t&&w(e.prototype,t),r&&w(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function C(e){var t=function(input,e){if("object"!==_(input)||null===input)return input;var t=input[Symbol.toPrimitive];if(void 0!==t){var r=t.call(input,e||"default");if("object"!==_(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(input)}(e,"string");return"symbol"===_(t)?t:String(t)}function _(e){return _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_(e)}function x(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}r.d(t,"a",(function(){return Fo}));var P={exports:{}};!function(e,t){var r,n,o,l,c;r=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,o=/(?:\/|^)\.(?=\/)/g,l=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,c={buildAbsoluteURL:function(e,t,r){if(r=r||{},e=e.trim(),!(t=t.trim())){if(!r.alwaysNormalize)return e;var o=c.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");return o.path=c.normalizePath(o.path),c.buildURLFromParts(o)}var l=c.parseURL(t);if(!l)throw new Error("Error trying to parse relative URL.");if(l.scheme)return r.alwaysNormalize?(l.path=c.normalizePath(l.path),c.buildURLFromParts(l)):t;var h=c.parseURL(e);if(!h)throw new Error("Error trying to parse base URL.");if(!h.netLoc&&h.path&&"/"!==h.path[0]){var d=n.exec(h.path);h.netLoc=d[1],h.path=d[2]}h.netLoc&&!h.path&&(h.path="/");var f={scheme:h.scheme,netLoc:l.netLoc,path:null,params:l.params,query:l.query,fragment:l.fragment};if(!l.netLoc&&(f.netLoc=h.netLoc,"/"!==l.path[0]))if(l.path){var v=h.path,m=v.substring(0,v.lastIndexOf("/")+1)+l.path;f.path=c.normalizePath(m)}else f.path=h.path,l.params||(f.params=h.params,l.query||(f.query=h.query));return null===f.path&&(f.path=r.alwaysNormalize?c.normalizePath(l.path):l.path),c.buildURLFromParts(f)},parseURL:function(e){var t=r.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(o,"");path.length!==(path=path.replace(l,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=c}(P);var F=P.exports;function M(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function O(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?M(Object(r),!0).forEach((function(t){U(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):M(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function N(e){var i=function(e,t){if("object"!=_(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=_(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==_(i)?i:String(i)}function U(e,t,r){return(t=N(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function B(){return B=Object.assign?Object.assign.bind():function(e){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var t in source)Object.prototype.hasOwnProperty.call(source,t)&&(e[t]=source[t])}return e},B.apply(this,arguments)}var G=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},K=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=H},H=Number.MAX_SAFE_INTEGER||9007199254740991,V=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e}({}),Y=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),j=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({}),W=function(){},X={trace:W,debug:W,log:W,warn:W,info:W,error:W},z=X;function Q(e){var t=self.console[e];return t?t.bind(self.console,"[".concat(e,"] >")):W}function J(e,t){if("object"===("undefined"==typeof console?"undefined":_(console))&&!0===e||"object"===_(e)){!function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];r.forEach((function(t){z[t]=e[t]?e[t].bind(e):Q(t)}))}(e,"debug","log","info","warn","error");try{z.log('Debug logs enabled for "'.concat(t,'" in hls.js version ',"1.5.17"))}catch(e){z=X}}else z=X}var $=z,Z=/^(\d+)x(\d+)$/,ee=/(.+?)=(".*?"|.*?)(?:,|$)/g,te=function(){function e(t){D(this,e),"string"==typeof t&&(t=e.parseAttrList(t)),B(this,t)}return I(e,[{key:"clientAttrs",get:function(){return Object.keys(this).filter((function(e){return"X-"===e.substring(0,2)}))}},{key:"decimalInteger",value:function(e){var t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}},{key:"hexadecimalInteger",value:function(e){if(this[e]){var t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;for(var r=new Uint8Array(t.length/2),i=0;i<t.length/2;i++)r[i]=parseInt(t.slice(2*i,2*i+2),16);return r}return null}},{key:"hexadecimalIntegerAsNumber",value:function(e){var t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}},{key:"decimalFloatingPoint",value:function(e){return parseFloat(this[e])}},{key:"optionalFloat",value:function(e,t){var r=this[e];return r?parseFloat(r):t}},{key:"enumeratedString",value:function(e){return this[e]}},{key:"bool",value:function(e){return"YES"===this[e]}},{key:"decimalResolution",value:function(e){var t=Z.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}}],[{key:"parseAttrList",value:function(input){var e,t={};for(ee.lastIndex=0;null!==(e=ee.exec(input));){var r=e[2];0===r.indexOf('"')&&r.lastIndexOf('"')===r.length-1&&(r=r.slice(1,-1)),t[e[1].trim()]=r}return t}}]),e}();function re(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}var ie=function(){function e(t,r){if(D(this,e),this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,r){var n=r.attr;for(var o in n)if(Object.prototype.hasOwnProperty.call(t,o)&&t[o]!==n[o]){$.warn('DATERANGE tag attribute: "'.concat(o,'" does not match for tags with ID: "').concat(t.ID,'"')),this._badValueForSameId=o;break}t=B(new te({}),n,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){var l=new Date(this.attr["END-DATE"]);G(l.getTime())&&(this._endDate=l)}}return I(e,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){if(this._endDate)return this._endDate;var e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}},{key:"duration",get:function(){if("DURATION"in this.attr){var e=this.attr.decimalFloatingPoint("DURATION");if(G(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}},{key:"endOnNext",get:function(){return this.attr.bool("END-ON-NEXT")}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&G(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}]),e}(),ae=I((function e(){D(this,e),this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}})),ne="audio",se="video",oe="audiovideo",le=function(){function e(t){var r;D(this,e),this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(R(r={},ne,null),R(r,se,null),R(r,oe,null),r),this.baseurl=t}return I(e,[{key:"setByteRange",value:function(e,t){var r,n=e.split("@",2);r=1===n.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(n[1]),this._byteRange=[r,parseInt(n[0])+r]}},{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=F.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(e){this._url=e}}]),e}(),ue=function(e){y(r,e);var t=E(r);function r(e,n){var o;return D(this,r),(o=t.call(this,n))._decryptdata=null,o.rawProgramDateTime=null,o.programDateTime=null,o.tagList=[],o.duration=0,o.sn=0,o.levelkeys=void 0,o.type=void 0,o.loader=null,o.keyLoader=null,o.level=-1,o.cc=0,o.startPTS=void 0,o.endPTS=void 0,o.startDTS=void 0,o.endDTS=void 0,o.start=0,o.deltaPTS=void 0,o.maxStartPTS=void 0,o.minEndPTS=void 0,o.stats=new ae,o.data=void 0,o.bitrateTest=!1,o.title=null,o.initSegment=null,o.endList=void 0,o.gap=void 0,o.urlId=0,o.type=e,o}return I(r,[{key:"decryptdata",get:function(){if(!this.levelkeys&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{var t=Object.keys(this.levelkeys);if(1===t.length)return this._decryptdata=this.levelkeys[t[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(null===this.programDateTime)return null;if(!G(this.programDateTime))return null;var e=G(this.duration)?this.duration:0;return this.programDateTime+1e3*e}},{key:"encrypted",get:function(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){var t=Object.keys(this.levelkeys),r=t.length;if(r>1||1===r&&this.levelkeys[t[0]].encrypted)return!0}return!1}},{key:"setKeyFormat",value:function(e){if(this.levelkeys){var t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}},{key:"abortRequests",value:function(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}},{key:"setElementaryStreamInfo",value:function(e,t,r,n,o){var l=arguments.length>5&&void 0!==arguments[5]&&arguments[5],c=this.elementaryStreams,h=c[e];h?(h.startPTS=Math.min(h.startPTS,t),h.endPTS=Math.max(h.endPTS,r),h.startDTS=Math.min(h.startDTS,n),h.endDTS=Math.max(h.endDTS,o)):c[e]={startPTS:t,endPTS:r,startDTS:n,endDTS:o,partial:l}}},{key:"clearElementaryStreamInfo",value:function(){var e=this.elementaryStreams;e[ne]=null,e[se]=null,e[oe]=null}}]),r}(le),ce=function(e){y(r,e);var t=E(r);function r(e,n,o,l,c){var h;D(this,r),(h=t.call(this,o)).fragOffset=0,h.duration=0,h.gap=!1,h.independent=!1,h.relurl=void 0,h.fragment=void 0,h.index=void 0,h.stats=new ae,h.duration=e.decimalFloatingPoint("DURATION"),h.gap=e.bool("GAP"),h.independent=e.bool("INDEPENDENT"),h.relurl=e.enumeratedString("URI"),h.fragment=n,h.index=l;var d=e.enumeratedString("BYTERANGE");return d&&h.setByteRange(d,c),c&&(h.fragOffset=c.fragOffset+c.duration),h}return I(r,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var e=this.elementaryStreams;return!!(e.audio||e.video||e.audiovideo)}}]),r}(le),he=function(){function e(t){D(this,e),this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}return I(e,[{key:"reloaded",value:function(e){if(!e)return this.advanced=!0,void(this.updated=!0);var t=this.lastPartSn-e.lastPartSn,r=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!r||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&r>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}},{key:"hasProgramDateTime",get:function(){return!!this.fragments.length&&G(this.fragments[this.fragments.length-1].programDateTime)}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||10}},{key:"drift",get:function(){var e=this.driftEndTime-this.driftStartTime;return e>0?1e3*(this.driftEnd-this.driftStart)/e:1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),e}();function de(e){return Uint8Array.from(atob(e),(function(e){return e.charCodeAt(0)}))}function fe(e){var t,r,n=e.split(":"),o=null;if("data"===n[0]&&2===n.length){var l=n[1].split(";"),c=l[l.length-1].split(",");if(2===c.length){var h="base64"===c[0],data=c[1];h?(l.splice(-1,1),o=de(data)):(t=ve(data).subarray(0,16),(r=new Uint8Array(16)).set(t,16-t.length),o=r)}}return o}function ve(e){return Uint8Array.from(unescape(encodeURIComponent(e)),(function(e){return e.charCodeAt(0)}))}var ge="undefined"!=typeof self?self:void 0,me={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},ye="org.w3.clearkey",pe="com.apple.streamingkeydelivery",ke="com.microsoft.playready",Ee="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function Te(e){switch(e){case pe:return me.FAIRPLAY;case ke:return me.PLAYREADY;case Ee:return me.WIDEVINE;case ye:return me.CLEARKEY}}var Se="1077efecc0b24d02ace33c1e52e2fb4b",Le="e2719d58a985b3c9781ab030af78d30e",Ae="9a04f07998404286ab92e65be0885f95",Re="edef8ba979d64acea3c827dcd51d21ed";function be(e){return e===Re?me.WIDEVINE:e===Ae?me.PLAYREADY:e===Se||e===Le?me.CLEARKEY:void 0}function De(e){switch(e){case me.FAIRPLAY:return pe;case me.PLAYREADY:return ke;case me.WIDEVINE:return Ee;case me.CLEARKEY:return ye}}function we(e){var t=e.drmSystems,r=e.widevineLicenseUrl,n=t?[me.FAIRPLAY,me.WIDEVINE,me.PLAYREADY,me.CLEARKEY].filter((function(e){return!!t[e]})):[];return!n[me.WIDEVINE]&&r&&n.push(me.WIDEVINE),n}var Ie,Ce=null!=ge&&null!=(Ie=ge.navigator)&&Ie.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function _e(e,t,r){return Uint8Array.prototype.slice?e.slice(t,r):new Uint8Array(Array.prototype.slice.call(e,t,r))}var xe,Pe=function(data,e){return e+10<=data.length&&73===data[e]&&68===data[e+1]&&51===data[e+2]&&data[e+3]<255&&data[e+4]<255&&data[e+6]<128&&data[e+7]<128&&data[e+8]<128&&data[e+9]<128},Fe=function(data,e){return e+10<=data.length&&51===data[e]&&68===data[e+1]&&73===data[e+2]&&data[e+3]<255&&data[e+4]<255&&data[e+6]<128&&data[e+7]<128&&data[e+8]<128&&data[e+9]<128},Me=function(data,e){for(var t=e,r=0;Pe(data,e);){r+=10,r+=Oe(data,e+6),Fe(data,e+10)&&(r+=10),e+=r}if(r>0)return data.subarray(t,t+r)},Oe=function(data,e){var t=0;return t=(127&data[e])<<21,t|=(127&data[e+1])<<14,t|=(127&data[e+2])<<7,t|=127&data[e+3]},Ne=function(data,e){return Pe(data,e)&&Oe(data,e+6)+10<=data.length-e},Ue=function(data){for(var e=Ke(data),i=0;i<e.length;i++){var t=e[i];if(Be(t))return We(t)}},Be=function(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info},Ge=function(data){var e=String.fromCharCode(data[0],data[1],data[2],data[3]),t=Oe(data,4);return{type:e,size:t,data:data.subarray(10,10+t)}},Ke=function(e){for(var t=0,r=[];Pe(e,t);){for(var n=Oe(e,t+6),o=(t+=10)+n;t+8<o;){var l=Ge(e.subarray(t)),c=He(l);c&&r.push(c),t+=l.size+10}Fe(e,t)&&(t+=10)}return r},He=function(e){return"PRIV"===e.type?Ve(e):"W"===e.type[0]?je(e):Ye(e)},Ve=function(e){if(!(e.size<2)){var t=qe(e.data,!0),r=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:r.buffer}}},Ye=function(e){if(!(e.size<2)){if("TXXX"===e.type){var t=1,r=qe(e.data.subarray(t),!0);t+=r.length+1;var n=qe(e.data.subarray(t));return{key:e.type,info:r,data:n}}var text=qe(e.data.subarray(1));return{key:e.type,data:text}}},je=function(e){if("WXXX"===e.type){if(e.size<2)return;var t=1,r=qe(e.data.subarray(t),!0);t+=r.length+1;var n=qe(e.data.subarray(t));return{key:e.type,info:r,data:n}}var o=qe(e.data);return{key:e.type,data:o}},We=function(e){if(8===e.data.byteLength){var data=new Uint8Array(e.data),t=1&data[3],r=(data[4]<<23)+(data[5]<<15)+(data[6]<<7)+data[7];return r/=45,t&&(r+=47721858.84),Math.round(r)}},qe=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=Xe();if(r){var n=r.decode(e);if(t){var o=n.indexOf("\0");return-1!==o?n.substring(0,o):n}return n.replace(/\0/g,"")}for(var l,c,h,d=e.length,f="",i=0;i<d;){if(0===(l=e[i++])&&t)return f;if(0!==l&&3!==l)switch(l>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:f+=String.fromCharCode(l);break;case 12:case 13:c=e[i++],f+=String.fromCharCode((31&l)<<6|63&c);break;case 14:c=e[i++],h=e[i++],f+=String.fromCharCode((15&l)<<12|(63&c)<<6|(63&h)<<0)}}return f};function Xe(){if(!navigator.userAgent.includes("PlayStation 4"))return xe||void 0===self.TextDecoder||(xe=new self.TextDecoder("utf-8")),xe}var ze=function(e){for(var t="",i=0;i<e.length;i++){var r=e[i].toString(16);r.length<2&&(r="0"+r),t+=r}return t},Qe=Math.pow(2,32)-1,Je=[].push,$e={video:1,audio:2,id3:3,text:4};function Ze(data){return String.fromCharCode.apply(null,data)}function et(e,t){var r=e[t]<<8|e[t+1];return r<0?65536+r:r}function tt(e,t){var r=at(e,t);return r<0?4294967296+r:r}function it(e,t){var r=tt(e,t);return r*=Math.pow(2,32),r+=tt(e,t+4)}function at(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function nt(e,t,r){e[t]=r>>24,e[t+1]=r>>16&255,e[t+2]=r>>8&255,e[t+3]=255&r}function st(data,path){var e=[];if(!path.length)return e;for(var t=data.byteLength,i=0;i<t;){var r=tt(data,i),n=r>1?i+r:t;if(Ze(data.subarray(i+4,i+8))===path[0])if(1===path.length)e.push(data.subarray(i+8,n));else{var o=st(data.subarray(i+8,n),path.slice(1));o.length&&Je.apply(e,o)}i=n}return e}function ot(e){var t=[],r=e[0],n=8,o=tt(e,n);n+=4;var l=0,c=0;0===r?(l=tt(e,n),c=tt(e,n+4),n+=8):(l=it(e,n),c=it(e,n+8),n+=16),n+=2;var h=e.length+c,d=et(e,n);n+=2;for(var i=0;i<d;i++){var f=n,v=tt(e,f);f+=4;var m=2147483647&v;if(1===(2147483648&v)>>>31)return $.warn("SIDX has hierarchical references (not supported)"),null;var y=tt(e,f);f+=4,t.push({referenceSize:m,subsegmentDuration:y,info:{duration:y/o,start:h,end:h+m-1}}),h+=m,n=f+=4}return{earliestPresentationTime:l,timescale:o,version:r,referencesCount:d,references:t}}function lt(e){for(var t=[],r=st(e,["moov","trak"]),i=0;i<r.length;i++){var n=r[i],o=st(n,["tkhd"])[0];if(o){var l=o[0],c=tt(o,0===l?12:20),h=st(n,["mdia","mdhd"])[0];if(h){var d=tt(h,0===(l=h[0])?12:20),f=st(n,["mdia","hdlr"])[0];if(f){var v=Ze(f.subarray(8,12)),m={soun:ne,vide:se}[v];if(m){var y=ut(st(n,["mdia","minf","stbl","stsd"])[0]);t[c]={timescale:d,type:m},t[m]=O({timescale:d,id:c},y)}}}}}return st(e,["moov","mvex","trex"]).forEach((function(e){var r=tt(e,4),track=t[r];track&&(track.default={duration:tt(e,12),flags:tt(e,20)})})),t}function ut(e){var t=e.subarray(8),r=t.subarray(86),n=Ze(t.subarray(4,8)),o=n,l="enca"===n||"encv"===n;if(l){var c=st(t,[n])[0];st(c.subarray("enca"===n?28:78),["sinf"]).forEach((function(e){var t=st(e,["schm"])[0];if(t){var r=Ze(t.subarray(4,8));if("cbcs"===r||"cenc"===r){var n=st(e,["frma"])[0];n&&(o=Ze(n))}}}))}switch(o){case"avc1":case"avc2":case"avc3":case"avc4":var h=st(r,["avcC"])[0];o+="."+ht(h[1])+ht(h[2])+ht(h[3]);break;case"mp4a":var d=st(t,[n])[0],f=st(d.subarray(28),["esds"])[0];if(f&&f.length>12){var i=4;if(3!==f[i++])break;i=ct(f,i),i+=2;var v=f[i++];if(128&v&&(i+=2),64&v&&(i+=f[i++]),4!==f[i++])break;i=ct(f,i);var m=f[i++];if(64!==m)break;if(o+="."+ht(m),i+=12,5!==f[i++])break;i=ct(f,i);var y=f[i++],k=(248&y)>>3;31===k&&(k+=1+((7&y)<<3)+((224&f[i])>>5)),o+="."+k}break;case"hvc1":case"hev1":var E=st(r,["hvcC"])[0],T=E[1],S=["","A","B","C"][T>>6],L=31&T,A=tt(E,2),R=(32&T)>>5?"H":"L",D=E[12],w=E.subarray(6,12);o+="."+S+L,o+="."+A.toString(16).toUpperCase(),o+="."+R+D;for(var I="",C=w.length;C--;){var _=w[C];if(_||I)I="."+_.toString(16).toUpperCase()+I}o+=I;break;case"dvh1":case"dvhe":var x=st(r,["dvcC"])[0],P=x[2]>>1&127,F=x[2]<<5&32|x[3]>>3&31;o+="."+ft(P)+"."+ft(F);break;case"vp09":var M=st(r,["vpcC"])[0],O=M[4],N=M[5],U=M[6]>>4&15;o+="."+ft(O)+"."+ft(N)+"."+ft(U);break;case"av01":var B=st(r,["av1C"])[0],G=B[1]>>>5,K=31&B[1],H=B[2]>>>7?"H":"M",V=(64&B[2])>>6,Y=(32&B[2])>>5,j=2===G&&V?Y?12:10:V?10:8,W=(16&B[2])>>4,X=(8&B[2])>>3,z=(4&B[2])>>2,Q=3&B[2];o+="."+G+"."+ft(K)+H+"."+ft(j)+"."+W+"."+X+z+Q+"."+ft(1)+"."+ft(1)+"."+ft(1)+".0"}return{codec:o,encrypted:l}}function ct(e,i){for(var t=i+5;128&e[i++]&&i<t;);return i}function ht(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function ft(e){return(e<10?"0":"")+e}function vt(e){var t=st(e,["schm"])[0];if(t){var r=Ze(t.subarray(4,8));if("cbcs"===r||"cenc"===r)return st(e,["schi","tenc"])[0]}return null}function gt(e){var t=tt(e,0),r=8;1&t&&(r+=4),4&t&&(r+=4);for(var n=0,o=tt(e,4),i=0;i<o;i++){if(256&t)n+=tt(e,r),r+=4;512&t&&(r+=4),1024&t&&(r+=4),2048&t&&(r+=4)}return n}function mt(e,t){var r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function yt(e,track){var t=[],r=track.samples,n=track.timescale,o=track.id,l=!1;return st(r,["moof"]).map((function(c){var h=c.byteOffset-8;st(c,["traf"]).map((function(c){var d=st(c,["tfdt"]).map((function(e){var t=e[0],r=tt(e,4);return 1===t&&(r*=Math.pow(2,32),r+=tt(e,8)),r/n}))[0];return void 0!==d&&(e=d),st(c,["tfhd"]).map((function(d){var f=tt(d,4),v=16777215&tt(d,0),m=0,y=0!=(16&v),k=0,E=0!=(32&v),T=8;f===o&&(0!=(1&v)&&(T+=8),0!=(2&v)&&(T+=4),0!=(8&v)&&(m=tt(d,T),T+=4),y&&(k=tt(d,T),T+=4),E&&(T+=4),"video"===track.type&&(l=function(e){if(!e)return!1;var t=e.indexOf("."),r=t<0?e:e.substring(0,t);return"hvc1"===r||"hev1"===r||"dvh1"===r||"dvhe"===r}(track.codec)),st(c,["trun"]).map((function(o){var c=o[0],d=16777215&tt(o,0),f=0!=(1&d),v=0,y=0!=(4&d),E=0!=(256&d),T=0,S=0!=(512&d),L=0,A=0!=(1024&d),R=0!=(2048&d),D=0,w=tt(o,4),I=8;f&&(v=tt(o,I),I+=4),y&&(I+=4);for(var C=v+h,_=0;_<w;_++){if(E?(T=tt(o,I),I+=4):T=m,S?(L=tt(o,I),I+=4):L=k,A&&(I+=4),R&&(D=0===c?tt(o,I):at(o,I),I+=4),track.type===se)for(var x=0;x<L;){var P=tt(r,C);if(pt(l,r[C+=4]))kt(r.subarray(C,C+P),l?2:1,e+D/n,t);C+=P,x+=P+4}e+=T/n}})))}))}))})),t}function pt(e,t){if(e){var r=t>>1&63;return 39===r||40===r}return 6===(31&t)}function kt(e,t,r,n){var data=Et(e),o=0;o+=t;for(var l=0,c=0,b=0;o<data.length;){l=0;do{if(o>=data.length)break;l+=b=data[o++]}while(255===b);c=0;do{if(o>=data.length)break;c+=b=data[o++]}while(255===b);var h=data.length-o,d=o;if(c<h)o+=c;else if(c>h){$.error("Malformed SEI payload. ".concat(c," is too small, only ").concat(h," bytes left to parse."));break}if(4===l){if(181===data[d++]){var f=et(data,d);if(d+=2,49===f){var v=tt(data,d);if(d+=4,1195456820===v){var m=data[d++];if(3===m){var y=data[d++],k=64&y,E=k?2+3*(31&y):0,T=new Uint8Array(E);if(k){T[0]=y;for(var i=1;i<E;i++)T[i]=data[d++]}n.push({type:m,payloadType:l,pts:r,bytes:T})}}}}}else if(5===l&&c>16){for(var S=[],L=0;L<16;L++){var A=data[d++].toString(16);S.push(1==A.length?"0"+A:A),3!==L&&5!==L&&7!==L&&9!==L||S.push("-")}for(var R=c-16,D=new Uint8Array(R),w=0;w<R;w++)D[w]=data[d++];n.push({payloadType:l,pts:r,uuid:S.join(""),userData:qe(D),userDataBytes:D})}}}function Et(data){for(var e=data.byteLength,t=[],i=1;i<e-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(t.push(i+2),i+=2):i++;if(0===t.length)return data;var r=e-t.length,n=new Uint8Array(r),o=0;for(i=0;i<r;o++,i++)o===t[0]&&(o++,t.shift()),n[i]=data[o];return n}function Tt(e,t,data){if(16!==e.byteLength)throw new RangeError("Invalid system id");var r,n,o;if(t){r=1,n=new Uint8Array(16*t.length);for(var l=0;l<t.length;l++){var c=t[l];if(16!==c.byteLength)throw new RangeError("Invalid key");n.set(c,16*l)}}else r=0,n=new Uint8Array;r>0?(o=new Uint8Array(4),t.length>0&&new DataView(o.buffer).setUint32(0,t.length,!1)):o=new Uint8Array;var h=new Uint8Array(4);return data&&data.byteLength>0&&new DataView(h.buffer).setUint32(0,data.byteLength,!1),function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];for(var o=r.length,l=8,i=o;i--;)l+=r[i].byteLength;var c=new Uint8Array(l);for(c[0]=l>>24&255,c[1]=l>>16&255,c[2]=l>>8&255,c[3]=255&l,c.set(e,4),i=0,l=8;i<o;i++)c.set(r[i],l),l+=r[i].byteLength;return c}([112,115,115,104],new Uint8Array([r,0,0,0]),e,o,n,h,data||new Uint8Array)}function St(view){var e=view.getUint32(0),t=view.byteOffset,r=view.byteLength;if(r<e)return{offset:t,size:r};if(1886614376!==view.getUint32(4))return{offset:t,size:e};var n=view.getUint32(8)>>>24;if(0!==n&&1!==n)return{offset:t,size:e};var o=view.buffer,l=ze(new Uint8Array(o,t+12,16)),c=view.getUint32(28),h=null,data=null;if(0===n){if(e-32<c||c<22)return{offset:t,size:e};data=new Uint8Array(o,t+32,c)}else if(1===n){if(!c||r<t+32+16*c+16)return{offset:t,size:e};h=[];for(var i=0;i<c;i++)h.push(new Uint8Array(o,t+32+16*i,16))}return{version:n,systemId:l,kids:h,data:data,offset:t,size:e}}var Lt={},At=function(){function e(t,r,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[1],l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;D(this,e),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=r,this.keyFormat=n,this.keyFormatVersions=o,this.iv=l,this.encrypted=!!t&&"NONE"!==t,this.isCommonEncryption=this.encrypted&&"AES-128"!==t}return I(e,[{key:"isSupported",value:function(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case pe:case Ee:case ke:case ye:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}},{key:"getDecryptData",value:function(t){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof t&&("AES-128"!==this.method||this.iv||$.warn('missing IV for initialization segment with method="'.concat(this.method,'" - compliance issue')),t=0);var r=function(e){for(var t=new Uint8Array(16),i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}(t);return new e(this.method,this.uri,"identity",this.keyFormatVersions,r)}var n=fe(this.uri);if(n)switch(this.keyFormat){case Ee:this.pssh=n,n.length>=22&&(this.keyId=n.subarray(n.length-22,n.length-6));break;case ke:var o=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Tt(o,null,n);var l=new Uint16Array(n.buffer,n.byteOffset,n.byteLength/2),c=String.fromCharCode.apply(null,Array.from(l)),h=c.substring(c.indexOf("<"),c.length),d=(new DOMParser).parseFromString(h,"text/xml").getElementsByTagName("KID")[0];if(d){var f=d.childNodes[0]?d.childNodes[0].nodeValue:d.getAttribute("VALUE");if(f){var v=de(f).subarray(0,16);!function(e){var t=function(e,t,r){var n=e[t];e[t]=e[r],e[r]=n};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(v),this.keyId=v}}break;default:var m=n.subarray(0,16);if(16!==m.length){var y=new Uint8Array(16);y.set(m,16-m.length),m=y}this.keyId=m}if(!this.keyId||16!==this.keyId.byteLength){var k=Lt[this.uri];if(!k){var E=Object.keys(Lt).length%Number.MAX_SAFE_INTEGER;k=new Uint8Array(16),new DataView(k.buffer,12,4).setUint32(0,E),Lt[this.uri]=k}this.keyId=k}return this}}],[{key:"clearKeyUriToKeyIdMap",value:function(){Lt={}}}]),e}();var Rt=/\{\$([a-zA-Z0-9-_]+)\}/g;function bt(e){return Rt.test(e)}function Dt(e,t,r){if(null!==e.variableList||e.hasVariableRefs)for(var i=r.length;i--;){var n=r[i],o=t[n];o&&(t[n]=wt(e,o))}}function wt(e,t){if(null!==e.variableList||e.hasVariableRefs){var r=e.variableList;return t.replace(Rt,(function(t){var n=t.substring(2,t.length-1),o=null==r?void 0:r[n];return void 0===o?(e.playlistParsingError||(e.playlistParsingError=new Error('Missing preceding EXT-X-DEFINE tag for Variable Reference: "'.concat(n,'"'))),t):o}))}return t}function It(e,t,r){var n,o,l=e.variableList;if(l||(e.variableList=l={}),"QUERYPARAM"in t){n=t.QUERYPARAM;try{var c=new self.URL(r).searchParams;if(!c.has(n))throw new Error('"'.concat(n,'" does not match any query parameter in URI: "').concat(r,'"'));o=c.get(n)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error("EXT-X-DEFINE QUERYPARAM: ".concat(t.message)))}}else n=t.NAME,o=t.VALUE;n in l?e.playlistParsingError||(e.playlistParsingError=new Error('EXT-X-DEFINE duplicate Variable Name declarations: "'.concat(n,'"'))):l[n]=o||""}function Ct(e,t,r){var n=t.IMPORT;if(r&&n in r){var o=e.variableList;o||(e.variableList=o={}),o[n]=r[n]}else e.playlistParsingError||(e.playlistParsingError=new Error('EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "'.concat(n,'"')))}function _t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if("undefined"!=typeof self){var t=(e||!self.MediaSource)&&self.ManagedMediaSource;return t||self.MediaSource||self.WebKitMediaSource}}var xt={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Pt(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return!e.split(",").some((function(e){return!Ft(e,t,r)}))}function Ft(e,t){var r,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=_t(n);return null!=(r=null==o?void 0:o.isTypeSupported(Mt(e,t)))&&r}function Mt(e,t){return"".concat(t,'/mp4;codecs="').concat(e,'"')}function Ot(e){if(e){var t=e.substring(0,4);return xt.video[t]}return 2}function Nt(e){return e.split(",").reduce((function(e,t){var r=xt.video[t];return r?(2*r+e)/(e?3:2):(xt.audio[t]+e)/(e?2:1)}),0)}var Ut={};function Bt(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Ut[e])return Ut[e];for(var r={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[e],i=0;i<r.length;i++)if(Ft(r[i],"audio",t))return Ut[e]=r[i],r[i];return e}var Gt=/flac|opus/i;function Kt(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e.replace(Gt,(function(e){return Bt(e.toLowerCase(),t)}))}function Ht(e,t){return e&&"mp4a"!==e?e:t?t.split(",")[0]:t}var Vt=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Yt=/#EXT-X-MEDIA:(.*)/g,jt=/^#EXT(?:INF|-X-TARGETDURATION):/m,Wt=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),qt=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),Xt=function(){function e(){D(this,e)}return I(e,null,[{key:"findGroup",value:function(e,t){for(var i=0;i<e.length;i++){var r=e[i];if(r.id===t)return r}}},{key:"resolve",value:function(e,t){return F.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}},{key:"isMediaPlaylist",value:function(e){return jt.test(e)}},{key:"parseMasterPlaylist",value:function(t,r){var n,o={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:bt(t)},l=[];for(Vt.lastIndex=0;null!=(n=Vt.exec(t));)if(n[1]){var c,h=new te(n[1]);Dt(o,h,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);var d=wt(o,n[2]),f={attrs:h,bitrate:h.decimalInteger("BANDWIDTH")||h.decimalInteger("AVERAGE-BANDWIDTH"),name:h.NAME,url:e.resolve(d,r)},v=h.decimalResolution("RESOLUTION");v&&(f.width=v.width,f.height=v.height),Jt(h.CODECS,f),null!=(c=f.unknownCodecs)&&c.length||l.push(f),o.levels.push(f)}else if(n[3]){var m=n[3],y=n[4];switch(m){case"SESSION-DATA":var k=new te(y);Dt(o,k,["DATA-ID","LANGUAGE","VALUE","URI"]);var E=k["DATA-ID"];E&&(null===o.sessionData&&(o.sessionData={}),o.sessionData[E]=k);break;case"SESSION-KEY":var T=zt(y,r,o);T.encrypted&&T.isSupported()?(null===o.sessionKeys&&(o.sessionKeys=[]),o.sessionKeys.push(T)):$.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'.concat(y,'"'));break;case"DEFINE":var S=new te(y);Dt(o,S,["NAME","VALUE","QUERYPARAM"]),It(o,S,r);break;case"CONTENT-STEERING":var L=new te(y);Dt(o,L,["SERVER-URI","PATHWAY-ID"]),o.contentSteering={uri:e.resolve(L["SERVER-URI"],r),pathwayId:L["PATHWAY-ID"]||"."};break;case"START":o.startTimeOffset=Qt(y)}}var A=l.length>0&&l.length<o.levels.length;return o.levels=A?l:o.levels,0===o.levels.length&&(o.playlistParsingError=new Error("no levels found in manifest")),o}},{key:"parseMasterPlaylistMedia",value:function(t,r,n){var o,l={},c=n.levels,h={AUDIO:c.map((function(e){return{id:e.attrs.AUDIO,audioCodec:e.audioCodec}})),SUBTITLES:c.map((function(e){return{id:e.attrs.SUBTITLES,textCodec:e.textCodec}})),"CLOSED-CAPTIONS":[]},d=0;for(Yt.lastIndex=0;null!==(o=Yt.exec(t));){var f=new te(o[1]),v=f.TYPE;if(v){var m=h[v],y=l[v]||[];l[v]=y,Dt(n,f,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);var k=f.LANGUAGE,E=f["ASSOC-LANGUAGE"],T=f.CHANNELS,S=f.CHARACTERISTICS,L=f["INSTREAM-ID"],A={attrs:f,bitrate:0,id:d++,groupId:f["GROUP-ID"]||"",name:f.NAME||k||"",type:v,default:f.bool("DEFAULT"),autoselect:f.bool("AUTOSELECT"),forced:f.bool("FORCED"),lang:k,url:f.URI?e.resolve(f.URI,r):""};if(E&&(A.assocLang=E),T&&(A.channels=T),S&&(A.characteristics=S),L&&(A.instreamId=L),null!=m&&m.length){var R=e.findGroup(m,A.groupId)||m[0];$t(A,R,"audioCodec"),$t(A,R,"textCodec")}y.push(A)}}return l}},{key:"parseLevelPlaylist",value:function(e,t,r,n,o,l){var c,i,h,d=new he(t),f=d.fragments,v=null,m=0,y=0,k=0,E=0,T=null,S=new ue(n,t),L=-1,A=!1,R=null;for(Wt.lastIndex=0,d.m3u8=e,d.hasVariableRefs=bt(e);null!==(c=Wt.exec(e));){A&&(A=!1,(S=new ue(n,t)).start=k,S.sn=m,S.cc=E,S.level=r,v&&(S.initSegment=v,S.rawProgramDateTime=v.rawProgramDateTime,v.rawProgramDateTime=null,R&&(S.setByteRange(R),R=null)));var D=c[1];if(D){S.duration=parseFloat(D);var title=(" "+c[2]).slice(1);S.title=title||null,S.tagList.push(title?["INF",D,title]:["INF",D])}else if(c[3]){if(G(S.duration)){S.start=k,h&&rr(S,h,d),S.sn=m,S.level=r,S.cc=E,f.push(S);var w=(" "+c[3]).slice(1);S.relurl=wt(d,w),Zt(S,T),T=S,k+=S.duration,m++,y=0,A=!0}}else if(c[4]){var data=(" "+c[4]).slice(1);T?S.setByteRange(data,T):S.setByteRange(data)}else if(c[5])S.rawProgramDateTime=(" "+c[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),-1===L&&(L=f.length);else{if(!(c=c[0].match(qt))){$.warn("No matches on slow regex match for level playlist!");continue}for(i=1;i<c.length&&void 0===c[i];i++);var I=(" "+c[i]).slice(1),C=(" "+c[i+1]).slice(1),_=c[i+2]?(" "+c[i+2]).slice(1):"";switch(I){case"PLAYLIST-TYPE":d.type=C.toUpperCase();break;case"MEDIA-SEQUENCE":m=d.startSN=parseInt(C);break;case"SKIP":var x=new te(C);Dt(d,x,["RECENTLY-REMOVED-DATERANGES"]);var P=x.decimalInteger("SKIPPED-SEGMENTS");if(G(P)){d.skippedSegments=P;for(var F=P;F--;)f.unshift(null);m+=P}var M=x.enumeratedString("RECENTLY-REMOVED-DATERANGES");M&&(d.recentlyRemovedDateranges=M.split("\t"));break;case"TARGETDURATION":d.targetduration=Math.max(parseInt(C),1);break;case"VERSION":d.version=parseInt(C);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":d.live=!1;break;case"#":(C||_)&&S.tagList.push(_?[C,_]:[C]);break;case"DISCONTINUITY":E++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([I]);break;case"BITRATE":S.tagList.push([I,C]);break;case"DATERANGE":var O=new te(C);Dt(d,O,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),Dt(d,O,O.clientAttrs);var N=new ie(O,d.dateRanges[O.ID]);N.isValid||d.skippedSegments?d.dateRanges[N.id]=N:$.warn('Ignoring invalid DATERANGE tag: "'.concat(C,'"')),S.tagList.push(["EXT-X-DATERANGE",C]);break;case"DEFINE":var U=new te(C);Dt(d,U,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in U?Ct(d,U,l):It(d,U,t);break;case"DISCONTINUITY-SEQUENCE":E=parseInt(C);break;case"KEY":var K=zt(C,t,d);if(K.isSupported()){if("NONE"===K.method){h=void 0;break}h||(h={}),h[K.keyFormat]&&(h=B({},h)),h[K.keyFormat]=K}else $.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'.concat(C,'"'));break;case"START":d.startTimeOffset=Qt(C);break;case"MAP":var H=new te(C);if(Dt(d,H,["BYTERANGE","URI"]),S.duration){var V=new ue(n,t);er(V,H,r,h),v=V,S.initSegment=v,v.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=v.rawProgramDateTime)}else{var Y=S.byteRangeEndOffset;if(Y){var j=S.byteRangeStartOffset;R="".concat(Y-j,"@").concat(j)}else R=null;er(S,H,r,h),v=S,A=!0}break;case"SERVER-CONTROL":var W=new te(C);d.canBlockReload=W.bool("CAN-BLOCK-RELOAD"),d.canSkipUntil=W.optionalFloat("CAN-SKIP-UNTIL",0),d.canSkipDateRanges=d.canSkipUntil>0&&W.bool("CAN-SKIP-DATERANGES"),d.partHoldBack=W.optionalFloat("PART-HOLD-BACK",0),d.holdBack=W.optionalFloat("HOLD-BACK",0);break;case"PART-INF":var X=new te(C);d.partTarget=X.decimalFloatingPoint("PART-TARGET");break;case"PART":var z=d.partList;z||(z=d.partList=[]);var Q=y>0?z[z.length-1]:void 0,J=y++,Z=new te(C);Dt(d,Z,["BYTERANGE","URI"]);var ee=new ce(Z,S,t,J,Q);z.push(ee),S.duration+=ee.duration;break;case"PRELOAD-HINT":var re=new te(C);Dt(d,re,["URI"]),d.preloadHint=re;break;case"RENDITION-REPORT":var ae=new te(C);Dt(d,ae,["URI"]),d.renditionReports=d.renditionReports||[],d.renditionReports.push(ae);break;default:$.warn("line parsed but not handled: ".concat(c))}}}T&&!T.relurl?(f.pop(),k-=T.duration,d.partList&&(d.fragmentHint=T)):d.partList&&(Zt(S,T),S.cc=E,d.fragmentHint=S,h&&rr(S,h,d));var ne=f.length,se=f[0],oe=f[ne-1];if((k+=d.skippedSegments*d.targetduration)>0&&ne&&oe){d.averagetargetduration=k/ne;var le=oe.sn;d.endSN="initSegment"!==le?le:0,d.live||(oe.endList=!0),se&&(d.startCC=se.cc)}else d.endSN=0,d.startCC=0;return d.fragmentHint&&(k+=d.fragmentHint.duration),d.totalduration=k,d.endCC=E,L>0&&function(e,t){for(var r=e[t],i=t;i--;){var n=e[i];if(!n)return;n.programDateTime=r.programDateTime-1e3*n.duration,r=n}}(f,L),d}}]),e}();function zt(e,t,r){var n,o,l=new te(e);Dt(r,l,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);var c=null!=(n=l.METHOD)?n:"",h=l.URI,d=l.hexadecimalInteger("IV"),f=l.KEYFORMATVERSIONS,v=null!=(o=l.KEYFORMAT)?o:"identity";h&&l.IV&&!d&&$.error("Invalid IV: ".concat(l.IV));var m=h?Xt.resolve(h,t):"",y=(f||"1").split("/").map(Number).filter(Number.isFinite);return new At(c,m,v,y,d)}function Qt(e){var t=new te(e).decimalFloatingPoint("TIME-OFFSET");return G(t)?t:null}function Jt(e,t){var r=(e||"").split(/[ ,]+/).filter((function(e){return e}));["video","audio","text"].forEach((function(e){var n=r.filter((function(t){return function(e,t){var r=xt[t];return!!r&&!!r[e.slice(0,4)]}(t,e)}));n.length&&(t["".concat(e,"Codec")]=n.join(","),r=r.filter((function(e){return-1===n.indexOf(e)})))})),t.unknownCodecs=r}function $t(e,t,r){var n=t[r];n&&(e[r]=n)}function Zt(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),G(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function er(e,t,r,n){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=r,e.sn="initSegment",n&&(e.levelkeys=n),e.initSegment=null}function rr(e,t,r){e.levelkeys=t;var n=r.encryptedFragments;n.length&&n[n.length-1].levelkeys===t||!Object.keys(t).some((function(e){return t[e].isCommonEncryption}))||n.push(e)}var ir="manifest",ar="level",nr="audioTrack",sr="subtitleTrack",or="main",lr="audio",ur="subtitle";function cr(e){switch(e.type){case nr:return lr;case sr:return ur;default:return or}}function dr(e,t){var r=e.url;return void 0!==r&&0!==r.indexOf("data:")||(r=t.url),r}var fr=function(){function e(t){D(this,e),this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}return I(e,[{key:"startLoad",value:function(e){}},{key:"stopLoad",value:function(){this.destroyInternalLoaders()}},{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.LEVEL_LOADING,this.onLevelLoading,this),e.on(V.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(V.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.LEVEL_LOADING,this.onLevelLoading,this),e.off(V.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(V.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}},{key:"createInternalLoader",value:function(e){var t=this.hls.config,r=t.pLoader,n=t.loader,o=new(r||n)(t);return this.loaders[e.type]=o,o}},{key:"getInternalLoader",value:function(e){return this.loaders[e.type]}},{key:"resetInternalLoader",value:function(e){this.loaders[e]&&delete this.loaders[e]}},{key:"destroyInternalLoaders",value:function(){for(var e in this.loaders){var t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}},{key:"destroy",value:function(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}},{key:"onManifestLoading",value:function(e,data){var t=data.url;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:ir,url:t,deliveryDirectives:null})}},{key:"onLevelLoading",value:function(e,data){var t=data.id,r=data.level,n=data.pathwayId,o=data.url,l=data.deliveryDirectives;this.load({id:t,level:r,pathwayId:n,responseType:"text",type:ar,url:o,deliveryDirectives:l})}},{key:"onAudioTrackLoading",value:function(e,data){var t=data.id,r=data.groupId,n=data.url,o=data.deliveryDirectives;this.load({id:t,groupId:r,level:null,responseType:"text",type:nr,url:n,deliveryDirectives:o})}},{key:"onSubtitleTrackLoading",value:function(e,data){var t=data.id,r=data.groupId,n=data.url,o=data.deliveryDirectives;this.load({id:t,groupId:r,level:null,responseType:"text",type:sr,url:n,deliveryDirectives:o})}},{key:"load",value:function(e){var t,r,n,o=this,l=this.hls.config,c=this.getInternalLoader(e);if(c){var h=c.context;if(h&&h.url===e.url&&h.level===e.level)return void $.trace("[playlist-loader]: playlist request ongoing");$.log("[playlist-loader]: aborting previous loader for type: ".concat(e.type)),c.abort()}if((r=e.type===ir?l.manifestLoadPolicy.default:B({},l.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),c=this.createInternalLoader(e),G(null==(t=e.deliveryDirectives)?void 0:t.part))&&(e.type===ar&&null!==e.level?n=this.hls.levels[e.level].details:e.type===nr&&null!==e.id?n=this.hls.audioTracks[e.id].details:e.type===sr&&null!==e.id&&(n=this.hls.subtitleTracks[e.id].details),n)){var d=n.partTarget,f=n.targetduration;if(d&&f){var v=1e3*Math.max(3*d,.8*f);r=B({},r,{maxTimeToFirstByteMs:Math.min(v,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(v,r.maxTimeToFirstByteMs)})}}var m=r.errorRetry||r.timeoutRetry||{},y={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:m.maxNumRetry||0,retryDelay:m.retryDelayMs||0,maxRetryDelay:m.maxRetryDelayMs||0},k={onSuccess:function(e,t,r,n){var l=o.getInternalLoader(r);o.resetInternalLoader(r.type);var c=e.data;0===c.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),Xt.isMediaPlaylist(c)?o.handleTrackOrLevelPlaylist(e,t,r,n||null,l):o.handleMasterPlaylist(e,t,r,n)):o.handleManifestParsingError(e,r,new Error("no EXTM3U delimiter"),n||null,t)},onError:function(e,t,r,n){o.handleNetworkError(t,r,!1,e,n)},onTimeout:function(e,t,r){o.handleNetworkError(t,r,!0,void 0,e)}};c.load(e,y,k)}},{key:"handleMasterPlaylist",value:function(e,t,r,n){var o=this.hls,l=e.data,c=dr(e,r),h=Xt.parseMasterPlaylist(l,c);if(h.playlistParsingError)this.handleManifestParsingError(e,r,h.playlistParsingError,n,t);else{var d=h.contentSteering,f=h.levels,v=h.sessionData,m=h.sessionKeys,y=h.startTimeOffset,k=h.variableList;this.variableList=k;var E=Xt.parseMasterPlaylistMedia(l,c,h),T=E.AUDIO,S=void 0===T?[]:T,L=E.SUBTITLES,A=E["CLOSED-CAPTIONS"];if(S.length)S.some((function(e){return!e.url}))||!f[0].audioCodec||f[0].attrs.AUDIO||($.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),S.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new te({}),bitrate:0,url:""}));o.trigger(V.MANIFEST_LOADED,{levels:f,audioTracks:S,subtitles:L,captions:A,contentSteering:d,url:c,stats:t,networkDetails:n,sessionData:v,sessionKeys:m,startTimeOffset:y,variableList:k})}}},{key:"handleTrackOrLevelPlaylist",value:function(e,t,r,n,o){var l=this.hls,c=r.id,h=r.level,d=r.type,f=dr(e,r),v=G(h)?h:G(c)?c:0,m=cr(r),y=Xt.parseLevelPlaylist(e.data,f,v,m,0,this.variableList);if(d===ir){var k={attrs:new te({}),bitrate:0,details:y,name:"",url:f};l.trigger(V.MANIFEST_LOADED,{levels:[k],audioTracks:[],url:f,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),r.levelDetails=y,this.handlePlaylistLoaded(y,e,t,r,n,o)}},{key:"handleManifestParsingError",value:function(e,t,r,n,o){this.hls.trigger(V.ERROR,{type:Y.NETWORK_ERROR,details:j.MANIFEST_PARSING_ERROR,fatal:t.type===ir,url:e.url,err:r,error:r,reason:r.message,response:e,context:t,networkDetails:n,stats:o})}},{key:"handleNetworkError",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,l="A network ".concat(r?"timeout":"error"+(n?" (status "+n.code+")":"")," occurred while loading ").concat(e.type);e.type===ar?l+=": ".concat(e.level," id: ").concat(e.id):e.type!==nr&&e.type!==sr||(l+=" id: ".concat(e.id,' group-id: "').concat(e.groupId,'"'));var c=new Error(l);$.warn("[playlist-loader]: ".concat(l));var details=j.UNKNOWN,h=!1,d=this.getInternalLoader(e);switch(e.type){case ir:details=r?j.MANIFEST_LOAD_TIMEOUT:j.MANIFEST_LOAD_ERROR,h=!0;break;case ar:details=r?j.LEVEL_LOAD_TIMEOUT:j.LEVEL_LOAD_ERROR,h=!1;break;case nr:details=r?j.AUDIO_TRACK_LOAD_TIMEOUT:j.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case sr:details=r?j.SUBTITLE_TRACK_LOAD_TIMEOUT:j.SUBTITLE_LOAD_ERROR,h=!1}d&&this.resetInternalLoader(e.type);var f={type:Y.NETWORK_ERROR,details:details,fatal:h,url:e.url,loader:d,context:e,error:c,networkDetails:t,stats:o};if(n){var v=(null==t?void 0:t.url)||e.url;f.response=O({url:v,data:void 0},n)}this.hls.trigger(V.ERROR,f)}},{key:"handlePlaylistLoaded",value:function(e,t,r,n,o,l){var c=this.hls,h=n.type,d=n.level,f=n.id,v=n.groupId,m=n.deliveryDirectives,y=dr(t,n),k=cr(n),E="number"==typeof n.level&&k===or?d:void 0;if(e.fragments.length){e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));var T=e.playlistParsingError;if(T)c.trigger(V.ERROR,{type:Y.NETWORK_ERROR,details:j.LEVEL_PARSING_ERROR,fatal:!1,url:y,error:T,reason:T.message,response:t,context:n,level:E,parent:k,networkDetails:o,stats:r});else switch(e.live&&l&&(l.getCacheAge&&(e.ageHeader=l.getCacheAge()||0),l.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),h){case ir:case ar:c.trigger(V.LEVEL_LOADED,{details:e,level:E||0,id:f||0,stats:r,networkDetails:o,deliveryDirectives:m});break;case nr:c.trigger(V.AUDIO_TRACK_LOADED,{details:e,id:f||0,groupId:v||"",stats:r,networkDetails:o,deliveryDirectives:m});break;case sr:c.trigger(V.SUBTITLE_TRACK_LOADED,{details:e,id:f||0,groupId:v||"",stats:r,networkDetails:o,deliveryDirectives:m})}}else{var S=new Error("No Segments found in Playlist");c.trigger(V.ERROR,{type:Y.NETWORK_ERROR,details:j.LEVEL_EMPTY_ERROR,fatal:!1,url:y,error:S,reason:S.message,response:t,context:n,level:E,parent:k,networkDetails:o,stats:r})}}}]),e}();function vr(track,e){var t;try{t=new Event("addtrack")}catch(e){(t=document.createEvent("Event")).initEvent("addtrack",!1,!1)}t.track=track,e.dispatchEvent(t)}function gr(track,e){var t=track.mode;if("disabled"===t&&(track.mode="hidden"),track.cues&&!track.cues.getCueById(e.id))try{if(track.addCue(e),!track.cues.getCueById(e.id))throw new Error("addCue is failed for: ".concat(e))}catch(t){$.debug("[texttrack-utils]: ".concat(t));try{var r=new self.TextTrackCue(e.startTime,e.endTime,e.text);r.id=e.id,track.addCue(r)}catch(e){$.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: ".concat(e))}}"disabled"===t&&(track.mode=t)}function mr(track){var e=track.mode;if("disabled"===e&&(track.mode="hidden"),track.cues)for(var i=track.cues.length;i--;)track.removeCue(track.cues[i]);"disabled"===e&&(track.mode=e)}function yr(track,e,t,r){var n=track.mode;if("disabled"===n&&(track.mode="hidden"),track.cues&&track.cues.length>0)for(var o=function(e,t,r){var n=[],o=function(e,time){if(time<e[0].startTime)return 0;var t=e.length-1;if(time>e[t].endTime)return-1;var r=0,n=t;for(;r<=n;){var o=Math.floor((n+r)/2);if(time<e[o].startTime)n=o-1;else{if(!(time>e[o].startTime&&r<t))return o;r=o+1}}return e[r].startTime-time<time-e[n].startTime?r:n}(e,t);if(o>-1)for(var i=o,l=e.length;i<l;i++){var c=e[i];if(c.startTime>=t&&c.endTime<=r)n.push(c);else if(c.startTime>r)return n}return n}(track.cues,e,t),i=0;i<o.length;i++)r&&!r(o[i])||track.removeCue(o[i]);"disabled"===n&&(track.mode=n)}function pr(e){for(var t=[],i=0;i<e.length;i++){var track=e[i];"subtitles"!==track.kind&&"captions"!==track.kind||!track.label||t.push(e[i])}return t}var kr="org.id3",Er="com.apple.quicktime.HLS",Tr="https://aomedia.org/emsg/ID3";function Sr(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function Lr(e,t,r,data,n){var o=new e(t,r,"");try{o.value=data,n&&(o.type=n)}catch(l){o=new e(t,r,JSON.stringify(n?O({type:n},data):data))}return o}var Ar=function(){var e=Sr();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function Rr(e,t){return e.getTime()/1e3-t}var Dr=function(){function e(t){D(this,e),this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}return I(e,[{key:"destroy",value:function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}},{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(V.LEVEL_UPDATED,this.onLevelUpdated,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(V.LEVEL_UPDATED,this.onLevelUpdated,this)}},{key:"onMediaAttached",value:function(e,data){this.media=data.media}},{key:"onMediaDetaching",value:function(){this.id3Track&&(mr(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}},{key:"onManifestLoading",value:function(){this.dateRangeCuesAppended={}}},{key:"createTrack",value:function(e){var track=this.getID3Track(e.textTracks);return track.mode="hidden",track}},{key:"getID3Track",value:function(e){if(this.media){for(var i=0;i<e.length;i++){var t=e[i];if("metadata"===t.kind&&"id3"===t.label)return vr(t,this.media),t}return this.media.addTextTrack("metadata","id3")}}},{key:"onFragParsingMetadata",value:function(e,data){if(this.media){var t=this.hls.config,r=t.enableEmsgMetadataCues,n=t.enableID3MetadataCues;if(r||n){var o=data.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));var l=Sr();if(l)for(var i=0;i<o.length;i++){var c=o[i].type;if((c!==Tr||r)&&n){var h=Ke(o[i].data);if(h){var d=o[i].pts,f=d+o[i].duration;f>Ar&&(f=Ar),f-d<=0&&(f=d+.25);for(var v=0;v<h.length;v++){var m=h[v];if(!Be(m)){this.updateId3CueEnds(d,c);var y=Lr(l,d,f,m,c);y&&this.id3Track.addCue(y)}}}}}}}}},{key:"updateId3CueEnds",value:function(e,t){var r,n=null==(r=this.id3Track)?void 0:r.cues;if(n)for(var i=n.length;i--;){var o=n[i];o.type===t&&o.startTime<e&&o.endTime===Ar&&(o.endTime=e)}}},{key:"onBufferFlushing",value:function(e,t){var r=t.startOffset,n=t.endOffset,o=t.type,l=this.id3Track,c=this.hls;if(c){var h=c.config,d=h.enableEmsgMetadataCues,f=h.enableID3MetadataCues;if(l&&(d||f))yr(l,r,n,"audio"===o?function(e){return e.type===kr&&f}:"video"===o?function(e){return e.type===Tr&&d}:function(e){return e.type===kr&&f||e.type===Tr&&d})}}},{key:"onLevelUpdated",value:function(e,t){var r=this,details=t.details;if(this.media&&details.hasProgramDateTime&&this.hls.config.enableDateRangeMetadataCues){var n=this.dateRangeCuesAppended,o=this.id3Track,l=details.dateRanges,c=Object.keys(l);if(o)for(var h=Object.keys(n).filter((function(e){return!c.includes(e)})),d=function(i){var e=h[i];Object.keys(n[e].cues).forEach((function(t){o.removeCue(n[e].cues[t])})),delete n[e]},i=h.length;i--;)d(i);var f=details.fragments[details.fragments.length-1];if(0!==c.length&&G(null==f?void 0:f.programDateTime)){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var v=f.programDateTime/1e3-f.start,m=Sr(),y=function(e){var t=c[e],o=l[t],h=Rr(o.startDate,v),d=n[t],f=(null==d?void 0:d.cues)||{},y=(null==d?void 0:d.durationKnown)||!1,k=Ar,E=o.endDate;if(E)k=Rr(E,v),y=!0;else if(o.endOnNext&&!y){var T=c.reduce((function(e,t){if(t!==o.id){var r=l[t];if(r.class===o.class&&r.startDate>o.startDate&&(!e||o.startDate<e.startDate))return r}return e}),null);T&&(k=Rr(T.startDate,v),y=!0)}for(var S,L,A=Object.keys(o.attr),R=0;R<A.length;R++){var D=A[R];if("ID"!==(L=D)&&"CLASS"!==L&&"START-DATE"!==L&&"DURATION"!==L&&"END-DATE"!==L&&"END-ON-NEXT"!==L){var w=f[D];if(w)y&&!d.durationKnown&&(w.endTime=k);else if(m){var data=o.attr[D];re(D)&&(S=data,data=Uint8Array.from(S.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);var I=Lr(m,h,k,{key:D,data:data},Er);I&&(I.id=t,r.id3Track.addCue(I),f[D]=I)}}}n[t]={cues:f,dateRange:o,durationKnown:y}},k=0;k<c.length;k++)y(k)}}}}]),e}(),wr=function(){function e(t){var r=this;D(this,e),this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return r.timeupdate()},this.hls=t,this.config=t.config,this.registerListeners()}return I(e,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var e=this.config,t=this.levelDetails;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}},{key:"targetLatency",get:function(){var e=this.levelDetails;if(null===e)return null;var t=e.holdBack,r=e.partHoldBack,n=e.targetduration,o=this.config,l=o.liveSyncDuration,c=o.liveSyncDurationCount,h=o.lowLatencyMode,d=this.hls.userConfig,f=h&&r||t;(d.liveSyncDuration||d.liveSyncDurationCount||0===f)&&(f=void 0!==l?l:c*n);var v=n;return f+Math.min(1*this.stallCount,v)}},{key:"liveSyncPosition",get:function(){var e=this.estimateLiveEdge(),t=this.targetLatency,r=this.levelDetails;if(null===e||null===t||null===r)return null;var n=r.edge,o=e-t-this.edgeStalled,l=n-r.totalduration,c=n-(this.config.lowLatencyMode&&r.partTarget||r.targetduration);return Math.min(Math.max(l,o),c)}},{key:"drift",get:function(){var e=this.levelDetails;return null===e?1:e.drift}},{key:"edgeStalled",get:function(){var e=this.levelDetails;if(null===e)return 0;var t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}},{key:"forwardBufferLength",get:function(){var e=this.media,t=this.levelDetails;if(!e||!t)return 0;var r=e.buffered.length;return(r?e.buffered.end(r-1):t.edge)-this.currentTime}},{key:"destroy",value:function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}},{key:"registerListeners",value:function(){this.hls.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(V.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(V.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(V.ERROR,this.onError,this)}},{key:"unregisterListeners",value:function(){this.hls.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(V.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(V.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(V.ERROR,this.onError,this)}},{key:"onMediaAttached",value:function(e,data){this.media=data.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}},{key:"onMediaDetaching",value:function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}},{key:"onManifestLoading",value:function(){this.levelDetails=null,this._latency=null,this.stallCount=0}},{key:"onLevelUpdated",value:function(e,t){var details=t.details;this.levelDetails=details,details.advanced&&this.timeupdate(),!details.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}},{key:"onError",value:function(e,data){var t;data.details===j.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(t=this.levelDetails)&&t.live&&$.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}},{key:"timeupdate",value:function(){var e=this.media,t=this.levelDetails;if(e&&t){this.currentTime=e.currentTime;var r=this.computeLatency();if(null!==r){this._latency=r;var n=this.config,o=n.lowLatencyMode,l=n.maxLiveSyncPlaybackRate;if(o&&1!==l&&t.live){var c=this.targetLatency;if(null!==c){var h=r-c;if(h<Math.min(this.maxLatency,c+t.targetduration)&&h>.05&&this.forwardBufferLength>1){var d=Math.min(2,Math.max(1,l)),f=Math.round(2/(1+Math.exp(-.75*h-this.edgeStalled))*20)/20;e.playbackRate=Math.min(d,Math.max(1,f))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}}}}}},{key:"estimateLiveEdge",value:function(){var e=this.levelDetails;return null===e?null:e.edge+e.age}},{key:"computeLatency",value:function(){var e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}]),e}(),Ir=["NONE","TYPE-0","TYPE-1",null];var Cr=["SDR","PQ","HLG"];var _r="",xr="YES",Pr="v2";function Fr(details){var e=details.canSkipUntil,t=details.canSkipDateRanges,r=details.age;return e&&r<e/2?t?Pr:xr:_r}var Mr=function(){function e(t,r,n){D(this,e),this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=r,this.skip=n}return I(e,[{key:"addDirectives",value:function(e){var t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}]),e}(),Or=function(){function e(data){D(this,e),this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[data.url],this._attrs=[data.attrs],this.bitrate=data.bitrate,data.details&&(this.details=data.details),this.id=data.id||0,this.name=data.name,this.width=data.width||0,this.height=data.height||0,this.frameRate=data.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=data.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=data.audioCodec,this.videoCodec=data.videoCodec,this.codecSet=[data.videoCodec,data.audioCodec].filter((function(e){return!!e})).map((function(s){return s.substring(0,4)})).join(","),this.addGroupId("audio",data.attrs.AUDIO),this.addGroupId("text",data.attrs.SUBTITLES)}return I(e,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"averageBitrate",get:function(){return this._avgBitrate||this.realBitrate||this.bitrate}},{key:"attrs",get:function(){return this._attrs[0]}},{key:"codecs",get:function(){return this.attrs.CODECS||""}},{key:"pathwayId",get:function(){return this.attrs["PATHWAY-ID"]||"."}},{key:"videoRange",get:function(){return this.attrs["VIDEO-RANGE"]||"SDR"}},{key:"score",get:function(){return this.attrs.optionalFloat("SCORE",0)}},{key:"uri",get:function(){return this.url[0]||""}},{key:"hasAudioGroup",value:function(e){return Nr(this._audioGroups,e)}},{key:"hasSubtitleGroup",value:function(e){return Nr(this._subtitleGroups,e)}},{key:"audioGroups",get:function(){return this._audioGroups}},{key:"subtitleGroups",get:function(){return this._subtitleGroups}},{key:"addGroupId",value:function(e,t){if(t)if("audio"===e){var r=this._audioGroups;r||(r=this._audioGroups=[]),-1===r.indexOf(t)&&r.push(t)}else if("text"===e){var n=this._subtitleGroups;n||(n=this._subtitleGroups=[]),-1===n.indexOf(t)&&n.push(t)}}},{key:"urlId",get:function(){return 0},set:function(e){}},{key:"audioGroupIds",get:function(){return this.audioGroups?[this.audioGroupId]:void 0}},{key:"textGroupIds",get:function(){return this.subtitleGroups?[this.textGroupId]:void 0}},{key:"audioGroupId",get:function(){var e;return null==(e=this.audioGroups)?void 0:e[0]}},{key:"textGroupId",get:function(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}},{key:"addFallback",value:function(){}}]),e}();function Nr(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function Ur(e,t){var r=t.startPTS;if(G(r)){var n,o=0;t.sn>e.sn?(o=r-e.start,n=e):(o=e.start-r,n=t),n.duration!==o&&(n.duration=o)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function Br(details,e,t,r,n,o){r-t<=0&&($.warn("Fragment should have a positive duration",e),r=t+e.duration,o=n+e.duration);var l=t,c=r,h=e.startPTS,d=e.endPTS;if(G(h)){var f=Math.abs(h-t);G(e.deltaPTS)?e.deltaPTS=Math.max(f,e.deltaPTS):e.deltaPTS=f,l=Math.max(t,h),t=Math.min(t,h),n=Math.min(n,e.startDTS),c=Math.min(r,d),r=Math.max(r,d),o=Math.max(o,e.endDTS)}var v=t-e.start;0!==e.start&&(e.start=t),e.duration=r-e.start,e.startPTS=t,e.maxStartPTS=l,e.startDTS=n,e.endPTS=r,e.minEndPTS=c,e.endDTS=o;var i,m=e.sn;if(!details||m<details.startSN||m>details.endSN)return 0;var y=m-details.startSN,k=details.fragments;for(k[y]=e,i=y;i>0;i--)Ur(k[i],k[i-1]);for(i=y;i<k.length-1;i++)Ur(k[i],k[i+1]);return details.fragmentHint&&Ur(k[k.length-1],details.fragmentHint),details.PTSKnown=details.alignedSliding=!0,v}function Gr(e,t){for(var r=null,n=e.fragments,i=n.length-1;i>=0;i--){var o=n[i].initSegment;if(o){r=o;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;var l,c=0;(function(e,t,r){for(var n=t.skippedSegments,o=Math.max(e.startSN,t.startSN)-t.startSN,l=(e.fragmentHint?1:0)+(n?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,c=t.startSN-e.startSN,h=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,d=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,i=o;i<=l;i++){var f=d[c+i],v=h[i];n&&!v&&i<n&&(v=t.fragments[i]=f),f&&v&&r(f,v)}}(e,t,(function(e,n){e.relurl&&(c=e.cc-n.cc),G(e.startPTS)&&G(e.endPTS)&&(n.start=n.startPTS=e.startPTS,n.startDTS=e.startDTS,n.maxStartPTS=e.maxStartPTS,n.endPTS=e.endPTS,n.endDTS=e.endDTS,n.minEndPTS=e.minEndPTS,n.duration=e.endPTS-e.startPTS,n.duration&&(l=n),t.PTSKnown=t.alignedSliding=!0),n.elementaryStreams=e.elementaryStreams,n.loader=e.loader,n.stats=e.stats,e.initSegment&&(n.initSegment=e.initSegment,r=e.initSegment)})),r)&&(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach((function(e){var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=r)?void 0:t.relurl)||(e.initSegment=r)}));if(t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some((function(e){return!e})),t.deltaUpdateFailed){$.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var h=t.skippedSegments;h--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=function(e,t,r){var n=B({},e);r&&r.forEach((function(e){delete n[e]}));return Object.keys(t).forEach((function(e){var r=new ie(t[e].attr,n[e]);r.isValid?n[e]=r:$.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'.concat(JSON.stringify(t[e].attr),'"'))})),n}(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));var d=t.fragments;if(c){$.warn("discontinuity sliding from playlist, take drift into account");for(var f=0;f<d.length;f++)d[f].cc+=c}t.skippedSegments&&(t.startCC=t.fragments[0].cc),function(e,t,r){if(e&&t)for(var n=0,i=0,o=e.length;i<=o;i++){var l=e[i],c=t[i+n];l&&c&&l.index===c.index&&l.fragment.sn===c.fragment.sn?r(l,c):n--}}(e.partList,t.partList,(function(e,t){t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),l?Br(t,l,l.startPTS,l.endPTS,l.startDTS,l.endDTS):Kr(e,t),d.length&&(t.totalduration=t.edge-d[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;var v=t.advancedDateTime;if(t.advanced&&v){var m=t.edge;t.driftStart||(t.driftStartTime=v,t.driftStart=m),t.driftEndTime=v,t.driftEnd=m}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function Kr(e,t){var r=t.startSN+t.skippedSegments-e.startSN,n=e.fragments;r<0||r>=n.length||Hr(t,n[r].start)}function Hr(details,e){if(e){for(var t=details.fragments,i=details.skippedSegments;i<t.length;i++)t[i].start+=e;details.fragmentHint&&(details.fragmentHint.start+=e)}}function Vr(e,t,r){var n;return null!=e&&e.details?Yr(null==(n=e.details)?void 0:n.partList,t,r):null}function Yr(e,t,r){if(e)for(var i=e.length;i--;){var n=e[i];if(n.index===r&&n.fragment.sn===t)return n}return null}function jr(e){e.forEach((function(e,t){var details=e.details;null!=details&&details.fragments&&details.fragments.forEach((function(e){e.level=t}))}))}function Wr(e){switch(e.details){case j.FRAG_LOAD_TIMEOUT:case j.KEY_LOAD_TIMEOUT:case j.LEVEL_LOAD_TIMEOUT:case j.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function qr(e,t){var r=Wr(t);return e.default["".concat(r?"timeout":"error","Retry")]}function Xr(e,t){var r="linear"===e.backoff?1:Math.pow(2,t);return Math.min(r*e.retryDelayMs,e.maxRetryDelayMs)}function zr(e){return O(O({},e),{errorRetry:null,timeoutRetry:null})}function Qr(e,t,r,n){if(!e)return!1;var o=null==n?void 0:n.code,l=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(o)||!!r);return e.shouldRetry?e.shouldRetry(e,t,r,n,l):l}var Jr=function(e,t){for(var r=0,n=e.length-1,o=null,l=null;r<=n;){var c=t(l=e[o=(r+n)/2|0]);if(c>0)r=o+1;else{if(!(c<0))return l;n=o-1}}return null};function $r(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.005,l=null;if(e){l=t[e.sn-t[0].sn+1]||null;var c=e.endDTS-r;c>0&&c<15e-7&&(r+=15e-7)}else 0===r&&0===t[0].start&&(l=t[0]);if(l&&((!e||e.level===l.level)&&0===ei(r,n,l)||Zr(l,e,Math.min(o,n))))return l;var h=Jr(t,ei.bind(null,r,n));return!h||h===e&&l?l:h}function Zr(e,t,r){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){var n=t.tagList.reduce((function(e,t){return"INF"===t[0]&&(e+=parseFloat(t[1])),e}),r);return e.start<=n}return!1}function ei(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;if(r.start<=e&&r.start+r.duration>e)return 0;var n=Math.min(t,r.duration+(r.deltaPTS?r.deltaPTS:0));return r.start+r.duration-n<=e?1:r.start-n>e&&r.start?-1:0}function ti(e,t,r){var n=1e3*Math.min(t,r.duration+(r.deltaPTS?r.deltaPTS:0));return(r.endProgramDateTime||0)-n>e}var ri=0,ii=2,ai=3,ni=5,si=0,oi=1,ui=2,ci=function(){function e(t){D(this,e),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=$.log.bind($,"[info]:"),this.warn=$.warn.bind($,"[warning]:"),this.error=$.error.bind($,"[error]:"),this.registerListeners()}return I(e,[{key:"registerListeners",value:function(){var e=this.hls;e.on(V.ERROR,this.onError,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.LEVEL_UPDATED,this.onLevelUpdated,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e&&(e.off(V.ERROR,this.onError,this),e.off(V.ERROR,this.onErrorOut,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.LEVEL_UPDATED,this.onLevelUpdated,this))}},{key:"destroy",value:function(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}},{key:"startLoad",value:function(e){}},{key:"stopLoad",value:function(){this.playlistError=0}},{key:"getVariantLevelIndex",value:function(e){return(null==e?void 0:e.type)===or?e.level:this.hls.loadLevel}},{key:"onManifestLoading",value:function(){this.playlistError=0,this.penalizedRenditions={}}},{key:"onLevelUpdated",value:function(){this.playlistError=0}},{key:"onError",value:function(e,data){var t,r;if(!data.fatal){var n=this.hls,o=data.context;switch(data.details){case j.FRAG_LOAD_ERROR:case j.FRAG_LOAD_TIMEOUT:case j.KEY_LOAD_ERROR:case j.KEY_LOAD_TIMEOUT:return void(data.errorAction=this.getFragRetryOrSwitchAction(data));case j.FRAG_PARSING_ERROR:if(null!=(t=data.frag)&&t.gap)return void(data.errorAction={action:ri,flags:si});case j.FRAG_GAP:case j.FRAG_DECRYPT_ERROR:return data.errorAction=this.getFragRetryOrSwitchAction(data),void(data.errorAction.action=ii);case j.LEVEL_EMPTY_ERROR:case j.LEVEL_PARSING_ERROR:var l,c,h=data.parent===or?data.level:n.loadLevel;return void(data.details===j.LEVEL_EMPTY_ERROR&&null!=(l=data.context)&&null!=(c=l.levelDetails)&&c.live?data.errorAction=this.getPlaylistRetryOrSwitchAction(data,h):(data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,h)));case j.LEVEL_LOAD_ERROR:case j.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==o?void 0:o.level)&&(data.errorAction=this.getPlaylistRetryOrSwitchAction(data,o.level)));case j.AUDIO_TRACK_LOAD_ERROR:case j.AUDIO_TRACK_LOAD_TIMEOUT:case j.SUBTITLE_LOAD_ERROR:case j.SUBTITLE_TRACK_LOAD_TIMEOUT:if(o){var d=n.levels[n.loadLevel];if(d&&(o.type===nr&&d.hasAudioGroup(o.groupId)||o.type===sr&&d.hasSubtitleGroup(o.groupId)))return data.errorAction=this.getPlaylistRetryOrSwitchAction(data,n.loadLevel),data.errorAction.action=ii,void(data.errorAction.flags=oi)}return;case j.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:var f=n.levels[n.loadLevel],v=null==f?void 0:f.attrs["HDCP-LEVEL"];return void(v?data.errorAction={action:ii,flags:ui,hdcpLevel:v}:this.keySystemError(data));case j.BUFFER_ADD_CODEC_ERROR:case j.REMUX_ALLOC_ERROR:case j.BUFFER_APPEND_ERROR:return void(data.errorAction=this.getLevelSwitchAction(data,null!=(r=data.level)?r:n.loadLevel));case j.INTERNAL_EXCEPTION:case j.BUFFER_APPENDING_ERROR:case j.BUFFER_FULL_ERROR:case j.LEVEL_SWITCH_ERROR:case j.BUFFER_STALLED_ERROR:case j.BUFFER_SEEK_OVER_HOLE:case j.BUFFER_NUDGE_ON_STALL:return void(data.errorAction={action:ri,flags:si})}data.type===Y.KEY_SYSTEM_ERROR&&this.keySystemError(data)}}},{key:"keySystemError",value:function(data){var e=this.getVariantLevelIndex(data.frag);data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,e)}},{key:"getPlaylistRetryOrSwitchAction",value:function(data,e){var t=qr(this.hls.config.playlistLoadPolicy,data),r=this.playlistError++;if(Qr(t,r,Wr(data),data.response))return{action:ni,flags:si,retryConfig:t,retryCount:r};var n=this.getLevelSwitchAction(data,e);return t&&(n.retryConfig=t,n.retryCount=r),n}},{key:"getFragRetryOrSwitchAction",value:function(data){var e=this.hls,t=this.getVariantLevelIndex(data.frag),r=e.levels[t],n=e.config,o=n.fragLoadPolicy,l=n.keyLoadPolicy,c=qr(data.details.startsWith("key")?l:o,data),h=e.levels.reduce((function(e,t){return e+t.fragmentError}),0);if(r&&(data.details!==j.FRAG_GAP&&r.fragmentError++,Qr(c,h,Wr(data),data.response)))return{action:ni,flags:si,retryConfig:c,retryCount:h};var d=this.getLevelSwitchAction(data,t);return c&&(d.retryConfig=c,d.retryCount=h),d}},{key:"getLevelSwitchAction",value:function(data,e){var t=this.hls;null==e&&(e=t.loadLevel);var r=this.hls.levels[e];if(r){var n,o,l=data.details;r.loadError++,l===j.BUFFER_APPEND_ERROR&&r.fragmentError++;var c=-1,h=t.levels,d=t.loadLevel,f=t.minAutoLevel,v=t.maxAutoLevel;t.autoLevelEnabled||(t.loadLevel=-1);for(var m=null==(n=data.frag)?void 0:n.type,y=(m===lr&&l===j.FRAG_PARSING_ERROR||"audio"===data.sourceBufferName&&(l===j.BUFFER_ADD_CODEC_ERROR||l===j.BUFFER_APPEND_ERROR))&&h.some((function(e){var t=e.audioCodec;return r.audioCodec!==t})),k="video"===data.sourceBufferName&&(l===j.BUFFER_ADD_CODEC_ERROR||l===j.BUFFER_APPEND_ERROR)&&h.some((function(e){var t=e.codecSet,n=e.audioCodec;return r.codecSet!==t&&r.audioCodec===n})),E=null!=(o=data.context)?o:{},T=E.type,S=E.groupId,i=h.length;i--;){var L=(i+d)%h.length;if(L!==d&&L>=f&&L<=v&&0===h[L].loadError){var A,R,D=function(){var e=h[L];if(l===j.FRAG_GAP&&m===or&&data.frag){var t=h[L].details;if(t){var n=$r(data.frag,t.fragments,data.frag.start);if(null!=n&&n.gap)return"continue"}}else{if(T===nr&&e.hasAudioGroup(S)||T===sr&&e.hasSubtitleGroup(S))return"continue";if(m===lr&&null!=(A=r.audioGroups)&&A.some((function(t){return e.hasAudioGroup(t)}))||m===ur&&null!=(R=r.subtitleGroups)&&R.some((function(t){return e.hasSubtitleGroup(t)}))||y&&r.audioCodec===e.audioCodec||!y&&r.audioCodec!==e.audioCodec||k&&r.codecSet===e.codecSet)return"continue"}return c=L,"break"}();if("continue"===D)continue;if("break"===D)break}}if(c>-1&&t.loadLevel!==c)return data.levelRetry=!0,this.playlistError=0,{action:ii,flags:si,nextAutoLevel:c}}return{action:ii,flags:oi}}},{key:"onErrorOut",value:function(e,data){var t;switch(null==(t=data.errorAction)?void 0:t.action){case ri:break;case ii:this.sendAlternateToPenaltyBox(data),data.errorAction.resolved||data.details===j.FRAG_GAP?/MediaSource readyState: ended/.test(data.error.message)&&(this.warn('MediaSource ended after "'.concat(data.sourceBufferName,'" sourceBuffer append error. Attempting to recover from media error.')),this.hls.recoverMediaError()):data.fatal=!0}data.fatal&&this.hls.stopLoad()}},{key:"sendAlternateToPenaltyBox",value:function(data){var e=this.hls,t=data.errorAction;if(t){var r=t.flags,n=t.hdcpLevel,o=t.nextAutoLevel;switch(r){case si:this.switchLevel(data,o);break;case ui:n&&(e.maxHdcpLevel=Ir[Ir.indexOf(n)-1],t.resolved=!0),this.warn('Restricting playback to HDCP-LEVEL of "'.concat(e.maxHdcpLevel,'" or lower'))}t.resolved||this.switchLevel(data,o)}}},{key:"switchLevel",value:function(data,e){void 0!==e&&data.errorAction&&(this.warn("switching to level ".concat(e," after ").concat(data.details)),this.hls.nextAutoLevel=e,data.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}]),e}(),hi=function(){function e(t,r){D(this,e),this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=$.log.bind($,"".concat(r,":")),this.warn=$.warn.bind($,"".concat(r,":")),this.hls=t}return I(e,[{key:"destroy",value:function(){this.clearTimer(),this.hls=this.log=this.warn=null}},{key:"clearTimer",value:function(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}},{key:"startLoad",value:function(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}},{key:"stopLoad",value:function(){this.canLoad=!1,this.clearTimer()}},{key:"switchParams",value:function(e,t,r){var n=null==t?void 0:t.renditionReports;if(n){for(var o=-1,i=0;i<n.length;i++){var l=n[i],c=void 0;try{c=new self.URL(l.URI,t.url).href}catch(e){$.warn("Could not construct new URL for Rendition Report: ".concat(e)),c=l.URI||""}if(c===e){o=i;break}c===e.substring(0,c.length)&&(o=i)}if(-1!==o){var h=n[o],d=parseInt(h["LAST-MSN"])||(null==t?void 0:t.lastPartSn),f=parseInt(h["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){var v=Math.min(t.age-t.partTarget,t.targetduration);f>=0&&v>t.partTarget&&(f+=1)}var m=r&&Fr(r);return new Mr(d,f>=0?f:void 0,m)}}}},{key:"loadPlaylist",value:function(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}},{key:"shouldLoadPlaylist",value:function(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}},{key:"shouldReloadPlaylist",value:function(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}},{key:"playlistLoaded",value:function(e,data,t){var r=this,details=data.details,n=data.stats,o=self.performance.now(),l=n.loading.first?Math.max(0,o-n.loading.first):0;if(details.advancedDateTime=Date.now()-l,details.live||null!=t&&t.live){if(details.reloaded(t),t&&this.log("live playlist ".concat(e," ").concat(details.advanced?"REFRESHED "+details.lastPartSn+"-"+details.lastPartIndex:details.updated?"UPDATED":"MISSED")),t&&details.fragments.length>0&&Gr(t,details),!this.canLoad||!details.live)return;var c,h=void 0,d=void 0;if(details.canBlockReload&&details.endSN&&details.advanced){var f=this.hls.config.lowLatencyMode,v=details.lastPartSn,m=details.endSN,y=details.lastPartIndex,k=v===m;-1!==y?(h=k?m+1:v,d=k?f?0:y:y+1):h=m+1;var E=details.age,T=E+details.ageHeader,S=Math.min(T-details.partTarget,1.5*details.targetduration);if(S>0){if(t&&S>t.tuneInGoal)this.warn("CDN Tune-in goal increased from: ".concat(t.tuneInGoal," to: ").concat(S," with playlist age: ").concat(details.age)),S=0;else{var L=Math.floor(S/details.targetduration);if(h+=L,void 0!==d)d+=Math.round(S%details.targetduration/details.partTarget);this.log("CDN Tune-in age: ".concat(details.ageHeader,"s last advanced ").concat(E.toFixed(2),"s goal: ").concat(S," skip sn ").concat(L," to part ").concat(d))}details.tuneInGoal=S}if(c=this.getDeliveryDirectives(details,data.deliveryDirectives,h,d),f||!k)return void this.loadPlaylist(c)}else(details.canBlockReload||details.canSkipUntil)&&(c=this.getDeliveryDirectives(details,data.deliveryDirectives,h,d));var A=this.hls.mainForwardBufferInfo,R=A?A.end-A.len:0,D=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r=1e3*e.targetduration;if(e.updated){var n=e.fragments,o=4;if(n.length&&r*o>t){var l=1e3*n[n.length-1].duration;l<r&&(r=l)}}else r/=2;return Math.round(r)}(details,1e3*(details.edge-R));details.updated&&o>this.requestScheduled+D&&(this.requestScheduled=n.loading.start),void 0!==h&&details.canBlockReload?this.requestScheduled=n.loading.first+D-(1e3*details.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+D<o?this.requestScheduled=o:this.requestScheduled-o<=0&&(this.requestScheduled+=D);var w=this.requestScheduled-o;w=Math.max(0,w),this.log("reload live playlist ".concat(e," in ").concat(Math.round(w)," ms")),this.timer=self.setTimeout((function(){return r.loadPlaylist(c)}),w)}else this.clearTimer()}},{key:"getDeliveryDirectives",value:function(details,e,t,r){var n=Fr(details);return null!=e&&e.skip&&details.deltaUpdateFailed&&(t=e.msn,r=e.part,n=_r),new Mr(t,r,n)}},{key:"checkRetry",value:function(e){var t=this,r=e.details,n=Wr(e),o=e.errorAction,l=o||{},c=l.action,h=l.retryCount,d=void 0===h?0:h,f=l.retryConfig,v=!!o&&!!f&&(c===ni||!o.resolved&&c===ii);if(v){var m;if(this.requestScheduled=-1,d>=f.maxNumRetry)return!1;if(n&&null!=(m=e.context)&&m.deliveryDirectives)this.warn("Retrying playlist loading ".concat(d+1,"/").concat(f.maxNumRetry,' after "').concat(r,'" without delivery-directives')),this.loadPlaylist();else{var y=Xr(f,d);this.timer=self.setTimeout((function(){return t.loadPlaylist()}),y),this.warn("Retrying playlist loading ".concat(d+1,"/").concat(f.maxNumRetry,' after "').concat(r,'" in ').concat(y,"ms"))}e.levelRetry=!0,o.resolved=!0}return v}}]),e}(),di=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;D(this,e),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=r,this.totalWeight_=n}return I(e,[{key:"sample",value:function(e,t){var r=Math.pow(this.alpha_,e);this.estimate_=t*(1-r)+r*this.estimate_,this.totalWeight_+=e}},{key:"getTotalWeight",value:function(){return this.totalWeight_}},{key:"getEstimate",value:function(){if(this.alpha_){var e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}]),e}(),fi=function(){function e(t,r,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;D(this,e),this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new di(t),this.fast_=new di(r),this.defaultTTFB_=o,this.ttfb_=new di(t)}return I(e,[{key:"update",value:function(e,t){var r=this.slow_,n=this.fast_,o=this.ttfb_;r.halfLife!==e&&(this.slow_=new di(e,r.getEstimate(),r.getTotalWeight())),n.halfLife!==t&&(this.fast_=new di(t,n.getEstimate(),n.getTotalWeight())),o.halfLife!==e&&(this.ttfb_=new di(e,o.getEstimate(),o.getTotalWeight()))}},{key:"sample",value:function(e,t){var r=(e=Math.max(e,this.minDelayMs_))/1e3,n=8*t/r;this.fast_.sample(r,n),this.slow_.sample(r,n)}},{key:"sampleTTFB",value:function(e){var t=e/1e3,r=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(r,Math.max(e,5))}},{key:"canEstimate",value:function(){return this.fast_.getTotalWeight()>=this.minWeight_}},{key:"getEstimate",value:function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}},{key:"getEstimateTTFB",value:function(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}},{key:"destroy",value:function(){}}]),e}(),vi={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},gi={};function mi(e,t,r){var n=e.videoCodec,o=e.audioCodec;if(!n||!o||!r)return Promise.resolve(vi);var l={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},c=e.videoRange;"SDR"!==c&&(l.transferFunction=c.toLowerCase());var h=n.split(",").map((function(e){return{type:"media-source",video:O(O({},l),{},{contentType:Mt(e,"video")})}}));return o&&e.audioGroups&&e.audioGroups.forEach((function(e){var r;e&&(null==(r=t.groups[e])||r.tracks.forEach((function(t){if(t.groupId===e){var r=t.channels||"",n=parseFloat(r);G(n)&&n>2&&h.push.apply(h,o.split(",").map((function(e){return{type:"media-source",audio:{contentType:Mt(e,"audio"),channels:""+n}}})))}})))})),Promise.all(h.map((function(e){var t=function(e){var audio=e.audio,video=e.video,t=video||audio;if(t){var r=t.contentType.split('"')[1];if(video)return"r".concat(video.height,"x").concat(video.width,"f").concat(Math.ceil(video.framerate)).concat(video.transferFunction||"sd","_").concat(r,"_").concat(Math.ceil(video.bitrate/1e5));if(audio)return"c".concat(audio.channels).concat(audio.spatialRendering?"s":"n","_").concat(r)}return""}(e);return gi[t]||(gi[t]=r.decodingInfo(e))}))).then((function(e){return{supported:!e.some((function(e){return!e.supported})),configurations:h,decodingInfoResults:e}})).catch((function(e){return{supported:!1,configurations:h,decodingInfoResults:[],error:e}}))}function yi(e,t){var r=!1,n=[];return e&&(r="SDR"!==e,n=[e]),t&&(n=t.allowedVideoRanges||Cr.slice(0),n=(r=void 0!==t.preferHDR?t.preferHDR:function(){if("function"==typeof matchMedia){var e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}())?n.filter((function(e){return"SDR"!==e})):["SDR"]),{preferHDR:r,allowedVideoRanges:n}}function pi(e,t){$.log('[abr] start candidates with "'.concat(e,'" ignored because ').concat(t))}function ki(option,e,t){if("attrs"in option){var r=e.indexOf(option);if(-1!==r)return r}for(var i=0;i<e.length;i++){if(Ei(option,e[i],t))return i}return-1}function Ei(option,track,e){var t=option.groupId,r=option.name,n=option.lang,o=option.assocLang,l=option.characteristics,c=option.default,h=option.forced;return(void 0===t||track.groupId===t)&&(void 0===r||track.name===r)&&(void 0===n||track.lang===n)&&(void 0===n||track.assocLang===o)&&(void 0===c||track.default===c)&&(void 0===h||track.forced===h)&&(void 0===l||function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=e.split(","),n=t.split(",");return r.length===n.length&&!r.some((function(e){return-1===n.indexOf(e)}))}(l,track.characteristics))&&(void 0===e||e(option,track))}function Ti(option,track){var e=option.audioCodec,t=option.channels;return!(void 0!==e&&(track.audioCodec||"").substring(0,4)!==e.substring(0,4)||void 0!==t&&t!==(track.channels||"2"))}function Si(e,t,r){for(var i=t;i>-1;i--)if(r(e[i]))return i;for(var n=t+1;n<e.length;n++)if(r(e[n]))return n;return-1}var Li=function(){function e(t){var r=this;D(this,e),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=function(){var e=r.fragCurrent,t=r.partCurrent,n=r.hls,o=n.autoLevelEnabled,l=n.media;if(e&&l){var c=performance.now(),h=t?t.stats:e.stats,d=t?t.duration:e.duration,f=c-h.loading.start,v=n.minAutoLevel;if(h.aborted||h.loaded&&h.loaded===h.total||e.level<=v)return r.clearTimer(),void(r._nextAutoLevel=-1);if(o&&!l.paused&&l.playbackRate&&l.readyState){var m=n.mainForwardBufferInfo;if(null!==m){var y=r.bwEstimator.getEstimateTTFB(),k=Math.abs(l.playbackRate);if(!(f<=Math.max(y,d/(2*k)*1e3))){var E=m.len/k,T=h.loading.first?h.loading.first-h.loading.start:-1,S=h.loaded&&T>-1,L=r.getBwEstimate(),A=n.levels,R=A[e.level],D=h.total||Math.max(h.loaded,Math.round(d*R.averageBitrate/8)),w=S?f-T:f;w<1&&S&&(w=Math.min(f,8*h.loaded/L));var I=S?1e3*h.loaded/w:0,C=I?(D-h.loaded)/I:8*D/L+y/1e3;if(!(C<=E)){var _,x=I?8*I:L,P=Number.POSITIVE_INFINITY;for(_=e.level-1;_>v;_--){var F=A[_].maxBitrate;if((P=r.getTimeToLoadFrag(y/1e3,x,d*F,!A[_].details))<E)break}if(!(P>=C||P>10*d)){n.nextLoadLevel=n.nextAutoLevel=_,S?r.bwEstimator.sample(f-Math.min(y,T),h.loaded):r.bwEstimator.sampleTTFB(f);var M=A[_].maxBitrate;r.getBwEstimate()*r.hls.config.abrBandWidthUpFactor>M&&r.resetEstimator(M),r.clearTimer(),$.warn("[abr] Fragment ".concat(e.sn).concat(t?" part "+t.index:""," of level ").concat(e.level," is loading too slowly;\n      Time to underbuffer: ").concat(E.toFixed(3)," s\n      Estimated load time for current fragment: ").concat(C.toFixed(3)," s\n      Estimated load time for down switch fragment: ").concat(P.toFixed(3)," s\n      TTFB estimate: ").concat(0|T," ms\n      Current BW estimate: ").concat(G(L)?0|L:"Unknown"," bps\n      New BW estimate: ").concat(0|r.getBwEstimate()," bps\n      Switching to level ").concat(_," @ ").concat(0|M," bps")),n.trigger(V.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:h})}}}}}}},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}return I(e,[{key:"resetEstimator",value:function(e){e&&($.log("setting initial bwe to ".concat(e)),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}},{key:"initEstimator",value:function(){var e=this.hls.config;return new fi(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}},{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.FRAG_LOADING,this.onFragLoading,this),e.on(V.FRAG_LOADED,this.onFragLoaded,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this),e.on(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(V.LEVEL_LOADED,this.onLevelLoaded,this),e.on(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(V.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(V.ERROR,this.onError,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e&&(e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.FRAG_LOADING,this.onFragLoading,this),e.off(V.FRAG_LOADED,this.onFragLoaded,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this),e.off(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(V.LEVEL_LOADED,this.onLevelLoaded,this),e.off(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(V.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(V.ERROR,this.onError,this))}},{key:"destroy",value:function(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}},{key:"onManifestLoading",value:function(e,data){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}},{key:"onLevelsUpdated",value:function(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}},{key:"onMaxAutoLevelUpdated",value:function(){this.firstSelection=-1,this.nextAutoLevelKey=""}},{key:"onFragLoading",value:function(e,data){var t=data.frag;if(!this.ignoreFragment(t)){var r;if(!t.bitrateTest)this.fragCurrent=t,this.partCurrent=null!=(r=data.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}},{key:"onLevelSwitching",value:function(e,data){this.clearTimer()}},{key:"onError",value:function(e,data){if(!data.fatal)switch(data.details){case j.BUFFER_ADD_CODEC_ERROR:case j.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case j.FRAG_LOAD_TIMEOUT:var t=data.frag,r=this.fragCurrent,n=this.partCurrent;if(t&&r&&t.sn===r.sn&&t.level===r.level){var o=performance.now(),l=n?n.stats:t.stats,c=o-l.loading.start,h=l.loading.first?l.loading.first-l.loading.start:-1;if(l.loaded&&h>-1){var d=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(d,h),l.loaded)}else this.bwEstimator.sampleTTFB(c)}}}},{key:"getTimeToLoadFrag",value:function(e,t,r,n){return e+r/t+(n?this.lastLevelLoadSec:0)}},{key:"onLevelLoaded",value:function(e,data){var t=this.hls.config,r=data.stats.loading,n=r.end-r.start;G(n)&&(this.lastLevelLoadSec=n/1e3),data.details.live?this.bwEstimator.update(t.abrEwmaSlowLive,t.abrEwmaFastLive):this.bwEstimator.update(t.abrEwmaSlowVoD,t.abrEwmaFastVoD)}},{key:"onFragLoaded",value:function(e,t){var r=t.frag,n=t.part,o=n?n.stats:r.stats;if(r.type===or&&this.bwEstimator.sampleTTFB(o.loading.first-o.loading.start),!this.ignoreFragment(r)){if(this.clearTimer(),r.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){var l=n?n.duration:r.duration,c=this.hls.levels[r.level],h=(c.loaded?c.loaded.bytes:0)+o.loaded,d=(c.loaded?c.loaded.duration:0)+l;c.loaded={bytes:h,duration:d},c.realBitrate=Math.round(8*h/d)}if(r.bitrateTest){var f={stats:o,frag:r,part:n,id:r.type};this.onFragBuffered(V.FRAG_BUFFERED,f),r.bitrateTest=!1}else this.lastLoadedFragLevel=r.level}}},{key:"onFragBuffered",value:function(e,data){var t=data.frag,r=data.part,n=null!=r&&r.stats.loaded?r.stats:t.stats;if(!n.aborted&&!this.ignoreFragment(t)){var o=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,n.loaded),n.bwEstimate=this.getBwEstimate(),t.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}}},{key:"ignoreFragment",value:function(e){return e.type!==or||"initSegment"===e.sn}},{key:"clearTimer",value:function(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}},{key:"firstAutoLevel",get:function(){var e=this.hls,t=e.maxAutoLevel,r=e.minAutoLevel,n=this.getBwEstimate(),o=this.hls.config.maxStarvationDelay,l=this.findBestLevel(n,r,t,0,o,1,1);if(l>-1)return l;var c=this.hls.firstLevel,h=Math.min(Math.max(c,r),t);return $.warn("[abr] Could not find best starting auto level. Defaulting to first in playlist ".concat(c," clamped to ").concat(h)),h}},{key:"forcedAutoLevel",get:function(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}},{key:"nextAutoLevel",get:function(){var e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),r=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&r&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;var n=t&&r?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){var o=this.hls.levels;if(o.length>Math.max(e,n)&&o[e].loadError<=o[n].loadError)return e}return this._nextAutoLevel=n,this.nextAutoLevelKey=this.getAutoLevelKey(),n},set:function(e){var t=this.hls,r=t.maxAutoLevel,n=t.minAutoLevel,o=Math.min(Math.max(e,n),r);this._nextAutoLevel!==o&&(this.nextAutoLevelKey="",this._nextAutoLevel=o)}},{key:"getAutoLevelKey",value:function(){return"".concat(this.getBwEstimate(),"_").concat(this.getStarvationDelay().toFixed(2))}},{key:"getNextABRAutoLevel",value:function(){var e=this.fragCurrent,t=this.partCurrent,r=this.hls,n=r.maxAutoLevel,o=r.config,l=r.minAutoLevel,c=t?t.duration:e?e.duration:0,h=this.getBwEstimate(),d=this.getStarvationDelay(),f=o.abrBandWidthFactor,v=o.abrBandWidthUpFactor;if(d){var m=this.findBestLevel(h,l,n,d,0,f,v);if(m>=0)return m}var y=c?Math.min(c,o.maxStarvationDelay):o.maxStarvationDelay;if(!d){var k=this.bitrateTestDelay;if(k)y=(c?Math.min(c,o.maxLoadingDelay):o.maxLoadingDelay)-k,$.info("[abr] bitrate test took ".concat(Math.round(1e3*k),"ms, set first fragment max fetchDuration to ").concat(Math.round(1e3*y)," ms")),f=v=1}var E=this.findBestLevel(h,l,n,d,y,f,v);if($.info("[abr] ".concat(d?"rebuffering expected":"buffer is empty",", optimal quality level ").concat(E)),E>-1)return E;var T=r.levels[l],S=r.levels[r.loadLevel];return(null==T?void 0:T.bitrate)<(null==S?void 0:S.bitrate)?l:r.loadLevel}},{key:"getStarvationDelay",value:function(){var e=this.hls,t=e.media;if(!t)return 1/0;var r=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/r}},{key:"getBwEstimate",value:function(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}},{key:"findBestLevel",value:function(e,t,r,n,o,l,c){var h,d=this,f=n+o,v=this.lastLoadedFragLevel,m=-1===v?this.hls.firstLevel:v,y=this.fragCurrent,k=this.partCurrent,E=this.hls,T=E.levels,S=E.allAudioTracks,L=E.loadLevel,A=E.config;if(1===T.length)return 0;var R,D=T[m],w=!(null==D||null==(h=D.details)||!h.live),I=-1===L||-1===v,C="SDR",x=(null==D?void 0:D.frameRate)||0,P=A.audioPreference,F=A.videoPreference,M=this.audioTracksByGroup||(this.audioTracksByGroup=function(e){return e.reduce((function(e,track){var t=e.groups[track.groupId];t||(t=e.groups[track.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),t.tracks.push(track);var r=track.channels||"2";return t.channels[r]=(t.channels[r]||0)+1,t.hasDefault=t.hasDefault||track.default,t.hasAutoSelect=t.hasAutoSelect||track.autoselect,t.hasDefault&&(e.hasDefaultAudio=!0),t.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(S));if(I){if(-1!==this.firstSelection)return this.firstSelection;var O=this.codecTiers||(this.codecTiers=function(e,t,r,n){return e.slice(r,n+1).reduce((function(e,r){if(!r.codecSet)return e;var n=r.audioGroups,o=e[r.codecSet];o||(e[r.codecSet]=o={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!n,fragmentError:0}),o.minBitrate=Math.min(o.minBitrate,r.bitrate);var l=Math.min(r.height,r.width);return o.minHeight=Math.min(o.minHeight,l),o.minFramerate=Math.min(o.minFramerate,r.frameRate),o.maxScore=Math.max(o.maxScore,r.score),o.fragmentError+=r.fragmentError,o.videoRanges[r.videoRange]=(o.videoRanges[r.videoRange]||0)+1,n&&n.forEach((function(e){if(e){var r=t.groups[e];r&&(o.hasDefaultAudio=o.hasDefaultAudio||t.hasDefaultAudio?r.hasDefault:r.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(r.channels).forEach((function(e){o.channels[e]=(o.channels[e]||0)+r.channels[e]})))}})),e}),{})}(T,M,t,r)),N=function(e,t,r,n,o){for(var l=Object.keys(e),c=null==n?void 0:n.channels,h=null==n?void 0:n.audioCodec,d=c&&2===parseInt(c),f=!0,v=!1,m=1/0,y=1/0,k=1/0,E=0,T=[],S=yi(t,o),L=S.preferHDR,A=S.allowedVideoRanges,R=function(i){var t=e[l[i]];f=t.channels[2]>0,m=Math.min(m,t.minHeight),y=Math.min(y,t.minFramerate),k=Math.min(k,t.minBitrate);var r=A.filter((function(e){return t.videoRanges[e]>0}));r.length>0&&(v=!0,T=r)},i=l.length;i--;)R(i);m=G(m)?m:0,y=G(y)?y:0;var D=Math.max(1080,m),w=Math.max(30,y);return k=G(k)?k:r,r=Math.max(k,r),v||(t=void 0,T=[]),{codecSet:l.reduce((function(t,n){var o=e[n];if(n===t)return t;if(o.minBitrate>r)return pi(n,"min bitrate of ".concat(o.minBitrate," > current estimate of ").concat(r)),t;if(!o.hasDefaultAudio)return pi(n,"no renditions with default or auto-select sound found"),t;if(h&&n.indexOf(h.substring(0,4))%5!=0)return pi(n,'audio codec preference "'.concat(h,'" not found')),t;if(c&&!d){if(!o.channels[c])return pi(n,"no renditions with ".concat(c," channel sound found (channels options: ").concat(Object.keys(o.channels),")")),t}else if((!h||d)&&f&&0===o.channels[2])return pi(n,"no renditions with stereo sound found"),t;return o.minHeight>D?(pi(n,"min resolution of ".concat(o.minHeight," > maximum of ").concat(D)),t):o.minFramerate>w?(pi(n,"min framerate of ".concat(o.minFramerate," > maximum of ").concat(w)),t):T.some((function(e){return o.videoRanges[e]>0}))?o.maxScore<E?(pi(n,"max score of ".concat(o.maxScore," < selected max of ").concat(E)),t):t&&(Nt(n)>=Nt(t)||o.fragmentError>e[t].fragmentError)?t:(E=o.maxScore,n):(pi(n,"no variants with VIDEO-RANGE of ".concat(JSON.stringify(T)," found")),t)}),void 0),videoRanges:T,preferHDR:L,minFramerate:y,minBitrate:k}}(O,C,e,P,F),U=N.codecSet,B=N.videoRanges,K=N.minFramerate,H=N.minBitrate,V=N.preferHDR;R=U,C=V?B[B.length-1]:B[0],x=K,e=Math.max(e,H),$.log("[abr] picked start tier ".concat(JSON.stringify(N)))}else R=null==D?void 0:D.codecSet,C=null==D?void 0:D.videoRange;for(var Y=k?k.duration:y?y.duration:0,j=this.bwEstimator.getEstimateTTFB()/1e3,W=[],X=function(i){var t=T[i],h=i>m;if(!t)return"continue";if(A.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){var y=navigator.mediaCapabilities;"function"==typeof(null==y?void 0:y.decodingInfo)&&function(e,t,r,n,o,l){var c=e.audioCodec?e.audioGroups:null,h=null==l?void 0:l.audioCodec,d=null==l?void 0:l.channels,f=d?parseInt(d):h?1/0:2,v=null;if(null!=c&&c.length)try{v=1===c.length&&c[0]?t.groups[c[0]].channels:c.reduce((function(e,r){if(r){var n=t.groups[r];if(!n)throw new Error("Audio track group ".concat(r," not found"));Object.keys(n.channels).forEach((function(t){e[t]=(e[t]||0)+n.channels[t]}))}return e}),{2:0})}catch(e){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(n,30)||"SDR"!==e.videoRange&&e.videoRange!==r||e.bitrate>Math.max(o,8e6))||!!v&&G(f)&&Object.keys(v).some((function(e){return parseInt(e)>f}))}(t,M,C,x,e,P)?(t.supportedPromise=mi(t,M,y),t.supportedPromise.then((function(e){if(d.hls){t.supportedResult=e;var r=d.hls.levels,n=r.indexOf(t);e.error?$.warn('[abr] MediaCapabilities decodingInfo error: "'.concat(e.error,'" for level ').concat(n," ").concat(JSON.stringify(e))):e.supported||($.warn("[abr] Unsupported MediaCapabilities decodingInfo result for level ".concat(n," ").concat(JSON.stringify(e))),n>-1&&r.length>1&&($.log("[abr] Removing unsupported level ".concat(n)),d.hls.removeLevel(n)))}}))):t.supportedResult=vi}if(R&&t.codecSet!==R||C&&t.videoRange!==C||h&&x>t.frameRate||!h&&x>0&&x<t.frameRate||t.supportedResult&&(null==(z=t.supportedResult.decodingInfoResults)||!z[0].smooth))return W.push(i),"continue";var E=t.details,S=(k?null==E?void 0:E.partTarget:null==E?void 0:E.averagetargetduration)||Y,_=void 0;_=h?c*e:l*e;var F=Y&&n>=2*Y&&0===o?T[i].averageBitrate:T[i].maxBitrate,O=d.getTimeToLoadFrag(j,_,F*S,void 0===E);if(_>=F&&(i===v||0===t.loadError&&0===t.fragmentError)&&(O<=j||!G(O)||w&&!d.bitrateTestDelay||O<f)){var N=d.forcedAutoLevel;return i===L||-1!==N&&N===L||(W.length&&$.trace("[abr] Skipped level(s) ".concat(W.join(",")," of ").concat(r,' max with CODECS and VIDEO-RANGE:"').concat(T[W[0]].codecs,'" ').concat(T[W[0]].videoRange,'; not compatible with "').concat(D.codecs,'" ').concat(C)),$.info("[abr] switch candidate:".concat(m,"->").concat(i," adjustedbw(").concat(Math.round(_),")-bitrate=").concat(Math.round(_-F)," ttfb:").concat(j.toFixed(1)," avgDuration:").concat(S.toFixed(1)," maxFetchDuration:").concat(f.toFixed(1)," fetchDuration:").concat(O.toFixed(1)," firstSelection:").concat(I," codecSet:").concat(R," videoRange:").concat(C," hls.loadLevel:").concat(L))),I&&(d.firstSelection=i),{v:i}}},i=r;i>=t;i--){var z,Q=X(i);if("continue"!==Q&&"object"===_(Q))return Q.v}return-1}}]),e}(),Ai=function(){function e(){D(this,e),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}return I(e,[{key:"destroy",value:function(){this.onHandlerDestroying(),this.onHandlerDestroyed()}},{key:"onHandlerDestroying",value:function(){this.clearNextTick(),this.clearInterval()}},{key:"onHandlerDestroyed",value:function(){}},{key:"hasInterval",value:function(){return!!this._tickInterval}},{key:"hasNextTick",value:function(){return!!this._tickTimer}},{key:"setInterval",value:function(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}},{key:"clearInterval",value:function(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}},{key:"clearNextTick",value:function(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}},{key:"tick",value:function(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}},{key:"tickImmediate",value:function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}},{key:"doTick",value:function(){}}]),e}(),Ri="NOT_LOADED",bi="APPENDING",Di="PARTIAL",wi="OK",Ii=function(){function e(t){D(this,e),this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}return I(e,[{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.BUFFER_APPENDED,this.onBufferAppended,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this),e.on(V.FRAG_LOADED,this.onFragLoaded,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.BUFFER_APPENDED,this.onBufferAppended,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this),e.off(V.FRAG_LOADED,this.onFragLoaded,this)}},{key:"destroy",value:function(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}},{key:"getAppendedFrag",value:function(e,t){var r=this.activePartLists[t];if(r)for(var i=r.length;i--;){var n=r[i];if(!n)break;var o=n.end;if(n.start<=e&&null!==o&&e<=o)return n}return this.getBufferedFrag(e,t)}},{key:"getBufferedFrag",value:function(e,t){for(var r=this.fragments,n=Object.keys(r),i=n.length;i--;){var o=r[n[i]];if((null==o?void 0:o.body.type)===t&&o.buffered){var l=o.body;if(l.start<=e&&e<=l.end)return l}}return null}},{key:"detectEvictedFragments",value:function(e,t,r,n){var o=this;this.timeRanges&&(this.timeRanges[e]=t);var l=(null==n?void 0:n.fragment.sn)||-1;Object.keys(this.fragments).forEach((function(n){var c=o.fragments[n];if(c&&!(l>=c.body.sn))if(c.buffered||c.loaded){var h=c.range[e];h&&h.time.some((function(time){var e=!o.isTimeBuffered(time.startPTS,time.endPTS,t);return e&&o.removeFragment(c.body),e}))}else c.body.type===r&&o.removeFragment(c.body)}))}},{key:"detectPartialFragments",value:function(data){var e=this,t=this.timeRanges,r=data.frag,n=data.part;if(t&&"initSegment"!==r.sn){var o=_i(r),l=this.fragments[o];if(!(!l||l.buffered&&r.gap)){var c=!r.relurl;if(Object.keys(t).forEach((function(o){var h=r.elementaryStreams[o];if(h){var d=t[o],f=c||!0===h.partial;l.range[o]=e.getBufferedTimes(r,n,f,d)}})),l.loaded=null,Object.keys(l.range).length)l.buffered=!0,(l.body.endList=r.endList||l.body.endList)&&(this.endListFragments[l.body.type]=l),Ci(l)||this.removeParts(r.sn-1,r.type);else this.removeFragment(l.body)}}}},{key:"removeParts",value:function(e,t){var r=this.activePartLists[t];r&&(this.activePartLists[t]=r.filter((function(t){return t.fragment.sn>=e})))}},{key:"fragBuffered",value:function(e,t){var r=_i(e),n=this.fragments[r];!n&&t&&(n=this.fragments[r]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)}},{key:"getBufferedTimes",value:function(e,t,r,n){for(var o={time:[],partial:r},l=e.start,c=e.end,h=e.minEndPTS||c,d=e.maxStartPTS||l,i=0;i<n.length;i++){var f=n.start(i)-this.bufferPadding,v=n.end(i)+this.bufferPadding;if(d>=f&&h<=v){o.time.push({startPTS:Math.max(l,n.start(i)),endPTS:Math.min(c,n.end(i))});break}if(l<v&&c>f){var m=Math.max(l,n.start(i)),y=Math.min(c,n.end(i));y>m&&(o.partial=!0,o.time.push({startPTS:m,endPTS:y}))}else if(c<=f)break}return o}},{key:"getPartialFragment",value:function(time){var e,t,r,n=null,o=0,l=this.bufferPadding,c=this.fragments;return Object.keys(c).forEach((function(h){var d=c[h];d&&Ci(d)&&(t=d.body.start-l,r=d.body.end+l,time>=t&&time<=r&&(e=Math.min(time-t,r-time),o<=e&&(n=d.body,o=e)))})),n}},{key:"isEndListAppended",value:function(e){var t=this.endListFragments[e];return void 0!==t&&(t.buffered||Ci(t))}},{key:"getState",value:function(e){var t=_i(e),r=this.fragments[t];return r?r.buffered?Ci(r)?Di:wi:bi:Ri}},{key:"isTimeBuffered",value:function(e,t,r){for(var n,o,i=0;i<r.length;i++){if(n=r.start(i)-this.bufferPadding,o=r.end(i)+this.bufferPadding,e>=n&&t<=o)return!0;if(t<=n)return!1}return!1}},{key:"onFragLoaded",value:function(e,data){var t=data.frag,r=data.part;if("initSegment"!==t.sn&&!t.bitrateTest){var n=r?null:data,o=_i(t);this.fragments[o]={body:t,appendedPTS:null,loaded:n,buffered:!1,range:Object.create(null)}}}},{key:"onBufferAppended",value:function(e,data){var t=this,r=data.frag,n=data.part,o=data.timeRanges;if("initSegment"!==r.sn){var l=r.type;if(n){var c=this.activePartLists[l];c||(this.activePartLists[l]=c=[]),c.push(n)}this.timeRanges=o,Object.keys(o).forEach((function(e){var r=o[e];t.detectEvictedFragments(e,r,l,n)}))}}},{key:"onFragBuffered",value:function(e,data){this.detectPartialFragments(data)}},{key:"hasFragment",value:function(e){var t=_i(e);return!!this.fragments[t]}},{key:"hasParts",value:function(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}},{key:"removeFragmentsInRange",value:function(e,t,r,n,o){var l=this;n&&!this.hasGaps||Object.keys(this.fragments).forEach((function(c){var h=l.fragments[c];if(h){var d=h.body;d.type!==r||n&&!d.gap||d.start<t&&d.end>e&&(h.buffered||o)&&l.removeFragment(d)}}))}},{key:"removeFragment",value:function(e){var t=_i(e);e.stats.loaded=0,e.clearElementaryStreamInfo();var r=this.activePartLists[e.type];if(r){var n=e.sn;this.activePartLists[e.type]=r.filter((function(e){return e.fragment.sn!==n}))}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}},{key:"removeAllFragments",value:function(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}]),e}();function Ci(e){var t,r,n;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(r=e.range.audio)?void 0:r.partial)||(null==(n=e.range.audiovideo)?void 0:n.partial))}function _i(e){return"".concat(e.type,"_").concat(e.level,"_").concat(e.sn)}var xi={length:0,start:function(){return 0},end:function(){return 0}},Pi=function(){function e(){D(this,e)}return I(e,null,[{key:"isBuffered",value:function(t,r){try{if(t)for(var n=e.getBuffered(t),i=0;i<n.length;i++)if(r>=n.start(i)&&r<=n.end(i))return!0}catch(e){}return!1}},{key:"bufferInfo",value:function(t,r,n){try{if(t){var i,o=e.getBuffered(t),l=[];for(i=0;i<o.length;i++)l.push({start:o.start(i),end:o.end(i)});return this.bufferedInfo(l,r,n)}}catch(e){}return{len:0,start:r,end:r,nextStart:void 0}}},{key:"bufferedInfo",value:function(e,t,r){t=Math.max(0,t),e.sort((function(a,b){var e=a.start-b.start;return e||b.end-a.end}));var n=[];if(r)for(var i=0;i<e.length;i++){var o=n.length;if(o){var l=n[o-1].end;e[i].start-l<r?e[i].end>l&&(n[o-1].end=e[i].end):n.push(e[i])}else n.push(e[i])}else n=e;for(var c,h=0,d=t,f=t,v=0;v<n.length;v++){var m=n[v].start,y=n[v].end;if(t+r>=m&&t<y)d=m,h=(f=y)-t;else if(t+r<m){c=m;break}}return{len:h,start:d||0,end:f||0,nextStart:c}}},{key:"getBuffered",value:function(e){try{return e.buffered}catch(e){return $.log("failed to get media.buffered",e),xi}}}]),e}(),Fi=I((function e(t,r,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,c=arguments.length>5&&void 0!==arguments[5]&&arguments[5];D(this,e),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=t,this.sn=r,this.id=n,this.size=o,this.part=l,this.partial=c}));function Mi(e,t){for(var i=0,r=e.length;i<r;i++){var n;if((null==(n=e[i])?void 0:n.cc)===t)return e[i]}return null}function Oi(e,t){if(e){var r=e.start+t;e.start=e.startPTS=r,e.endPTS=r+e.duration}}function Ni(e,details){for(var t=details.fragments,i=0,r=t.length;i<r;i++)Oi(t[i],e);details.fragmentHint&&Oi(details.fragmentHint,e),details.alignedSliding=!0}function Ui(e,t,details){t&&(!function(e,details,t){if(function(e,t,details){return!(!t||!(details.endCC>details.startCC||e&&e.cc<details.startCC))}(e,t,details)){var r=function(e,t){var r=e.fragments,n=t.fragments;if(n.length&&r.length){var o=Mi(r,n[0].cc);if(o&&(!o||o.startPTS))return o;$.log("No frag in previous level to align on")}else $.log("No fragments to align")}(t,details);r&&G(r.start)&&($.log("Adjusting PTS using last level due to CC increase within current level ".concat(details.url)),Ni(r.start,details))}}(e,details,t),!details.alignedSliding&&t&&Bi(details,t),details.alignedSliding||!t||details.skippedSegments||Kr(t,details))}function Bi(details,e){if(details.hasProgramDateTime&&e.hasProgramDateTime){var t=details.fragments,r=e.fragments;if(t.length&&r.length){var n,o,l=Math.min(e.endCC,details.endCC);e.startCC<l&&details.startCC<l&&(n=Mi(r,l),o=Mi(t,l)),n&&o||(o=Mi(t,(n=r[Math.floor(r.length/2)]).cc)||t[Math.floor(t.length/2)]);var c=n.programDateTime,h=o.programDateTime;if(c&&h)Ni((h-c)/1e3-(o.start-n.start),details)}}}var Gi=Math.pow(2,17),Ki=function(){function e(t){D(this,e),this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}return I(e,[{key:"destroy",value:function(){this.loader&&(this.loader.destroy(),this.loader=null)}},{key:"abort",value:function(){this.loader&&this.loader.abort()}},{key:"load",value:function(e,t){var r=this,n=e.url;if(!n)return Promise.reject(new Yi({type:Y.NETWORK_ERROR,details:j.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a ".concat(n?"part list":"url")),networkDetails:null}));this.abort();var o=this.config,l=o.fLoader,c=o.loader;return new Promise((function(h,d){if(r.loader&&r.loader.destroy(),e.gap){if(e.tagList.some((function(e){return"GAP"===e[0]})))return void d(Vi(e));e.gap=!1}var f=r.loader=e.loader=l?new l(o):new c(o),v=Hi(e),m=zr(o.fragLoadPolicy.default),y={loadPolicy:m,timeout:m.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:Gi};e.stats=f.stats,f.load(v,y,{onSuccess:function(t,n,o,l){r.resetLoader(e,f);var c=t.data;o.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(c.slice(0,16)),c=c.slice(16)),h({frag:e,part:null,payload:c,networkDetails:l})},onError:function(t,o,l,c){r.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:O({url:n,data:void 0},t),error:new Error("HTTP Error ".concat(t.code," ").concat(t.text)),networkDetails:l,stats:c}))},onAbort:function(t,n,o){r.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:o,stats:t}))},onTimeout:function(t,n,o){r.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error("Timeout after ".concat(y.timeout,"ms")),networkDetails:o,stats:t}))},onProgress:function(r,n,data,o){t&&t({frag:e,part:null,payload:data,networkDetails:o})}})}))}},{key:"loadPart",value:function(e,t,r){var n=this;this.abort();var o=this.config,l=o.fLoader,c=o.loader;return new Promise((function(h,d){if(n.loader&&n.loader.destroy(),e.gap||t.gap)d(Vi(e,t));else{var f=n.loader=e.loader=l?new l(o):new c(o),v=Hi(e,t),m=zr(o.fragLoadPolicy.default),y={loadPolicy:m,timeout:m.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Gi};t.stats=f.stats,f.load(v,y,{onSuccess:function(o,l,c,d){n.resetLoader(e,f),n.updateStatsFromPart(e,t);var v={frag:e,part:t,payload:o.data,networkDetails:d};r(v),h(v)},onError:function(r,o,l,c){n.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:O({url:v.url,data:void 0},r),error:new Error("HTTP Error ".concat(r.code," ").concat(r.text)),networkDetails:l,stats:c}))},onAbort:function(r,o,l){e.stats.aborted=t.stats.aborted,n.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:l,stats:r}))},onTimeout:function(r,o,l){n.resetLoader(e,f),d(new Yi({type:Y.NETWORK_ERROR,details:j.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error("Timeout after ".concat(y.timeout,"ms")),networkDetails:l,stats:r}))}})}}))}},{key:"updateStatsFromPart",value:function(e,t){var r=e.stats,n=t.stats,o=n.total;if(r.loaded+=n.loaded,o){var l=Math.round(e.duration/t.duration),c=Math.min(Math.round(r.loaded/o),l),h=(l-c)*Math.round(r.loaded/c);r.total=r.loaded+h}else r.total=Math.max(r.loaded,r.total);var d=r.loading,f=n.loading;d.start?d.first+=f.first-f.start:(d.start=f.start,d.first=f.first),d.end=f.end}},{key:"resetLoader",value:function(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}]),e}();function Hi(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=t||e,n={frag:e,part:t,responseType:"arraybuffer",url:r.url,headers:{},rangeStart:0,rangeEnd:0},o=r.byteRangeStartOffset,l=r.byteRangeEndOffset;if(G(o)&&G(l)){var c,h=o,d=l;if("initSegment"===e.sn&&"AES-128"===(null==(c=e.decryptdata)?void 0:c.method)){var f=l-o;f%16&&(d=l+(16-f%16)),0!==o&&(n.resetIV=!0,h=o-16)}n.rangeStart=h,n.rangeEnd=d}return n}function Vi(e,t){var r=new Error("GAP ".concat(e.gap?"tag":"attribute"," found")),n={type:Y.MEDIA_ERROR,details:j.FRAG_GAP,fatal:!1,frag:e,error:r,networkDetails:null};return t&&(n.part=t),(t||e).stats.aborted=!0,new Yi(n)}var Yi=function(e){y(r,e);var t=E(r);function r(data){var e;return D(this,r),(e=t.call(this,data.error.message)).data=void 0,e.data=data,e}return I(r)}(v(Error)),ji=function(){function e(t,r){D(this,e),this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=r}return I(e,[{key:"decrypt",value:function(data,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,data)}}]),e}(),Wi=function(){function e(t,r){D(this,e),this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=r}return I(e,[{key:"expandKey",value:function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}]),e}();var qi=function(){function e(){D(this,e),this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}return I(e,[{key:"uint8ArrayToUint32Array_",value:function(e){for(var view=new DataView(e),t=new Uint32Array(4),i=0;i<4;i++)t[i]=view.getUint32(4*i);return t}},{key:"initTable",value:function(){var e=this.sBox,t=this.invSBox,r=this.subMix,n=r[0],o=r[1],l=r[2],c=r[3],h=this.invSubMix,d=h[0],f=h[1],v=h[2],m=h[3],y=new Uint32Array(256),k=0,E=0,i=0;for(i=0;i<256;i++)y[i]=i<128?i<<1:i<<1^283;for(i=0;i<256;i++){var T=E^E<<1^E<<2^E<<3^E<<4;T=T>>>8^255&T^99,e[k]=T,t[T]=k;var S=y[k],L=y[S],A=y[L],R=257*y[T]^16843008*T;n[k]=R<<24|R>>>8,o[k]=R<<16|R>>>16,l[k]=R<<8|R>>>24,c[k]=R,R=16843009*A^65537*L^257*S^16843008*k,d[T]=R<<24|R>>>8,f[T]=R<<16|R>>>16,v[T]=R<<8|R>>>24,m[T]=R,k?(k=S^y[y[y[A^S]]],E^=y[y[E]]):k=E=1}}},{key:"expandKey",value:function(e){for(var t=this.uint8ArrayToUint32Array_(e),r=!0,n=0;n<t.length&&r;)r=t[n]===this.key[n],n++;if(!r){this.key=t;var o=this.keySize=t.length;if(4!==o&&6!==o&&8!==o)throw new Error("Invalid aes key size="+o);var l,c,h,d,f=this.ksRows=4*(o+6+1),v=this.keySchedule=new Uint32Array(f),m=this.invKeySchedule=new Uint32Array(f),y=this.sBox,k=this.rcon,E=this.invSubMix,T=E[0],S=E[1],L=E[2],A=E[3];for(l=0;l<f;l++)l<o?h=v[l]=t[l]:(d=h,l%o==0?(d=y[(d=d<<8|d>>>24)>>>24]<<24|y[d>>>16&255]<<16|y[d>>>8&255]<<8|y[255&d],d^=k[l/o|0]<<24):o>6&&l%o==4&&(d=y[d>>>24]<<24|y[d>>>16&255]<<16|y[d>>>8&255]<<8|y[255&d]),v[l]=h=(v[l-o]^d)>>>0);for(c=0;c<f;c++)l=f-c,d=3&c?v[l]:v[l-4],m[c]=c<4||l<=4?d:T[y[d>>>24]]^S[y[d>>>16&255]]^L[y[d>>>8&255]]^A[y[255&d]],m[c]=m[c]>>>0}}},{key:"networkToHostOrderSwap",value:function(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}},{key:"decrypt",value:function(e,t,r){for(var n,o,l,c,h,d,f,v,m,y,k,E,T,i,S=this.keySize+6,L=this.invKeySchedule,A=this.invSBox,R=this.invSubMix,D=R[0],w=R[1],I=R[2],C=R[3],_=this.uint8ArrayToUint32Array_(r),x=_[0],P=_[1],F=_[2],M=_[3],O=new Int32Array(e),N=new Int32Array(O.length),U=this.networkToHostOrderSwap;t<O.length;){for(m=U(O[t]),y=U(O[t+1]),k=U(O[t+2]),E=U(O[t+3]),h=m^L[0],d=E^L[1],f=k^L[2],v=y^L[3],T=4,i=1;i<S;i++)n=D[h>>>24]^w[d>>16&255]^I[f>>8&255]^C[255&v]^L[T],o=D[d>>>24]^w[f>>16&255]^I[v>>8&255]^C[255&h]^L[T+1],l=D[f>>>24]^w[v>>16&255]^I[h>>8&255]^C[255&d]^L[T+2],c=D[v>>>24]^w[h>>16&255]^I[d>>8&255]^C[255&f]^L[T+3],h=n,d=o,f=l,v=c,T+=4;n=A[h>>>24]<<24^A[d>>16&255]<<16^A[f>>8&255]<<8^A[255&v]^L[T],o=A[d>>>24]<<24^A[f>>16&255]<<16^A[v>>8&255]<<8^A[255&h]^L[T+1],l=A[f>>>24]<<24^A[v>>16&255]<<16^A[h>>8&255]<<8^A[255&d]^L[T+2],c=A[v>>>24]<<24^A[h>>16&255]<<16^A[d>>8&255]<<8^A[255&f]^L[T+3],N[t]=U(n^x),N[t+1]=U(c^P),N[t+2]=U(l^F),N[t+3]=U(o^M),x=m,P=y,F=k,M=E,t+=4}return N.buffer}}]),e}(),Xi=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.removePKCS7Padding,o=void 0===n||n;if(D(this,e),this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=o,o)try{var l=self.crypto;l&&(this.subtle=l.subtle||l.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}return I(e,[{key:"destroy",value:function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}},{key:"isSync",value:function(){return this.useSoftware}},{key:"flush",value:function(){var e=this.currentResult,t=this.remainderData;if(!e||t)return this.reset(),null;var r,n,o,data=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?(n=(r=data).byteLength,(o=n&&new DataView(r.buffer).getUint8(n-1))?_e(r,0,n-o):r):data}},{key:"reset",value:function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}},{key:"decrypt",value:function(data,e,t){var r=this;return this.useSoftware?new Promise((function(n,o){r.softwareDecrypt(new Uint8Array(data),e,t);var l=r.flush();l?n(l.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(data),e,t)}},{key:"softwareDecrypt",value:function(data,e,t){var r=this.currentIV,n=this.currentResult,o=this.remainderData;this.logOnce("JS AES decrypt"),o&&(data=mt(o,data),this.remainderData=null);var l=this.getValidChunk(data);if(!l.length)return null;r&&(t=r);var c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new qi),c.expandKey(e);var h=n;return this.currentResult=c.decrypt(l.buffer,0,t),this.currentIV=_e(l,-16).buffer,h||null}},{key:"webCryptoDecrypt",value:function(data,e,t){var r=this;if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(data,e,t));this.key=e,this.fastAesKey=new Wi(this.subtle,e)}return this.fastAesKey.expandKey().then((function(e){return r.subtle?(r.logOnce("WebCrypto AES decrypt"),new ji(r.subtle,new Uint8Array(t)).decrypt(data.buffer,e)):Promise.reject(new Error("web crypto not initialized"))})).catch((function(n){return $.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, ".concat(n.name,": ").concat(n.message)),r.onWebCryptoError(data,e,t)}))}},{key:"onWebCryptoError",value:function(data,e,t){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(data,e,t);var r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}},{key:"getValidChunk",value:function(data){var e=data,t=data.length-data.length%16;return t!==data.length&&(e=_e(data,0,t),this.remainderData=_e(data,t)),e}},{key:"logOnce",value:function(e){this.logEnabled&&($.log("[decrypter]: ".concat(e)),this.logEnabled=!1)}}]),e}(),zi=function(e){for(var t="",r=e.length,i=0;i<r;i++)t+="[".concat(e.start(i).toFixed(3),"-").concat(e.end(i).toFixed(3),"]");return t},Qi="STOPPED",Ji="IDLE",$i="KEY_LOADING",Zi="FRAG_LOADING",ea="FRAG_LOADING_WAITING_RETRY",ta="WAITING_TRACK",ra="PARSING",ia="PARSED",aa="ENDED",na="ERROR",sa="WAITING_INIT_PTS",oa="WAITING_LEVEL",la=function(e){y(r,e);var t=E(r);function r(e,n,o,l,c){var h;return D(this,r),(h=t.call(this)).hls=void 0,h.fragPrevious=null,h.fragCurrent=null,h.fragmentTracker=void 0,h.transmuxer=null,h._state=Qi,h.playlistType=void 0,h.media=null,h.mediaBuffer=null,h.config=void 0,h.bitrateTest=!1,h.lastCurrentTime=0,h.nextLoadPosition=0,h.startPosition=0,h.startTimeOffset=null,h.loadedmetadata=!1,h.retryDate=0,h.levels=null,h.fragmentLoader=void 0,h.keyLoader=void 0,h.levelLastLoaded=null,h.startFragRequested=!1,h.decrypter=void 0,h.initPTS=[],h.onvseeking=null,h.onvended=null,h.logPrefix="",h.log=void 0,h.warn=void 0,h.playlistType=c,h.logPrefix=l,h.log=$.log.bind($,"".concat(l,":")),h.warn=$.warn.bind($,"".concat(l,":")),h.hls=e,h.fragmentLoader=new Ki(e.config),h.keyLoader=o,h.fragmentTracker=n,h.config=e.config,h.decrypter=new Xi(e.config),e.on(V.MANIFEST_LOADED,h.onManifestLoaded,S(h)),h}return I(r,[{key:"doTick",value:function(){this.onTickEnd()}},{key:"onTickEnd",value:function(){}},{key:"startLoad",value:function(e){}},{key:"stopLoad",value:function(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);var e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=Qi}},{key:"_streamEnded",value:function(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;var r=t.partList;if(null!=r&&r.length){var n=r[r.length-1];return Pi.isBuffered(this.media,n.start+n.duration/2)}var o=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(o)}},{key:"getLevelDetails",value:function(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}},{key:"onMediaAttached",value:function(e,data){var t=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),t.addEventListener("seeking",this.onvseeking),t.addEventListener("ended",this.onvended);var r=this.config;this.levels&&r.autoStartLoad&&this.state===Qi&&this.startLoad(r.startPosition)}},{key:"onMediaDetaching",value:function(){var e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}},{key:"onMediaSeeking",value:function(){var e=this.config,t=this.fragCurrent,r=this.media,n=this.mediaBuffer,o=this.state,l=r?r.currentTime:0,c=Pi.bufferInfo(n||r,l,e.maxBufferHole);if(this.log("media seeking to ".concat(G(l)?l.toFixed(3):l,", state: ").concat(o)),this.state===aa)this.resetLoadingState();else if(t){var h=e.maxFragLookUpTolerance,d=t.start-h,f=t.start+t.duration+h;if(!c.len||f<c.start||d>c.end){var v=l>f;(l<d||v)&&(v&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}r&&(this.fragmentTracker.removeFragmentsInRange(l,1/0,this.playlistType,!0),this.lastCurrentTime=l),this.loadedmetadata||c.len||(this.nextLoadPosition=this.startPosition=l),this.tickImmediate()}},{key:"onMediaEnded",value:function(){this.startPosition=this.lastCurrentTime=0}},{key:"onManifestLoaded",value:function(e,data){this.startTimeOffset=data.startTimeOffset,this.initPTS=[]}},{key:"onHandlerDestroying",value:function(){this.hls.off(V.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),d(A(r.prototype),"onHandlerDestroying",this).call(this),this.hls=null}},{key:"onHandlerDestroyed",value:function(){this.state=Qi,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,d(A(r.prototype),"onHandlerDestroyed",this).call(this)}},{key:"loadFragment",value:function(e,t,r){this._loadFragForPlayback(e,t,r)}},{key:"_loadFragForPlayback",value:function(e,t,r){var n=this;this._doFragLoad(e,t,r,(function(data){if(n.fragContextChanged(e))return n.warn("Fragment ".concat(e.sn).concat(data.part?" p: "+data.part.index:""," of level ").concat(e.level," was dropped during download.")),void n.fragmentTracker.removeFragment(e);e.stats.chunkCount++,n._handleFragmentLoadProgress(data)})).then((function(data){if(data){var t=n.state;n.fragContextChanged(e)?(t===Zi||!n.fragCurrent&&t===ra)&&(n.fragmentTracker.removeFragment(e),n.state=Ji):("payload"in data&&(n.log("Loaded fragment ".concat(e.sn," of level ").concat(e.level)),n.hls.trigger(V.FRAG_LOADED,data)),n._handleFragmentLoadComplete(data))}})).catch((function(t){n.state!==Qi&&n.state!==na&&(n.warn("Frag error: ".concat((null==t?void 0:t.message)||t)),n.resetFragmentLoading(e))}))}},{key:"clearTrackerIfNeeded",value:function(e){var t,r=this.fragmentTracker;if(r.getState(e)===bi){var n=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,n),l=Math.max(e.duration,o?o.len:this.config.maxBufferLength),c=this.backtrackFragment;(1===(c?e.sn-c.sn:0)||this.reduceMaxBufferLength(l,e.duration))&&r.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?r.removeAllFragments():r.hasParts(e.type)&&(r.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),r.getState(e)===Di&&r.removeFragment(e))}},{key:"checkLiveUpdate",value:function(details){if(details.updated&&!details.live){var e=details.fragments[details.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}details.fragments[0]||(details.deltaUpdateFailed=!0)}},{key:"flushMainBuffer",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(e-t){var n={startOffset:e,endOffset:t,type:r};this.hls.trigger(V.BUFFER_FLUSHING,n)}}},{key:"_loadInitSegment",value:function(e,t){var r=this;this._doFragLoad(e,t).then((function(data){if(!data||r.fragContextChanged(e)||!r.levels)throw new Error("init load aborted");return data})).then((function(data){var t=r.hls,n=data.payload,o=e.decryptdata;if(n&&n.byteLength>0&&null!=o&&o.key&&o.iv&&"AES-128"===o.method){var l=self.performance.now();return r.decrypter.decrypt(new Uint8Array(n),o.key.buffer,o.iv.buffer).catch((function(r){throw t.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_DECRYPT_ERROR,fatal:!1,error:r,reason:r.message,frag:e}),r})).then((function(n){var o=self.performance.now();return t.trigger(V.FRAG_DECRYPTED,{frag:e,payload:n,stats:{tstart:l,tdecrypt:o}}),data.payload=n,r.completeInitSegmentLoad(data)}))}return r.completeInitSegmentLoad(data)})).catch((function(t){r.state!==Qi&&r.state!==na&&(r.warn(t),r.resetFragmentLoading(e))}))}},{key:"completeInitSegmentLoad",value:function(data){if(!this.levels)throw new Error("init load aborted, missing levels");var e=data.frag.stats;this.state=Ji,data.frag.data=new Uint8Array(data.payload),e.parsing.start=e.buffering.start=self.performance.now(),e.parsing.end=e.buffering.end=self.performance.now(),this.tick()}},{key:"fragContextChanged",value:function(e){var t=this.fragCurrent;return!e||!t||e.sn!==t.sn||e.level!==t.level}},{key:"fragBufferedComplete",value:function(e,t){var r,n,o,l,c=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log("Buffered ".concat(e.type," sn: ").concat(e.sn).concat(t?" part: "+t.index:""," of ").concat(this.playlistType===or?"level":"track"," ").concat(e.level," (frag:[").concat((null!=(r=e.startPTS)?r:NaN).toFixed(3),"-").concat((null!=(n=e.endPTS)?n:NaN).toFixed(3),"] > buffer:").concat(c?zi(Pi.getBuffered(c)):"(detached)",")")),"initSegment"!==e.sn){var h;if(e.type!==ur){var d=e.elementaryStreams;if(!Object.keys(d).some((function(e){return!!d[e]})))return void(this.state=Ji)}var f=null==(h=this.levels)?void 0:h[e.level];null!=f&&f.fragmentError&&(this.log("Resetting level fragment error count of ".concat(f.fragmentError," on frag buffered")),f.fragmentError=0)}this.state=Ji,c&&(!this.loadedmetadata&&e.type==or&&c.buffered.length&&(null==(o=this.fragCurrent)?void 0:o.sn)===(null==(l=this.fragPrevious)?void 0:l.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}},{key:"seekToStartPos",value:function(){}},{key:"_handleFragmentLoadComplete",value:function(e){var t=this.transmuxer;if(t){var r=e.frag,n=e.part,o=e.partsLoaded,l=!o||0===o.length||o.some((function(e){return!e})),c=new Fi(r.level,r.sn,r.stats.chunkCount+1,0,n?n.index:-1,!l);t.flush(c)}}},{key:"_handleFragmentLoadProgress",value:function(e){}},{key:"_doFragLoad",value:function(e,t){var r,n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3?arguments[3]:void 0,details=null==t?void 0:t.details;if(!this.levels||!details)throw new Error("frag load aborted, missing level".concat(details?"":" detail","s"));var h=null;if(!e.encrypted||null!=(r=e.decryptdata)&&r.key?!e.encrypted&&details.encryptedFragments.length&&this.keyLoader.loadClear(e,details.encryptedFragments):(this.log("Loading key for ".concat(e.sn," of [").concat(details.startSN,"-").concat(details.endSN,"], ").concat("[stream-controller]"===this.logPrefix?"level":"track"," ").concat(e.level)),this.state=$i,this.fragCurrent=e,h=this.keyLoader.load(e).then((function(e){if(!n.fragContextChanged(e.frag))return n.hls.trigger(V.KEY_LOADED,e),n.state===$i&&(n.state=Ji),e})),this.hls.trigger(V.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(h=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),o=Math.max(e.start,o||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){var d=details.partList;if(d&&c){o>e.end&&details.fragmentHint&&(e=details.fragmentHint);var f=this.getNextPart(d,e,o);if(f>-1){var v,m=d[f];return this.log("Loading part sn: ".concat(e.sn," p: ").concat(m.index," cc: ").concat(e.cc," of playlist [").concat(details.startSN,"-").concat(details.endSN,"] parts [0-").concat(f,"-").concat(d.length-1,"] ").concat("[stream-controller]"===this.logPrefix?"level":"track",": ").concat(e.level,", target: ").concat(parseFloat(o.toFixed(3)))),this.nextLoadPosition=m.start+m.duration,this.state=Zi,v=h?h.then((function(r){return!r||n.fragContextChanged(r.frag)?null:n.doFragPartsLoad(e,m,t,c)})).catch((function(e){return n.handleFragLoadError(e)})):this.doFragPartsLoad(e,m,t,c).catch((function(e){return n.handleFragLoadError(e)})),this.hls.trigger(V.FRAG_LOADING,{frag:e,part:m,targetBufferTime:o}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):v}if(!e.url||this.loadedEndOfParts(d,o))return Promise.resolve(null)}}this.log("Loading fragment ".concat(e.sn," cc: ").concat(e.cc," ").concat(details?"of ["+details.startSN+"-"+details.endSN+"] ":"").concat("[stream-controller]"===this.logPrefix?"level":"track",": ").concat(e.level,", target: ").concat(parseFloat(o.toFixed(3)))),G(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Zi;var y,k=this.config.progressive;return y=k&&h?h.then((function(t){return!t||n.fragContextChanged(null==t?void 0:t.frag)?null:n.fragmentLoader.load(e,c)})).catch((function(e){return n.handleFragLoadError(e)})):Promise.all([this.fragmentLoader.load(e,k?c:void 0),h]).then((function(e){var t=l(e,1)[0];return!k&&t&&c&&c(t),t})).catch((function(e){return n.handleFragLoadError(e)})),this.hls.trigger(V.FRAG_LOADING,{frag:e,targetBufferTime:o}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):y}},{key:"doFragPartsLoad",value:function(e,t,r,n){var o=this;return new Promise((function(l,c){var h,d=[],f=null==(h=r.details)?void 0:h.partList;!function t(h){o.fragmentLoader.loadPart(e,h,n).then((function(n){d[h.index]=n;var c=n.part;o.hls.trigger(V.FRAG_LOADED,n);var v=Vr(r,e.sn,h.index+1)||Yr(f,e.sn,h.index+1);if(!v)return l({frag:e,part:c,partsLoaded:d});t(v)})).catch(c)}(t)}))}},{key:"handleFragLoadError",value:function(e){if("data"in e){var data=e.data;e.data&&data.details===j.INTERNAL_ABORTED?this.handleFragLoadAborted(data.frag,data.part):this.hls.trigger(V.ERROR,data)}else this.hls.trigger(V.ERROR,{type:Y.OTHER_ERROR,details:j.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}},{key:"_handleTransmuxerFlush",value:function(e){var t=this.getCurrentContext(e);if(t&&this.state===ra){var r=t.frag,n=t.part,o=t.level,l=self.performance.now();r.stats.parsing.end=l,n&&(n.stats.parsing.end=l),this.updateLevelTiming(r,n,o,e.partial)}else this.fragCurrent||this.state===Qi||this.state===na||(this.state=Ji)}},{key:"getCurrentContext",value:function(e){var t=this.levels,r=this.fragCurrent,n=e.level,o=e.sn,l=e.part;if(null==t||!t[n])return this.warn("Levels object was unset while buffering fragment ".concat(o," of level ").concat(n,". The current chunk will not be buffered.")),null;var c=t[n],h=l>-1?Vr(c,o,l):null,d=h?h.fragment:function(e,t,r){if(null==e||!e.details)return null;var n=e.details,o=n.fragments[t-n.startSN];return o||((o=n.fragmentHint)&&o.sn===t?o:t<n.startSN&&r&&r.sn===t?r:null)}(c,o,r);return d?(r&&r!==d&&(d.stats=r.stats),{frag:d,part:h,level:c}):null}},{key:"bufferFragmentData",value:function(data,e,t,r,n){var o;if(data&&this.state===ra){var l=data.data1,c=data.data2,h=l;if(l&&c&&(h=mt(l,c)),null!=(o=h)&&o.length){var d={type:data.type,frag:e,part:t,chunkMeta:r,parent:e.type,data:h};if(this.hls.trigger(V.BUFFER_APPENDING,d),data.dropped&&data.independent&&!t){if(n)return;this.flushBufferGap(e)}}}}},{key:"flushBufferGap",value:function(e){var t=this.media;if(t)if(Pi.isBuffered(t,t.currentTime)){var r=t.currentTime,n=Pi.bufferInfo(t,r,0),o=e.duration,l=Math.min(2*this.config.maxFragLookUpTolerance,.25*o),c=Math.max(Math.min(e.start-l,n.end-l),r+l);e.start-c>l&&this.flushMainBuffer(c,e.start)}else this.flushMainBuffer(0,e.start)}},{key:"getFwdBufferInfo",value:function(e,t){var r=this.getLoadPosition();return G(r)?this.getFwdBufferInfoAtPos(e,r,t):null}},{key:"getFwdBufferInfoAtPos",value:function(e,t,r){var n=this.config.maxBufferHole,o=Pi.bufferInfo(e,t,n);if(0===o.len&&void 0!==o.nextStart){var l=this.fragmentTracker.getBufferedFrag(t,r);if(l&&o.nextStart<l.end)return Pi.bufferInfo(e,t,Math.max(o.nextStart,n))}return o}},{key:"getMaxBufferLength",value:function(e){var t,r=this.config;return t=e?Math.max(8*r.maxBufferSize/e,r.maxBufferLength):r.maxBufferLength,Math.min(t,r.maxMaxBufferLength)}},{key:"reduceMaxBufferLength",value:function(e,t){var r=this.config,n=Math.max(Math.min(e-t,r.maxBufferLength),t),o=Math.max(e-3*t,r.maxMaxBufferLength/2,n);return o>=n&&(r.maxMaxBufferLength=o,this.warn("Reduce max buffer length to ".concat(o,"s")),!0)}},{key:"getAppendedFrag",value:function(e){var t=this.fragmentTracker.getAppendedFrag(e,or);return t&&"fragment"in t?t.fragment:t}},{key:"getNextFragment",value:function(e,t){var r=t.fragments,n=r.length;if(!n)return null;var o,l=this.config,c=r[0].start;if(t.live){var h=l.initialLiveManifestSize;if(n<h)return this.warn("Not enough fragments to start playback (have: ".concat(n,", need: ").concat(h,")")),null;(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<c)&&(o=this.getInitialLiveFragment(t,r),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=c&&(o=r[0]);if(!o){var d=l.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,d,t)}return this.mapToInitFragWhenRequired(o)}},{key:"isLoopLoading",value:function(e,t){var r=this.fragmentTracker.getState(e);return(r===wi||r===Di&&!!e.gap)&&this.nextLoadPosition>t}},{key:"getNextFragmentLoopLoading",value:function(e,t,r,n,o){var l=e.gap,c=this.getNextFragment(this.nextLoadPosition,t);if(null===c)return c;if(e=c,l&&e&&!e.gap&&r.nextStart){var h=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,r.nextStart,n);if(null!==h&&r.len+h.len>=o)return this.log('buffer full after gaps in "'.concat(n,'" playlist starting at sn: ').concat(e.sn)),null}return e}},{key:"mapToInitFragWhenRequired",value:function(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}},{key:"getNextPart",value:function(e,t,r){for(var n=-1,o=!1,l=!0,i=0,c=e.length;i<c;i++){var h=e[i];if(l=l&&!h.independent,n>-1&&r<h.start)break;var d=h.loaded;d?n=-1:(o||h.independent||l)&&h.fragment===t&&(n=i),o=d}return n}},{key:"loadedEndOfParts",value:function(e,t){var r=e[e.length-1];return r&&t>r.start&&r.loaded}},{key:"getInitialLiveFragment",value:function(e,t){var r=this.fragPrevious,n=null;if(r){if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: ".concat(r.programDateTime)),n=function(e,t,r){if(null===t||!Array.isArray(e)||!e.length||!G(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;r=r||0;for(var n=0;n<e.length;++n){var o=e[n];if(ti(t,r,o))return o}return null}(t,r.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){var o=r.sn+1;if(o>=e.startSN&&o<=e.endSN){var l=t[o-e.startSN];r.cc===l.cc&&(n=l,this.log("Live playlist, switching playlist, load frag with next SN: ".concat(n.sn)))}n||(n=function(e,t){return Jr(e,(function(e){return e.cc<t?1:e.cc>t?-1:0}))}(t,r.cc),n&&this.log("Live playlist, switching playlist, load frag with same CC: ".concat(n.sn)))}}else{var c=this.hls.liveSyncPosition;null!==c&&(n=this.getFragmentAtPosition(c,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}},{key:"getFragmentAtPosition",value:function(e,t,r){var n,o=this.config,l=this.fragPrevious,c=r.fragments,h=r.endSN,d=r.fragmentHint,f=o.maxFragLookUpTolerance,v=r.partList,m=!!(o.lowLatencyMode&&null!=v&&v.length&&d);(m&&d&&!this.bitrateTest&&(c=c.concat(d),h=d.sn),e<t)?n=$r(l,c,e,e>t-f?0:f):n=c[c.length-1];if(n){var y=n.sn-r.startSN,k=this.fragmentTracker.getState(n);if((k===wi||k===Di&&n.gap)&&(l=n),l&&n.sn===l.sn&&(!m||v[0].fragment.sn>n.sn))if(l&&n.level===l.level){var E=c[y+1];n=n.sn<h&&this.fragmentTracker.getState(E)!==wi?E:null}}return n}},{key:"synchronizeToLiveEdge",value:function(e){var t=this.config,r=this.media;if(r){var n=this.hls.liveSyncPosition,o=r.currentTime,l=e.fragments[0].start,c=e.edge,h=o>=l-t.maxFragLookUpTolerance&&o<=c;if(null!==n&&r.duration>n&&(o<n||!h)){var d=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!h&&r.readyState<4||o<c-d)&&(this.loadedmetadata||(this.nextLoadPosition=n),r.readyState&&(this.warn("Playback: ".concat(o.toFixed(3)," is located too far from the end of live sliding playlist: ").concat(c,", reset currentTime to : ").concat(n.toFixed(3))),r.currentTime=n))}}}},{key:"alignPlaylists",value:function(details,e,t){var r=details.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;var n=details.fragments[0].start,o=!e,l=details.alignedSliding&&G(n);if(o||!l&&!n){var c=this.fragPrevious;Ui(c,t,details);var h=details.fragments[0].start;return this.log("Live playlist sliding: ".concat(h.toFixed(2)," start-sn: ").concat(e?e.startSN:"na","->").concat(details.startSN," prev-sn: ").concat(c?c.sn:"na"," fragments: ").concat(r)),h}return n}},{key:"waitForCdnTuneIn",value:function(details){return details.live&&details.canBlockReload&&details.partTarget&&details.tuneInGoal>Math.max(details.partHoldBack,3*details.partTarget)}},{key:"setStartPosition",value:function(details,e){var t=this.startPosition;if(t<e&&(t=-1),-1===t||-1===this.lastCurrentTime){var r=null!==this.startTimeOffset,n=r?this.startTimeOffset:details.startTimeOffset;null!==n&&G(n)?(t=e+n,n<0&&(t+=details.totalduration),t=Math.min(Math.max(e,t),e+details.totalduration),this.log("Start time offset ".concat(n," found in ").concat(r?"multivariant":"media"," playlist, adjust startPosition to ").concat(t)),this.startPosition=t):details.live?t=this.hls.liveSyncPosition||e:this.startPosition=t=0,this.lastCurrentTime=t}this.nextLoadPosition=t}},{key:"getLoadPosition",value:function(){var e=this.media,t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}},{key:"handleFragLoadAborted",value:function(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn("Fragment ".concat(e.sn).concat(t?" part "+t.index:""," of level ").concat(e.level," was aborted")),this.resetFragmentLoading(e))}},{key:"resetFragmentLoading",value:function(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===ea)||(this.state=Ji)}},{key:"onFragmentOrKeyLoadError",value:function(e,data){if(data.chunkMeta&&!data.frag){var t=this.getCurrentContext(data.chunkMeta);t&&(data.frag=t.frag)}var r=data.frag;if(r&&r.type===e&&this.levels)if(this.fragContextChanged(r)){var n;this.warn("Frag load error must match current frag to retry ".concat(r.url," > ").concat(null==(n=this.fragCurrent)?void 0:n.url))}else{var o=data.details===j.FRAG_GAP;o&&this.fragmentTracker.fragBuffered(r,!0);var l=data.errorAction,c=l||{},h=c.action,d=c.retryCount,f=void 0===d?0:d,v=c.retryConfig;if(l&&h===ni&&v){this.resetStartWhenNotLoaded(this.levelLastLoaded);var m=Xr(v,f);this.warn("Fragment ".concat(r.sn," of ").concat(e," ").concat(r.level," errored with ").concat(data.details,", retrying loading ").concat(f+1,"/").concat(v.maxNumRetry," in ").concat(m,"ms")),l.resolved=!0,this.retryDate=self.performance.now()+m,this.state=ea}else if(v&&l){if(this.resetFragmentErrors(e),!(f<v.maxNumRetry))return void $.warn("".concat(data.details," reached or exceeded max retry (").concat(f,")"));o||h===ai||(l.resolved=!0)}else(null==l?void 0:l.action)===ii?this.state=oa:this.state=na;this.tickImmediate()}}},{key:"reduceLengthAndFlushBuffer",value:function(data){if(this.state===ra||this.state===ia){var e=data.frag,t=data.parent,r=this.getFwdBufferInfo(this.mediaBuffer,t),n=r&&r.len>.5;n&&this.reduceMaxBufferLength(r.len,(null==e?void 0:e.duration)||10);var o=!n;return o&&this.warn("Buffer full error while media.currentTime is not buffered, flush ".concat(t," buffer")),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),o}return!1}},{key:"resetFragmentErrors",value:function(e){e===lr&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==Qi&&(this.state=Ji)}},{key:"afterBufferFlushed",value:function(e,t,r){if(e){var n=Pi.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,r),this.state===aa&&this.resetLoadingState()}}},{key:"resetLoadingState",value:function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=Ji}},{key:"resetStartWhenNotLoaded",value:function(e){if(!this.loadedmetadata){this.startFragRequested=!1;var details=e?e.details:null;null!=details&&details.live?(this.startPosition=-1,this.setStartPosition(details,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}},{key:"resetWhenMissingContext",value:function(e){this.warn("The loading context changed while buffering fragment ".concat(e.sn," of level ").concat(e.level,". This chunk will not be buffered.")),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}},{key:"removeUnbufferedFrags",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}},{key:"updateLevelTiming",value:function(e,t,r,n){var o,l=this,details=r.details;if(details){if(!Object.keys(e.elementaryStreams).reduce((function(t,o){var c=e.elementaryStreams[o];if(c){var h=c.endPTS-c.startPTS;if(h<=0)return l.warn("Could not parse fragment ".concat(e.sn," ").concat(o," duration reliably (").concat(h,")")),t||!1;var d=n?0:Br(details,e,c.startPTS,c.endPTS,c.startDTS,c.endDTS);return l.hls.trigger(V.LEVEL_PTS_UPDATED,{details:details,level:r,drift:d,type:o,frag:e,start:c.startPTS,end:c.endPTS}),!0}return t}),!1)&&null===(null==(o=this.transmuxer)?void 0:o.error)){var c=new Error("Found no media in fragment ".concat(e.sn," of level ").concat(e.level," resetting transmuxer to fallback to playlist timing"));if(0===r.fragmentError&&(r.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(c.message),this.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_PARSING_ERROR,fatal:!1,error:c,frag:e,reason:"Found no media in msn ".concat(e.sn,' of level "').concat(r.url,'"')}),!this.hls)return;this.resetTransmuxer()}this.state=ia,this.hls.trigger(V.FRAG_PARSED,{frag:e,part:t})}else this.warn("level.details undefined")}},{key:"resetTransmuxer",value:function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}},{key:"recoverWorkerError",value:function(data){"demuxerWorker"===data.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}},{key:"state",get:function(){return this._state},set:function(e){var t=this._state;t!==e&&(this._state=e,this.log("".concat(t,"->").concat(e)))}}]),r}(Ai),ua=function(){function e(){D(this,e),this.chunks=[],this.dataLength=0}return I(e,[{key:"push",value:function(e){this.chunks.push(e),this.dataLength+=e.length}},{key:"flush",value:function(){var e,t=this.chunks,r=this.dataLength;return t.length?(e=1===t.length?t[0]:function(e,t){for(var r=new Uint8Array(t),n=0,i=0;i<e.length;i++){var o=e[i];r.set(o,n),n+=o.length}return r}(t,r),this.reset(),e):new Uint8Array(0)}},{key:"reset",value:function(){this.chunks.length=0,this.dataLength=0}}]),e}();function ca(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}var ha=function(){function e(){D(this,e),this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}return I(e,[{key:"resetInitSegment",value:function(e,t,r,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}},{key:"resetTimeStamp",value:function(e){this.initPTS=e,this.resetContiguity()}},{key:"resetContiguity",value:function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}},{key:"canParse",value:function(data,e){return!1}},{key:"appendFrame",value:function(track,data,e){}},{key:"demux",value:function(data,e){this.cachedData&&(data=mt(this.cachedData,data),this.cachedData=null);var t,r=Me(data,0),n=r?r.length:0,track=this._audioTrack,o=this._id3Track,l=r?Ue(r):void 0,c=data.length;for((null===this.basePTS||0===this.frameIndex&&G(l))&&(this.basePTS=da(l,e,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:kr,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(data,n)){var h=this.appendFrame(track,data,n);h?(this.frameIndex++,this.lastPTS=h.sample.pts,t=n+=h.length):n=c}else Ne(data,n)?(r=Me(data,n),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:kr,duration:Number.POSITIVE_INFINITY}),t=n+=r.length):n++;if(n===c&&t!==c){var d=_e(data,t);this.cachedData?this.cachedData=mt(this.cachedData,d):this.cachedData=d}}return{audioTrack:track,videoTrack:ca(),id3Track:o,textTrack:ca()}}},{key:"demuxSampleAes",value:function(data,e,t){return Promise.reject(new Error("[".concat(this,"] This demuxer does not support Sample-AES decryption")))}},{key:"flush",value:function(e){var t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:ca(),id3Track:this._id3Track,textTrack:ca()}}},{key:"destroy",value:function(){}}]),e}(),da=function(e,t,r){return G(e)?90*e:9e4*t+(r?9e4*r.baseTime/r.timescale:0)};function fa(data,e){return 255===data[e]&&240==(246&data[e+1])}function va(data,e){return 1&data[e+1]?7:9}function ga(data,e){return(3&data[e+3])<<11|data[e+4]<<3|(224&data[e+5])>>>5}function ma(data,e){return e+1<data.length&&fa(data,e)}function ya(data,e){if(ma(data,e)){var t=va(data,e);if(e+t>=data.length)return!1;var r=ga(data,e);if(r<=t)return!1;var n=e+r;return n===data.length||ma(data,n)}return!1}function pa(track,e,data,t,r){if(!track.samplerate){var n=function(e,data,t,r){var n,o,l,c,h=navigator.userAgent.toLowerCase(),d=r,f=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];n=1+((192&data[t+2])>>>6);var v=(60&data[t+2])>>>2;if(!(v>f.length-1))return l=(1&data[t+2])<<2,l|=(192&data[t+3])>>>6,$.log("manifest codec:".concat(r,", ADTS type:").concat(n,", samplingIndex:").concat(v)),/firefox/i.test(h)?v>=6?(n=5,c=new Array(4),o=v-3):(n=2,c=new Array(2),o=v):-1!==h.indexOf("android")?(n=2,c=new Array(2),o=v):(n=5,c=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&v>=6?o=v-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(v>=6&&1===l||/vivaldi/i.test(h))||!r&&1===l)&&(n=2,c=new Array(2)),o=v)),c[0]=n<<3,c[0]|=(14&v)>>1,c[1]|=(1&v)<<7,c[1]|=l<<3,5===n&&(c[1]|=(14&o)>>1,c[2]=(1&o)<<7,c[2]|=8,c[3]=0),{config:c,samplerate:f[v],channelCount:l,codec:"mp4a.40."+n,manifestCodec:d};var m=new Error("invalid ADTS sampling index:".concat(v));e.emit(V.ERROR,V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_PARSING_ERROR,fatal:!0,error:m,reason:m.message})}(e,data,t,r);if(!n)return;track.config=n.config,track.samplerate=n.samplerate,track.channelCount=n.channelCount,track.codec=n.codec,track.manifestCodec=n.manifestCodec,$.log("parsed codec:".concat(track.codec,", rate:").concat(n.samplerate,", channels:").concat(n.channelCount))}}function ka(e){return 9216e4/e}function Ea(track,data,e,t,r){var n,o=t+r*ka(track.samplerate),header=function(data,e){var t=va(data,e);if(e+t<=data.length){var r=ga(data,e)-t;if(r>0)return{headerLength:t,frameLength:r}}}(data,e);if(header){var l=header.frameLength,c=header.headerLength,h=c+l,d=Math.max(0,e+h-data.length);d?(n=new Uint8Array(h-c)).set(data.subarray(e+c,data.length),0):n=data.subarray(e+c,e+h);var f={unit:n,pts:o};return d||track.samples.push(f),{sample:f,length:h,missing:d}}var v=data.length-e;return(n=new Uint8Array(v)).set(data.subarray(e,data.length),0),{sample:{unit:n,pts:o},length:v,missing:-1}}var Ta=null,Sa=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],La=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Aa=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Ra=[0,1,1,4];function ba(track,data,e,t,r){if(!(e+24>data.length)){var header=Da(data,e);if(header&&e+header.frameLength<=data.length){var n=t+r*(9e4*header.samplesPerFrame/header.sampleRate),o={unit:data.subarray(e,e+header.frameLength),pts:n,dts:n};return track.config=[],track.channelCount=header.channelCount,track.samplerate=header.sampleRate,track.samples.push(o),{sample:o,length:header.frameLength,missing:0}}}}function Da(data,e){var t=data[e+1]>>3&3,r=data[e+1]>>1&3,n=data[e+2]>>4&15,o=data[e+2]>>2&3;if(1!==t&&0!==n&&15!==n&&3!==o){var l=data[e+2]>>1&1,c=data[e+3]>>6,h=1e3*Sa[14*(3===t?3-r:3===r?3:4)+n-1],d=La[3*(3===t?0:2===t?1:2)+o],f=3===c?1:2,v=Aa[t][r],m=Ra[r],y=8*v*m,k=Math.floor(v*h/d+l)*m;if(null===Ta){var E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ta=E?parseInt(E[1]):0}return!!Ta&&Ta<=87&&2===r&&h>=224e3&&0===c&&(data[e+3]=128|data[e+3]),{sampleRate:d,channelCount:f,frameLength:k,samplesPerFrame:y}}}function wa(data,e){return 255===data[e]&&224==(224&data[e+1])&&0!=(6&data[e+1])}function Ia(data,e){return e+1<data.length&&wa(data,e)}function Ca(data,e){if(e+1<data.length&&wa(data,e)){var header=Da(data,e),t=4;null!=header&&header.frameLength&&(t=header.frameLength);var r=e+t;return r===data.length||Ia(data,r)}return!1}var _a=function(e){y(r,e);var t=E(r);function r(e,n){var o;return D(this,r),(o=t.call(this)).observer=void 0,o.config=void 0,o.observer=e,o.config=n,o}return I(r,[{key:"resetInitSegment",value:function(e,t,n,o){d(A(r.prototype),"resetInitSegment",this).call(this,e,t,n,o),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:o,inputTimeScale:9e4,dropped:0}}},{key:"canParse",value:function(data,e){return function(data,e){return function(data,e){return e+5<data.length}(data,e)&&fa(data,e)&&ga(data,e)<=data.length-e}(data,e)}},{key:"appendFrame",value:function(track,data,e){pa(track,this.observer,data,e,track.manifestCodec);var t=Ea(track,data,e,this.basePTS,this.frameIndex);if(t&&0===t.missing)return t}}],[{key:"probe",value:function(data){if(!data)return!1;var e=Me(data,0),t=(null==e?void 0:e.length)||0;if(Ca(data,t))return!1;for(var r=data.length;t<r;t++)if(ya(data,t))return $.log("ADTS sync word found !"),!0;return!1}}]),r}(ha),xa=/\/emsg[-/]ID3/i,Pa=function(){function e(t,r){D(this,e),this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=r}return I(e,[{key:"resetTimeStamp",value:function(){}},{key:"resetInitSegment",value:function(e,t,r,n){var o=this.videoTrack=ca("video",1),l=this.audioTrack=ca("audio",1),c=this.txtTrack=ca("text",1);if(this.id3Track=ca("id3",1),this.timeOffset=0,null!=e&&e.byteLength){var h=lt(e);if(h.video){var d=h.video,f=d.id,v=d.timescale,m=d.codec;o.id=f,o.timescale=c.timescale=v,o.codec=m}if(h.audio){var y=h.audio,k=y.id,E=y.timescale,T=y.codec;l.id=k,l.timescale=E,l.codec=T}c.id=$e.text,o.sampleDuration=0,o.duration=l.duration=n}}},{key:"resetContiguity",value:function(){this.remainderData=null}},{key:"demux",value:function(data,e){this.timeOffset=e;var t=data,r=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(t=mt(this.remainderData,data));var o=function(data){var e={valid:null,remainder:null},t=st(data,["moof"]);if(t.length<2)return e.remainder=data,e;var r=t[t.length-1];return e.valid=_e(data,0,r.byteOffset-8),e.remainder=_e(data,r.byteOffset-8),e}(t);this.remainderData=o.remainder,r.samples=o.valid||new Uint8Array}else r.samples=t;var l=this.extractID3Track(r,e);return n.samples=yt(e,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:l,textTrack:this.txtTrack}}},{key:"flush",value:function(){var e=this.timeOffset,t=this.videoTrack,r=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;var n=this.extractID3Track(t,this.timeOffset);return r.samples=yt(e,t),{videoTrack:t,audioTrack:ca(),id3Track:n,textTrack:ca()}}},{key:"extractID3Track",value:function(e,t){var r=this.id3Track;if(e.samples.length){var n=st(e.samples,["emsg"]);n&&n.forEach((function(data){var e=function(data){var e=data[0],t="",r="",n=0,o=0,l=0,c=0,h=0,d=0;if(0===e){for(;"\0"!==Ze(data.subarray(d,d+1));)t+=Ze(data.subarray(d,d+1)),d+=1;for(t+=Ze(data.subarray(d,d+1)),d+=1;"\0"!==Ze(data.subarray(d,d+1));)r+=Ze(data.subarray(d,d+1)),d+=1;r+=Ze(data.subarray(d,d+1)),d+=1,n=tt(data,12),o=tt(data,16),c=tt(data,20),h=tt(data,24),d=28}else if(1===e){n=tt(data,d+=4);var f=tt(data,d+=4),v=tt(data,d+=4);for(d+=4,l=Math.pow(2,32)*f+v,K(l)||(l=Number.MAX_SAFE_INTEGER,$.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),c=tt(data,d),h=tt(data,d+=4),d+=4;"\0"!==Ze(data.subarray(d,d+1));)t+=Ze(data.subarray(d,d+1)),d+=1;for(t+=Ze(data.subarray(d,d+1)),d+=1;"\0"!==Ze(data.subarray(d,d+1));)r+=Ze(data.subarray(d,d+1)),d+=1;r+=Ze(data.subarray(d,d+1)),d+=1}return{schemeIdUri:t,value:r,timeScale:n,presentationTime:l,presentationTimeDelta:o,eventDuration:c,id:h,payload:data.subarray(d,data.byteLength)}}(data);if(xa.test(e.schemeIdUri)){var n=G(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale,o=4294967295===e.eventDuration?Number.POSITIVE_INFINITY:e.eventDuration/e.timeScale;o<=.001&&(o=Number.POSITIVE_INFINITY);var l=e.payload;r.samples.push({data:l,len:l.byteLength,dts:n,pts:n,type:Tr,duration:o})}}))}return r}},{key:"demuxSampleAes",value:function(data,e,t){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}},{key:"destroy",value:function(){}}],[{key:"probe",value:function(data){return function(data){for(var e=data.byteLength,i=0;i<e;){var t=tt(data,i);if(t>8&&109===data[i+4]&&111===data[i+5]&&111===data[i+6]&&102===data[i+7])return!0;i=t>1?i+t:e}return!1}(data)}}]),e}(),Fa=function(data,e){var t=0,r=5;e+=r;for(var n=new Uint32Array(1),mask=new Uint32Array(1),o=new Uint8Array(1);r>0;){o[0]=data[e];var l=Math.min(r,8),c=8-l;mask[0]=4278190080>>>24+c<<c,n[0]=(o[0]&mask[0])>>c,t=t?t<<l|n[0]:n[0],e+=1,r-=l}return t},Ma=function(e){y(r,e);var t=E(r);function r(e){var n;return D(this,r),(n=t.call(this)).observer=void 0,n.observer=e,n}return I(r,[{key:"resetInitSegment",value:function(e,t,n,o){d(A(r.prototype),"resetInitSegment",this).call(this,e,t,n,o),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:o,inputTimeScale:9e4,dropped:0}}},{key:"canParse",value:function(data,e){return e+64<data.length}},{key:"appendFrame",value:function(track,data,e){var t=Oa(track,data,e,this.basePTS,this.frameIndex);if(-1!==t)return{sample:track.samples[track.samples.length-1],length:t,missing:0}}}],[{key:"probe",value:function(data){if(!data)return!1;var e=Me(data,0);if(!e)return!1;var t=e.length;return 11===data[t]&&119===data[t+1]&&void 0!==Ue(e)&&Fa(data,t)<16}}]),r}(ha);function Oa(track,data,e,t,r){if(e+8>data.length)return-1;if(11!==data[e]||119!==data[e+1])return-1;var n=data[e+4]>>6;if(n>=3)return-1;var o=[48e3,44100,32e3][n],l=63&data[e+4],c=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*l+n];if(e+c>data.length)return-1;var h=data[e+6]>>5,d=0;2===h?d+=2:(1&h&&1!==h&&(d+=2),4&h&&(d+=2));var f=(data[e+6]<<8|data[e+7])>>12-d&1,v=[2,1,2,3,3,4,4,5][h]+f,m=data[e+5]>>3,y=7&data[e+5],k=new Uint8Array([n<<6|m<<1|y>>2,(3&y)<<6|h<<3|f<<2|l>>4,l<<4&224]),E=t+r*(1536/o*9e4),T=data.subarray(e,e+c);return track.config=k,track.channelCount=v,track.samplerate=o,track.samples.push({unit:T,pts:E}),c}var Na=function(){function e(){D(this,e),this.VideoSample=null}return I(e,[{key:"createVideoSample",value:function(e,t,r,n){return{key:e,frame:!1,pts:t,dts:r,units:[],debug:n,length:0}}},{key:"getLastNalUnit",value:function(e){var t,r,n=this.VideoSample;if(n&&0!==n.units.length||(n=e[e.length-1]),null!=(t=n)&&t.units){var o=n.units;r=o[o.length-1]}return r}},{key:"pushAccessUnit",value:function(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){var r=t.samples,n=r.length;if(!n)return void t.dropped++;var o=r[n-1];e.pts=o.pts,e.dts=o.dts}t.samples.push(e)}e.debug.length&&$.log(e.pts+"/"+e.dts+":"+e.debug)}}]),e}(),Ua=function(){function e(data){D(this,e),this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=data,this.bytesAvailable=data.byteLength,this.word=0,this.bitsAvailable=0}return I(e,[{key:"loadWord",value:function(){var data=this.data,e=this.bytesAvailable,t=data.byteLength-e,r=new Uint8Array(4),n=Math.min(4,e);if(0===n)throw new Error("no bytes available");r.set(data.subarray(t,t+n)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*n,this.bytesAvailable-=n}},{key:"skipBits",value:function(e){var t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,e-=(t=e>>3)<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}},{key:"readBits",value:function(e){var t=Math.min(this.bitsAvailable,e),r=this.word>>>32-t;if(e>32&&$.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return(t=e-t)>0&&this.bitsAvailable?r<<t|this.readBits(t):r}},{key:"skipLZ",value:function(){var e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBoolean",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}},{key:"skipScalingList",value:function(e){for(var t=8,r=8,n=0;n<e;n++)0!==r&&(r=(t+this.readEG()+256)%256),t=0===r?t:r}},{key:"readSPS",value:function(){var e,t,i,r=0,n=0,o=0,l=0,c=this.readUByte.bind(this),h=this.readBits.bind(this),d=this.readUEG.bind(this),f=this.readBoolean.bind(this),v=this.skipBits.bind(this),m=this.skipEG.bind(this),y=this.skipUEG.bind(this),k=this.skipScalingList.bind(this);c();var E=c();if(h(5),v(3),c(),y(),100===E||110===E||122===E||244===E||44===E||83===E||86===E||118===E||128===E){var T=d();if(3===T&&v(1),y(),y(),v(1),f())for(t=3!==T?8:12,i=0;i<t;i++)f()&&k(i<6?16:64)}y();var S=d();if(0===S)d();else if(1===S)for(v(1),m(),m(),e=d(),i=0;i<e;i++)m();y(),v(1);var L=d(),A=d(),R=h(1);0===R&&v(1),v(1),f()&&(r=d(),n=d(),o=d(),l=d());var D=[1,1];if(f()&&f())switch(c()){case 1:D=[1,1];break;case 2:D=[12,11];break;case 3:D=[10,11];break;case 4:D=[16,11];break;case 5:D=[40,33];break;case 6:D=[24,11];break;case 7:D=[20,11];break;case 8:D=[32,11];break;case 9:D=[80,33];break;case 10:D=[18,11];break;case 11:D=[15,11];break;case 12:D=[64,33];break;case 13:D=[160,99];break;case 14:D=[4,3];break;case 15:D=[3,2];break;case 16:D=[2,1];break;case 255:D=[c()<<8|c(),c()<<8|c()]}return{width:Math.ceil(16*(L+1)-2*r-2*n),height:(2-R)*(A+1)*16-(R?2:4)*(o+l),pixelRatio:D}}},{key:"readSliceType",value:function(){return this.readUByte(),this.readUEG(),this.readUEG()}}]),e}(),Ba=function(e){y(r,e);var t=E(r);function r(){return D(this,r),t.apply(this,arguments)}return I(r,[{key:"parseAVCPES",value:function(track,e,t,r,n){var o,l=this,c=this.parseAVCNALu(track,t.data),h=this.VideoSample,d=!1;t.data=null,h&&c.length&&!track.audFound&&(this.pushAccessUnit(h,track),h=this.VideoSample=this.createVideoSample(!1,t.pts,t.dts,"")),c.forEach((function(r){var c;switch(r.type){case 1:var f=!1;o=!0;var v,data=r.data;if(d&&data.length>4){var m=new Ua(data).readSliceType();2!==m&&4!==m&&7!==m&&9!==m||(f=!0)}if(f)null!=(v=h)&&v.frame&&!h.key&&(l.pushAccessUnit(h,track),h=l.VideoSample=null);h||(h=l.VideoSample=l.createVideoSample(!0,t.pts,t.dts,"")),h.frame=!0,h.key=f;break;case 5:o=!0,null!=(c=h)&&c.frame&&!h.key&&(l.pushAccessUnit(h,track),h=l.VideoSample=null),h||(h=l.VideoSample=l.createVideoSample(!0,t.pts,t.dts,"")),h.key=!0,h.frame=!0;break;case 6:o=!0,kt(r.data,1,t.pts,e.samples);break;case 7:var y,k;o=!0,d=!0;var E=r.data,T=new Ua(E).readSPS();if(!track.sps||track.width!==T.width||track.height!==T.height||(null==(y=track.pixelRatio)?void 0:y[0])!==T.pixelRatio[0]||(null==(k=track.pixelRatio)?void 0:k[1])!==T.pixelRatio[1]){track.width=T.width,track.height=T.height,track.pixelRatio=T.pixelRatio,track.sps=[E],track.duration=n;for(var S=E.subarray(1,4),L="avc1.",i=0;i<3;i++){var A=S[i].toString(16);A.length<2&&(A="0"+A),L+=A}track.codec=L}break;case 8:o=!0,track.pps=[r.data];break;case 9:o=!0,track.audFound=!0,h&&l.pushAccessUnit(h,track),h=l.VideoSample=l.createVideoSample(!1,t.pts,t.dts,"");break;case 12:o=!0;break;default:o=!1,h&&(h.debug+="unknown NAL "+r.type+" ")}h&&o&&h.units.push(r)})),r&&h&&(this.pushAccessUnit(h,track),this.VideoSample=null)}},{key:"parseAVCNALu",value:function(track,e){var t,r,n=e.byteLength,o=track.naluState||0,l=o,c=[],i=0,h=-1,d=0;for(-1===o&&(h=0,d=31&e[0],o=0,i=1);i<n;)if(t=e[i++],o)if(1!==o)if(t)if(1===t){if(r=i-o-1,h>=0){var f={data:e.subarray(h,r),type:d};c.push(f)}else{var v=this.getLastNalUnit(track.samples);v&&(l&&i<=4-l&&v.state&&(v.data=v.data.subarray(0,v.data.byteLength-l)),r>0&&(v.data=mt(v.data,e.subarray(0,r)),v.state=0))}i<n?(h=i,d=31&e[i],o=0):o=-1}else o=0;else o=3;else o=t?0:2;else o=t?0:1;if(h>=0&&o>=0){var m={data:e.subarray(h,n),type:d,state:o};c.push(m)}if(0===c.length){var y=this.getLastNalUnit(track.samples);y&&(y.data=mt(y.data,e))}return track.naluState=o,c}}]),r}(Na),Ga=function(){function e(t,r,n){D(this,e),this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new Xi(r,{removePKCS7Padding:!1})}return I(e,[{key:"decryptBuffer",value:function(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}},{key:"decryptAacSample",value:function(e,t,r){var n=this,o=e[t].unit;if(!(o.length<=16)){var l=o.subarray(16,o.length-o.length%16),c=l.buffer.slice(l.byteOffset,l.byteOffset+l.length);this.decryptBuffer(c).then((function(l){var c=new Uint8Array(l);o.set(c,16),n.decrypter.isSync()||n.decryptAacSamples(e,t+1,r)}))}}},{key:"decryptAacSamples",value:function(e,t,r){for(;;t++){if(t>=e.length)return void r();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,r),!this.decrypter.isSync()))return}}},{key:"getAvcEncryptedData",value:function(e){for(var t=16*Math.floor((e.length-48)/160)+16,r=new Int8Array(t),n=0,o=32;o<e.length-16;o+=160,n+=16)r.set(e.subarray(o,o+16),n);return r}},{key:"getAvcDecryptedUnit",value:function(e,t){for(var r=new Uint8Array(t),n=0,o=32;o<e.length-16;o+=160,n+=16)e.set(r.subarray(n,n+16),o);return e}},{key:"decryptAvcSample",value:function(e,t,r,n,o){var l=this,c=Et(o.data),h=this.getAvcEncryptedData(c);this.decryptBuffer(h.buffer).then((function(h){o.data=l.getAvcDecryptedUnit(c,h),l.decrypter.isSync()||l.decryptAvcSamples(e,t,r+1,n)}))}},{key:"decryptAvcSamples",value:function(e,t,r,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,r=0){if(t>=e.length)return void n();for(var o=e[t].units;!(r>=o.length);r++){var l=o[r];if(!(l.data.length<=48||1!==l.type&&5!==l.type||(this.decryptAvcSample(e,t,r,n,l),this.decrypter.isSync())))return}}}}]),e}(),Ka=188,Ha=function(){function e(t,r,n){D(this,e),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=r,this.typeSupported=n,this.videoParser=new Ba}return I(e,[{key:"resetInitSegment",value:function(t,r,n,o){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=e.createTrack("video"),this._audioTrack=e.createTrack("audio",o),this._id3Track=e.createTrack("id3"),this._txtTrack=e.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=r,this.videoCodec=n,this._duration=o}},{key:"resetTimeStamp",value:function(){}},{key:"resetContiguity",value:function(){var e=this._audioTrack,t=this._videoTrack,r=this._id3Track;e&&(e.pesData=null),t&&(t.pesData=null),r&&(r.pesData=null),this.aacOverFlow=null,this.remainderData=null}},{key:"demux",value:function(data,t){var r,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];n||(this.sampleAes=null);var l=this._videoTrack,c=this._audioTrack,h=this._id3Track,d=this._txtTrack,f=l.pid,v=l.pesData,m=c.pid,y=h.pid,k=c.pesData,E=h.pesData,T=null,S=this.pmtParsed,L=this._pmtId,A=data.length;if(this.remainderData&&(A=(data=mt(this.remainderData,data)).length,this.remainderData=null),A<Ka&&!o)return this.remainderData=data,{audioTrack:c,videoTrack:l,id3Track:h,textTrack:d};var R=Math.max(0,e.syncOffset(data));(A-=(A-R)%Ka)<data.byteLength&&!o&&(this.remainderData=new Uint8Array(data.buffer,A,data.buffer.byteLength-A));for(var D=0,w=R;w<A;w+=Ka)if(71===data[w]){var I=!!(64&data[w+1]),C=Va(data,w),_=(48&data[w+3])>>4,x=void 0;if(_>1){if((x=w+5+data[w+4])===w+Ka)continue}else x=w+4;switch(C){case f:I&&(v&&(r=Xa(v))&&this.videoParser.parseAVCPES(l,d,r,!1,this._duration),v={data:[],size:0}),v&&(v.data.push(data.subarray(x,w+Ka)),v.size+=w+Ka-x);break;case m:if(I){if(k&&(r=Xa(k)))switch(c.segmentCodec){case"aac":this.parseAACPES(c,r);break;case"mp3":this.parseMPEGPES(c,r);break;case"ac3":this.parseAC3PES(c,r)}k={data:[],size:0}}k&&(k.data.push(data.subarray(x,w+Ka)),k.size+=w+Ka-x);break;case y:I&&(E&&(r=Xa(E))&&this.parseID3PES(h,r),E={data:[],size:0}),E&&(E.data.push(data.subarray(x,w+Ka)),E.size+=w+Ka-x);break;case 0:I&&(x+=data[x]+1),L=this._pmtId=Ya(data,x);break;case L:I&&(x+=data[x]+1);var P=ja(data,x,this.typeSupported,n,this.observer);(f=P.videoPid)>0&&(l.pid=f,l.segmentCodec=P.segmentVideoCodec),(m=P.audioPid)>0&&(c.pid=m,c.segmentCodec=P.segmentAudioCodec),(y=P.id3Pid)>0&&(h.pid=y),null===T||S||($.warn("MPEG-TS PMT found at ".concat(w," after unknown PID '").concat(T,"'. Backtracking to sync byte @").concat(R," to parse all TS packets.")),T=null,w=R-188),S=this.pmtParsed=!0;break;case 17:case 8191:break;default:T=C}}else D++;D>0&&Wa(this.observer,new Error("Found ".concat(D," TS packet/s that do not start with 0x47"))),l.pesData=v,c.pesData=k,h.pesData=E;var F={audioTrack:c,videoTrack:l,id3Track:h,textTrack:d};return o&&this.extractRemainingSamples(F),F}},{key:"flush",value:function(){var e,t=this.remainderData;return this.remainderData=null,e=t?this.demux(t,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}},{key:"extractRemainingSamples",value:function(e){var t,r=e.audioTrack,n=e.videoTrack,o=e.id3Track,l=e.textTrack,c=n.pesData,h=r.pesData,d=o.pesData;if(c&&(t=Xa(c))?(this.videoParser.parseAVCPES(n,l,t,!0,this._duration),n.pesData=null):n.pesData=c,h&&(t=Xa(h))){switch(r.segmentCodec){case"aac":this.parseAACPES(r,t);break;case"mp3":this.parseMPEGPES(r,t);break;case"ac3":this.parseAC3PES(r,t)}r.pesData=null}else null!=h&&h.size&&$.log("last AAC PES packet truncated,might overlap between fragments"),r.pesData=h;d&&(t=Xa(d))?(this.parseID3PES(o,t),o.pesData=null):o.pesData=d}},{key:"demuxSampleAes",value:function(data,e,t){var r=this.demux(data,t,!0,!this.config.progressive),n=this.sampleAes=new Ga(this.observer,this.config,e);return this.decrypt(r,n)}},{key:"decrypt",value:function(e,t){return new Promise((function(r){var n=e.audioTrack,o=e.videoTrack;n.samples&&"aac"===n.segmentCodec?t.decryptAacSamples(n.samples,0,(function(){o.samples?t.decryptAvcSamples(o.samples,0,0,(function(){r(e)})):r(e)})):o.samples&&t.decryptAvcSamples(o.samples,0,0,(function(){r(e)}))}))}},{key:"destroy",value:function(){this._duration=0}},{key:"parseAACPES",value:function(track,e){var t,r,n,o=0,l=this.aacOverFlow,data=e.data;if(l){this.aacOverFlow=null;var c=l.missing,h=l.sample.unit.byteLength;if(-1===c)data=mt(l.sample.unit,data);else{var d=h-c;l.sample.unit.set(data.subarray(0,c),d),track.samples.push(l.sample),o=l.missing}}for(t=o,r=data.length;t<r-1&&!ma(data,t);t++);if(t!==o){var f,v=t<r-1;if(f=v?"AAC PES did not start with ADTS header,offset:".concat(t):"No ADTS header found in AAC PES",Wa(this.observer,new Error(f),v),!v)return}if(pa(track,this.observer,data,t,this.audioCodec),void 0!==e.pts)n=e.pts;else{if(!l)return void $.warn("[tsdemuxer]: AAC PES unknown PTS");var m=ka(track.samplerate);n=l.sample.pts+m}for(var y,k=0;t<r;){if(t+=(y=Ea(track,data,t,n,k)).length,y.missing){this.aacOverFlow=y;break}for(k++;t<r-1&&!ma(data,t);t++);}}},{key:"parseMPEGPES",value:function(track,e){var data=e.data,t=data.length,r=0,n=0,o=e.pts;if(void 0!==o)for(;n<t;)if(Ia(data,n)){var l=ba(track,data,n,o,r);if(!l)break;n+=l.length,r++}else n++;else $.warn("[tsdemuxer]: MPEG PES unknown PTS")}},{key:"parseAC3PES",value:function(track,e){var data=e.data,t=e.pts;if(void 0!==t)for(var r,n=data.length,o=0,l=0;l<n&&(r=Oa(track,data,l,t,o++))>0;)l+=r;else $.warn("[tsdemuxer]: AC3 PES unknown PTS")}},{key:"parseID3PES",value:function(e,t){if(void 0!==t.pts){var r=B({},t,{type:this._videoTrack?Tr:kr,duration:Number.POSITIVE_INFINITY});e.samples.push(r)}else $.warn("[tsdemuxer]: ID3 PES unknown PTS")}}],[{key:"probe",value:function(data){var t=e.syncOffset(data);return t>0&&$.warn("MPEG2-TS detected but first sync word found @ offset ".concat(t)),-1!==t}},{key:"syncOffset",value:function(data){for(var e=data.length,t=Math.min(940,e-Ka)+1,i=0;i<t;){for(var r=!1,n=-1,o=0,l=i;l<e;l+=Ka){if(71!==data[l]||e-l!==Ka&&71!==data[l+Ka]){if(o)return-1;break}if(o++,-1===n&&0!==(n=l)&&(t=Math.min(n+18612,data.length-Ka)+1),r||(r=0===Va(data,l)),r&&o>1&&(0===n&&o>2||l+Ka>t))return n}i++}return-1}},{key:"createTrack",value:function(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:$e[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}}]),e}();function Va(data,e){return((31&data[e+1])<<8)+data[e+2]}function Ya(data,e){return(31&data[e+10])<<8|data[e+11]}function ja(data,e,t,r,n){var o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},l=e+3+((15&data[e+1])<<8|data[e+2])-4;for(e+=12+((15&data[e+10])<<8|data[e+11]);e<l;){var c=Va(data,e),h=(15&data[e+3])<<8|data[e+4];switch(data[e]){case 207:if(!r){qa("ADTS AAC");break}case 15:-1===o.audioPid&&(o.audioPid=c);break;case 21:-1===o.id3Pid&&(o.id3Pid=c);break;case 219:if(!r){qa("H.264");break}case 27:-1===o.videoPid&&(o.videoPid=c,o.segmentVideoCodec="avc");break;case 3:case 4:t.mpeg||t.mp3?-1===o.audioPid&&(o.audioPid=c,o.segmentAudioCodec="mp3"):$.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){qa("AC-3");break}case 129:t.ac3?-1===o.audioPid&&(o.audioPid=c,o.segmentAudioCodec="ac3"):$.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===o.audioPid&&h>0)for(var d=e+5,f=h;f>2;){if(106===data[d])!0!==t.ac3?$.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=c,o.segmentAudioCodec="ac3");var v=data[d+1]+2;d+=v,f-=v}break;case 194:case 135:return Wa(n,new Error("Unsupported EC-3 in M2TS found")),o;case 36:return Wa(n,new Error("Unsupported HEVC in M2TS found")),o}e+=h+5}return o}function Wa(e,t,r){$.warn("parsing error: ".concat(t.message)),e.emit(V.ERROR,V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_PARSING_ERROR,fatal:!1,levelRetry:r,error:t,reason:t.message})}function qa(e){$.log("".concat(e," with AES-128-CBC encryption found in unencrypted stream"))}function Xa(e){var t,r,n,o,l,i=0,data=e.data;if(!e||0===e.size)return null;for(;data[0].length<19&&data.length>1;)data[0]=mt(data[0],data[1]),data.splice(1,1);if(1===((t=data[0])[0]<<16)+(t[1]<<8)+t[2]){if((r=(t[4]<<8)+t[5])&&r>e.size-6)return null;var c=t[7];192&c&&(o=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&c?o-(l=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2)>54e5&&($.warn("".concat(Math.round((o-l)/9e4),"s delta between PTS and DTS, align them")),o=l):l=o);var h=(n=t[8])+9;if(e.size<=h)return null;e.size-=h;for(var d=new Uint8Array(e.size),f=0,v=data.length;f<v;f++){var m=(t=data[f]).byteLength;if(h){if(h>m){h-=m;continue}t=t.subarray(h),m-=h,h=0}d.set(t,i),i+=m}return r&&(r-=n+3),{data:d,pts:o,dts:l,len:r}}return null}var za=function(e){y(r,e);var t=E(r);function r(){return D(this,r),t.apply(this,arguments)}return I(r,[{key:"resetInitSegment",value:function(e,t,n,o){d(A(r.prototype),"resetInitSegment",this).call(this,e,t,n,o),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:o,inputTimeScale:9e4,dropped:0}}},{key:"canParse",value:function(data,e){return function(data,e){return wa(data,e)&&4<=data.length-e}(data,e)}},{key:"appendFrame",value:function(track,data,e){if(null!==this.basePTS)return ba(track,data,e,this.basePTS,this.frameIndex)}}],[{key:"probe",value:function(data){if(!data)return!1;var e=Me(data,0),t=(null==e?void 0:e.length)||0;if(e&&11===data[t]&&119===data[t+1]&&void 0!==Ue(e)&&Fa(data,t)<=16)return!1;for(var r=data.length;t<r;t++)if(Ca(data,t))return $.log("MPEG Audio sync word found !"),!0;return!1}}]),r}(ha),Qa=function(){function e(){D(this,e)}return I(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}]),e}(),Ja=Math.pow(2,32)-1,$a=function(){function e(){D(this,e)}return I(e,null,[{key:"init",value:function(){var i;for(i in e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},e.types)e.types.hasOwnProperty(i)&&(e.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:t,audio:r};var n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),o=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=o,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var l=new Uint8Array([105,115,111,109]),c=new Uint8Array([97,118,99,49]),h=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,l,h,l,c),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,n))}},{key:"box",value:function(e){for(var t=8,r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];for(var i=n.length,l=i;i--;)t+=n[i].byteLength;var c=new Uint8Array(t);for(c[0]=t>>24&255,c[1]=t>>16&255,c[2]=t>>8&255,c[3]=255&t,c.set(e,4),i=0,t=8;i<l;i++)c.set(n[i],t),t+=n[i].byteLength;return c}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"mdat",value:function(data){return e.box(e.types.mdat,data)}},{key:"mdhd",value:function(t,r){r*=t;var n=Math.floor(r/(Ja+1)),o=Math.floor(r%(Ja+1));return e.box(e.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24,n>>16&255,n>>8&255,255&n,o>>24,o>>16&255,o>>8&255,255&o,85,196,0,0]))}},{key:"mdia",value:function(track){return e.box(e.types.mdia,e.mdhd(track.timescale,track.duration),e.hdlr(track.type),e.minf(track))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"minf",value:function(track){return"audio"===track.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(track)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(track))}},{key:"moof",value:function(t,r,track){return e.box(e.types.moof,e.mfhd(t),e.traf(track,r))}},{key:"moov",value:function(t){for(var i=t.length,r=[];i--;)r[i]=e.trak(t[i]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale,t[0].duration)].concat(r).concat(e.mvex(t)))}},{key:"mvex",value:function(t){for(var i=t.length,r=[];i--;)r[i]=e.trex(t[i]);return e.box.apply(null,[e.types.mvex].concat(r))}},{key:"mvhd",value:function(t,r){r*=t;var n=Math.floor(r/(Ja+1)),o=Math.floor(r%(Ja+1)),l=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24,n>>16&255,n>>8&255,255&n,o>>24,o>>16&255,o>>8&255,255&o,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,l)}},{key:"sdtp",value:function(track){var i,t,r=track.samples||[],n=new Uint8Array(4+r.length);for(i=0;i<r.length;i++)t=r[i].flags,n[i+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return e.box(e.types.sdtp,n)}},{key:"stbl",value:function(track){return e.box(e.types.stbl,e.stsd(track),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function(track){var i,data,t,r=[],n=[];for(i=0;i<track.sps.length;i++)t=(data=track.sps[i]).byteLength,r.push(t>>>8&255),r.push(255&t),r=r.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)t=(data=track.pps[i]).byteLength,n.push(t>>>8&255),n.push(255&t),n=n.concat(Array.prototype.slice.call(data));var o=e.box(e.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|track.sps.length].concat(r).concat([track.pps.length]).concat(n))),l=track.width,c=track.height,h=track.pixelRatio[0],d=track.pixelRatio[1];return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,c>>8&255,255&c,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),e.box(e.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}},{key:"esds",value:function(track){var e=track.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(track.config).concat([6,1,2]))}},{key:"audioStsd",value:function(track){var e=track.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0])}},{key:"mp4a",value:function(track){return e.box(e.types.mp4a,e.audioStsd(track),e.box(e.types.esds,e.esds(track)))}},{key:"mp3",value:function(track){return e.box(e.types[".mp3"],e.audioStsd(track))}},{key:"ac3",value:function(track){return e.box(e.types["ac-3"],e.audioStsd(track),e.box(e.types.dac3,track.config))}},{key:"stsd",value:function(track){return"audio"===track.type?"mp3"===track.segmentCodec&&"mp3"===track.codec?e.box(e.types.stsd,e.STSD,e.mp3(track)):"ac3"===track.segmentCodec?e.box(e.types.stsd,e.STSD,e.ac3(track)):e.box(e.types.stsd,e.STSD,e.mp4a(track)):e.box(e.types.stsd,e.STSD,e.avc1(track))}},{key:"tkhd",value:function(track){var t=track.id,r=track.duration*track.timescale,n=track.width,o=track.height,l=Math.floor(r/(Ja+1)),c=Math.floor(r%(Ja+1));return e.box(e.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,l>>24,l>>16&255,l>>8&255,255&l,c>>24,c>>16&255,c>>8&255,255&c,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,255&n,0,0,o>>8&255,255&o,0,0]))}},{key:"traf",value:function(track,t){var r=e.sdtp(track),n=track.id,o=Math.floor(t/(Ja+1)),l=Math.floor(t%(Ja+1));return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n])),e.box(e.types.tfdt,new Uint8Array([1,0,0,0,o>>24,o>>16&255,o>>8&255,255&o,l>>24,l>>16&255,l>>8&255,255&l])),e.trun(track,r.length+16+20+8+16+8+8),r)}},{key:"trak",value:function(track){return track.duration=track.duration||4294967295,e.box(e.types.trak,e.tkhd(track),e.mdia(track))}},{key:"trex",value:function(track){var t=track.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(track,t){var i,r,n,o,l,c,h=track.samples||[],d=h.length,f=12+16*d,v=new Uint8Array(f);for(t+=8+f,v.set(["video"===track.type?1:0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,255&d,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),i=0;i<d;i++)n=(r=h[i]).duration,o=r.size,l=r.flags,c=r.cts,v.set([n>>>24&255,n>>>16&255,n>>>8&255,255&n,o>>>24&255,o>>>16&255,o>>>8&255,255&o,l.isLeading<<2|l.dependsOn,l.isDependedOn<<6|l.hasRedundancy<<4|l.paddingValue<<1|l.isNonSync,61440&l.degradPrio,15&l.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*i);return e.box(e.types.trun,v)}},{key:"initSegment",value:function(t){e.types||e.init();var r=e.moov(t);return mt(e.FTYP,r)}}]),e}();$a.types=void 0,$a.HDLR_TYPES=void 0,$a.STTS=void 0,$a.STSC=void 0,$a.STCO=void 0,$a.STSZ=void 0,$a.VMHD=void 0,$a.SMHD=void 0,$a.STSD=void 0,$a.FTYP=void 0,$a.DINF=void 0;var Za=9e4;function en(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=e*t*r;return n?Math.round(o):o}function tn(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return en(e,1e3,11111111111111112e-21,t)}var rn=null,an=null,nn=function(){function e(t,r,n){if(D(this,e),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=r,this.typeSupported=n,this.ISGenerated=!1,null===rn){var o=navigator.userAgent||"",l=o.match(/Chrome\/(\d+)/i);rn=l?parseInt(l[1]):0}if(null===an){var c=navigator.userAgent.match(/Safari\/(\d+)/i);an=c?parseInt(c[1]):0}}return I(e,[{key:"destroy",value:function(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}},{key:"resetTimeStamp",value:function(e){$.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}},{key:"resetNextTimestamp",value:function(){$.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}},{key:"resetInitSegment",value:function(){$.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}},{key:"getVideoStartPts",value:function(e){var t=!1,r=e.reduce((function(e,r){var n=r.pts-e;return n<-4294967296?(t=!0,sn(e,r.pts)):n>0?e:r.pts}),e[0].pts);return t&&$.debug("PTS rollover detected"),r}},{key:"remux",value:function(e,t,r,n,o,l,c,h){var video,audio,d,text,f,v,m=o,y=o,k=e.pid>-1,E=t.pid>-1,T=t.samples.length,S=e.samples.length>0,L=c&&T>0||T>1;if((!k||S)&&(!E||L)||this.ISGenerated||c){if(this.ISGenerated){var A,R,D,w,I=this.videoTrackConfig;!I||t.width===I.width&&t.height===I.height&&(null==(A=t.pixelRatio)?void 0:A[0])===(null==(R=I.pixelRatio)?void 0:R[0])&&(null==(D=t.pixelRatio)?void 0:D[1])===(null==(w=I.pixelRatio)?void 0:w[1])||this.resetInitSegment()}else d=this.generateIS(e,t,o,l);var C,_=this.isVideoContiguous,x=-1;if(L&&(x=function(e){for(var i=0;i<e.length;i++)if(e[i].key)return i;return-1}(t.samples),!_&&this.config.forceKeyFrameOnDiscontinuity))if(v=!0,x>0){$.warn("[mp4-remuxer]: Dropped ".concat(x," out of ").concat(T," video samples due to a missing keyframe"));var P=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(x),t.dropped+=x,C=y+=(t.samples[0].pts-P)/t.inputTimeScale}else-1===x&&($.warn("[mp4-remuxer]: No keyframe found out of ".concat(T," video samples")),v=!1);if(this.ISGenerated){if(S&&L){var F=this.getVideoStartPts(t.samples),M=(sn(e.samples[0].pts,F)-F)/t.inputTimeScale;m+=Math.max(0,M),y+=Math.max(0,-M)}if(S){if(e.samplerate||($.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,o,l)),audio=this.remuxAudio(e,m,this.isAudioContiguous,l,E||L||h===lr?y:void 0),L){var O=audio?audio.endPTS-audio.startPTS:0;t.inputTimeScale||($.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,o,l)),video=this.remuxVideo(t,y,_,O)}}else L&&(video=this.remuxVideo(t,y,_,0));video&&(video.firstKeyFrame=x,video.independent=-1!==x,video.firstKeyFramePTS=C)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(r.samples.length&&(f=on(r,o,this._initPTS,this._initDTS)),n.samples.length&&(text=ln(n,o,this._initPTS))),{audio:audio,video:video,initSegment:d,independent:v,text:text,id3:f}}},{key:"generateIS",value:function(e,t,r,n){var o,l,c,h=e.samples,d=t.samples,f=this.typeSupported,v={},m=this._initPTS,y=!m||n,k="audio/mp4";if(y&&(o=l=1/0),e.config&&h.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":f.mpeg?(k="audio/mpeg",e.codec=""):f.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}v.audio={id:"audio",container:k,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&f.mpeg?new Uint8Array(0):$a.initSegment([e]),metadata:{channelCount:e.channelCount}},y&&(c=e.inputTimeScale,m&&c===m.timescale?y=!1:o=l=h[0].pts-Math.round(c*r))}if(t.sps&&t.pps&&d.length){if(t.timescale=t.inputTimeScale,v.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:$a.initSegment([t]),metadata:{width:t.width,height:t.height}},y)if(c=t.inputTimeScale,m&&c===m.timescale)y=!1;else{var E=this.getVideoStartPts(d),T=Math.round(c*r);l=Math.min(l,sn(d[0].dts,E)-T),o=Math.min(o,E-T)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(v).length)return this.ISGenerated=!0,y?(this._initPTS={baseTime:o,timescale:c},this._initDTS={baseTime:l,timescale:c}):o=c=void 0,{tracks:v,initPTS:o,timescale:c}}},{key:"remuxVideo",value:function(track,e,t,r){var n,o,l=track.inputTimeScale,c=track.samples,h=[],d=c.length,f=this._initPTS,v=this.nextAvcDts,m=8,y=this.videoSampleDuration,k=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,T=!1;if(!t||null===v){var S=e*l,L=c[0].pts-sn(c[0].dts,c[0].pts);rn&&null!==v&&Math.abs(S-L-v)<15e3?t=!0:v=S-L}for(var A=f.baseTime*l/f.timescale,i=0;i<d;i++){var R=c[i];R.pts=sn(R.pts-A,v),R.dts=sn(R.dts-A,v),R.dts<c[i>0?i-1:i].dts&&(T=!0)}T&&c.sort((function(a,b){var e=a.dts-b.dts,t=a.pts-b.pts;return e||t})),n=c[0].dts;var D=(o=c[c.length-1].dts)-n,w=D?Math.round(D/(d-1)):y||track.inputTimeScale/30;if(t){var I=n-v,C=I>w,_=I<-1;if((C||_)&&(C?$.warn("AVC: ".concat(tn(I,!0)," ms (").concat(I,"dts) hole between fragments detected at ").concat(e.toFixed(3))):$.warn("AVC: ".concat(tn(-I,!0)," ms (").concat(I,"dts) overlapping between fragments detected at ").concat(e.toFixed(3))),!_||v>=c[0].pts||rn)){n=v;var x=c[0].pts-I;if(C)c[0].dts=n,c[0].pts=x;else for(var P=0;P<c.length&&!(c[P].dts>x);P++)c[P].dts-=I,c[P].pts-=I;$.log("Video: Initial PTS/DTS adjusted: ".concat(tn(x,!0),"/").concat(tn(n,!0),", delta: ").concat(tn(I,!0)," ms"))}}for(var F=0,M=0,O=n=Math.max(0,n),N=0;N<d;N++){for(var U=c[N],G=U.units,K=G.length,H=0,W=0;W<K;W++)H+=G[W].data.length;M+=H,F+=K,U.length=H,U.dts<O?(U.dts=O,O+=w/4|0||1):O=U.dts,k=Math.min(U.pts,k),E=Math.max(U.pts,E)}o=c[d-1].dts;var X,z=M+4*F+8;try{X=new Uint8Array(z)}catch(e){return void this.observer.emit(V.ERROR,V.ERROR,{type:Y.MUX_ERROR,details:j.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:z,reason:"fail allocating video mdat ".concat(z)})}var view=new DataView(X.buffer);view.setUint32(0,z),X.set($a.types.mdat,4);for(var Q=!1,J=Number.POSITIVE_INFINITY,Z=Number.POSITIVE_INFINITY,ee=Number.NEGATIVE_INFINITY,te=Number.NEGATIVE_INFINITY,re=0;re<d;re++){for(var ie=c[re],ae=ie.units,ne=0,se=0,oe=ae.length;se<oe;se++){var le=ae[se],ue=le.data,ce=le.data.byteLength;view.setUint32(m,ce),m+=4,X.set(ue,m),m+=ce,ne+=4+ce}var he=void 0;if(re<d-1)y=c[re+1].dts-ie.dts,he=c[re+1].pts-ie.pts;else{var de=this.config,fe=re>0?ie.dts-c[re-1].dts:w;if(he=re>0?ie.pts-c[re-1].pts:w,de.stretchShortVideoTrack&&null!==this.nextAudioPts){var ve=Math.floor(de.maxBufferHole*l),ge=(r?k+r*l:this.nextAudioPts)-ie.pts;ge>ve?((y=ge-fe)<0?y=fe:Q=!0,$.log("[mp4-remuxer]: It is approximately ".concat(ge/90," ms to the next segment; using duration ").concat(y/90," ms for the last video frame."))):y=fe}else y=fe}var me=Math.round(ie.pts-ie.dts);J=Math.min(J,y),ee=Math.max(ee,y),Z=Math.min(Z,he),te=Math.max(te,he),h.push(new cn(ie.key,y,ne,me))}if(h.length)if(rn){if(rn<70){var ye=h[0].flags;ye.dependsOn=2,ye.isNonSync=0}}else if(an&&te-Z<ee-J&&w/ee<.025&&0===h[0].cts){$.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var pe=n,ke=0,Ee=h.length;ke<Ee;ke++){var Te=pe+h[ke].duration,Se=pe+h[ke].cts;if(ke<Ee-1){var Le=Te+h[ke+1].cts;h[ke].duration=Le-Se}else h[ke].duration=ke?h[ke-1].duration:w;h[ke].cts=0,pe=Te}}y=Q||!y?w:y,this.nextAvcDts=v=o+y,this.videoSampleDuration=y,this.isVideoContiguous=!0;var data={data1:$a.moof(track.sequenceNumber++,n,B({},track,{samples:h})),data2:X,startPTS:k/l,endPTS:(E+y)/l,startDTS:n/l,endDTS:v/l,type:"video",hasAudio:!1,hasVideo:!0,nb:h.length,dropped:track.dropped};return track.samples=[],track.dropped=0,data}},{key:"getSamplesPerFrame",value:function(track){switch(track.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}},{key:"remuxAudio",value:function(track,e,t,r,n){var o=track.inputTimeScale,l=o/(track.samplerate?track.samplerate:o),c=this.getSamplesPerFrame(track),h=c*l,d=this._initPTS,f="mp3"===track.segmentCodec&&this.typeSupported.mpeg,v=[],m=void 0!==n,y=track.samples,k=f?0:8,E=this.nextAudioPts||-1,T=e*o,S=d.baseTime*o/d.timescale;if(this.isAudioContiguous=t=t||y.length&&E>0&&(r&&Math.abs(T-E)<9e3||Math.abs(sn(y[0].pts-S,T)-E)<20*h),y.forEach((function(e){e.pts=sn(e.pts-S,T)})),!t||E<0){if(y=y.filter((function(e){return e.pts>=0})),!y.length)return;E=0===n?0:r&&!m?Math.max(0,T):y[0].pts}if("aac"===track.segmentCodec)for(var L=this.config.maxAudioFramesDrift,i=0,A=E;i<y.length;i++){var R=y[i],D=R.pts,w=D-A,I=Math.abs(1e3*w/o);if(w<=-L*h&&m)0===i&&($.warn("Audio frame @ ".concat((D/o).toFixed(3),"s overlaps nextAudioPts by ").concat(Math.round(1e3*w/o)," ms.")),this.nextAudioPts=E=A=D);else if(w>=L*h&&I<1e4&&m){var C=Math.round(w/h);(A=D-C*h)<0&&(C--,A+=h),0===i&&(this.nextAudioPts=E=A),$.warn("[mp4-remuxer]: Injecting ".concat(C," audio frame @ ").concat((A/o).toFixed(3),"s due to ").concat(Math.round(1e3*w/o)," ms gap."));for(var _=0;_<C;_++){var x=Math.max(A,0),P=Qa.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);P||($.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),P=R.unit.subarray()),y.splice(i,0,{unit:P,pts:x}),A+=h,i++}}R.pts=A,A+=h}for(var F,M=null,O=null,N=0,U=y.length;U--;)N+=y[U].unit.byteLength;for(var G=0,K=y.length;G<K;G++){var H=y[G],W=H.unit,X=H.pts;if(null!==O){v[G-1].duration=Math.round((X-O)/l)}else{if(t&&"aac"===track.segmentCodec&&(X=E),M=X,!(N>0))return;N+=k;try{F=new Uint8Array(N)}catch(e){return void this.observer.emit(V.ERROR,V.ERROR,{type:Y.MUX_ERROR,details:j.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:N,reason:"fail allocating audio mdat ".concat(N)})}f||(new DataView(F.buffer).setUint32(0,N),F.set($a.types.mdat,4))}F.set(W,k);var z=W.byteLength;k+=z,v.push(new cn(!0,c,z,0)),O=X}var Q=v.length;if(Q){var J=v[v.length-1];this.nextAudioPts=E=O+l*J.duration;var Z=f?new Uint8Array(0):$a.moof(track.sequenceNumber++,M/l,B({},track,{samples:v}));track.samples=[];var ee=M/o,te=E/o,re={data1:Z,data2:F,startPTS:ee,endPTS:te,startDTS:ee,endDTS:te,type:"audio",hasAudio:!0,hasVideo:!1,nb:Q};return this.isAudioContiguous=!0,re}}},{key:"remuxEmptyAudio",value:function(track,e,t,r){var n=track.inputTimeScale,o=n/(track.samplerate?track.samplerate:n),l=this.nextAudioPts,c=this._initDTS,h=9e4*c.baseTime/c.timescale,d=(null!==l?l:r.startDTS*n)+h,f=r.endDTS*n+h,v=1024*o,m=Math.ceil((f-d)/v),y=Qa.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if($.warn("[mp4-remuxer]: remux empty Audio"),y){for(var k=[],i=0;i<m;i++){var E=d+i*v;k.push({unit:y,pts:E,dts:E})}return track.samples=k,this.remuxAudio(track,e,t,!1)}$.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec")}}]),e}();function sn(e,t){var r;if(null===t)return e;for(r=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=r;return e}function on(track,e,t,r){var n=track.samples.length;if(n){for(var o=track.inputTimeScale,l=0;l<n;l++){var c=track.samples[l];c.pts=sn(c.pts-t.baseTime*o/t.timescale,e*o)/o,c.dts=sn(c.dts-r.baseTime*o/r.timescale,e*o)/o}var h=track.samples;return track.samples=[],{samples:h}}}function ln(track,e,t){var r=track.samples.length;if(r){for(var n=track.inputTimeScale,o=0;o<r;o++){var l=track.samples[o];l.pts=sn(l.pts-t.baseTime*n/t.timescale,e*n)/n}track.samples.sort((function(a,b){return a.pts-b.pts}));var c=track.samples;return track.samples=[],{samples:c}}}var un,cn=I((function e(t,r,n,o){D(this,e),this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=r,this.size=n,this.cts=o,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}})),hn=function(){function e(){D(this,e),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}return I(e,[{key:"destroy",value:function(){}},{key:"resetTimeStamp",value:function(e){this.initPTS=e,this.lastEndTime=null}},{key:"resetNextTimestamp",value:function(){this.lastEndTime=null}},{key:"resetInitSegment",value:function(e,t,r,n){this.audioCodec=t,this.videoCodec=r,this.generateInitSegment(function(e,t){if(!e||!t)return e;var r=t.keyId;return r&&t.isCommonEncryption&&st(e,["moov","trak"]).forEach((function(e){var t=st(e,["mdia","minf","stbl","stsd"])[0].subarray(8),n=st(t,["enca"]),o=n.length>0;o||(n=st(t,["encv"])),n.forEach((function(e){st(o?e.subarray(28):e.subarray(78),["sinf"]).forEach((function(e){var t=vt(e);if(t){var n=t.subarray(8,24);n.some((function(b){return 0!==b}))||($.log("[eme] Patching keyId in 'enc".concat(o?"a":"v",">sinf>>tenc' box: ").concat(ze(n)," -> ").concat(ze(r))),t.set(r,8))}}))}))})),e}(e,n)),this.emitInitSegment=!0}},{key:"generateInitSegment",value:function(e){var t=this.audioCodec,r=this.videoCodec;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);var n=this.initData=lt(e);n.audio&&(t=dn(n.audio,ne)),n.video&&(r=dn(n.video,se));var o={};n.audio&&n.video?o.audiovideo={container:"video/mp4",codec:t+","+r,initSegment:e,id:"main"}:n.audio?o.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:n.video?o.video={container:"video/mp4",codec:r,initSegment:e,id:"main"}:$.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=o}},{key:"remux",value:function(e,t,r,n,o,l){var c,h,d=this.initPTS,f=this.lastEndTime,v={audio:void 0,video:void 0,text:n,id3:r,initSegment:void 0};G(f)||(f=this.lastEndTime=o||0);var data=t.samples;if(null==data||!data.length)return v;var m={initPTS:void 0,timescale:1},y=this.initData;if(null!=(c=y)&&c.length||(this.generateInitSegment(data),y=this.initData),null==(h=y)||!h.length)return $.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),v;this.emitInitSegment&&(m.tracks=this.initTracks,this.emitInitSegment=!1);var k=function(data,e){for(var t=0,r=0,n=0,o=st(data,["moof","traf"]),i=0;i<o.length;i++){var l=o[i],c=st(l,["tfhd"])[0],track=e[tt(c,4)];if(track){var h=track.default,d=tt(c,0)|(null==h?void 0:h.flags),f=null==h?void 0:h.duration;8&d&&(f=tt(c,2&d?12:8));for(var v=track.timescale||9e4,m=st(l,["trun"]),y=0;y<m.length;y++)!(t=gt(m[y]))&&f&&(t=f*tt(m[y],4)),track.type===se?r+=t/v:track.type===ne&&(n+=t/v)}}if(0===r&&0===n){for(var k=1/0,E=0,T=0,S=st(data,["sidx"]),L=0;L<S.length;L++){var A=ot(S[L]);if(null!=A&&A.references){k=Math.min(k,A.earliestPresentationTime/A.timescale);var R=A.references.reduce((function(e,t){return e+t.info.duration||0}),0);T=(E=Math.max(E,R+A.earliestPresentationTime/A.timescale))-k}}if(T&&G(T))return T}return r||n}(data,y),E=function(e,t){return st(t,["moof","traf"]).reduce((function(t,r){var n=st(r,["tfdt"])[0],o=n[0],l=st(r,["tfhd"]).reduce((function(t,r){var l=tt(r,4),track=e[l];if(track){var c=tt(n,4);if(1===o){if(c===Qe)return $.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;c*=Qe+1,c+=tt(n,8)}var h=c/(track.timescale||9e4);if(G(h)&&(null===t||h<t))return h}return t}),null);return null!==l&&G(l)&&(null===t||l<t)?l:t}),null)}(y,data),T=null===E?o:E;(function(e,t,r,n){if(null===e)return!0;var o=Math.max(n,1),l=t-e.baseTime/e.timescale;return Math.abs(l-r)>o}(d,T,o,k)||m.timescale!==d.timescale&&l)&&(m.initPTS=T-o,d&&1===d.timescale&&$.warn("Adjusting initPTS by ".concat(m.initPTS-d.baseTime)),this.initPTS=d={baseTime:m.initPTS,timescale:1});var S=e?T-d.baseTime/d.timescale:f,L=S+k;!function(e,t,r){st(t,["moof","traf"]).forEach((function(t){st(t,["tfhd"]).forEach((function(n){var o=tt(n,4),track=e[o];if(track){var l=track.timescale||9e4;st(t,["tfdt"]).forEach((function(e){var t=e[0],n=r*l;if(n){var o=tt(e,4);if(0===t)o-=n,nt(e,4,o=Math.max(o,0));else{o*=Math.pow(2,32),o+=tt(e,8),o-=n,o=Math.max(o,0);var c=Math.floor(o/(Qe+1)),h=Math.floor(o%(Qe+1));nt(e,4,c),nt(e,8,h)}}}))}}))}))}(y,data,d.baseTime/d.timescale),k>0?this.lastEndTime=L:($.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var A=!!y.audio,R=!!y.video,D="";A&&(D+="audio"),R&&(D+="video");var track={data1:data,startPTS:S,startDTS:S,endPTS:L,endDTS:L,type:D,hasAudio:A,hasVideo:R,nb:1,dropped:0};return v.audio="audio"===track.type?track:void 0,v.video="audio"!==track.type?track:void 0,v.initSegment=m,v.id3=on(r,o,d,d),n.samples.length&&(v.text=ln(n,o,d)),v}}]),e}();function dn(track,e){var t=null==track?void 0:track.codec;if(t&&t.length>4)return t;if(e===ne){if("ec-3"===t||"ac-3"===t||"alac"===t)return t;if("fLaC"===t||"Opus"===t){return Kt(t,!1)}var r="mp4a.40.5";return $.info('Parsed audio codec "'.concat(t,'" or audio object type not handled. Using "').concat(r,'"')),r}return $.warn('Unhandled video codec "'.concat(t,'"')),"hvc1"===t||"hev1"===t?"hvc1.1.6.L120.90":"av01"===t?"av01.0.04M.08":"avc1.42e01e"}try{un=self.performance.now.bind(self.performance)}catch(e){$.debug("Unable to use Performance API on this environment"),un=null==ge?void 0:ge.Date.now}var fn=[{demux:Pa,remux:hn},{demux:Ha,remux:nn},{demux:_a,remux:nn},{demux:za,remux:nn}];fn.splice(2,0,{demux:Ma,remux:nn});var vn=function(){function e(t,r,n,o,l){D(this,e),this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=r,this.config=n,this.vendor=o,this.id=l}return I(e,[{key:"configure",value:function(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}},{key:"push",value:function(data,e,t,r){var n=this,o=t.transmuxing;o.executeStart=un();var l=new Uint8Array(data),c=this.currentTransmuxState,h=this.transmuxConfig;r&&(this.currentTransmuxState=r);var d=r||c,f=d.contiguous,v=d.discontinuity,m=d.trackSwitch,y=d.accurateTimeOffset,k=d.timeOffset,E=d.initSegmentChange,T=h.audioCodec,S=h.videoCodec,L=h.defaultInitPts,A=h.duration,R=h.initSegmentData,D=function(data,e){var t=null;data.byteLength>0&&null!=(null==e?void 0:e.key)&&null!==e.iv&&null!=e.method&&(t=e);return t}(l,e);if(D&&"AES-128"===D.method){var w=this.getDecrypter();if(!w.isSync())return this.decryptionPromise=w.webCryptoDecrypt(l,D.key.buffer,D.iv.buffer).then((function(e){var r=n.push(e,null,t);return n.decryptionPromise=null,r})),this.decryptionPromise;var I=w.softwareDecrypt(l,D.key.buffer,D.iv.buffer);if(t.part>-1&&(I=w.flush()),!I)return o.executeEnd=un(),gn(t);l=new Uint8Array(I)}var C=this.needsProbing(v,m);if(C){var _=this.configureTransmuxer(l);if(_)return $.warn("[transmuxer] ".concat(_.message)),this.observer.emit(V.ERROR,V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_PARSING_ERROR,fatal:!1,error:_,reason:_.message}),o.executeEnd=un(),gn(t)}(v||m||E||C)&&this.resetInitSegment(R,T,S,A,e),(v||E||C)&&this.resetInitialTimestamp(L),f||this.resetContiguity();var x=this.transmux(l,D,k,y,t),P=this.currentTransmuxState;return P.contiguous=!0,P.discontinuity=!1,P.trackSwitch=!1,o.executeEnd=un(),x}},{key:"flush",value:function(e){var t=this,r=e.transmuxing;r.executeStart=un();var n=this.decrypter,o=this.currentTransmuxState,l=this.decryptionPromise;if(l)return l.then((function(){return t.flush(e)}));var c=[],h=o.timeOffset;if(n){var d=n.flush();d&&c.push(this.push(d,null,e))}var f=this.demuxer,v=this.remuxer;if(!f||!v)return r.executeEnd=un(),[gn(e)];var m=f.flush(h);return mn(m)?m.then((function(r){return t.flushRemux(c,r,e),c})):(this.flushRemux(c,m,e),c)}},{key:"flushRemux",value:function(e,t,r){var n=t.audioTrack,o=t.videoTrack,l=t.id3Track,c=t.textTrack,h=this.currentTransmuxState,d=h.accurateTimeOffset,f=h.timeOffset;$.log("[transmuxer.ts]: Flushed fragment ".concat(r.sn).concat(r.part>-1?" p: "+r.part:""," of level ").concat(r.level));var v=this.remuxer.remux(n,o,l,c,f,d,!0,this.id);e.push({remuxResult:v,chunkMeta:r}),r.transmuxing.executeEnd=un()}},{key:"resetInitialTimestamp",value:function(e){var t=this.demuxer,r=this.remuxer;t&&r&&(t.resetTimeStamp(e),r.resetTimeStamp(e))}},{key:"resetContiguity",value:function(){var e=this.demuxer,t=this.remuxer;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}},{key:"resetInitSegment",value:function(e,t,r,n,o){var l=this.demuxer,c=this.remuxer;l&&c&&(l.resetInitSegment(e,t,r,n),c.resetInitSegment(e,t,r,o))}},{key:"destroy",value:function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}},{key:"transmux",value:function(data,e,t,r,n){return e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(data,e,t,r,n):this.transmuxUnencrypted(data,t,r,n)}},{key:"transmuxUnencrypted",value:function(data,e,t,r){var n=this.demuxer.demux(data,e,!1,!this.config.progressive),o=n.audioTrack,l=n.videoTrack,c=n.id3Track,h=n.textTrack;return{remuxResult:this.remuxer.remux(o,l,c,h,e,t,!1,this.id),chunkMeta:r}}},{key:"transmuxSampleAes",value:function(data,e,t,r,n){var o=this;return this.demuxer.demuxSampleAes(data,e,t).then((function(e){return{remuxResult:o.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,t,r,!1,o.id),chunkMeta:n}}))}},{key:"configureTransmuxer",value:function(data){for(var e,t=this.config,r=this.observer,n=this.typeSupported,o=this.vendor,i=0,l=fn.length;i<l;i++){var c;if(null!=(c=fn[i].demux)&&c.probe(data)){e=fn[i];break}}if(!e)return new Error("Failed to find demuxer by probing fragment data");var h=this.demuxer,d=this.remuxer,f=e.remux,v=e.demux;d&&d instanceof f||(this.remuxer=new f(r,t,n,o)),h&&h instanceof v||(this.demuxer=new v(r,t,n),this.probe=v.probe)}},{key:"needsProbing",value:function(e,t){return!this.demuxer||!this.remuxer||e||t}},{key:"getDecrypter",value:function(){var e=this.decrypter;return e||(e=this.decrypter=new Xi(this.config)),e}}]),e}();var gn=function(e){return{remuxResult:{},chunkMeta:e}};function mn(p){return"then"in p&&p.then instanceof Function}var yn=I((function e(t,r,n,o,l){D(this,e),this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=r,this.initSegmentData=n,this.duration=o,this.defaultInitPts=l||null})),pn=I((function e(t,r,n,o,l,c){D(this,e),this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=r,this.accurateTimeOffset=n,this.trackSwitch=o,this.timeOffset=l,this.initSegmentChange=c})),kn={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function l(e,t,n,l,c){if("function"!=typeof n)throw new TypeError("The listener must be a function");var h=new o(n,l||e,c),d=r?r+t:t;return e._events[d]?e._events[d].fn?e._events[d]=[e._events[d],h]:e._events[d].push(h):(e._events[d]=h,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function h(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),h.prototype.eventNames=function(){var e,n,o=[];if(0===this._eventsCount)return o;for(n in e=this._events)t.call(e,n)&&o.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},h.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,l=new Array(o);i<o;i++)l[i]=n[i].fn;return l},h.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},h.prototype.emit=function(e,t,n,o,l,c){var h=r?r+e:e;if(!this._events[h])return!1;var d,i,f=this._events[h],v=arguments.length;if(f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),v){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,t),!0;case 3:return f.fn.call(f.context,t,n),!0;case 4:return f.fn.call(f.context,t,n,o),!0;case 5:return f.fn.call(f.context,t,n,o,l),!0;case 6:return f.fn.call(f.context,t,n,o,l,c),!0}for(i=1,d=new Array(v-1);i<v;i++)d[i-1]=arguments[i];f.fn.apply(f.context,d)}else{var m,y=f.length;for(i=0;i<y;i++)switch(f[i].once&&this.removeListener(e,f[i].fn,void 0,!0),v){case 1:f[i].fn.call(f[i].context);break;case 2:f[i].fn.call(f[i].context,t);break;case 3:f[i].fn.call(f[i].context,t,n);break;case 4:f[i].fn.call(f[i].context,t,n,o);break;default:if(!d)for(m=1,d=new Array(v-1);m<v;m++)d[m-1]=arguments[m];f[i].fn.apply(f[i].context,d)}}return!0},h.prototype.on=function(e,t,r){return l(this,e,t,r,!1)},h.prototype.once=function(e,t,r){return l(this,e,t,r,!0)},h.prototype.removeListener=function(e,t,n,o){var l=r?r+e:e;if(!this._events[l])return this;if(!t)return c(this,l),this;var h=this._events[l];if(h.fn)h.fn!==t||o&&!h.once||n&&h.context!==n||c(this,l);else{for(var i=0,d=[],f=h.length;i<f;i++)(h[i].fn!==t||o&&!h[i].once||n&&h[i].context!==n)&&d.push(h[i]);d.length?this._events[l]=1===d.length?d[0]:d:c(this,l)}return this},h.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&c(this,t)):(this._events=new n,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=r,h.EventEmitter=h,e.exports=h}(kn);var En=x(kn.exports),Tn=function(){function e(t,r,n,o){var l=this;D(this,e),this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var c=t.config;this.hls=t,this.id=r,this.useWorker=!!c.enableWorker,this.onTransmuxComplete=n,this.onFlush=o;var h=function(e,data){(data=data||{}).frag=l.frag,data.id=l.id,e===V.ERROR&&(l.error=data.error),l.hls.trigger(e,data)};this.observer=new En,this.observer.on(V.FRAG_DECRYPTED,h),this.observer.on(V.ERROR,h);var d,f,path,v,m=_t(c.preferManagedMediaSource)||{isTypeSupported:function(){return!1}},y={mpeg:m.isTypeSupported("audio/mpeg"),mp3:m.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:m.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&"undefined"!=typeof Worker&&(c.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__)){try{c.workerPath?($.log("loading Web Worker ".concat(c.workerPath,' for "').concat(r,'"')),this.workerContext=(path=c.workerPath,v=new self.URL(path,self.location.href).href,{worker:new self.Worker(v),scriptURL:v})):($.log('injecting Web Worker for "'.concat(r,'"')),this.workerContext=(d=new self.Blob(["var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(".concat(__HLS_WORKER_BUNDLE__.toString(),")(true);")],{type:"text/javascript"}),f=self.URL.createObjectURL(d),{worker:new self.Worker(f),objectURL:f})),this.onwmsg=function(e){return l.onWorkerMessage(e)};var k=this.workerContext.worker;k.addEventListener("message",this.onwmsg),k.onerror=function(e){var t=new Error("".concat(e.message,"  (").concat(e.filename,":").concat(e.lineno,")"));c.enableWorker=!1,$.warn('Error in "'.concat(r,'" Web Worker, fallback to inline')),l.hls.trigger(V.ERROR,{type:Y.OTHER_ERROR,details:j.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:t})},k.postMessage({cmd:"init",typeSupported:y,vendor:"",id:r,config:JSON.stringify(c)})}catch(e){$.warn('Error setting up "'.concat(r,'" Web Worker, fallback to inline'),e),this.resetWorker(),this.error=null,this.transmuxer=new vn(this.observer,y,c,"",r)}return}this.transmuxer=new vn(this.observer,y,c,"",r)}return I(e,[{key:"resetWorker",value:function(){if(this.workerContext){var e=this.workerContext,t=e.worker,r=e.objectURL;r&&self.URL.revokeObjectURL(r),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}},{key:"destroy",value:function(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{var e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}var t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}},{key:"push",value:function(data,e,t,r,n,o,l,c,h,d){var f,v,m=this;h.transmuxing.start=self.performance.now();var y=this.transmuxer,k=o?o.start:n.start,E=n.decryptdata,T=this.frag,S=!(T&&n.cc===T.cc),L=!(T&&h.level===T.level),A=T?h.sn-T.sn:-1,R=this.part?h.part-this.part.index:-1,D=0===A&&h.id>1&&h.id===(null==T?void 0:T.stats.chunkCount),w=!L&&(1===A||0===A&&(1===R||D&&R<=0)),I=self.performance.now();(L||A||0===n.stats.parsing.start)&&(n.stats.parsing.start=I),!o||!R&&w||(o.stats.parsing.start=I);var C=!(T&&(null==(f=n.initSegment)?void 0:f.url)===(null==(v=T.initSegment)?void 0:v.url)),_=new pn(S,w,c,L,k,C);if(!w||S||C){$.log("[transmuxer-interface, ".concat(n.type,"]: Starting new transmux session for sn: ").concat(h.sn," p: ").concat(h.part," level: ").concat(h.level," id: ").concat(h.id,"\n        discontinuity: ").concat(S,"\n        trackSwitch: ").concat(L,"\n        contiguous: ").concat(w,"\n        accurateTimeOffset: ").concat(c,"\n        timeOffset: ").concat(k,"\n        initSegmentChange: ").concat(C));var x=new yn(t,r,e,l,d);this.configureTransmuxer(x)}if(this.frag=n,this.part=o,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:data,decryptdata:E,chunkMeta:h,state:_},data instanceof ArrayBuffer?[data]:[]);else if(y){var P=y.push(data,E,h,_);mn(P)?(y.async=!0,P.then((function(data){m.handleTransmuxComplete(data)})).catch((function(e){m.transmuxerError(e,h,"transmuxer-interface push error")}))):(y.async=!1,this.handleTransmuxComplete(P))}}},{key:"flush",value:function(e){var t=this;e.transmuxing.start=self.performance.now();var r=this.transmuxer;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(r){var n=r.flush(e);mn(n)||r.async?(mn(n)||(n=Promise.resolve(n)),n.then((function(data){t.handleFlushResult(data,e)})).catch((function(r){t.transmuxerError(r,e,"transmuxer-interface flush error")}))):this.handleFlushResult(n,e)}}},{key:"transmuxerError",value:function(e,t,r){this.hls&&(this.error=e,this.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,fatal:!1,error:e,err:e,reason:r}))}},{key:"handleFlushResult",value:function(e,t){var r=this;e.forEach((function(e){r.handleTransmuxComplete(e)})),this.onFlush(t)}},{key:"onWorkerMessage",value:function(e){var data=e.data;if(null!=data&&data.event){var t=this.hls;if(this.hls)switch(data.event){case"init":var r,n=null==(r=this.workerContext)?void 0:r.objectURL;n&&self.URL.revokeObjectURL(n);break;case"transmuxComplete":this.handleTransmuxComplete(data.data);break;case"flush":this.onFlush(data.data);break;case"workerLog":$[data.data.logType]&&$[data.data.logType](data.data.message);break;default:data.data=data.data||{},data.data.frag=this.frag,data.data.id=this.id,t.trigger(data.event,data.data)}}else $.warn("worker message received with no ".concat(data?"event name":"data"))}},{key:"configureTransmuxer",value:function(e){var t=this.transmuxer;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}},{key:"handleTransmuxComplete",value:function(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}]),e}();function Sn(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(!Ln(e[i].attrs,t[i].attrs))return!1;return!0}function Ln(e,t,r){var n=e["STABLE-RENDITION-ID"];return n&&!r?n===t["STABLE-RENDITION-ID"]:!(r||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((function(r){return e[r]!==t[r]}))}function An(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}var Rn=function(e){y(r,e);var t=E(r);function r(e,n,o){var l;return D(this,r),(l=t.call(this,e,n,o,"[audio-stream-controller]",lr)).videoBuffer=null,l.videoTrackCC=-1,l.waitingVideoCC=-1,l.bufferedTrack=null,l.switchingTrack=null,l.trackId=-1,l.waitingData=null,l.mainDetails=null,l.flushing=!1,l.bufferFlushed=!1,l.cachedTrackLoadedData=null,l._registerListeners(),l}return I(r,[{key:"onHandlerDestroying",value:function(){this._unregisterListeners(),d(A(r.prototype),"onHandlerDestroying",this).call(this),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}},{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.LEVEL_LOADED,this.onLevelLoaded,this),e.on(V.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(V.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(V.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(V.ERROR,this.onError,this),e.on(V.BUFFER_RESET,this.onBufferReset,this),e.on(V.BUFFER_CREATED,this.onBufferCreated,this),e.on(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(V.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(V.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.LEVEL_LOADED,this.onLevelLoaded,this),e.off(V.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(V.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(V.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(V.ERROR,this.onError,this),e.off(V.BUFFER_RESET,this.onBufferReset,this),e.off(V.BUFFER_CREATED,this.onBufferCreated,this),e.off(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(V.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(V.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"onInitPtsFound",value:function(e,t){var r=t.frag,n=t.id,o=t.initPTS,l=t.timescale;if("main"===n){var c=r.cc;this.initPTS[r.cc]={baseTime:o,timescale:l},this.log("InitPTS for cc: ".concat(c," found from main: ").concat(o)),this.videoTrackCC=c,this.state===sa&&this.tick()}}},{key:"startLoad",value:function(e){if(!this.levels)return this.startPosition=e,void(this.state=Qi);var t=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),t>0&&-1===e?(this.log("Override startPosition with lastCurrentTime @".concat(t.toFixed(3))),e=t,this.state=Ji):(this.loadedmetadata=!1,this.state=ta),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}},{key:"doTick",value:function(){switch(this.state){case Ji:this.doTickIdle();break;case ta:var e,t=this.levels,n=this.trackId,details=null==t||null==(e=t[n])?void 0:e.details;if(details){if(this.waitForCdnTuneIn(details))break;this.state=sa}break;case ea:var o,l=performance.now(),c=this.retryDate;if(!c||l>=c||null!=(o=this.media)&&o.seeking){var h=this.levels,f=this.trackId;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==h?void 0:h[f])||null),this.state=Ji}break;case sa:var v=this.waitingData;if(v){var m=v.frag,y=v.part,k=v.cache,E=v.complete;if(void 0!==this.initPTS[m.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=Zi;var data={frag:m,part:y,payload:k.flush(),networkDetails:null};this._handleFragmentLoadProgress(data),E&&d(A(r.prototype),"_handleFragmentLoadComplete",this).call(this,data)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc (".concat(m.cc,") cancelled because video is at cc ").concat(this.videoTrackCC)),this.clearWaitingFragment();else{var T=this.getLoadPosition(),S=Pi.bufferInfo(this.mediaBuffer,T,this.config.maxBufferHole);ei(S.end,this.config.maxFragLookUpTolerance,m)<0&&(this.log("Waiting fragment cc (".concat(m.cc,") @ ").concat(m.start," cancelled because another fragment at ").concat(S.end," is needed")),this.clearWaitingFragment())}}else this.state=Ji}this.onTickEnd()}},{key:"clearWaitingFragment",value:function(){var e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=Ji)}},{key:"resetLoadingState",value:function(){this.clearWaitingFragment(),d(A(r.prototype),"resetLoadingState",this).call(this)}},{key:"onTickEnd",value:function(){var e=this.media;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}},{key:"doTickIdle",value:function(){var e=this.hls,t=this.levels,r=this.media,n=this.trackId,o=e.config;if((r||!this.startFragRequested&&o.startFragPrefetch)&&null!=t&&t[n]){var l=t[n],c=l.details;if(!c||c.live&&this.levelLastLoaded!==l||this.waitForCdnTuneIn(c))this.state=ta;else{var h=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&h&&(this.bufferFlushed=!1,this.afterBufferFlushed(h,ne,lr));var d=this.getFwdBufferInfo(h,lr);if(null!==d){var f=this.bufferedTrack,v=this.switchingTrack;if(!v&&this._streamEnded(d,c))return e.trigger(V.BUFFER_EOS,{type:"audio"}),void(this.state=aa);var m=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,or),y=d.len,k=this.getMaxBufferLength(null==m?void 0:m.len),E=c.fragments,T=E[0].start,S=this.flushing?this.getLoadPosition():d.end;if(v&&r){var L=this.getLoadPosition();f&&!Ln(v.attrs,f.attrs)&&(S=L),c.PTSKnown&&L<T&&(d.end>T||d.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),r.currentTime=T+.05)}if(!(y>=k&&!v&&S<E[E.length-1].start)){var A=this.getNextFragment(S,c),R=!1;if(A&&this.isLoopLoading(A,S)&&(R=!!A.gap,A=this.getNextFragmentLoopLoading(A,c,d,or,k)),A){var D=m&&A.start>m.end+c.targetduration;if(D||(null==m||!m.len)&&d.len){var w=this.getAppendedFrag(A.start,or);if(null===w)return;if(R||(R=!!w.gap||!!D&&0===m.len),D&&!R||R&&d.nextStart&&d.nextStart<w.end)return}this.loadFragment(A,l,S)}else this.bufferFlushed=!0}}}}}},{key:"getMaxBufferLength",value:function(e){var t=d(A(r.prototype),"getMaxBufferLength",this).call(this);return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}},{key:"onMediaDetaching",value:function(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,d(A(r.prototype),"onMediaDetaching",this).call(this)}},{key:"onAudioTracksUpdated",value:function(e,t){var r=t.audioTracks;this.resetTransmuxer(),this.levels=r.map((function(e){return new Or(e)}))}},{key:"onAudioTrackSwitching",value:function(e,data){var t=!!data.url;this.trackId=data.id;var r=this.fragCurrent;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),t?this.setInterval(100):this.resetTransmuxer(),t?(this.switchingTrack=data,this.state=Ji,this.flushAudioIfNeeded(data)):(this.switchingTrack=null,this.bufferedTrack=data,this.state=Qi),this.tick()}},{key:"onManifestLoading",value:function(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}},{key:"onLevelLoaded",value:function(e,data){this.mainDetails=data.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(V.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}},{key:"onAudioTrackLoaded",value:function(e,data){var t;if(null!=this.mainDetails){var r=this.levels,n=data.details,o=data.id;if(r){this.log("Audio track ".concat(o," loaded [").concat(n.startSN,",").concat(n.endSN,"]").concat(n.lastPartSn?"[part-".concat(n.lastPartSn,"-").concat(n.lastPartIndex,"]"):"",",duration:").concat(n.totalduration));var track=r[o],l=0;if(n.live||null!=(t=track.details)&&t.live){this.checkLiveUpdate(n);var c,h=this.mainDetails;if(n.deltaUpdateFailed||!h)return;if(!track.details&&n.hasProgramDateTime&&h.hasProgramDateTime)Bi(n,h),l=n.fragments[0].start;else l=this.alignPlaylists(n,track.details,null==(c=this.levelLastLoaded)?void 0:c.details)}track.details=n,this.levelLastLoaded=track,this.startFragRequested||!this.mainDetails&&n.live||this.setStartPosition(this.mainDetails||n,l),this.state!==ta||this.waitForCdnTuneIn(n)||(this.state=Ji),this.tick()}else this.warn("Audio tracks were reset while loading level ".concat(o))}else this.cachedTrackLoadedData=data}},{key:"_handleFragmentLoadProgress",value:function(data){var e,t=data.frag,r=data.part,n=data.payload,o=this.config,l=this.trackId,c=this.levels;if(c){var track=c[l];if(track){var details=track.details;if(!details)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(t.start);var h=o.defaultAudioCodec||track.audioCodec||"mp4a.40.2",d=this.transmuxer;d||(d=this.transmuxer=new Tn(this.hls,lr,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var f=this.initPTS[t.cc],v=null==(e=t.initSegment)?void 0:e.data;if(void 0!==f){var m=r?r.index:-1,y=-1!==m,k=new Fi(t.level,t.sn,t.stats.chunkCount,n.byteLength,m,y);d.push(n,v,h,"",t,r,details.totalduration,!1,k,f)}else{this.log("Unknown video PTS for cc ".concat(t.cc,", waiting for video PTS before demuxing audio frag ").concat(t.sn," of [").concat(details.startSN," ,").concat(details.endSN,"],track ").concat(l)),(this.waitingData=this.waitingData||{frag:t,part:r,cache:new ua,complete:!1}).cache.push(new Uint8Array(n)),this.waitingVideoCC=this.videoTrackCC,this.state=sa}}else this.warn("Audio track is undefined on fragment load progress")}else this.warn("Audio tracks were reset while fragment load was in progress. Fragment ".concat(t.sn," of level ").concat(t.level," will not be buffered"))}},{key:"_handleFragmentLoadComplete",value:function(e){this.waitingData?this.waitingData.complete=!0:d(A(r.prototype),"_handleFragmentLoadComplete",this).call(this,e)}},{key:"onBufferReset",value:function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}},{key:"onBufferCreated",value:function(e,data){var t=data.tracks.audio;t&&(this.mediaBuffer=t.buffer||null),data.tracks.video&&(this.videoBuffer=data.tracks.video.buffer||null)}},{key:"onFragBuffered",value:function(e,data){var t=data.frag,r=data.part;if(t.type===lr)if(this.fragContextChanged(t))this.warn("Fragment ".concat(t.sn).concat(r?" p: "+r.index:""," of level ").concat(t.level," finished buffering, but was aborted. state: ").concat(this.state,", audioSwitch: ").concat(this.switchingTrack?this.switchingTrack.name:"false"));else{if("initSegment"!==t.sn){this.fragPrevious=t;var track=this.switchingTrack;track&&(this.bufferedTrack=track,this.switchingTrack=null,this.hls.trigger(V.AUDIO_TRACK_SWITCHED,O({},track)))}this.fragBufferedComplete(t,r)}else if(!this.loadedmetadata&&t.type===or){var n=this.videoBuffer||this.media;if(n)Pi.getBuffered(n).length&&(this.loadedmetadata=!0)}}},{key:"onError",value:function(e,data){var t;if(data.fatal)this.state=na;else switch(data.details){case j.FRAG_GAP:case j.FRAG_PARSING_ERROR:case j.FRAG_DECRYPT_ERROR:case j.FRAG_LOAD_ERROR:case j.FRAG_LOAD_TIMEOUT:case j.KEY_LOAD_ERROR:case j.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(lr,data);break;case j.AUDIO_TRACK_LOAD_ERROR:case j.AUDIO_TRACK_LOAD_TIMEOUT:case j.LEVEL_PARSING_ERROR:data.levelRetry||this.state!==ta||(null==(t=data.context)?void 0:t.type)!==nr||(this.state=Ji);break;case j.BUFFER_APPEND_ERROR:case j.BUFFER_FULL_ERROR:if(!data.parent||"audio"!==data.parent)return;if(data.details===j.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(data)&&(this.bufferedTrack=null,d(A(r.prototype),"flushMainBuffer",this).call(this,0,Number.POSITIVE_INFINITY,"audio"));break;case j.INTERNAL_EXCEPTION:this.recoverWorkerError(data)}}},{key:"onBufferFlushing",value:function(e,t){t.type!==se&&(this.flushing=!0)}},{key:"onBufferFlushed",value:function(e,t){var r=t.type;if(r!==se){this.flushing=!1,this.bufferFlushed=!0,this.state===aa&&(this.state=Ji);var n=this.mediaBuffer||this.media;n&&(this.afterBufferFlushed(n,r,lr),this.tick())}}},{key:"_handleTransmuxComplete",value:function(e){var t,r="audio",n=this.hls,o=e.remuxResult,l=e.chunkMeta,c=this.getCurrentContext(l);if(c){var h=c.frag,d=c.part,f=c.level,details=f.details,audio=o.audio,text=o.text,v=o.id3,m=o.initSegment;if(!this.fragContextChanged(h)&&details){if(this.state=ra,this.switchingTrack&&audio&&this.completeAudioSwitch(this.switchingTrack),null!=m&&m.tracks){var y=h.initSegment||h;this._bufferInitSegment(f,m.tracks,y,l),n.trigger(V.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:r,tracks:m.tracks})}if(audio){var k=audio.startPTS,E=audio.endPTS,T=audio.startDTS,S=audio.endDTS;d&&(d.elementaryStreams[ne]={startPTS:k,endPTS:E,startDTS:T,endDTS:S}),h.setElementaryStreamInfo(ne,k,E,T,S),this.bufferFragmentData(audio,h,d,l)}if(null!=v&&null!=(t=v.samples)&&t.length){var L=B({id:r,frag:h,details:details},v);n.trigger(V.FRAG_PARSING_METADATA,L)}if(text){var A=B({id:r,frag:h,details:details},text);n.trigger(V.FRAG_PARSING_USERDATA,A)}}else this.fragmentTracker.removeFragment(h)}else this.resetWhenMissingContext(l)}},{key:"_bufferInitSegment",value:function(e,t,r,n){if(this.state===ra){t.video&&delete t.video;var track=t.audio;if(track){track.id="audio";var o=e.audioCodec;this.log("Init audio buffer, container:".concat(track.container,", codecs[level/parsed]=[").concat(o,"/").concat(track.codec,"]")),o&&1===o.split(",").length&&(track.levelCodec=o),this.hls.trigger(V.BUFFER_CODECS,t);var l=track.initSegment;if(null!=l&&l.byteLength){var c={type:"audio",frag:r,part:null,chunkMeta:n,parent:r.type,data:l};this.hls.trigger(V.BUFFER_APPENDING,c)}this.tickImmediate()}}}},{key:"loadFragment",value:function(e,track,t){var n,o=this.fragmentTracker.getState(e);if(this.fragCurrent=e,this.switchingTrack||o===Ri||o===Di)if("initSegment"===e.sn)this._loadInitSegment(e,track);else if(null!=(n=track.details)&&n.live&&!this.initPTS[e.cc]){this.log("Waiting for video PTS in continuity counter ".concat(e.cc," of live stream before loading audio fragment ").concat(e.sn," of level ").concat(this.trackId)),this.state=sa;var l=this.mainDetails;l&&l.fragments[0].start!==track.details.fragments[0].start&&Bi(track.details,l)}else this.startFragRequested=!0,d(A(r.prototype),"loadFragment",this).call(this,e,track,t);else this.clearTrackerIfNeeded(e)}},{key:"flushAudioIfNeeded",value:function(e){var t=this.media,n=this.bufferedTrack,o=null==n?void 0:n.attrs,l=e.attrs;t&&o&&(o.CHANNELS!==l.CHANNELS||n.name!==e.name||n.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),d(A(r.prototype),"flushMainBuffer",this).call(this,0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}},{key:"completeAudioSwitch",value:function(e){var t=this.hls;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(V.AUDIO_TRACK_SWITCHED,O({},e))}}]),r}(la),bn=function(e){y(r,e);var t=E(r);function r(e){var n;return D(this,r),(n=t.call(this,e,"[audio-track-controller]")).tracks=[],n.groupIds=null,n.tracksInGroup=[],n.trackId=-1,n.currentTrack=null,n.selectDefaultTrack=!0,n.registerListeners(),n}return I(r,[{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.LEVEL_LOADING,this.onLevelLoading,this),e.on(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(V.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(V.ERROR,this.onError,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.LEVEL_LOADING,this.onLevelLoading,this),e.off(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(V.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(V.ERROR,this.onError,this)}},{key:"destroy",value:function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,d(A(r.prototype),"destroy",this).call(this)}},{key:"onManifestLoading",value:function(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}},{key:"onManifestParsed",value:function(e,data){this.tracks=data.audioTracks||[]}},{key:"onAudioTrackLoaded",value:function(e,data){var t=data.id,r=data.groupId,details=data.details,n=this.tracksInGroup[t];if(n&&n.groupId===r){var o=n.details;n.details=data.details,this.log("Audio track ".concat(t,' "').concat(n.name,'" lang:').concat(n.lang," group:").concat(r," loaded [").concat(details.startSN,"-").concat(details.endSN,"]")),t===this.trackId&&this.playlistLoaded(t,data,o)}else this.warn("Audio track with id:".concat(t," and group:").concat(r," not found in active group ").concat(null==n?void 0:n.groupId))}},{key:"onLevelLoading",value:function(e,data){this.switchLevel(data.level)}},{key:"onLevelSwitching",value:function(e,data){this.switchLevel(data.level)}},{key:"switchLevel",value:function(e){var t=this.hls.levels[e];if(t){var r=t.audioGroups||null,n=this.groupIds,o=this.currentTrack;if(!r||(null==n?void 0:n.length)!==(null==r?void 0:r.length)||null!=r&&r.some((function(e){return-1===(null==n?void 0:n.indexOf(e))}))){this.groupIds=r,this.trackId=-1,this.currentTrack=null;var l=this.tracks.filter((function(track){return!r||-1!==r.indexOf(track.groupId)}));if(l.length)this.selectDefaultTrack&&!l.some((function(track){return track.default}))&&(this.selectDefaultTrack=!1),l.forEach((function(track,i){track.id=i}));else if(!o&&!this.tracksInGroup.length)return;this.tracksInGroup=l;var c=this.hls.config.audioPreference;if(!o&&c){var h=ki(c,l,Ti);if(h>-1)o=l[h];else{var d=ki(c,this.tracks);o=this.tracks[d]}}var f=this.findTrackId(o);-1===f&&o&&(f=this.findTrackId(null));var v={audioTracks:l};this.log("Updating audio tracks, ".concat(l.length," track(s) found in group(s): ").concat(null==r?void 0:r.join(","))),this.hls.trigger(V.AUDIO_TRACKS_UPDATED,v);var m=this.trackId;if(-1!==f&&-1===m)this.setAudioTrack(f);else if(l.length&&-1===m){var y,k=new Error("No audio track selected for current audio group-ID(s): ".concat(null==(y=this.groupIds)?void 0:y.join(",")," track count: ").concat(l.length));this.warn(k.message),this.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:k})}}else this.shouldReloadPlaylist(o)&&this.setAudioTrack(this.trackId)}}},{key:"onError",value:function(e,data){!data.fatal&&data.context&&(data.context.type!==nr||data.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(data.context.groupId)||(this.requestScheduled=-1,this.checkRetry(data)))}},{key:"allAudioTracks",get:function(){return this.tracks}},{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}},{key:"setAudioOption",value:function(e){var t=this.hls;if(t.config.audioPreference=e,e){var r=this.allAudioTracks;if(this.selectDefaultTrack=!1,r.length){var n=this.currentTrack;if(n&&Ei(e,n,Ti))return n;var o=ki(e,this.tracksInGroup,Ti);if(o>-1){var track=this.tracksInGroup[o];return this.setAudioTrack(o),track}if(n){var l=t.loadLevel;-1===l&&(l=t.firstAutoLevel);var c=function(option,e,t,r,n){var o=e[r],l=e.reduce((function(e,t,r){var n=t.uri;return(e[n]||(e[n]=[])).push(r),e}),{})[o.uri];l.length>1&&(r=Math.max.apply(Math,l));var c=o.videoRange,h=o.frameRate,d=o.codecSet.substring(0,4),f=Si(e,r,(function(e){if(e.videoRange!==c||e.frameRate!==h||e.codecSet.substring(0,4)!==d)return!1;var r=e.audioGroups,o=t.filter((function(track){return!r||-1!==r.indexOf(track.groupId)}));return ki(option,o,n)>-1}));return f>-1?f:Si(e,r,(function(e){var r=e.audioGroups,o=t.filter((function(track){return!r||-1!==r.indexOf(track.groupId)}));return ki(option,o,n)>-1}))}(e,t.levels,r,l,Ti);if(-1===c)return null;t.nextLoadLevel=c}if(e.channels||e.audioCodec){var h=ki(e,r);if(h>-1)return r[h]}}}return null}},{key:"setAudioTrack",value:function(e){var t=this.tracksInGroup;if(e<0||e>=t.length)this.warn("Invalid audio track id: ".concat(e));else{this.clearTimer(),this.selectDefaultTrack=!1;var r=this.currentTrack,track=t[e],n=track.details&&!track.details.live;if(!(e===this.trackId&&track===r&&n||(this.log("Switching to audio-track ".concat(e,' "').concat(track.name,'" lang:').concat(track.lang," group:").concat(track.groupId," channels:").concat(track.channels)),this.trackId=e,this.currentTrack=track,this.hls.trigger(V.AUDIO_TRACK_SWITCHING,O({},track)),n))){var o=this.switchParams(track.url,null==r?void 0:r.details,track.details);this.loadPlaylist(o)}}}},{key:"findTrackId",value:function(e){for(var t=this.tracksInGroup,i=0;i<t.length;i++){var track=t[i];if((!this.selectDefaultTrack||track.default)&&(!e||Ei(e,track,Ti)))return i}if(e){for(var r=e.name,n=e.lang,o=e.assocLang,l=e.characteristics,c=e.audioCodec,h=e.channels,d=0;d<t.length;d++){if(Ei({name:r,lang:n,assocLang:o,characteristics:l,audioCodec:c,channels:h},t[d],Ti))return d}for(var f=0;f<t.length;f++){var v=t[f];if(Ln(e.attrs,v.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return f}for(var m=0;m<t.length;m++){var y=t[m];if(Ln(e.attrs,y.attrs,["LANGUAGE"]))return m}}return-1}},{key:"loadPlaylist",value:function(e){var t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){d(A(r.prototype),"loadPlaylist",this).call(this);var n=t.id,o=t.groupId,l=t.url;if(e)try{l=e.addDirectives(l)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(e))}this.log("loading audio-track playlist ".concat(n,' "').concat(t.name,'" lang:').concat(t.lang," group:").concat(o)),this.clearTimer(),this.hls.trigger(V.AUDIO_TRACK_LOADING,{url:l,id:n,groupId:o,deliveryDirectives:e||null})}}}]),r}(hi),Dn=function(e){y(r,e);var t=E(r);function r(e,n,o){var l;return D(this,r),(l=t.call(this,e,n,o,"[subtitle-stream-controller]",ur)).currentTrackId=-1,l.tracksBuffered=[],l.mainDetails=null,l._registerListeners(),l}return I(r,[{key:"onHandlerDestroying",value:function(){this._unregisterListeners(),d(A(r.prototype),"onHandlerDestroying",this).call(this),this.mainDetails=null}},{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.LEVEL_LOADED,this.onLevelLoaded,this),e.on(V.ERROR,this.onError,this),e.on(V.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(V.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(V.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(V.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.LEVEL_LOADED,this.onLevelLoaded,this),e.off(V.ERROR,this.onError,this),e.off(V.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(V.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(V.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(V.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"startLoad",value:function(e){this.stopLoad(),this.state=Ji,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}},{key:"onManifestLoading",value:function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}},{key:"onMediaDetaching",value:function(){this.tracksBuffered=[],d(A(r.prototype),"onMediaDetaching",this).call(this)}},{key:"onLevelLoaded",value:function(e,data){this.mainDetails=data.details}},{key:"onSubtitleFragProcessed",value:function(e,data){var t=data.frag,r=data.success;if(this.fragPrevious=t,this.state=Ji,r){var n=this.tracksBuffered[this.currentTrackId];if(n){for(var o,l=t.start,i=0;i<n.length;i++)if(l>=n[i].start&&l<=n[i].end){o=n[i];break}var c=t.start+t.duration;o?o.end=c:(o={start:l,end:c},n.push(o)),this.fragmentTracker.fragBuffered(t),this.fragBufferedComplete(t,null)}}}},{key:"onBufferFlushing",value:function(e,data){var t=data.startOffset,r=data.endOffset;if(0===t&&r!==Number.POSITIVE_INFINITY){var n=r-1;if(n<=0)return;data.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach((function(e){for(var i=0;i<e.length;)if(e[i].end<=n)e.shift();else{if(!(e[i].start<n))break;e[i].start=n,i++}})),this.fragmentTracker.removeFragmentsInRange(t,n,ur)}}},{key:"onFragBuffered",value:function(e,data){var t;this.loadedmetadata||data.frag.type!==or||null!=(t=this.media)&&t.buffered.length&&(this.loadedmetadata=!0)}},{key:"onError",value:function(e,data){var t=data.frag;(null==t?void 0:t.type)===ur&&(data.details===j.FRAG_GAP&&this.fragmentTracker.fragBuffered(t,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==Qi&&(this.state=Ji))}},{key:"onSubtitleTracksUpdated",value:function(e,t){var r=this,n=t.subtitleTracks;this.levels&&Sn(this.levels,n)?this.levels=n.map((function(e){return new Or(e)})):(this.tracksBuffered=[],this.levels=n.map((function(e){var t=new Or(e);return r.tracksBuffered[t.id]=[],t})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,ur),this.fragPrevious=null,this.mediaBuffer=null)}},{key:"onSubtitleTrackSwitch",value:function(e,data){var t;if(this.currentTrackId=data.id,null!=(t=this.levels)&&t.length&&-1!==this.currentTrackId){var r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(500)}else this.clearInterval()}},{key:"onSubtitleTrackLoaded",value:function(e,data){var t,r=this.currentTrackId,n=this.levels,o=data.details,l=data.id;if(n){var track=n[l];if(!(l>=n.length)&&track){this.log("Subtitle track ".concat(l," loaded [").concat(o.startSN,",").concat(o.endSN,"]").concat(o.lastPartSn?"[part-".concat(o.lastPartSn,"-").concat(o.lastPartIndex,"]"):"",",duration:").concat(o.totalduration)),this.mediaBuffer=this.mediaBufferTimeRanges;var c=0;if(o.live||null!=(t=track.details)&&t.live){var h=this.mainDetails;if(o.deltaUpdateFailed||!h)return;var d,f=h.fragments[0];if(track.details)0===(c=this.alignPlaylists(o,track.details,null==(d=this.levelLastLoaded)?void 0:d.details))&&f&&Hr(o,c=f.start);else o.hasProgramDateTime&&h.hasProgramDateTime?(Bi(o,h),c=o.fragments[0].start):f&&Hr(o,c=f.start)}if(track.details=o,this.levelLastLoaded=track,l===r)if(this.startFragRequested||!this.mainDetails&&o.live||this.setStartPosition(this.mainDetails||o,c),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===Ji)$r(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),track.details=void 0)}}else this.warn("Subtitle tracks were reset while loading level ".concat(l))}},{key:"_handleFragmentLoadComplete",value:function(e){var t=this,r=e.frag,n=e.payload,o=r.decryptdata,l=this.hls;if(!this.fragContextChanged(r)&&n&&n.byteLength>0&&null!=o&&o.key&&o.iv&&"AES-128"===o.method){var c=performance.now();this.decrypter.decrypt(new Uint8Array(n),o.key.buffer,o.iv.buffer).catch((function(e){throw l.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:r}),e})).then((function(e){var t=performance.now();l.trigger(V.FRAG_DECRYPTED,{frag:r,payload:e,stats:{tstart:c,tdecrypt:t}})})).catch((function(e){t.warn("".concat(e.name,": ").concat(e.message)),t.state=Ji}))}}},{key:"doTick",value:function(){if(this.media){if(this.state===Ji){var e=this.currentTrackId,t=this.levels,track=null==t?void 0:t[e];if(!track||!t.length||!track.details)return;var r=this.config,n=this.getLoadPosition(),o=Pi.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,r.maxBufferHole),l=o.end,c=o.len,h=this.getFwdBufferInfo(this.media,or),d=track.details;if(c>this.getMaxBufferLength(null==h?void 0:h.len)+d.levelTargetDuration)return;var f=d.fragments,v=f.length,m=d.edge,y=null,k=this.fragPrevious;if(l<m){var E=r.maxFragLookUpTolerance,T=l>m-E?0:E;!(y=$r(k,f,Math.max(f[0].start,l),T))&&k&&k.start<f[0].start&&(y=f[0])}else y=f[v-1];if(!y)return;if("initSegment"!==(y=this.mapToInitFragWhenRequired(y)).sn){var S=f[y.sn-d.startSN-1];S&&S.cc===y.cc&&this.fragmentTracker.getState(S)===Ri&&(y=S)}this.fragmentTracker.getState(y)===Ri&&this.loadFragment(y,track,l)}}else this.state=Ji}},{key:"getMaxBufferLength",value:function(e){var t=d(A(r.prototype),"getMaxBufferLength",this).call(this);return e?Math.max(t,e):t}},{key:"loadFragment",value:function(e,t,n){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,d(A(r.prototype),"loadFragment",this).call(this,e,t,n))}},{key:"mediaBufferTimeRanges",get:function(){return new wn(this.tracksBuffered[this.currentTrackId]||[])}}]),r}(la),wn=I((function e(t){D(this,e),this.buffered=void 0;var r=function(e,r,n){if((r>>>=0)>n-1)throw new DOMException("Failed to execute '".concat(e,"' on 'TimeRanges': The index provided (").concat(r,") is greater than the maximum bound (").concat(n,")"));return t[r][e]};this.buffered={get length(){return t.length},end:function(e){return r("end",e,t.length)},start:function(e){return r("start",e,t.length)}}})),In=function(e){y(r,e);var t=E(r);function r(e){var n;return D(this,r),(n=t.call(this,e,"[subtitle-track-controller]")).media=null,n.tracks=[],n.groupIds=null,n.tracksInGroup=[],n.trackId=-1,n.currentTrack=null,n.selectDefaultTrack=!0,n.queuedDefaultTrack=-1,n.asyncPollTrackChange=function(){return n.pollTrackChange(0)},n.useTextTrackPolling=!1,n.subtitlePollingInterval=-1,n._subtitleDisplay=!0,n.onTextTracksChanged=function(){if(n.useTextTrackPolling||self.clearInterval(n.subtitlePollingInterval),n.media&&n.hls.config.renderTextTracksNatively){for(var e=null,t=pr(n.media.textTracks),i=0;i<t.length;i++)if("hidden"===t[i].mode)e=t[i];else if("showing"===t[i].mode){e=t[i];break}var r=n.findTrackForTextTrack(e);n.subtitleTrack!==r&&n.setSubtitleTrack(r)}},n.registerListeners(),n}return I(r,[{key:"destroy",value:function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,d(A(r.prototype),"destroy",this).call(this)}},{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}},{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.LEVEL_LOADING,this.onLevelLoading,this),e.on(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(V.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(V.ERROR,this.onError,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.LEVEL_LOADING,this.onLevelLoading,this),e.off(V.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(V.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(V.ERROR,this.onError,this)}},{key:"onMediaAttached",value:function(e,data){this.media=data.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}},{key:"pollTrackChange",value:function(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}},{key:"onMediaDetaching",value:function(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),pr(this.media.textTracks).forEach((function(track){mr(track)})),this.subtitleTrack=-1,this.media=null)}},{key:"onManifestLoading",value:function(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}},{key:"onManifestParsed",value:function(e,data){this.tracks=data.subtitleTracks}},{key:"onSubtitleTrackLoaded",value:function(e,data){var t=data.id,r=data.groupId,details=data.details,n=this.tracksInGroup[t];if(n&&n.groupId===r){var o=n.details;n.details=data.details,this.log("Subtitle track ".concat(t,' "').concat(n.name,'" lang:').concat(n.lang," group:").concat(r," loaded [").concat(details.startSN,"-").concat(details.endSN,"]")),t===this.trackId&&this.playlistLoaded(t,data,o)}else this.warn("Subtitle track with id:".concat(t," and group:").concat(r," not found in active group ").concat(null==n?void 0:n.groupId))}},{key:"onLevelLoading",value:function(e,data){this.switchLevel(data.level)}},{key:"onLevelSwitching",value:function(e,data){this.switchLevel(data.level)}},{key:"switchLevel",value:function(e){var t=this.hls.levels[e];if(t){var r=t.subtitleGroups||null,n=this.groupIds,o=this.currentTrack;if(!r||(null==n?void 0:n.length)!==(null==r?void 0:r.length)||null!=r&&r.some((function(e){return-1===(null==n?void 0:n.indexOf(e))}))){this.groupIds=r,this.trackId=-1,this.currentTrack=null;var l=this.tracks.filter((function(track){return!r||-1!==r.indexOf(track.groupId)}));if(l.length)this.selectDefaultTrack&&!l.some((function(track){return track.default}))&&(this.selectDefaultTrack=!1),l.forEach((function(track,i){track.id=i}));else if(!o&&!this.tracksInGroup.length)return;this.tracksInGroup=l;var c=this.hls.config.subtitlePreference;if(!o&&c){this.selectDefaultTrack=!1;var h=ki(c,l);if(h>-1)o=l[h];else{var d=ki(c,this.tracks);o=this.tracks[d]}}var f=this.findTrackId(o);-1===f&&o&&(f=this.findTrackId(null));var v={subtitleTracks:l};this.log("Updating subtitle tracks, ".concat(l.length,' track(s) found in "').concat(null==r?void 0:r.join(","),'" group-id')),this.hls.trigger(V.SUBTITLE_TRACKS_UPDATED,v),-1!==f&&-1===this.trackId&&this.setSubtitleTrack(f)}else this.shouldReloadPlaylist(o)&&this.setSubtitleTrack(this.trackId)}}},{key:"findTrackId",value:function(e){for(var t=this.tracksInGroup,r=this.selectDefaultTrack,i=0;i<t.length;i++){var track=t[i];if((!r||track.default)&&(r||e)&&(!e||Ei(track,e)))return i}if(e){for(var n=0;n<t.length;n++){var o=t[n];if(Ln(e.attrs,o.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(var l=0;l<t.length;l++){var c=t[l];if(Ln(e.attrs,c.attrs,["LANGUAGE"]))return l}}return-1}},{key:"findTrackForTextTrack",value:function(e){if(e)for(var t=this.tracksInGroup,i=0;i<t.length;i++){if(An(t[i],e))return i}return-1}},{key:"onError",value:function(e,data){!data.fatal&&data.context&&(data.context.type!==sr||data.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(data.context.groupId)||this.checkRetry(data))}},{key:"allSubtitleTracks",get:function(){return this.tracks}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}},{key:"setSubtitleOption",value:function(e){if(this.hls.config.subtitlePreference=e,e){var t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){var r=this.currentTrack;if(r&&Ei(e,r))return r;var n=ki(e,this.tracksInGroup);if(n>-1){var track=this.tracksInGroup[n];return this.setSubtitleTrack(n),track}if(r)return null;var o=ki(e,t);if(o>-1)return t[o]}}return null}},{key:"loadPlaylist",value:function(e){d(A(r.prototype),"loadPlaylist",this).call(this);var t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){var n=t.id,o=t.groupId,l=t.url;if(e)try{l=e.addDirectives(l)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(e))}this.log("Loading subtitle playlist for id ".concat(n)),this.hls.trigger(V.SUBTITLE_TRACK_LOADING,{url:l,id:n,groupId:o,deliveryDirectives:e||null})}}},{key:"toggleTrackModes",value:function(){var e=this.media;if(e){var t,r=pr(e.textTracks),n=this.currentTrack;if(n&&((t=r.filter((function(e){return An(n,e)}))[0])||this.warn('Unable to find subtitle TextTrack with name "'.concat(n.name,'" and language "').concat(n.lang,'"'))),[].slice.call(r).forEach((function(track){"disabled"!==track.mode&&track!==t&&(track.mode="disabled")})),t){var o=this.subtitleDisplay?"showing":"hidden";t.mode!==o&&(t.mode=o)}}}},{key:"setSubtitleTrack",value:function(e){var t=this.tracksInGroup;if(this.media)if(e<-1||e>=t.length||!G(e))this.warn("Invalid subtitle track id: ".concat(e));else{this.clearTimer(),this.selectDefaultTrack=!1;var r=this.currentTrack,track=t[e]||null;if(this.trackId=e,this.currentTrack=track,this.toggleTrackModes(),track){var n=!!track.details&&!track.details.live;if(e!==this.trackId||track!==r||!n){this.log("Switching to subtitle-track ".concat(e)+(track?' "'.concat(track.name,'" lang:').concat(track.lang," group:").concat(track.groupId):""));var o=track.id,l=track.groupId,c=void 0===l?"":l,h=track.name,d=track.type,f=track.url;this.hls.trigger(V.SUBTITLE_TRACK_SWITCH,{id:o,groupId:c,name:h,type:d,url:f});var v=this.switchParams(track.url,null==r?void 0:r.details,track.details);this.loadPlaylist(v)}}else this.hls.trigger(V.SUBTITLE_TRACK_SWITCH,{id:e})}else this.queuedDefaultTrack=e}}]),r}(hi),Cn=function(){function e(t){D(this,e),this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}return I(e,[{key:"append",value:function(e,t,r){var n=this.queues[t];n.push(e),1!==n.length||r||this.executeNext(t)}},{key:"insertAbort",value:function(e,t){this.queues[t].unshift(e),this.executeNext(t)}},{key:"appendBlocker",value:function(e){var t,r=new Promise((function(e){t=e})),n={execute:t,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(n,e),r}},{key:"executeNext",value:function(e){var t=this.queues[e];if(t.length){var r=t[0];try{r.execute()}catch(t){$.warn('[buffer-operation-queue]: Exception executing "'.concat(e,'" SourceBuffer operation: ').concat(t)),r.onError(t);var n=this.buffers[e];null!=n&&n.updating||this.shiftAndExecuteNext(e)}}}},{key:"shiftAndExecuteNext",value:function(e){this.queues[e].shift(),this.executeNext(e)}},{key:"current",value:function(e){return this.queues[e][0]}}]),e}(),_n=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,xn=function(){function e(t){var r=this;D(this,e),this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=function(e){r.hls&&r.hls.pauseBuffering()},this._onStartStreaming=function(e){r.hls&&r.hls.resumeBuffering()},this._onMediaSourceOpen=function(){var e=r.media,t=r.mediaSource;r.log("Media source opened"),e&&(e.removeEventListener("emptied",r._onMediaEmptied),r.updateMediaElementDuration(),r.hls.trigger(V.MEDIA_ATTACHED,{media:e,mediaSource:t})),t&&t.removeEventListener("sourceopen",r._onMediaSourceOpen),r.checkPendingTracks()},this._onMediaSourceClose=function(){r.log("Media source closed")},this._onMediaSourceEnded=function(){r.log("Media source ended")},this._onMediaEmptied=function(){var e=r.mediaSrc,t=r._objectUrl;e!==t&&$.error("Media element src was set while attaching MediaSource (".concat(t," > ").concat(e,")"))},this.hls=t;var source,n="[buffer-controller]";this.appendSource=(source=_t(t.config.preferManagedMediaSource),"undefined"!=typeof self&&source===self.ManagedMediaSource),this.log=$.log.bind($,n),this.warn=$.warn.bind($,n),this.error=$.error.bind($,n),this._initSourceBuffer(),this.registerListeners()}return I(e,[{key:"hasSourceTypes",value:function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}},{key:"destroy",value:function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}},{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.BUFFER_RESET,this.onBufferReset,this),e.on(V.BUFFER_APPENDING,this.onBufferAppending,this),e.on(V.BUFFER_CODECS,this.onBufferCodecs,this),e.on(V.BUFFER_EOS,this.onBufferEos,this),e.on(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(V.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(V.FRAG_PARSED,this.onFragParsed,this),e.on(V.FRAG_CHANGED,this.onFragChanged,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.BUFFER_RESET,this.onBufferReset,this),e.off(V.BUFFER_APPENDING,this.onBufferAppending,this),e.off(V.BUFFER_CODECS,this.onBufferCodecs,this),e.off(V.BUFFER_EOS,this.onBufferEos,this),e.off(V.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(V.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(V.FRAG_PARSED,this.onFragParsed,this),e.off(V.FRAG_CHANGED,this.onFragChanged,this)}},{key:"_initSourceBuffer",value:function(){this.sourceBuffer={},this.operationQueue=new Cn(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}},{key:"onManifestLoading",value:function(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}},{key:"onManifestParsed",value:function(e,data){var t=2;(data.audio&&!data.video||!data.altAudio)&&(t=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=t,this.log("".concat(this.bufferCodecEventsExpected," bufferCodec event(s) expected"))}},{key:"onMediaAttaching",value:function(e,data){var t=this.media=data.media,r=_t(this.appendSource);if(t&&r){var n,o=this.mediaSource=new r;this.log("created media source: ".concat(null==(n=o.constructor)?void 0:n.name)),o.addEventListener("sourceopen",this._onMediaSourceOpen),o.addEventListener("sourceended",this._onMediaSourceEnded),o.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(o.addEventListener("startstreaming",this._onStartStreaming),o.addEventListener("endstreaming",this._onEndStreaming));var l=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{t.removeAttribute("src");var c=self.ManagedMediaSource;t.disableRemotePlayback=t.disableRemotePlayback||c&&o instanceof c,Pn(t),function(e,t){var source=self.document.createElement("source");source.type="video/mp4",source.src=t,e.appendChild(source)}(t,l),t.load()}catch(e){t.src=l}else t.src=l;t.addEventListener("emptied",this._onMediaEmptied)}}},{key:"onMediaDetaching",value:function(){var e=this.media,t=this.mediaSource,r=this._objectUrl;if(t){if(this.log("media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(e){this.warn("onMediaDetaching: ".concat(e.message," while calling endOfStream"))}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),r&&self.URL.revokeObjectURL(r),this.mediaSrc===r?(e.removeAttribute("src"),this.appendSource&&Pn(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(V.MEDIA_DETACHED,void 0)}},{key:"onBufferReset",value:function(){var e=this;this.getSourceBufferTypes().forEach((function(t){e.resetBuffer(t)})),this._initSourceBuffer()}},{key:"resetBuffer",value:function(e){var t=this.sourceBuffer[e];try{var r;if(t)this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,null!=(r=this.mediaSource)&&r.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}catch(t){this.warn("onBufferReset ".concat(e),t)}}},{key:"onBufferCodecs",value:function(e,data){var t=this,r=this.getSourceBufferTypes().length,n=Object.keys(data);if(n.forEach((function(e){if(r){var track=t.tracks[e];if(track&&"function"==typeof track.buffer.changeType){var n,o=data[e],l=o.id,c=o.codec,h=o.levelCodec,d=o.container,f=o.metadata,v=Ht(track.codec,track.levelCodec),m=null==v?void 0:v.replace(_n,"$1"),y=Ht(c,h),k=null==(n=y)?void 0:n.replace(_n,"$1");if(y&&m!==k){"audio"===e.slice(0,5)&&(y=Kt(y,t.appendSource));var E="".concat(d,";codecs=").concat(y);t.appendChangeType(e,E),t.log("switching codec ".concat(v," to ").concat(y)),t.tracks[e]={buffer:track.buffer,codec:c,container:d,levelCodec:h,metadata:f,id:l}}}}else t.pendingTracks[e]=data[e]})),!r){var o=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==o&&(this.log("".concat(o," bufferCodec event(s) expected ").concat(n.join(","))),this.bufferCodecEventsExpected=o),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}}},{key:"appendChangeType",value:function(e,t){var r=this,n=this.operationQueue,o={execute:function(){var o=r.sourceBuffer[e];o&&(r.log("changing ".concat(e," sourceBuffer type to ").concat(t)),o.changeType(t)),n.shiftAndExecuteNext(e)},onStart:function(){},onComplete:function(){},onError:function(t){r.warn("Failed to change ".concat(e," SourceBuffer type"),t)}};n.append(o,e,!!this.pendingTracks[e])}},{key:"onBufferAppending",value:function(e,t){var r=this,n=this.hls,o=this.operationQueue,l=this.tracks,data=t.data,c=t.type,h=t.frag,d=t.part,f=t.chunkMeta,v=f.buffering[c],m=self.performance.now();v.start=m;var y=h.stats.buffering,k=d?d.stats.buffering:null;0===y.start&&(y.start=m),k&&0===k.start&&(k.start=m);var E=l.audio,T=!1;"audio"===c&&"audio/mpeg"===(null==E?void 0:E.container)&&(T=!this.lastMpegAudioChunk||1===f.id||this.lastMpegAudioChunk.sn!==f.sn,this.lastMpegAudioChunk=f);var S=h.start,L={execute:function(){if(v.executeStart=self.performance.now(),T){var e=r.sourceBuffer[c];if(e){var t=S-e.timestampOffset;Math.abs(t)>=.1&&(r.log("Updating audio SourceBuffer timestampOffset to ".concat(S," (delta: ").concat(t,") sn: ").concat(h.sn,")")),e.timestampOffset=S)}}r.appendExecutor(data,c)},onStart:function(){},onComplete:function(){var e=self.performance.now();v.executeEnd=v.end=e,0===y.first&&(y.first=e),k&&0===k.first&&(k.first=e);var t=r.sourceBuffer,n={};for(var o in t)n[o]=Pi.getBuffered(t[o]);r.appendErrors[c]=0,"audio"===c||"video"===c?r.appendErrors.audiovideo=0:(r.appendErrors.audio=0,r.appendErrors.video=0),r.hls.trigger(V.BUFFER_APPENDED,{type:c,frag:h,part:d,chunkMeta:f,parent:h.type,timeRanges:n})},onError:function(e){var t={type:Y.MEDIA_ERROR,parent:h.type,details:j.BUFFER_APPEND_ERROR,sourceBufferName:c,frag:h,part:d,chunkMeta:f,error:e,err:e,fatal:!1};if(e.code===DOMException.QUOTA_EXCEEDED_ERR)t.details=j.BUFFER_FULL_ERROR;else{var o=++r.appendErrors[c];t.details=j.BUFFER_APPEND_ERROR,r.warn("Failed ".concat(o,"/").concat(n.config.appendErrorMaxRetry,' times to append segment in "').concat(c,'" sourceBuffer')),o>=n.config.appendErrorMaxRetry&&(t.fatal=!0)}n.trigger(V.ERROR,t)}};o.append(L,c,!!this.pendingTracks[c])}},{key:"onBufferFlushing",value:function(e,data){var t=this,r=this.operationQueue,n=function(e){return{execute:t.removeExecutor.bind(t,e,data.startOffset,data.endOffset),onStart:function(){},onComplete:function(){t.hls.trigger(V.BUFFER_FLUSHED,{type:e})},onError:function(r){t.warn("Failed to remove from ".concat(e," SourceBuffer"),r)}}};data.type?r.append(n(data.type),data.type):this.getSourceBufferTypes().forEach((function(e){r.append(n(e),e)}))}},{key:"onFragParsed",value:function(e,data){var t=this,r=data.frag,n=data.part,o=[],l=n?n.elementaryStreams:r.elementaryStreams;l[oe]?o.push("audiovideo"):(l[ne]&&o.push("audio"),l[se]&&o.push("video"));0===o.length&&this.warn("Fragments must have at least one ElementaryStreamType set. type: ".concat(r.type," level: ").concat(r.level," sn: ").concat(r.sn)),this.blockBuffers((function(){var e=self.performance.now();r.stats.buffering.end=e,n&&(n.stats.buffering.end=e);var o=n?n.stats:r.stats;t.hls.trigger(V.FRAG_BUFFERED,{frag:r,part:n,stats:o,id:r.type})}),o)}},{key:"onFragChanged",value:function(e,data){this.trimBuffers()}},{key:"onBufferEos",value:function(e,data){var t=this;this.getSourceBufferTypes().reduce((function(e,r){var n=t.sourceBuffer[r];return!n||data.type&&data.type!==r||(n.ending=!0,n.ended||(n.ended=!0,t.log("".concat(r," sourceBuffer now EOS")))),e&&!(n&&!n.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((function(){t.getSourceBufferTypes().forEach((function(e){var r=t.sourceBuffer[e];r&&(r.ending=!1)}));var e=t.mediaSource;e&&"open"===e.readyState?(t.log("Calling mediaSource.endOfStream()"),e.endOfStream()):e&&t.log("Could not call mediaSource.endOfStream(). mediaSource.readyState: ".concat(e.readyState))})))}},{key:"onLevelUpdated",value:function(e,t){var details=t.details;details.fragments.length&&(this.details=details,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}},{key:"trimBuffers",value:function(){var e=this.hls,details=this.details,t=this.media;if(t&&null!==details&&this.getSourceBufferTypes().length){var r=e.config,n=t.currentTime,o=details.levelTargetDuration,l=details.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(G(l)&&l>0){var c=Math.max(l,o),h=Math.floor(n/o)*o-c;this.flushBackBuffer(n,o,h)}if(G(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){var d=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),f=Math.max(d,o),v=Math.floor(n/o)*o+f;this.flushFrontBuffer(n,o,v)}}}},{key:"flushBackBuffer",value:function(e,t,r){var n=this,details=this.details,o=this.sourceBuffer;this.getSourceBufferTypes().forEach((function(l){var c=o[l];if(c){var h=Pi.getBuffered(c);if(h.length>0&&r>h.start(0)){if(n.hls.trigger(V.BACK_BUFFER_REACHED,{bufferEnd:r}),null!=details&&details.live)n.hls.trigger(V.LIVE_BACK_BUFFER_REACHED,{bufferEnd:r});else if(c.ended&&h.end(h.length-1)-e<2*t)return void n.log("Cannot flush ".concat(l," back buffer while SourceBuffer is in ended state"));n.hls.trigger(V.BUFFER_FLUSHING,{startOffset:0,endOffset:r,type:l})}}}))}},{key:"flushFrontBuffer",value:function(e,t,r){var n=this,o=this.sourceBuffer;this.getSourceBufferTypes().forEach((function(l){var c=o[l];if(c){var h=Pi.getBuffered(c),d=h.length;if(d<2)return;var f=h.start(d-1),v=h.end(d-1);if(r>f||e>=f&&e<=v)return;if(c.ended&&e-v<2*t)return void n.log("Cannot flush ".concat(l," front buffer while SourceBuffer is in ended state"));n.hls.trigger(V.BUFFER_FLUSHING,{startOffset:f,endOffset:1/0,type:l})}}))}},{key:"updateMediaElementDuration",value:function(){if(this.details&&this.media&&this.mediaSource&&"open"===this.mediaSource.readyState){var details=this.details,e=this.hls,t=this.media,r=this.mediaSource,n=details.fragments[0].start+details.totalduration,o=t.duration,l=G(r.duration)?r.duration:0;details.live&&e.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(details)):(n>l&&n>o||!G(o))&&(this.log("Updating Media Source duration to ".concat(n.toFixed(3))),r.duration=n)}}},{key:"updateSeekableRange",value:function(e){var t=this.mediaSource,r=e.fragments;if(r.length&&e.live&&null!=t&&t.setLiveSeekableRange){var n=Math.max(0,r[0].start),o=Math.max(n,n+e.totalduration);this.log("Media Source duration is set to ".concat(t.duration,". Setting seekable range to ").concat(n,"-").concat(o,".")),t.setLiveSeekableRange(n,o)}}},{key:"checkPendingTracks",value:function(){var e=this.bufferCodecEventsExpected,t=this.operationQueue,r=this.pendingTracks,n=Object.keys(r).length;if(n&&(!e||2===n||"audiovideo"in r)){this.createSourceBuffers(r),this.pendingTracks={};var o=this.getSourceBufferTypes();if(o.length)this.hls.trigger(V.BUFFER_CREATED,{tracks:this.tracks}),o.forEach((function(e){t.executeNext(e)}));else{var l=new Error("could not create source buffer for media codec(s)");this.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:l,reason:l.message})}}}},{key:"createSourceBuffers",value:function(e){var t=this,r=this.sourceBuffer,n=this.mediaSource;if(!n)throw Error("createSourceBuffers called when mediaSource was null");var o=function(o){if(!r[o]){var track=e[o];if(!track)throw Error("source buffer exists for track ".concat(o,", however track does not"));var l=-1===(null==(c=track.levelCodec)?void 0:c.indexOf(","))?track.levelCodec:track.codec;l&&"audio"===o.slice(0,5)&&(l=Kt(l,t.appendSource));var h="".concat(track.container,";codecs=").concat(l);t.log("creating sourceBuffer(".concat(h,")"));try{var d=r[o]=n.addSourceBuffer(h),f=o;t.addBufferListener(f,"updatestart",t._onSBUpdateStart),t.addBufferListener(f,"updateend",t._onSBUpdateEnd),t.addBufferListener(f,"error",t._onSBUpdateError),t.appendSource&&t.addBufferListener(f,"bufferedchange",(function(e,r){var n=r.removedRanges;null!=n&&n.length&&t.hls.trigger(V.BUFFER_FLUSHED,{type:o})})),t.tracks[o]={buffer:d,codec:l,container:track.container,levelCodec:track.levelCodec,metadata:track.metadata,id:track.id}}catch(e){t.error("error while trying to add sourceBuffer: ".concat(e.message)),t.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:o,mimeType:h})}}};for(var l in e){var c;o(l)}}},{key:"mediaSrc",get:function(){var e,t,r=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==r?void 0:r.src}},{key:"_onSBUpdateStart",value:function(e){this.operationQueue.current(e).onStart()}},{key:"_onSBUpdateEnd",value:function(e){var t;if("closed"!==(null==(t=this.mediaSource)?void 0:t.readyState)){var r=this.operationQueue;r.current(e).onComplete(),r.shiftAndExecuteNext(e)}else this.resetBuffer(e)}},{key:"_onSBUpdateError",value:function(e,t){var r,n=new Error("".concat(e," SourceBuffer error. MediaSource readyState: ").concat(null==(r=this.mediaSource)?void 0:r.readyState));this.error("".concat(n),t),this.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});var o=this.operationQueue.current(e);o&&o.onError(n)}},{key:"removeExecutor",value:function(e,t,r){var n=this.media,o=this.mediaSource,l=this.operationQueue,c=this.sourceBuffer[e];if(!n||!o||!c)return this.warn("Attempting to remove from the ".concat(e," SourceBuffer, but it does not exist")),void l.shiftAndExecuteNext(e);var h=G(n.duration)?n.duration:1/0,d=G(o.duration)?o.duration:1/0,f=Math.max(0,t),v=Math.min(r,h,d);v>f&&(!c.ending||c.ended)?(c.ended=!1,this.log("Removing [".concat(f,",").concat(v,"] from the ").concat(e," SourceBuffer")),c.remove(f,v)):l.shiftAndExecuteNext(e)}},{key:"appendExecutor",value:function(data,e){var t=this.sourceBuffer[e];if(t)t.ended=!1,t.appendBuffer(data);else if(!this.pendingTracks[e])throw new Error("Attempting to append to the ".concat(e," SourceBuffer, but it does not exist"))}},{key:"blockBuffers",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getSourceBufferTypes();if(!r.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);var n=this.operationQueue,o=r.map((function(e){return n.appendBlocker(e)}));Promise.all(o).then((function(){e(),r.forEach((function(e){var r=t.sourceBuffer[e];null!=r&&r.updating||n.shiftAndExecuteNext(e)}))}))}},{key:"getSourceBufferTypes",value:function(){return Object.keys(this.sourceBuffer)}},{key:"addBufferListener",value:function(e,t,r){var n=this.sourceBuffer[e];if(n){var o=r.bind(this,e);this.listeners[e].push({event:t,listener:o}),n.addEventListener(t,o)}}},{key:"removeBufferListeners",value:function(e){var t=this.sourceBuffer[e];t&&this.listeners[e].forEach((function(e){t.removeEventListener(e.event,e.listener)}))}}]),e}();function Pn(e){var t=e.querySelectorAll("source");[].slice.call(t).forEach((function(source){e.removeChild(source)}))}var Fn={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Mn=function(e){return String.fromCharCode(Fn[e]||e)},On=15,Nn=100,Un={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Bn={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Gn={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Kn={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Hn=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],Vn=function(){function e(){D(this,e),this.time=null,this.verboseLevel=0}return I(e,[{key:"log",value:function(e,t){if(this.verboseLevel>=e){var r="function"==typeof t?t():t;$.log("".concat(this.time," [").concat(e,"] ").concat(r))}}}]),e}(),Yn=function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r].toString(16));return t},jn=function(){function e(){D(this,e),this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}return I(e,[{key:"reset",value:function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}},{key:"setStyles",value:function(e){for(var t=["foreground","underline","italics","background","flash"],i=0;i<t.length;i++){var style=t[i];e.hasOwnProperty(style)&&(this[style]=e[style])}}},{key:"isDefault",value:function(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}},{key:"equals",value:function(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}},{key:"copy",value:function(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}},{key:"toString",value:function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}]),e}(),Wn=function(){function e(){D(this,e),this.uchar=" ",this.penState=new jn}return I(e,[{key:"reset",value:function(){this.uchar=" ",this.penState.reset()}},{key:"setChar",value:function(e,t){this.uchar=e,this.penState.copy(t)}},{key:"setPenState",value:function(e){this.penState.copy(e)}},{key:"equals",value:function(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}},{key:"copy",value:function(e){this.uchar=e.uchar,this.penState.copy(e.penState)}},{key:"isEmpty",value:function(){return" "===this.uchar&&this.penState.isDefault()}}]),e}(),qn=function(){function e(t){D(this,e),this.chars=[],this.pos=0,this.currPenState=new jn,this.cueStartTime=null,this.logger=void 0;for(var i=0;i<Nn;i++)this.chars.push(new Wn);this.logger=t}return I(e,[{key:"equals",value:function(e){for(var i=0;i<Nn;i++)if(!this.chars[i].equals(e.chars[i]))return!1;return!0}},{key:"copy",value:function(e){for(var i=0;i<Nn;i++)this.chars[i].copy(e.chars[i])}},{key:"isEmpty",value:function(){for(var e=!0,i=0;i<Nn;i++)if(!this.chars[i].isEmpty()){e=!1;break}return e}},{key:"setCursor",value:function(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Nn&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Nn)}},{key:"moveCursor",value:function(e){var t=this.pos+e;if(e>1)for(var i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}},{key:"backSpace",value:function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}},{key:"insertChar",value:function(e){var t=this;e>=144&&this.backSpace();var r=Mn(e);this.pos>=Nn?this.logger.log(0,(function(){return"Cannot insert "+e.toString(16)+" ("+r+") at position "+t.pos+". Skipping it!"})):(this.chars[this.pos].setChar(r,this.currPenState),this.moveCursor(1))}},{key:"clearFromPos",value:function(e){var i;for(i=e;i<Nn;i++)this.chars[i].reset()}},{key:"clear",value:function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}},{key:"clearToEndOfRow",value:function(){this.clearFromPos(this.pos)}},{key:"getTextString",value:function(){for(var e=[],t=!0,i=0;i<Nn;i++){var r=this.chars[i].uchar;" "!==r&&(t=!1),e.push(r)}return t?"":e.join("")}},{key:"setPenStyles",value:function(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}]),e}(),Xn=function(){function e(t){D(this,e),this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(var i=0;i<On;i++)this.rows.push(new qn(t));this.logger=t}return I(e,[{key:"reset",value:function(){for(var i=0;i<On;i++)this.rows[i].clear();this.currRow=14}},{key:"equals",value:function(e){for(var t=!0,i=0;i<On;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}},{key:"copy",value:function(e){for(var i=0;i<On;i++)this.rows[i].copy(e.rows[i])}},{key:"isEmpty",value:function(){for(var e=!0,i=0;i<On;i++)if(!this.rows[i].isEmpty()){e=!1;break}return e}},{key:"backSpace",value:function(){this.rows[this.currRow].backSpace()}},{key:"clearToEndOfRow",value:function(){this.rows[this.currRow].clearToEndOfRow()}},{key:"insertChar",value:function(e){this.rows[this.currRow].insertChar(e)}},{key:"setPen",value:function(e){this.rows[this.currRow].setPenStyles(e)}},{key:"moveCursor",value:function(e){this.rows[this.currRow].moveCursor(e)}},{key:"setCursor",value:function(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}},{key:"setPAC",value:function(e){this.logger.log(2,(function(){return"pacData = "+JSON.stringify(e)}));var t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(var i=0;i<On;i++)this.rows[i].clear();var r=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){var o=n.rows[r].cueStartTime,time=this.logger.time;if(null!==o&&null!==time&&o<time)for(var l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(n.rows[r+l])}}this.currRow=t;var c=this.rows[this.currRow];if(null!==e.indent){var h=e.indent,d=Math.max(h-1,0);c.setCursor(e.indent),e.color=c.chars[d].penState.foreground}var f={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(f)}},{key:"setBkgData",value:function(e){this.logger.log(2,(function(){return"bkgData = "+JSON.stringify(e)})),this.backSpace(),this.setPen(e),this.insertChar(32)}},{key:"setRollUpRows",value:function(e){this.nrRollUpRows=e}},{key:"rollUp",value:function(){var e=this;if(null!==this.nrRollUpRows){this.logger.log(1,(function(){return e.getDisplayText()}));var t=this.currRow+1-this.nrRollUpRows,r=this.rows.splice(t,1)[0];r.clear(),this.rows.splice(this.currRow,0,r),this.logger.log(2,"Rolling up")}else this.logger.log(3,"roll_up but nrRollUpRows not set yet")}},{key:"getDisplayText",value:function(e){e=e||!1;for(var t=[],text="",r=-1,i=0;i<On;i++){var n=this.rows[i].getTextString();n&&(r=i+1,e?t.push("Row "+r+": '"+n+"'"):t.push(n.trim()))}return t.length>0&&(text=e?"["+t.join(" | ")+"]":t.join("\n")),text}},{key:"getTextAndFormat",value:function(){return this.rows}}]),e}(),zn=function(){function e(t,r,n){D(this,e),this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=r,this.mode=null,this.verbose=0,this.displayedMemory=new Xn(n),this.nonDisplayedMemory=new Xn(n),this.lastOutputScreen=new Xn(n),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}return I(e,[{key:"reset",value:function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}},{key:"getHandler",value:function(){return this.outputFilter}},{key:"setHandler",value:function(e){this.outputFilter=e}},{key:"setPAC",value:function(e){this.writeScreen.setPAC(e)}},{key:"setBkgData",value:function(e){this.writeScreen.setBkgData(e)}},{key:"setMode",value:function(e){e!==this.mode&&(this.mode=e,this.logger.log(2,(function(){return"MODE="+e})),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}},{key:"insertChars",value:function(e){for(var t=this,i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);var r=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(function(){return r+": "+t.writeScreen.getDisplayText(!0)})),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(function(){return"DISPLAYED: "+t.displayedMemory.getDisplayText(!0)})),this.outputDataUpdate())}},{key:"ccRCL",value:function(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}},{key:"ccBS",value:function(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}},{key:"ccAOF",value:function(){}},{key:"ccAON",value:function(){}},{key:"ccDER",value:function(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}},{key:"ccRU",value:function(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}},{key:"ccFON",value:function(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}},{key:"ccRDC",value:function(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}},{key:"ccTR",value:function(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}},{key:"ccRTD",value:function(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}},{key:"ccEDM",value:function(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}},{key:"ccCR",value:function(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}},{key:"ccENM",value:function(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}},{key:"ccEOC",value:function(){var e=this;if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(function(){return"DISP: "+e.displayedMemory.getDisplayText()}))}this.outputDataUpdate(!0)}},{key:"ccTO",value:function(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}},{key:"ccMIDROW",value:function(e){var t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{var r=Math.floor(e/2)-16;t.foreground=["white","green","blue","cyan","red","yellow","magenta"][r]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}},{key:"outputDataUpdate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],time=this.logger.time;null!==time&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,time,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:time):this.cueStartTime=time,this.lastOutputScreen.copy(this.displayedMemory))}},{key:"cueSplitAtTime",value:function(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}]),e}(),Qn=function(){function e(t,r,n){D(this,e),this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;var o=this.logger=new Vn;this.channels=[null,new zn(t,r,o),new zn(t+1,n,o)]}return I(e,[{key:"getHandler",value:function(e){return this.channels[e].getHandler()}},{key:"setHandler",value:function(e,t){this.channels[e].setHandler(t)}},{key:"addData",value:function(time,e){var t=this;this.logger.time=time;for(var r=function(i){var a=127&e[i],b=127&e[i+1],r=!1,n=null;if(0===a&&0===b)return"continue";t.logger.log(3,(function(){return"["+Yn([e[i],e[i+1]])+"] -> ("+Yn([a,b])+")"}));var o=t.cmdHistory;if(a>=16&&a<=31){if(function(a,b,e){return e.a===a&&e.b===b}(a,b,o))return Jn(null,null,o),t.logger.log(3,(function(){return"Repeated command ("+Yn([a,b])+") is dropped"})),"continue";Jn(a,b,t.cmdHistory),(r=t.parseCmd(a,b))||(r=t.parseMidrow(a,b)),r||(r=t.parsePAC(a,b)),r||(r=t.parseBackgroundAttributes(a,b))}else Jn(null,null,o);if(!r&&(n=t.parseChars(a,b))){var l=t.currentChannel;if(l&&l>0)t.channels[l].insertChars(n);else t.logger.log(2,"No channel found yet. TEXT-MODE?")}r||n||t.logger.log(2,(function(){return"Couldn't parse cleaned data "+Yn([a,b])+" orig: "+Yn([e[i],e[i+1]])}))},i=0;i<e.length;i+=2)r(i)}},{key:"parseCmd",value:function(a,b){if(!((20===a||28===a||21===a||29===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=33&&b<=35))return!1;var e=20===a||21===a||23===a?1:2,t=this.channels[e];return 20===a||21===a||28===a||29===a?32===b?t.ccRCL():33===b?t.ccBS():34===b?t.ccAOF():35===b?t.ccAON():36===b?t.ccDER():37===b?t.ccRU(2):38===b?t.ccRU(3):39===b?t.ccRU(4):40===b?t.ccFON():41===b?t.ccRDC():42===b?t.ccTR():43===b?t.ccRTD():44===b?t.ccEDM():45===b?t.ccCR():46===b?t.ccENM():47===b&&t.ccEOC():t.ccTO(b-32),this.currentChannel=e,!0}},{key:"parseMidrow",value:function(a,b){var e=0;if((17===a||25===a)&&b>=32&&b<=47){if((e=17===a?1:2)!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;var t=this.channels[e];return!!t&&(t.ccMIDROW(b),this.logger.log(3,(function(){return"MIDROW ("+Yn([a,b])+")"})),!0)}return!1}},{key:"parsePAC",value:function(a,b){var e;if(!((a>=17&&a<=23||a>=25&&a<=31)&&b>=64&&b<=127)&&!((16===a||24===a)&&b>=64&&b<=95))return!1;var t=a<=23?1:2;e=b>=64&&b<=95?1===t?Un[a]:Gn[a]:1===t?Bn[a]:Kn[a];var r=this.channels[t];return!!r&&(r.setPAC(this.interpretPAC(e,b)),this.currentChannel=t,!0)}},{key:"interpretPAC",value:function(e,t){var r,n={color:null,italics:!1,indent:null,underline:!1,row:e};return r=t>95?t-96:t-64,n.underline=1==(1&r),r<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(r/2)]:r<=15?(n.italics=!0,n.color="white"):n.indent=4*Math.floor((r-16)/2),n}},{key:"parseChars",value:function(a,b){var e,t,r=null,n=null;(a>=25?(e=2,n=a-8):(e=1,n=a),n>=17&&n<=19)?(t=17===n?b+80:18===n?b+112:b+144,this.logger.log(2,(function(){return"Special char '"+Mn(t)+"' in channel "+e})),r=[t]):a>=32&&a<=127&&(r=0===b?[a]:[a,b]);return r&&this.logger.log(3,(function(){return"Char codes =  "+Yn(r).join(",")})),r}},{key:"parseBackgroundAttributes",value:function(a,b){var e;if(!((16===a||24===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=45&&b<=47))return!1;var t={};16===a||24===a?(e=Math.floor((b-32)/2),t.background=Hn[e],b%2==1&&(t.background=t.background+"_semi")):45===b?t.background="transparent":(t.foreground="black",47===b&&(t.underline=!0));var r=a<=23?1:2;return this.channels[r].setBkgData(t),!0}},{key:"reset",value:function(){for(var i=0;i<Object.keys(this.channels).length;i++){var e=this.channels[i];e&&e.reset()}Jn(null,null,this.cmdHistory)}},{key:"cueSplitAtTime",value:function(e){for(var i=0;i<this.channels.length;i++){var t=this.channels[i];t&&t.cueSplitAtTime(e)}}}]),e}();function Jn(a,b,e){e.a=a,e.b=b}var $n=function(){function e(t,r){D(this,e),this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=r}return I(e,[{key:"dispatchCue",value:function(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}},{key:"newCue",value:function(e,t,r){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=r,this.timelineController.createCaptionsTrack(this.trackName)}},{key:"reset",value:function(){this.cueRanges=[],this.startTime=null}}]),e}(),Zn=function(){if(null!=ge&&ge.VTTCue)return self.VTTCue;var e=["","lr","rl"],t=["start","middle","end","left","right"];function r(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;var r=t.toLowerCase();return!!~e.indexOf(r)&&r}function n(e){return r(t,e)}function o(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];for(var i=1;i<arguments.length;i++){var o=arguments[i];for(var p in o)e[p]=o[p]}return e}function l(t,l,text){var c=this,h={enumerable:!0};c.hasBeenReset=!1;var d="",f=!1,v=t,m=l,y=text,k=null,E="",T=!0,S="auto",L="start",A=50,R="middle",D=50,w="middle";Object.defineProperty(c,"id",o({},h,{get:function(){return d},set:function(e){d=""+e}})),Object.defineProperty(c,"pauseOnExit",o({},h,{get:function(){return f},set:function(e){f=!!e}})),Object.defineProperty(c,"startTime",o({},h,{get:function(){return v},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"endTime",o({},h,{get:function(){return m},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");m=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"text",o({},h,{get:function(){return y},set:function(e){y=""+e,this.hasBeenReset=!0}})),Object.defineProperty(c,"region",o({},h,{get:function(){return k},set:function(e){k=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"vertical",o({},h,{get:function(){return E},set:function(t){var n=function(t){return r(e,t)}(t);if(!1===n)throw new SyntaxError("An invalid or illegal string was specified.");E=n,this.hasBeenReset=!0}})),Object.defineProperty(c,"snapToLines",o({},h,{get:function(){return T},set:function(e){T=!!e,this.hasBeenReset=!0}})),Object.defineProperty(c,"line",o({},h,{get:function(){return S},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"lineAlign",o({},h,{get:function(){return L},set:function(e){var t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");L=t,this.hasBeenReset=!0}})),Object.defineProperty(c,"position",o({},h,{get:function(){return A},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");A=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"positionAlign",o({},h,{get:function(){return R},set:function(e){var t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");R=t,this.hasBeenReset=!0}})),Object.defineProperty(c,"size",o({},h,{get:function(){return D},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");D=e,this.hasBeenReset=!0}})),Object.defineProperty(c,"align",o({},h,{get:function(){return w},set:function(e){var t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");w=t,this.hasBeenReset=!0}})),c.displayState=void 0}return l.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},l}(),es=function(){function e(){D(this,e)}return I(e,[{key:"decode",value:function(data,e){if(!data)return"";if("string"!=typeof data)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(data))}}]),e}();function ts(input){function e(e,t,s,r){return 3600*(0|e)+60*(0|t)+(0|s)+parseFloat(r||0)}var t=input.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}var rs=function(){function e(){D(this,e),this.values=Object.create(null)}return I(e,[{key:"set",value:function(e,t){this.get(e)||""===t||(this.values[e]=t)}},{key:"get",value:function(e,t,r){return r?this.has(e)?this.values[e]:t[r]:this.has(e)?this.values[e]:t}},{key:"has",value:function(e){return e in this.values}},{key:"alt",value:function(e,t,a){for(var r=0;r<a.length;++r)if(t===a[r]){this.set(e,t);break}}},{key:"integer",value:function(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}},{key:"percent",value:function(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var r=parseFloat(t);if(r>=0&&r<=100)return this.set(e,r),!0}return!1}}]),e}();function is(input,e,t,r){var n=r?input.split(r):[input];for(var i in n)if("string"==typeof n[i]){var o=n[i].split(t);if(2===o.length)e(o[0],o[1])}}var as=new Zn(0,0,""),ns="middle"===as.align?"middle":"center";function ss(input,e,t){var r=input;function n(){var e=ts(input);if(null===e)throw new Error("Malformed timestamp: "+r);return input=input.replace(/^[^\sa-zA-Z-]+/,""),e}function o(){input=input.replace(/^\s+/,"")}if(o(),e.startTime=n(),o(),"--\x3e"!==input.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);input=input.slice(3),o(),e.endTime=n(),o(),function(input,e){var r=new rs;is(input,(function(e,n){var o;switch(e){case"region":for(var i=t.length-1;i>=0;i--)if(t[i].id===n){r.set(e,t[i].region);break}break;case"vertical":r.alt(e,n,["rl","lr"]);break;case"line":o=n.split(","),r.integer(e,o[0]),r.percent(e,o[0])&&r.set("snapToLines",!1),r.alt(e,o[0],["auto"]),2===o.length&&r.alt("lineAlign",o[1],["start",ns,"end"]);break;case"position":o=n.split(","),r.percent(e,o[0]),2===o.length&&r.alt("positionAlign",o[1],["start",ns,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,n);break;case"align":r.alt(e,n,["start",ns,"end","left","right"])}}),/:/,/\s/),e.region=r.get("region",null),e.vertical=r.get("vertical","");var line=r.get("line","auto");"auto"===line&&-1===as.line&&(line=-1),e.line=line,e.lineAlign=r.get("lineAlign","start"),e.snapToLines=r.get("snapToLines",!0),e.size=r.get("size",100),e.align=r.get("align",ns);var n=r.get("position","auto");"auto"===n&&50===as.position&&(n="start"===e.align||"left"===e.align?0:"end"===e.align||"right"===e.align?100:50),e.position=n}(input,e)}function os(input){return input.replace(/<br(?: \/)?>/gi,"\n")}var ls=function(){function e(){D(this,e),this.state="INITIAL",this.buffer="",this.decoder=new es,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}return I(e,[{key:"parse",value:function(data){var e=this;function t(){var t=e.buffer,r=0;for(t=os(t);r<t.length&&"\r"!==t[r]&&"\n"!==t[r];)++r;var line=t.slice(0,r);return"\r"===t[r]&&++r,"\n"===t[r]&&++r,e.buffer=t.slice(r),line}data&&(e.buffer+=e.decoder.decode(data,{stream:!0}));try{var line="";if("INITIAL"===e.state){if(!/\r\n|\n/.test(e.buffer))return this;var r=(line=t()).match(/^()?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");e.state="HEADER"}for(var n=!1;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(n?n=!1:line=t(),e.state){case"HEADER":/:/.test(line)?is(line,(function(e,t){}),/:/):line||(e.state="ID");continue;case"NOTE":line||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(line)){e.state="NOTE";break}if(!line)continue;if(e.cue=new Zn(0,0,""),e.state="CUE",-1===line.indexOf("--\x3e")){e.cue.id=line;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{ss(line,e.cue,e.regionList)}catch(t){e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":var o=-1!==line.indexOf("--\x3e");if(!line||o&&(n=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(null===e.cue)continue;e.cue.text&&(e.cue.text+="\n"),e.cue.text+=line;continue;case"BADCUE":line||(e.state="ID")}}}catch(t){"CUETEXT"===e.state&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state="INITIAL"===e.state?"BADWEBVTT":"BADCUE"}return this}},{key:"flush",value:function(){var e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}]),e}(),us=/\r\n|\n\r|\n|\r/g,cs=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.slice(r,r+t.length)===t},hs=function(text){for(var e=5381,i=text.length;i;)e=33*e^text.charCodeAt(--i);return(e>>>0).toString()};function ds(e,t,text){return hs(e.toString())+hs(t.toString())+hs(text)}function fs(e,t,r,n,o,l,c){var h,d=new ls,f=qe(new Uint8Array(e)).trim().replace(us,"\n").split("\n"),v=[],m=t?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return en(e,Za,1/t)}(t.baseTime,t.timescale):0,y="00:00.000",k=0,E=0,T=!0;d.oncue=function(e){var l=r[n],c=r.ccOffset,d=(k-m)/9e4;if(null!=l&&l.new&&(void 0!==E?c=r.ccOffset=l.start:function(e,t,r){var n=e[t],o=e[n.prevCC];if(!o||!o.new&&n.new)return e.ccOffset=e.presentationOffset=n.start,void(n.new=!1);for(;null!=(l=o)&&l.new;){var l;e.ccOffset+=n.start-o.start,n.new=!1,o=e[(n=o).prevCC]}e.presentationOffset=r}(r,n,d)),d){if(!t)return void(h=new Error("Missing initPTS for VTT MPEGTS"));c=d-r.presentationOffset}var f=e.endTime-e.startTime,y=sn(9e4*(e.startTime+c-E),9e4*o)/9e4;e.startTime=Math.max(y,0),e.endTime=Math.max(y+f,0);var text=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(text)),e.id||(e.id=ds(e.startTime,e.endTime,text)),e.endTime>0&&v.push(e)},d.onparsingerror=function(e){h=e},d.onflush=function(){h?c(h):l(v)},f.forEach((function(line){if(T){if(cs(line,"X-TIMESTAMP-MAP=")){T=!1,line.slice(16).split(",").forEach((function(e){cs(e,"LOCAL:")?y=e.slice(6):cs(e,"MPEGTS:")&&(k=parseInt(e.slice(7)))}));try{E=function(e){var t=parseInt(e.slice(-3)),r=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),o=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(G(t)&&G(r)&&G(n)&&G(o)))throw Error("Malformed X-TIMESTAMP-MAP: Local:".concat(e));return t+=1e3*r,t+=6e4*n,t+36e5*o}(y)/1e3}catch(e){h=e}return}""===line&&(T=!1)}d.parse(line+"\n")})),d.flush()}var vs="stpp.ttml.im1t",gs=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,ms=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,ys={left:"start",center:"center",right:"end",start:"start",end:"end"};function ps(e,t,r,n){var o=st(new Uint8Array(e),["mdat"]);if(0!==o.length){var l=o.map((function(e){return qe(e)})),c=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return en(e,t,1/r,n)}(t.baseTime,1,t.timescale);try{l.forEach((function(e){return r(function(e,t){var r=(new DOMParser).parseFromString(e,"text/xml"),n=r.getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");var o={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},l=Object.keys(o).reduce((function(e,t){return e[t]=n.getAttribute("ttp:".concat(t))||o[t],e}),{}),c="preserve"!==n.getAttribute("xml:space"),h=Es(ks(n,"styling","style")),d=Es(ks(n,"layout","region")),f=ks(n,"body","[begin]");return[].map.call(f,(function(e){var r=Ts(e,c);if(!r||!e.hasAttribute("begin"))return null;var n=As(e.getAttribute("begin"),l),o=As(e.getAttribute("dur"),l),f=As(e.getAttribute("end"),l);if(null===n)throw Ls(e);if(null===f){if(null===o)throw Ls(e);f=n+o}var v=new Zn(n-t,f-t,r);v.id=ds(v.startTime,v.endTime,v.text);var m=function(e,style,t){var r="http://www.w3.org/ns/ttml#styling",n=null,o=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],l=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;l&&t.hasOwnProperty(l)&&(n=t[l]);return o.reduce((function(t,o){var l=Ss(style,r,o)||Ss(e,r,o)||Ss(n,r,o);return l&&(t[o]=l),t}),{})}(d[e.getAttribute("region")],h[e.getAttribute("style")],h),y=m.textAlign;if(y){var k=ys[y];k&&(v.lineAlign=k),v.align=y}return B(v,m),v})).filter((function(e){return null!==e}))}(e,c))}))}catch(e){n(e)}}else n(new Error("Could not parse IMSC1 mdat"))}function ks(e,t,r){var n=e.getElementsByTagName(t)[0];return n?[].slice.call(n.querySelectorAll(r)):[]}function Es(e){return e.reduce((function(e,element){var t=element.getAttribute("xml:id");return t&&(e[t]=element),e}),{})}function Ts(element,e){return[].slice.call(element.childNodes).reduce((function(t,r,i){var n;return"br"===r.nodeName&&i?t+"\n":null!=(n=r.childNodes)&&n.length?Ts(r,e):e?t+r.textContent.trim().replace(/\s+/g," "):t+r.textContent}),"")}function Ss(element,e,t){return element&&element.hasAttributeNS(e,t)?element.getAttributeNS(e,t):null}function Ls(e){return new Error("Could not parse ttml timestamp ".concat(e))}function As(e,t){if(!e)return null;var r=ts(e);return null===r&&(gs.test(e)?r=function(e,t){var r=gs.exec(e),n=(0|r[4])+(0|r[5])/t.subFrameRate;return 3600*(0|r[1])+60*(0|r[2])+(0|r[3])+n/t.frameRate}(e,t):ms.test(e)&&(r=function(e,t){var r=ms.exec(e),n=Number(r[1]);switch(r[2]){case"h":return 3600*n;case"m":return 60*n;case"ms":return 1e3*n;case"f":return n/t.frameRate;case"t":return n/t.tickRate}return n}(e,t))),r}var Rs=function(){function e(t){D(this,e),this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(V.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(V.MANIFEST_LOADING,this.onManifestLoading,this),t.on(V.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(V.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(V.FRAG_LOADING,this.onFragLoading,this),t.on(V.FRAG_LOADED,this.onFragLoaded,this),t.on(V.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(V.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(V.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(V.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(V.BUFFER_FLUSHING,this.onBufferFlushing,this)}return I(e,[{key:"destroy",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(V.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(V.FRAG_LOADING,this.onFragLoading,this),e.off(V.FRAG_LOADED,this.onFragLoaded,this),e.off(V.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(V.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(V.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(V.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(V.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}},{key:"initCea608Parsers",value:function(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){var e=new $n(this,"textTrack1"),t=new $n(this,"textTrack2"),r=new $n(this,"textTrack3"),n=new $n(this,"textTrack4");this.cea608Parser1=new Qn(1,e,t),this.cea608Parser2=new Qn(3,r,n)}}},{key:"addCues",value:function(e,t,r,n,o){for(var l,c,h,d,f=!1,i=o.length;i--;){var v=o[i],m=(l=v[0],c=v[1],h=t,d=r,Math.min(c,d)-Math.max(l,h));if(m>=0&&(v[0]=Math.min(v[0],t),v[1]=Math.max(v[1],r),f=!0,m/(r-t)>.5))return}if(f||o.push([t,r]),this.config.renderTextTracksNatively){var track=this.captionsTracks[e];this.Cues.newCue(track,t,r,n)}else{var y=this.Cues.newCue(null,t,r,n);this.hls.trigger(V.CUES_PARSED,{type:"captions",cues:y,track:e})}}},{key:"onInitPtsFound",value:function(e,t){var r=this,n=t.frag,o=t.id,l=t.initPTS,c=t.timescale,h=this.unparsedVttFrags;"main"===o&&(this.initPTS[n.cc]={baseTime:l,timescale:c}),h.length&&(this.unparsedVttFrags=[],h.forEach((function(e){r.onFragLoaded(V.FRAG_LOADED,e)})))}},{key:"getExistingTrack",value:function(label,e){var t=this.media;if(t)for(var i=0;i<t.textTracks.length;i++){var r=t.textTracks[i];if(Ds(r,{name:label,lang:e,attrs:{}}))return r}return null}},{key:"createCaptionsTrack",value:function(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}},{key:"createNativeTrack",value:function(e){if(!this.captionsTracks[e]){var t=this.captionsProperties,r=this.captionsTracks,n=this.media,o=t[e],label=o.label,l=o.languageCode,c=this.getExistingTrack(label,l);if(c)r[e]=c,mr(r[e]),vr(r[e],n);else{var h=this.createTextTrack("captions",label,l);h&&(h[e]=!0,r[e]=h)}}}},{key:"createNonNativeTrack",value:function(e){if(!this.nonNativeCaptionsTracks[e]){var t=this.captionsProperties[e];if(t){var track={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=track,this.hls.trigger(V.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[track]})}}}},{key:"createTextTrack",value:function(e,label,t){var r=this.media;if(r)return r.addTextTrack(e,label,t)}},{key:"onMediaAttaching",value:function(e,data){this.media=data.media,this._cleanTracks()}},{key:"onMediaDetaching",value:function(){var e=this.captionsTracks;Object.keys(e).forEach((function(t){mr(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}},{key:"onManifestLoading",value:function(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}},{key:"_cleanTracks",value:function(){var e=this.media;if(e){var t=e.textTracks;if(t)for(var i=0;i<t.length;i++)mr(t[i])}}},{key:"onSubtitleTracksUpdated",value:function(e,data){var t=this,r=data.subtitleTracks||[],n=r.some((function(track){return track.textCodec===vs}));if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(Sn(this.tracks,r))return void(this.tracks=r);if(this.textTracks=[],this.tracks=r,this.config.renderTextTracksNatively){var o=this.media,l=o?pr(o.textTracks):null;if(this.tracks.forEach((function(track,e){var r;if(l){for(var n=null,i=0;i<l.length;i++)if(l[i]&&Ds(l[i],track)){n=l[i],l[i]=null;break}n&&(r=n)}if(r)mr(r);else{var o=bs(track);(r=t.createTextTrack(o,track.name,track.lang))&&(r.mode="disabled")}r&&t.textTracks.push(r)})),null!=l&&l.length){var c=l.filter((function(e){return null!==e})).map((function(e){return e.label}));c.length&&$.warn("Media element contains unused subtitle tracks: ".concat(c.join(", "),". Replace media element for each source to clear TextTracks and captions menu."))}}else if(this.tracks.length){var h=this.tracks.map((function(track){return{label:track.name,kind:track.type.toLowerCase(),default:track.default,subtitleTrack:track}}));this.hls.trigger(V.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:h})}}}},{key:"onManifestLoaded",value:function(e,data){var t=this;this.config.enableCEA708Captions&&data.captions&&data.captions.forEach((function(e){var r=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(r){var n="textTrack".concat(r[1]),o=t.captionsProperties[n];o&&(o.label=e.name,e.lang&&(o.languageCode=e.lang),o.media=e)}}))}},{key:"closedCaptionsForLevel",value:function(e){var t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}},{key:"onFragLoading",value:function(e,data){if(this.enabled&&data.frag.type===or){var t,r,n=this.cea608Parser1,o=this.cea608Parser2,l=this.lastSn,c=data.frag,h=c.cc,d=c.sn,f=null!=(t=null==(r=data.part)?void 0:r.index)?t:-1;n&&o&&(d!==l+1||d===l&&f!==this.lastPartIndex+1||h!==this.lastCc)&&(n.reset(),o.reset()),this.lastCc=h,this.lastSn=d,this.lastPartIndex=f}}},{key:"onFragLoaded",value:function(e,data){var t=data.frag,r=data.payload;if(t.type===ur)if(r.byteLength){var n=t.decryptdata,o="stats"in data;if(null==n||!n.encrypted||o){var l=this.tracks[t.level],c=this.vttCCs;c[t.cc]||(c[t.cc]={start:t.start,prevCC:this.prevCC,new:!0},this.prevCC=t.cc),l&&l.textCodec===vs?this._parseIMSC1(t,r):this._parseVTTs(data)}}else this.hls.trigger(V.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:new Error("Empty subtitle payload")})}},{key:"_parseIMSC1",value:function(e,t){var r=this,n=this.hls;ps(t,this.initPTS[e.cc],(function(t){r._appendCues(t,e.level),n.trigger(V.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(function(t){$.log("Failed to parse IMSC1: ".concat(t)),n.trigger(V.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}},{key:"_parseVTTs",value:function(data){var e,t=this,r=data.frag,n=data.payload,o=this.initPTS,l=this.unparsedVttFrags,c=o.length-1;if(o[r.cc]||-1!==c){var h=this.hls;fs(null!=(e=r.initSegment)&&e.data?mt(r.initSegment.data,new Uint8Array(n)):n,this.initPTS[r.cc],this.vttCCs,r.cc,r.start,(function(e){t._appendCues(e,r.level),h.trigger(V.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:r})}),(function(e){var o="Missing initPTS for VTT MPEGTS"===e.message;o?l.push(data):t._fallbackToIMSC1(r,n),$.log("Failed to parse VTT cue: ".concat(e)),o&&c>r.cc||h.trigger(V.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:e})}))}else l.push(data)}},{key:"_fallbackToIMSC1",value:function(e,t){var r=this,n=this.tracks[e.level];n.textCodec||ps(t,this.initPTS[e.cc],(function(){n.textCodec=vs,r._parseIMSC1(e,t)}),(function(){n.textCodec="wvtt"}))}},{key:"_appendCues",value:function(e,t){var r=this.hls;if(this.config.renderTextTracksNatively){var n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach((function(e){return gr(n,e)}))}else{var o=this.tracks[t];if(!o)return;var track=o.default?"default":"subtitles"+t;r.trigger(V.CUES_PARSED,{type:"subtitles",cues:e,track:track})}}},{key:"onFragDecrypted",value:function(e,data){data.frag.type===ur&&this.onFragLoaded(V.FRAG_LOADED,data)}},{key:"onSubtitleTracksCleared",value:function(){this.tracks=[],this.captionsTracks={}}},{key:"onFragParsingUserdata",value:function(e,data){this.initCea608Parsers();var t=this.cea608Parser1,r=this.cea608Parser2;if(this.enabled&&t&&r){var n=data.frag,o=data.samples;if(n.type!==or||"NONE"!==this.closedCaptionsForLevel(n))for(var i=0;i<o.length;i++){var l=o[i].bytes;if(l){var c=this.extractCea608Data(l);t.addData(o[i].pts,c[0]),r.addData(o[i].pts,c[1])}}}}},{key:"onBufferFlushing",value:function(e,t){var r=t.startOffset,n=t.endOffset,o=t.endOffsetSubtitles,l=t.type,c=this.media;if(c&&!(c.currentTime<n)){if(!l||"video"===l){var h=this.captionsTracks;Object.keys(h).forEach((function(e){return yr(h[e],r,n)}))}if(this.config.renderTextTracksNatively&&0===r&&void 0!==o){var d=this.textTracks;Object.keys(d).forEach((function(e){return yr(d[e],r,o)}))}}}},{key:"extractCea608Data",value:function(e){for(var t=[[],[]],r=31&e[0],n=2,o=0;o<r;o++){var l=e[n++],c=127&e[n++],h=127&e[n++];if(0!==c||0!==h)if(0!=(4&l)){var d=3&l;0!==d&&1!==d||(t[d].push(c),t[d].push(h))}}return t}}]),e}();function bs(track){return track.characteristics&&/transcribes-spoken-dialog/gi.test(track.characteristics)&&/describes-music-and-sound/gi.test(track.characteristics)?"captions":"subtitles"}function Ds(e,t){return!!e&&e.kind===bs(t)&&An(t,e)}var ws=function(){function e(t){D(this,e),this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}return I(e,[{key:"setStreamController",value:function(e){this.streamController=e}},{key:"destroy",value:function(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}},{key:"registerListeners",value:function(){var e=this.hls;e.on(V.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(V.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(V.BUFFER_CODECS,this.onBufferCodecs,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"unregisterListener",value:function(){var e=this.hls;e.off(V.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(V.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(V.BUFFER_CODECS,this.onBufferCodecs,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this)}},{key:"onFpsDropLevelCapping",value:function(e,data){var t=this.hls.levels[data.droppedLevel];this.isLevelAllowed(t)&&this.restrictedLevels.push({bitrate:t.bitrate,height:t.height,width:t.width})}},{key:"onMediaAttaching",value:function(e,data){this.media=data.media instanceof HTMLVideoElement?data.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}},{key:"onManifestParsed",value:function(e,data){var t=this.hls;this.restrictedLevels=[],this.firstLevel=data.firstLevel,t.config.capLevelToPlayerSize&&data.video&&this.startCapping()}},{key:"onLevelsUpdated",value:function(e,data){this.timer&&G(this.autoLevelCapping)&&this.detectPlayerSize()}},{key:"onBufferCodecs",value:function(e,data){this.hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()}},{key:"onMediaDetaching",value:function(){this.stopCapping()}},{key:"detectPlayerSize",value:function(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);var e=this.hls.levels;if(e.length){var t=this.hls,r=this.getMaxLevel(e.length-1);r!==this.autoLevelCapping&&$.log("Setting autoLevelCapping to ".concat(r,": ").concat(e[r].height,"p@").concat(e[r].bitrate," for media ").concat(this.mediaWidth,"x").concat(this.mediaHeight)),t.autoLevelCapping=r,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}},{key:"getMaxLevel",value:function(t){var r=this,n=this.hls.levels;if(!n.length)return-1;var o=n.filter((function(e,n){return r.isLevelAllowed(e)&&n<=t}));return this.clientRect=null,e.getMaxLevelByMediaSize(o,this.mediaWidth,this.mediaHeight)}},{key:"startCapping",value:function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}},{key:"stopCapping",value:function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}},{key:"getDimensions",value:function(){if(this.clientRect)return this.clientRect;var e=this.media,t={width:0,height:0};if(e){var r=e.getBoundingClientRect();t.width=r.width,t.height=r.height,t.width||t.height||(t.width=r.right-r.left||e.width||0,t.height=r.bottom-r.top||e.height||0)}return this.clientRect=t,t}},{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return e}},{key:"isLevelAllowed",value:function(e){return!this.restrictedLevels.some((function(t){return e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height}))}}],[{key:"getMaxLevelByMediaSize",value:function(e,t,r){if(null==e||!e.length)return-1;for(var n,o,l=e.length-1,c=Math.max(t,r),i=0;i<e.length;i+=1){var h=e[i];if((h.width>=c||h.height>=c)&&(n=h,!(o=e[i+1])||n.width!==o.width||n.height!==o.height)){l=i;break}}return l}}]),e}(),Is=function(){function e(t){D(this,e),this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}return I(e,[{key:"setStreamController",value:function(e){this.streamController=e}},{key:"registerListeners",value:function(){this.hls.on(V.MEDIA_ATTACHING,this.onMediaAttaching,this)}},{key:"unregisterListeners",value:function(){this.hls.off(V.MEDIA_ATTACHING,this.onMediaAttaching,this)}},{key:"destroy",value:function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}},{key:"onMediaAttaching",value:function(e,data){var t=this.hls.config;if(t.capLevelOnFPSDrop){var r=data.media instanceof self.HTMLVideoElement?data.media:null;this.media=r,r&&"function"==typeof r.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),t.fpsDroppedMonitoringPeriod)}}},{key:"checkFPS",value:function(video,e,t){var r=performance.now();if(e){if(this.lastTime){var n=r-this.lastTime,o=t-this.lastDroppedFrames,l=e-this.lastDecodedFrames,c=1e3*o/n,h=this.hls;if(h.trigger(V.FPS_DROP,{currentDropped:o,currentDecoded:l,totalDroppedFrames:t}),c>0&&o>h.config.fpsDroppedMonitoringThreshold*l){var d=h.currentLevel;$.warn("drop FPS ratio greater than max allowed value for currentLevel: "+d),d>0&&(-1===h.autoLevelCapping||h.autoLevelCapping>=d)&&(d-=1,h.trigger(V.FPS_DROP_LEVEL_CAPPING,{level:d,droppedLevel:h.currentLevel}),h.autoLevelCapping=d,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=t,this.lastDecodedFrames=e}}},{key:"checkFPSInterval",value:function(){var video=this.media;if(video)if(this.isVideoPlaybackQualityAvailable){var e=video.getVideoPlaybackQuality();this.checkFPS(video,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount)}}]),e}(),Cs="[eme]",_s=function(){function e(t){D(this,e),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=e.CDMCleanupPromise?[e.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=$.debug.bind($,Cs),this.log=$.log.bind($,Cs),this.warn=$.warn.bind($,Cs),this.error=$.error.bind($,Cs),this.hls=t,this.config=t.config,this.registerListeners()}return I(e,[{key:"destroy",value:function(){this.unregisterListeners(),this.onMediaDetached();var e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}},{key:"registerListeners",value:function(){this.hls.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(V.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(V.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(V.MANIFEST_LOADED,this.onManifestLoaded,this)}},{key:"unregisterListeners",value:function(){this.hls.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(V.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(V.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(V.MANIFEST_LOADED,this.onManifestLoaded,this)}},{key:"getLicenseServerUrl",value:function(e){var t=this.config,r=t.drmSystems,n=t.widevineLicenseUrl,o=r[e];if(o)return o.licenseUrl;if(e===me.WIDEVINE&&n)return n;throw new Error('no license server URL configured for key-system "'.concat(e,'"'))}},{key:"getServerCertificateUrl",value:function(e){var t=this.config.drmSystems[e];if(t)return t.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'.concat(e,'"]'))}},{key:"attemptKeySystemAccess",value:function(e){var t=this,r=this.hls.levels,n=function(e,i,a){return!!e&&a.indexOf(e)===i},o=r.map((function(e){return e.audioCodec})).filter(n),l=r.map((function(e){return e.videoCodec})).filter(n);return o.length+l.length===0&&l.push("avc1.42e01e"),new Promise((function(r,n){!function e(c){var h=c.shift();t.getMediaKeysPromise(h,o,l).then((function(e){return r({keySystem:h,mediaKeys:e})})).catch((function(t){c.length?e(c):n(t instanceof Ms?t:new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))}))}(e)}))}},{key:"requestMediaKeySystemAccess",value:function(e,t){var r=this.config.requestMediaKeySystemAccessFunc;if("function"!=typeof r){var n="Configured requestMediaKeySystemAccess is not a function ".concat(r);return null===Ce&&"http:"===self.location.protocol&&(n="navigator.requestMediaKeySystemAccess is not available over insecure protocol ".concat(location.protocol)),Promise.reject(new Error(n))}return r(e,t)}},{key:"getMediaKeysPromise",value:function(e,t,r){var n=this,o=function(e,t,r,n){var o;switch(e){case me.FAIRPLAY:o=["cenc","sinf"];break;case me.WIDEVINE:case me.PLAYREADY:o=["cenc"];break;case me.CLEARKEY:o=["cenc","keyids"];break;default:throw new Error("Unknown key-system: ".concat(e))}return function(e,t,r,n){return[{initDataTypes:e,persistentState:n.persistentState||"optional",distinctiveIdentifier:n.distinctiveIdentifier||"optional",sessionTypes:n.sessionTypes||[n.sessionType||"temporary"],audioCapabilities:t.map((function(e){return{contentType:'audio/mp4; codecs="'.concat(e,'"'),robustness:n.audioRobustness||"",encryptionScheme:n.audioEncryptionScheme||null}})),videoCapabilities:r.map((function(e){return{contentType:'video/mp4; codecs="'.concat(e,'"'),robustness:n.videoRobustness||"",encryptionScheme:n.videoEncryptionScheme||null}}))}]}(o,t,r,n)}(e,t,r,this.config.drmSystemOptions),l=this.keySystemAccessPromises[e],c=null==l?void 0:l.keySystemAccess;if(!c){this.log('Requesting encrypted media "'.concat(e,'" key-system access with config: ').concat(JSON.stringify(o))),c=this.requestMediaKeySystemAccess(e,o);var h=this.keySystemAccessPromises[e]={keySystemAccess:c};return c.catch((function(t){n.log('Failed to obtain access to key-system "'.concat(e,'": ').concat(t))})),c.then((function(t){n.log('Access for key-system "'.concat(t.keySystem,'" obtained'));var r=n.fetchServerCertificate(e);return n.log('Create media-keys for "'.concat(e,'"')),h.mediaKeys=t.createMediaKeys().then((function(t){return n.log('Media-keys created for "'.concat(e,'"')),r.then((function(r){return r?n.setMediaKeysServerCertificate(t,e,r):t}))})),h.mediaKeys.catch((function(t){n.error('Failed to create media-keys for "'.concat(e,'"}: ').concat(t))})),h.mediaKeys}))}return c.then((function(){return l.mediaKeys}))}},{key:"createMediaKeySessionContext",value:function(e){var t=e.decryptdata,r=e.keySystem,n=e.mediaKeys;this.log('Creating key-system session "'.concat(r,'" keyId: ').concat(ze(t.keyId||[])));var o=n.createSession(),l={decryptdata:t,keySystem:r,mediaKeys:n,mediaKeysSession:o,keyStatus:"status-pending"};return this.mediaKeySessions.push(l),l}},{key:"renewKeySession",value:function(e){var t=e.decryptdata;if(t.pssh){var r=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t);this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(r,"cenc",t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}},{key:"getKeyIdString",value:function(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return ze(e.keyId)}},{key:"updateKeySession",value:function(e,data){var t,r=e.mediaKeysSession;return this.log('Updating key-session "'.concat(r.sessionId,'" for keyID ').concat(ze((null==(t=e.decryptdata)?void 0:t.keyId)||[]),"\n      } (data length: ").concat(data?data.byteLength:data,")")),r.update(data)}},{key:"selectKeySystemFormat",value:function(e){var t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: ".concat(e.sn," ").concat(e.type,": ").concat(e.level,") key formats ").concat(t.join(", "))),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}},{key:"getKeyFormatPromise",value:function(e){var t=this;return new Promise((function(r,n){var o=we(t.config),l=e.map(Te).filter((function(e){return!!e&&-1!==o.indexOf(e)}));return t.getKeySystemSelectionPromise(l).then((function(e){var t=e.keySystem,o=De(t);o?r(o):n(new Error('Unable to find format for key-system "'.concat(t,'"')))})).catch(n)}))}},{key:"loadKey",value:function(data){var e=this,t=data.keyInfo.decryptdata,r=this.getKeyIdString(t),n="(keyId: ".concat(r,' format: "').concat(t.keyFormat,'" method: ').concat(t.method," uri: ").concat(t.uri,")");this.log("Starting session for key ".concat(n));var o=this.keyIdToKeySessionPromise[r];return o||(o=this.keyIdToKeySessionPromise[r]=this.getKeySystemForKeyPromise(t).then((function(r){var o=r.keySystem,l=r.mediaKeys;return e.throwIfDestroyed(),e.log("Handle encrypted media sn: ".concat(data.frag.sn," ").concat(data.frag.type,": ").concat(data.frag.level," using key ").concat(n)),e.attemptSetMediaKeys(o,l).then((function(){e.throwIfDestroyed();var r=e.createMediaKeySessionContext({keySystem:o,mediaKeys:l,decryptdata:t});return e.generateRequestWithPreferredKeySession(r,"cenc",t.pssh,"playlist-key")}))}))).catch((function(t){return e.handleError(t)})),o}},{key:"throwIfDestroyed",value:function(){if(!this.hls)throw new Error("invalid state")}},{key:"handleError",value:function(e){this.hls&&(this.error(e.message),e instanceof Ms?this.hls.trigger(V.ERROR,e.data):this.hls.trigger(V.ERROR,{type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}},{key:"getKeySystemForKeyPromise",value:function(e){var t=this.getKeyIdString(e),r=this.keyIdToKeySessionPromise[t];if(!r){var n=Te(e.keyFormat),o=n?[n]:we(this.config);return this.attemptKeySystemAccess(o)}return r}},{key:"getKeySystemSelectionPromise",value:function(e){if(e.length||(e=we(this.config)),0===e.length)throw new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options ".concat(JSON.stringify({drmSystems:this.config.drmSystems})));return this.attemptKeySystemAccess(e)}},{key:"_onMediaEncrypted",value:function(e){var t=this,r=e.initDataType,n=e.initData,o='"'.concat(e.type,'" event: init data type: "').concat(r,'"');if(this.debug(o),null!==n){var l,c;if("sinf"===r&&this.config.drmSystems[me.FAIRPLAY]){var h=Ze(new Uint8Array(n));try{var d=de(JSON.parse(h).sinf),f=vt(new Uint8Array(d));if(!f)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=f.subarray(8,24),c=me.FAIRPLAY}catch(e){return void this.warn("".concat(o," Failed to parse sinf: ").concat(e))}}else{var v=function(e){var t=[];if(e instanceof ArrayBuffer)for(var r=e.byteLength,n=0;n+32<r;){var o=St(new DataView(e,n));t.push(o),n+=o.size}return t}(n),m=v.filter((function(e){return e.systemId===Re}))[0];if(!m)return void(0===v.length||v.some((function(e){return!e.systemId}))?this.warn("".concat(o," contains incomplete or invalid pssh data")):this.log("ignoring ".concat(o," for ").concat(v.map((function(e){return be(e.systemId)})).join(",")," pssh data in favor of playlist keys")));if(c=be(m.systemId),0===m.version&&m.data){var y=m.data.length-22;l=m.data.subarray(y,y+16)}}if(c&&l){for(var k=ze(l),E=this.keyIdToKeySessionPromise,T=this.mediaKeySessions,S=E[k],L=function(i){var e=T[i],o=e.decryptdata;if(!o.keyId)return"continue";var c=ze(o.keyId);return k===c||-1!==o.uri.replace(/-/g,"").indexOf(k)?(S=E[c],o.pssh||(delete E[c],o.pssh=new Uint8Array(n),o.keyId=l,S=E[k]=S.then((function(){return t.generateRequestWithPreferredKeySession(e,r,n,"encrypted-event-key-match")}))),"break"):void 0},i=0;i<T.length;i++){var A=L(i);if("continue"!==A&&"break"===A)break}S||(S=E[k]=this.getKeySystemSelectionPromise([c]).then((function(e){var o,c=e.keySystem,h=e.mediaKeys;t.throwIfDestroyed();var d=new At("ISO-23001-7",k,null!=(o=De(c))?o:"");return d.pssh=new Uint8Array(n),d.keyId=l,t.attemptSetMediaKeys(c,h).then((function(){t.throwIfDestroyed();var e=t.createMediaKeySessionContext({decryptdata:d,keySystem:c,mediaKeys:h});return t.generateRequestWithPreferredKeySession(e,r,n,"encrypted-event-no-match")}))}))),S.catch((function(e){return t.handleError(e)}))}}}},{key:"_onWaitingForKey",value:function(e){this.log('"'.concat(e.type,'" event'))}},{key:"attemptSetMediaKeys",value:function(e,t){var r=this,n=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'.concat(e,'"'));var o=Promise.all(n).then((function(){if(!r.media)throw new Error("Attempted to set mediaKeys without media element attached");return r.media.setMediaKeys(t)}));return this.setMediaKeysQueue.push(o),o.then((function(){r.log('Media-keys set for "'.concat(e,'"')),n.push(o),r.setMediaKeysQueue=r.setMediaKeysQueue.filter((function(p){return-1===n.indexOf(p)}))}))}},{key:"generateRequestWithPreferredKeySession",value:function(e,t,r,n){var o,l,c=this,h=null==(o=this.config.drmSystems)||null==(l=o[e.keySystem])?void 0:l.generateRequest;if(h)try{var d=h.call(this.hls,t,r,e);if(!d)throw new Error("Invalid response from configured generateRequest filter");t=d.initDataType,r=e.decryptdata.pssh=d.initData?new Uint8Array(d.initData):null}catch(e){var f;if(this.warn(e.message),null!=(f=this.hls)&&f.config.debug)throw e}if(null===r)return this.log('Skipping key-session request for "'.concat(n,'" (no initData)')),Promise.resolve(e);var v=this.getKeyIdString(e.decryptdata);this.log('Generating key-session request for "'.concat(n,'": ').concat(v," (init data type: ").concat(t," length: ").concat(r?r.byteLength:null,")"));var m=new En,y=e._onmessage=function(t){var r=e.mediaKeysSession;if(r){var n=t.messageType,o=t.message;c.log('"'.concat(n,'" message event for session "').concat(r.sessionId,'" message size: ').concat(o.byteLength)),"license-request"===n||"license-renewal"===n?c.renewLicense(e,o).catch((function(e){c.handleError(e),m.emit("error",e)})):"license-release"===n?e.keySystem===me.FAIRPLAY&&(c.updateKeySession(e,ve("acknowledged")),c.removeSession(e)):c.warn('unhandled media key message type "'.concat(n,'"'))}else m.emit("error",new Error("invalid state"))},k=e._onkeystatuseschange=function(t){if(e.mediaKeysSession){c.onKeyStatusChange(e);var r=e.keyStatus;m.emit("keyStatus",r),"expired"===r&&(c.warn("".concat(e.keySystem," expired for key ").concat(v)),c.renewKeySession(e))}else m.emit("error",new Error("invalid state"))};e.mediaKeysSession.addEventListener("message",y),e.mediaKeysSession.addEventListener("keystatuseschange",k);var E=new Promise((function(e,t){m.on("error",t),m.on("keyStatus",(function(r){r.startsWith("usable")?e():"output-restricted"===r?t(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===r?t(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'.concat(r,'"'))):"expired"===r?t(new Error("key expired while generating request")):c.warn('unhandled key status change "'.concat(r,'"'))}))}));return e.mediaKeysSession.generateRequest(t,r).then((function(){var t;c.log('Request generated for key-session "'.concat(null==(t=e.mediaKeysSession)?void 0:t.sessionId,'" keyId: ').concat(v))})).catch((function(e){throw new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},"Error generating key-session request: ".concat(e))})).then((function(){return E})).catch((function(t){throw m.removeAllListeners(),c.removeSession(e),t})).then((function(){return m.removeAllListeners(),e}))}},{key:"onKeyStatusChange",value:function(e){var t=this;e.mediaKeysSession.keyStatuses.forEach((function(r,n){t.log('key status change "'.concat(r,'" for keyStatuses keyId: ').concat(ze("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))," session keyId: ").concat(ze(new Uint8Array(e.decryptdata.keyId||[]))," uri: ").concat(e.decryptdata.uri)),e.keyStatus=r}))}},{key:"fetchServerCertificate",value:function(e){var t=this.config,r=new(0,t.loader)(t),n=this.getServerCertificateUrl(e);return n?(this.log('Fetching server certificate for "'.concat(e,'"')),new Promise((function(o,l){var c={responseType:"arraybuffer",url:n},h=t.certLoadPolicy.default,d={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},f={onSuccess:function(e,t,r,n){o(e.data)},onError:function(t,r,o,h){l(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:O({url:c.url,data:void 0},t)},'"'.concat(e,'" certificate request failed (').concat(n,"). Status: ").concat(t.code," (").concat(t.text,")")))},onTimeout:function(t,r,o){l(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:c.url,data:void 0}},'"'.concat(e,'" certificate request timed out (').concat(n,")")))},onAbort:function(e,t,r){l(new Error("aborted"))}};r.load(c,d,f)}))):Promise.resolve()}},{key:"setMediaKeysServerCertificate",value:function(e,t,r){var n=this;return new Promise((function(o,l){e.setServerCertificate(r).then((function(l){n.log("setServerCertificate ".concat(l?"success":"not supported by CDM"," (").concat(null==r?void 0:r.byteLength,') on "').concat(t,'"')),o(e)})).catch((function(e){l(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))}))}))}},{key:"renewLicense",value:function(e,t){var r=this;return this.requestLicense(e,new Uint8Array(t)).then((function(data){return r.updateKeySession(e,new Uint8Array(data)).catch((function(e){throw new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))}))}},{key:"unpackPlayReadyKeyMessage",value:function(e,t){var r=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!r.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;var n=(new DOMParser).parseFromString(r,"application/xml"),o=n.querySelectorAll("HttpHeader");if(o.length>0)for(var header,i=0,l=o.length;i<l;i++){var c,h,d=null==(c=(header=o[i]).querySelector("name"))?void 0:c.textContent,f=null==(h=header.querySelector("value"))?void 0:h.textContent;d&&f&&e.setRequestHeader(d,f)}var v=n.querySelector("Challenge"),m=null==v?void 0:v.textContent;if(!m)throw new Error("Cannot find <Challenge> in key message");return ve(atob(m))}},{key:"setupLicenseXHR",value:function(e,t,r,n){var o=this,l=this.config.licenseXhrSetup;return l?Promise.resolve().then((function(){if(!r.decryptdata)throw new Error("Key removed");return l.call(o.hls,e,t,r,n)})).catch((function(c){if(!r.decryptdata)throw c;return e.open("POST",t,!0),l.call(o.hls,e,t,r,n)})).then((function(r){return e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:r||n}})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}},{key:"requestLicense",value:function(e,t){var r=this,n=this.config.keyLoadPolicy.default;return new Promise((function(o,l){var c=r.getLicenseServerUrl(e.keySystem);r.log("Sending license request to URL: ".concat(c));var h=new XMLHttpRequest;h.responseType="arraybuffer",h.onreadystatechange=function(){if(!r.hls||!e.mediaKeysSession)return l(new Error("invalid state"));if(4===h.readyState)if(200===h.status){r._requestLicenseFailureCount=0;var data=h.response;r.log("License received ".concat(data instanceof ArrayBuffer?data.byteLength:data));var d=r.config.licenseResponseCallback;if(d)try{data=d.call(r.hls,h,c,e)}catch(e){r.error(e)}o(data)}else{var f=n.errorRetry,v=f?f.maxNumRetry:0;if(r._requestLicenseFailureCount++,r._requestLicenseFailureCount>v||h.status>=400&&h.status<500)l(new Ms({type:Y.KEY_SYSTEM_ERROR,details:j.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:h,response:{url:c,data:void 0,code:h.status,text:h.statusText}},"License Request XHR failed (".concat(c,"). Status: ").concat(h.status," (").concat(h.statusText,")")));else{var m=v-r._requestLicenseFailureCount+1;r.warn("Retrying license request, ".concat(m," attempts left")),r.requestLicense(e,t).then(o,l)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=h,r.setupLicenseXHR(h,c,e,t).then((function(t){var n=t.xhr,o=t.licenseChallenge;e.keySystem==me.PLAYREADY&&(o=r.unpackPlayReadyKeyMessage(n,o)),n.send(o)}))}))}},{key:"onMediaAttached",value:function(e,data){if(this.config.emeEnabled){var t=data.media;this.media=t,t.addEventListener("encrypted",this.onMediaEncrypted),t.addEventListener("waitingforkey",this.onWaitingForKey)}}},{key:"onMediaDetached",value:function(){var t=this,r=this.media,n=this.mediaKeySessions;r&&(r.removeEventListener("encrypted",this.onMediaEncrypted),r.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},At.clearKeyUriToKeyIdMap();var o=n.length;e.CDMCleanupPromise=Promise.all(n.map((function(e){return t.removeSession(e)})).concat(null==r?void 0:r.setMediaKeys(null).catch((function(e){t.log("Could not clear media keys: ".concat(e))})))).then((function(){o&&(t.log("finished closing key sessions and clearing media keys"),n.length=0)})).catch((function(e){t.log("Could not close sessions and clear media keys: ".concat(e))}))}},{key:"onManifestLoading",value:function(){this.keyFormatPromise=null}},{key:"onManifestLoaded",value:function(e,t){var r=t.sessionKeys;if(r&&this.config.emeEnabled&&!this.keyFormatPromise){var n=r.reduce((function(e,t){return-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e}),[]);this.log("Selecting key-system from session-keys ".concat(n.join(", "))),this.keyFormatPromise=this.getKeyFormatPromise(n)}}},{key:"removeSession",value:function(e){var t=this,r=e.mediaKeysSession,n=e.licenseXhr;if(r){this.log("Remove licenses and keys and close session ".concat(r.sessionId)),e._onmessage&&(r.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(r.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;var o=this.mediaKeySessions.indexOf(e);return o>-1&&this.mediaKeySessions.splice(o,1),r.remove().catch((function(e){t.log("Could not remove session: ".concat(e))})).then((function(){return r.close()})).catch((function(e){t.log("Could not close session: ".concat(e))}))}}}]),e}();_s.CDMCleanupPromise=void 0;var xs,Ps,Fs,Ms=function(e){y(r,e);var t=E(r);function r(data,e){var n;return D(this,r),(n=t.call(this,e)).data=void 0,data.error||(data.error=new Error(e)),n.data=data,data.err=data.error,n}return I(r)}(v(Error));!function(e){e.MANIFEST="m",e.AUDIO="a",e.VIDEO="v",e.MUXED="av",e.INIT="i",e.CAPTION="c",e.TIMED_TEXT="tt",e.KEY="k",e.OTHER="o"}(xs||(xs={})),function(e){e.DASH="d",e.HLS="h",e.SMOOTH="s",e.OTHER="o"}(Ps||(Ps={})),function(e){e.OBJECT="CMCD-Object",e.REQUEST="CMCD-Request",e.SESSION="CMCD-Session",e.STATUS="CMCD-Status"}(Fs||(Fs={}));var Os=(R(n={},Fs.OBJECT,["br","d","ot","tb"]),R(n,Fs.REQUEST,["bl","dl","mtp","nor","nrr","su"]),R(n,Fs.SESSION,["cid","pr","sf","sid","st","v"]),R(n,Fs.STATUS,["bs","rtp"]),n),Ns=I((function e(t,r){D(this,e),this.value=void 0,this.params=void 0,Array.isArray(t)&&(t=t.map((function(t){return t instanceof e?t:new e(t)}))),this.value=t,this.params=r})),Us=I((function e(t){D(this,e),this.description=void 0,this.description=t})),Bs="Dict";function Gs(e,t,r,n){return new Error("failed to ".concat(e,' "').concat((o=t,Array.isArray(o)?JSON.stringify(o):o instanceof Map?"Map{}":o instanceof Set?"Set{}":"object"===_(o)?JSON.stringify(o):String(o)),'" as ').concat(r),{cause:n});var o}var Ks="Bare Item";var Hs=/[\x00-\x1f\x7f]+/;function Vs(e,t,r){return Gs("serialize",e,t,r)}function Ys(e){if(!1===ArrayBuffer.isView(e))throw Vs(e,"Byte Sequence");return":".concat((t=e,btoa(String.fromCharCode.apply(String,o(t)))),":");var t}function js(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw Vs(e,"Integer");return e.toString()}function Ws(e,t){if(e<0)return-Ws(-e,t);var r=Math.pow(10,t);if(Math.abs(e*r%1-.5)<Number.EPSILON){var n=Math.floor(e*r);return(n%2==0?n:n+1)/r}return Math.round(e*r)/r}function qs(e){var t=Ws(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw Vs(e,"Decimal");var r=t.toString();return r.includes(".")?r:"".concat(r,".0")}function Xs(e){var symbol,t=(symbol=e).description||symbol.toString().slice(7,-1);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw Vs(t,"Token");return t}function zs(e){switch(_(e)){case"number":if(!G(e))throw Vs(e,Ks);return Number.isInteger(e)?js(e):qs(e);case"string":return function(e){if(Hs.test(e))throw Vs(e,"String");return'"'.concat(e.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),'"')}(e);case"symbol":return Xs(e);case"boolean":return function(e){if("boolean"!=typeof e)throw Vs(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return"@".concat(js(e.getTime()/1e3))}(e);if(e instanceof Uint8Array)return Ys(e);if(e instanceof Us)return Xs(e);default:throw Vs(e,Ks)}}function Qs(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw Vs(e,"Key");return e}function Js(e){return null==e?"":Object.entries(e).map((function(e){var t=l(e,2),r=t[0],n=t[1];return!0===n?";".concat(Qs(r)):";".concat(Qs(r),"=").concat(zs(n))})).join("")}function $s(e){return e instanceof Ns?"".concat(zs(e.value)).concat(Js(e.params)):zs(e)}function Zs(e){return"(".concat(e.value.map($s).join(" "),")").concat(Js(e.params))}function eo(e,t){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whitespace:!0};if("object"!==_(e))throw Vs(e,Bs);var r=e instanceof Map?e.entries():Object.entries(e),n=null!=t&&t.whitespace?" ":"";return Array.from(r).map((function(e){var t=l(e,2),r=t[0],n=t[1];n instanceof Ns==0&&(n=new Ns(n));var output=Qs(r);return!0===n.value?output+=Js(n.params):(output+="=",Array.isArray(n.value)?output+=Zs(n):output+=$s(n)),output})).join(",".concat(n))}(e,t)}var to=function(e){return Math.round(e)},ro=function(e){return 100*to(e/100)},io={br:to,d:to,bl:ro,dl:ro,mtp:ro,nor:function(e,t){return null!=t&&t.baseUrl&&(e=function(e,base){var t=new URL(e),r=new URL(base);if(t.origin!==r.origin)return e;for(var n=t.pathname.split("/").slice(1),o=r.pathname.split("/").slice(1,-1);n[0]===o[0];)n.shift(),o.shift();for(;o.length;)o.shift(),n.unshift("..");return n.join("/")}(e,t.baseUrl)),encodeURIComponent(e)},rtp:ro,tb:to};function ao(e,t){var r={};if(null==e||"object"!==_(e))return r;var n=Object.keys(e).sort(),o=B({},io,null==t?void 0:t.formatters),filter=null==t?void 0:t.filter;return n.forEach((function(n){if(null==filter||!filter(n)){var l=e[n],c=o[n];c&&(l=c(l,t)),"v"===n&&1===l||"pr"==n&&1===l||function(e){return"number"==typeof e?G(e):null!=e&&""!==e&&!1!==e}(l)&&(function(e){return"ot"===e||"sf"===e||"st"===e}(n)&&"string"==typeof l&&(l=new Us(l)),r[n]=l)}})),r}function no(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e?eo(ao(e,t),B({whitespace:!1},t)):""}function so(e,t,r){return B(e,function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return{};var r=Object.entries(e),n=Object.entries(Os).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),o=r.reduce((function(e,t){var r,o=l(t,2),c=o[0],h=o[1],d=(null==(r=n.find((function(e){return e[1].includes(c)})))?void 0:r[0])||Fs.REQUEST;return null!=e[d]||(e[d]={}),e[d][c]=h,e}),{});return Object.entries(o).reduce((function(e,r){var n=l(r,2),o=n[0],c=n[1];return e[o]=no(c,t),e}),{})}(t,r))}var oo="CMCD";var lo=/CMCD=[^&#]+/;function uo(e,t,r){var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return"";var r=no(e,t);return"".concat(oo,"=").concat(encodeURIComponent(r))}(t,r);if(!n)return e;if(lo.test(e))return e.replace(lo,n);var o=e.includes("?")?"&":"?";return"".concat(e).concat(o).concat(n)}var co=function(){function e(t){var r=this;D(this,e),this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){r.initialized&&(r.starved=!0),r.buffering=!0},this.onPlaying=function(){r.initialized||(r.initialized=!0),r.buffering=!1},this.applyPlaylistData=function(e){try{r.apply(e,{ot:xs.MANIFEST,su:!r.initialized})}catch(e){$.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=function(e){try{var t=e.frag,n=r.hls.levels[t.level],o=r.getObjectType(t),data={d:1e3*t.duration,ot:o};o!==xs.VIDEO&&o!==xs.AUDIO&&o!=xs.MUXED||(data.br=n.bitrate/1e3,data.tb=r.getTopBandwidth(o)/1e3,data.bl=r.getBufferLength(o)),r.apply(e,data)}catch(e){$.warn("Could not generate segment CMCD data.",e)}},this.hls=t;var n=this.config=t.config,o=n.cmcd;null!=o&&(n.pLoader=this.createPlaylistLoader(),n.fLoader=this.createFragmentLoader(),this.sid=o.sessionId||function(){try{return crypto.randomUUID()}catch(r){try{var e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){var dt=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(dt+16*Math.random())%16|0;return dt=Math.floor(dt/16),("x"==e?t:3&t|8).toString(16)}))}}}(),this.cid=o.contentId,this.useHeaders=!0===o.useHeaders,this.includeKeys=o.includeKeys,this.registerListeners())}return I(e,[{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHED,this.onMediaDetached,this),e.on(V.BUFFER_CREATED,this.onBufferCreated,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHED,this.onMediaDetached,this),e.off(V.BUFFER_CREATED,this.onBufferCreated,this)}},{key:"destroy",value:function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}},{key:"onMediaAttached",value:function(e,data){this.media=data.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}},{key:"onMediaDetached",value:function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}},{key:"onBufferCreated",value:function(e,data){var t,r;this.audioBuffer=null==(t=data.tracks.audio)?void 0:t.buffer,this.videoBuffer=null==(r=data.tracks.video)?void 0:r.buffer}},{key:"createData",value:function(){var e;return{v:1,sf:Ps.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}},{key:"apply",value:function(e){var data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};B(data,this.createData());var t=data.ot===xs.INIT||data.ot===xs.VIDEO||data.ot===xs.MUXED;this.starved&&t&&(data.bs=!0,data.su=!0,this.starved=!1),null==data.su&&(data.su=this.buffering);var r=this.includeKeys;r&&(data=Object.keys(data).reduce((function(e,t){return r.includes(t)&&(e[t]=data[t]),e}),{})),this.useHeaders?(e.headers||(e.headers={}),so(e.headers,data)):e.url=uo(e.url,data)}},{key:"getObjectType",value:function(e){var t=e.type;return"subtitle"===t?xs.TIMED_TEXT:"initSegment"===e.sn?xs.INIT:"audio"===t?xs.AUDIO:"main"===t?this.hls.audioTracks.length?xs.VIDEO:xs.MUXED:void 0}},{key:"getTopBandwidth",value:function(e){var t,r=0,n=this.hls;if(e===xs.AUDIO)t=n.audioTracks;else{var o=n.maxAutoLevel,l=o>-1?o+1:n.levels.length;t=n.levels.slice(0,l)}var h,d=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=c(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,l=!0,h=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return l=e.done,e},e:function(e){h=!0,o=e},f:function(){try{l||null==r.return||r.return()}finally{if(h)throw o}}}}(t);try{for(d.s();!(h=d.n()).done;){var f=h.value;f.bitrate>r&&(r=f.bitrate)}}catch(e){d.e(e)}finally{d.f()}return r>0?r:NaN}},{key:"getBufferLength",value:function(e){var t=this.hls.media,r=e===xs.AUDIO?this.audioBuffer:this.videoBuffer;return r&&t?1e3*Pi.bufferInfo(r,t.currentTime,this.config.maxBufferHole).len:NaN}},{key:"createPlaylistLoader",value:function(){var e=this.config.pLoader,t=this.applyPlaylistData,r=e||this.config.loader;return function(){function e(t){D(this,e),this.loader=void 0,this.loader=new r(t)}return I(e,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}},{key:"destroy",value:function(){this.loader.destroy()}},{key:"abort",value:function(){this.loader.abort()}},{key:"load",value:function(e,r,n){t(e),this.loader.load(e,r,n)}}]),e}()}},{key:"createFragmentLoader",value:function(){var e=this.config.fLoader,t=this.applyFragmentData,r=e||this.config.loader;return function(){function e(t){D(this,e),this.loader=void 0,this.loader=new r(t)}return I(e,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}},{key:"destroy",value:function(){this.loader.destroy()}},{key:"abort",value:function(){this.loader.abort()}},{key:"load",value:function(e,r,n){t(e),this.loader.load(e,r,n)}}]),e}()}}]),e}(),ho=function(){function e(t){D(this,e),this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=$.log.bind($,"[content-steering]:"),this.registerListeners()}return I(e,[{key:"registerListeners",value:function(){var e=this.hls;e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.ERROR,this.onError,this)}},{key:"unregisterListeners",value:function(){var e=this.hls;e&&(e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.ERROR,this.onError,this))}},{key:"startLoad",value:function(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){var e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}},{key:"stopLoad",value:function(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}},{key:"clearTimeout",value:function(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}},{key:"destroy",value:function(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}},{key:"removeLevel",value:function(e){var t=this.levels;t&&(this.levels=t.filter((function(t){return t!==e})))}},{key:"onManifestLoading",value:function(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}},{key:"onManifestLoaded",value:function(e,data){var t=data.contentSteering;null!==t&&(this.pathwayId=t.pathwayId,this.uri=t.uri,this.started&&this.startLoad())}},{key:"onManifestParsed",value:function(e,data){this.audioTracks=data.audioTracks,this.subtitleTracks=data.subtitleTracks}},{key:"onError",value:function(e,data){var t=data.errorAction;if((null==t?void 0:t.action)===ii&&t.flags===oi){var r=this.levels,n=this.pathwayPriority,o=this.pathwayId;if(data.context){var l=data.context,c=l.groupId,h=l.pathwayId,d=l.type;c&&r?o=this.getPathwayForGroupId(c,d,o):h&&(o=h)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!n&&r&&(n=r.reduce((function(e,t){return-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e}),[])),n&&n.length>1&&(this.updatePathwayPriority(n),t.resolved=this.pathwayId!==o),t.resolved||$.warn("Could not resolve ".concat(data.details,' ("').concat(data.error.message,'") with content-steering for Pathway: ').concat(o," levels: ").concat(r?r.length:r," priorities: ").concat(JSON.stringify(n)," penalized: ").concat(JSON.stringify(this.penalizedPathways)))}}},{key:"filterParsedLevels",value:function(e){this.levels=e;var t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){var r=e[0].pathwayId;this.log("No levels found in Pathway ".concat(this.pathwayId,'. Setting initial Pathway to "').concat(r,'"')),t=this.getLevelsForPathway(r),this.pathwayId=r}return t.length!==e.length&&this.log("Found ".concat(t.length,"/").concat(e.length,' levels in Pathway "').concat(this.pathwayId,'"')),t}},{key:"getLevelsForPathway",value:function(e){return null===this.levels?[]:this.levels.filter((function(t){return e===t.pathwayId}))}},{key:"updatePathwayPriority",value:function(e){var t;this.pathwayPriority=e;var r=this.penalizedPathways,n=performance.now();Object.keys(r).forEach((function(e){n-r[e]>3e5&&delete r[e]}));for(var i=0;i<e.length;i++){var o=e[i];if(!(o in r)){if(o===this.pathwayId)return;var l=this.hls.nextLoadLevel,c=this.hls.levels[l];if((t=this.getLevelsForPathway(o)).length>0){this.log('Setting Pathway to "'.concat(o,'"')),this.pathwayId=o,jr(t),this.hls.trigger(V.LEVELS_UPDATED,{levels:t});var h=this.hls.levels[l];c&&h&&this.levels&&(h.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&h.bitrate!==c.bitrate&&this.log("Unstable Pathways change from bitrate ".concat(c.bitrate," to ").concat(h.bitrate)),this.hls.nextLoadLevel=l);break}}}}},{key:"getPathwayForGroupId",value:function(e,t,r){for(var n=this.getLevelsForPathway(r).concat(this.levels||[]),i=0;i<n.length;i++)if(t===nr&&n[i].hasAudioGroup(e)||t===sr&&n[i].hasSubtitleGroup(e))return n[i].pathwayId;return r}},{key:"clonePathways",value:function(e){var t=this,r=this.levels;if(r){var n={},l={};e.forEach((function(e){var c=e.ID,h=e["BASE-ID"],d=e["URI-REPLACEMENT"];if(!r.some((function(e){return e.pathwayId===c}))){var f=t.getLevelsForPathway(h).map((function(e){var t=new te(e.attrs);t["PATHWAY-ID"]=c;var r=t.AUDIO&&"".concat(t.AUDIO,"_clone_").concat(c),o=t.SUBTITLES&&"".concat(t.SUBTITLES,"_clone_").concat(c);r&&(n[t.AUDIO]=r,t.AUDIO=r),o&&(l[t.SUBTITLES]=o,t.SUBTITLES=o);var h=vo(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",d),f=new Or({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:h,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(var i=1;i<e.audioGroups.length;i++)f.addGroupId("audio","".concat(e.audioGroups[i],"_clone_").concat(c));if(e.subtitleGroups)for(var v=1;v<e.subtitleGroups.length;v++)f.addGroupId("text","".concat(e.subtitleGroups[v],"_clone_").concat(c));return f}));r.push.apply(r,o(f)),fo(t.audioTracks,n,d,c),fo(t.subtitleTracks,l,d,c)}}))}}},{key:"loadSteeringManifest",value:function(e){var t,r=this,n=this.hls.config,o=n.loader;this.loader&&this.loader.destroy(),this.loader=new o(n);try{t=new self.URL(e)}catch(t){return this.enabled=!1,void this.log("Failed to parse Steering Manifest URI: ".concat(e))}if("data:"!==t.protocol){var l=0|(this.hls.bandwidthEstimate||n.abrEwmaDefaultEstimate);t.searchParams.set("_HLS_pathway",this.pathwayId),t.searchParams.set("_HLS_throughput",""+l)}var c={responseType:"json",url:t.href},h=n.steeringManifestLoadPolicy.default,d=h.errorRetry||h.timeoutRetry||{},f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:d.maxNumRetry||0,retryDelay:d.retryDelayMs||0,maxRetryDelay:d.maxRetryDelayMs||0},v={onSuccess:function(e,n,o,l){r.log('Loaded steering manifest: "'.concat(t,'"'));var c=e.data;if(1===c.VERSION){r.updated=performance.now(),r.timeToLoad=c.TTL;var h=c["RELOAD-URI"],d=c["PATHWAY-CLONES"],f=c["PATHWAY-PRIORITY"];if(h)try{r.uri=new self.URL(h,t).href}catch(e){return r.enabled=!1,void r.log("Failed to parse Steering Manifest RELOAD-URI: ".concat(h))}r.scheduleRefresh(r.uri||o.url),d&&r.clonePathways(d);var v={steeringManifest:c,url:t.toString()};r.hls.trigger(V.STEERING_MANIFEST_LOADED,v),f&&r.updatePathwayPriority(f)}else r.log("Steering VERSION ".concat(c.VERSION," not supported!"))},onError:function(e,t,n,o){if(r.log("Error loading steering manifest: ".concat(e.code," ").concat(e.text," (").concat(t.url,")")),r.stopLoad(),410===e.code)return r.enabled=!1,void r.log("Steering manifest ".concat(t.url," no longer available"));var l=1e3*r.timeToLoad;if(429!==e.code)r.scheduleRefresh(r.uri||t.url,l);else{var c=r.loader;if("function"==typeof(null==c?void 0:c.getResponseHeader)){var h=c.getResponseHeader("Retry-After");h&&(l=1e3*parseFloat(h))}r.log("Steering manifest ".concat(t.url," rate limited"))}},onTimeout:function(e,t,n){r.log("Timeout loading steering manifest (".concat(t.url,")")),r.scheduleRefresh(r.uri||t.url)}};this.log("Requesting steering manifest: ".concat(t)),this.loader.load(c,f,v)}},{key:"scheduleRefresh",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3*this.timeToLoad;this.clearTimeout(),this.reloadTimer=self.setTimeout((function(){var r,n=null==(r=t.hls)?void 0:r.media;!n||n.ended?t.scheduleRefresh(e,1e3*t.timeToLoad):t.loadSteeringManifest(e)}),r)}}]),e}();function fo(e,t,r,n){e&&Object.keys(t).forEach((function(l){var c=e.filter((function(track){return track.groupId===l})).map((function(track){var e=B({},track);return e.details=void 0,e.attrs=new te(e.attrs),e.url=e.attrs.URI=vo(track.url,track.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",r),e.groupId=e.attrs["GROUP-ID"]=t[l],e.attrs["PATHWAY-ID"]=n,e}));e.push.apply(e,o(c))}))}function vo(e,t,r,n){var o,l=n.HOST,c=n.PARAMS,h=n[r];t&&(o=null==h?void 0:h[t])&&(e=o);var d=new self.URL(e);return l&&!o&&(d.host=l),c&&Object.keys(c).sort().forEach((function(e){e&&d.searchParams.set(e,c[e])})),d.href}var go=/^age:\s*[\d.]+\s*$/im,mo=function(){function e(t){D(this,e),this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new ae,this.retryDelay=0}return I(e,[{key:"destroy",value:function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}},{key:"abortInternal",value:function(){var e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}},{key:"abort",value:function(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}},{key:"load",value:function(e,t,r){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=r,this.loadInternal()}},{key:"loadInternal",value:function(){var e=this,t=this.config,r=this.context;if(t&&r){var n=this.loader=new self.XMLHttpRequest,o=this.stats;o.loading.first=0,o.loaded=0,o.aborted=!1;var l=this.xhrSetup;l?Promise.resolve().then((function(){if(e.loader===n&&!e.stats.aborted)return l(n,r.url)})).catch((function(t){if(e.loader===n&&!e.stats.aborted)return n.open("GET",r.url,!0),l(n,r.url)})).then((function(){e.loader!==n||e.stats.aborted||e.openAndSendXhr(n,r,t)})).catch((function(t){e.callbacks.onError({code:n.status,text:t.message},r,n,o)})):this.openAndSendXhr(n,r,t)}}},{key:"openAndSendXhr",value:function(e,t,r){e.readyState||e.open("GET",t.url,!0);var n=t.headers,o=r.loadPolicy,l=o.maxTimeToFirstByteMs,c=o.maxLoadTimeMs;if(n)for(var header in n)e.setRequestHeader(header,n[header]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),r.timeout=l&&G(l)?l:c,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.timeout),e.send()}},{key:"readystatechange",value:function(){var e=this.context,t=this.loader,r=this.stats;if(e&&t){var n=t.readyState,o=this.config;if(!r.aborted&&n>=2&&(0===r.loading.first&&(r.loading.first=Math.max(self.performance.now(),r.loading.start),o.timeout!==o.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),o.timeout=o.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),o.loadPolicy.maxLoadTimeMs-(r.loading.first-r.loading.start)))),4===n)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;var l=t.status,c="text"!==t.responseType;if(l>=200&&l<300&&(c&&t.response||null!==t.responseText)){r.loading.end=Math.max(self.performance.now(),r.loading.first);var data=c?t.response:t.responseText,h="arraybuffer"===t.responseType?data.byteLength:data.length;if(r.loaded=r.total=h,r.bwEstimate=8e3*r.total/(r.loading.end-r.loading.first),!this.callbacks)return;var d=this.callbacks.onProgress;if(d&&d(r,e,data,t),!this.callbacks)return;var f={url:t.responseURL,data:data,code:l};this.callbacks.onSuccess(f,r,e,t)}else{var v=o.loadPolicy.errorRetry;Qr(v,r.retry,!1,{url:e.url,data:void 0,code:l})?this.retry(v):($.error("".concat(l," while loading ").concat(e.url)),this.callbacks.onError({code:l,text:t.statusText},e,t,r))}}}}},{key:"loadtimeout",value:function(){if(this.config){var e=this.config.loadPolicy.timeoutRetry;if(Qr(e,this.stats.retry,!0))this.retry(e);else{var t;$.warn("timeout while loading ".concat(null==(t=this.context)?void 0:t.url));var r=this.callbacks;r&&(this.abortInternal(),r.onTimeout(this.stats,this.context,this.loader))}}}},{key:"retry",value:function(e){var t=this.context,r=this.stats;this.retryDelay=Xr(e,r.retry),r.retry++,$.warn("".concat(status?"HTTP Status "+status:"Timeout"," while loading ").concat(null==t?void 0:t.url,", retrying ").concat(r.retry,"/").concat(e.maxNumRetry," in ").concat(this.retryDelay,"ms")),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}},{key:"loadprogress",value:function(e){var t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}},{key:"getCacheAge",value:function(){var e=null;if(this.loader&&go.test(this.loader.getAllResponseHeaders())){var t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}},{key:"getResponseHeader",value:function(e){return this.loader&&new RegExp("^".concat(e,":\\s*[\\d.]+\\s*$"),"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}]),e}();var yo=/(\d+)-(\d+)\/(\d+)/,po=function(){function e(t){D(this,e),this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||ko,this.controller=new self.AbortController,this.stats=new ae}return I(e,[{key:"destroy",value:function(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}},{key:"abortInternal",value:function(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}},{key:"abort",value:function(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}},{key:"load",value:function(e,t,r){var n=this,o=this.stats;if(o.loading.start)throw new Error("Loader can only be used once.");o.loading.start=self.performance.now();var l=function(e,t){var r={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(B({},e.headers))};e.rangeEnd&&r.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return r}(e,this.controller.signal),c=r.onProgress,h="arraybuffer"===e.responseType,d=h?"byteLength":"length",f=t.loadPolicy,v=f.maxTimeToFirstByteMs,m=f.maxLoadTimeMs;this.context=e,this.config=t,this.callbacks=r,this.request=this.fetchSetup(e,l),self.clearTimeout(this.requestTimeout),t.timeout=v&&G(v)?v:m,this.requestTimeout=self.setTimeout((function(){n.abortInternal(),r.onTimeout(o,e,n.response)}),t.timeout),self.fetch(this.request).then((function(l){n.response=n.loader=l;var d=Math.max(self.performance.now(),o.loading.start);if(self.clearTimeout(n.requestTimeout),t.timeout=m,n.requestTimeout=self.setTimeout((function(){n.abortInternal(),r.onTimeout(o,e,n.response)}),m-(d-o.loading.start)),!l.ok){var f=l.status,v=l.statusText;throw new To(v||"fetch, bad network response",f,l)}return o.loading.first=d,o.total=function(e){var t=e.get("Content-Range");if(t){var r=function(e){var t=yo.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(G(r))return r}var n=e.get("Content-Length");if(n)return parseInt(n)}(l.headers)||o.total,c&&G(t.highWaterMark)?n.loadProgressively(l,o,e,t.highWaterMark,c):h?l.arrayBuffer():"json"===e.responseType?l.json():l.text()})).then((function(l){var h=n.response;if(!h)throw new Error("loader destroyed");self.clearTimeout(n.requestTimeout),o.loading.end=Math.max(self.performance.now(),o.loading.first);var f=l[d];f&&(o.loaded=o.total=f);var v={url:h.url,data:l,code:h.status};c&&!G(t.highWaterMark)&&c(o,e,l,h),r.onSuccess(v,o,e,h)})).catch((function(t){if(self.clearTimeout(n.requestTimeout),!o.aborted){var code=t&&t.code||0,text=t?t.message:null;r.onError({code:code,text:text},e,t?t.details:null,o)}}))}},{key:"getCacheAge",value:function(){var e=null;if(this.response){var t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}},{key:"getResponseHeader",value:function(e){return this.response?this.response.headers.get(e):null}},{key:"loadProgressively",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4?arguments[4]:void 0,l=new ua,c=e.body.getReader(),h=function h(){return c.read().then((function(data){if(data.done)return l.dataLength&&o(t,r,l.flush(),e),Promise.resolve(new ArrayBuffer(0));var c=data.value,d=c.length;return t.loaded+=d,d<n||l.dataLength?(l.push(c),l.dataLength>=n&&o(t,r,l.flush(),e)):o(t,r,c,e),h()})).catch((function(){return Promise.reject()}))};return h()}}]),e}();function ko(e,t){return new self.Request(e.url,t)}var Eo,To=function(e){y(r,e);var t=E(r);function r(e,code,details){var n;return D(this,r),(n=t.call(this,e)).code=void 0,n.details=void 0,n.code=code,n.details=details,n}return I(r)}(v(Error)),So=/\s/,Lo=O(O({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:mo,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Li,bufferController:xn,capLevelController:ws,errorController:ci,fpsController:Is,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Ce,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:{newCue:function(track,e,t,r){for(var n,o,l,c,text,h=[],d=self.VTTCue||self.TextTrackCue,f=0;f<r.rows.length;f++)if(l=!0,c=0,text="",!(n=r.rows[f]).isEmpty()){for(var v,m=0;m<n.chars.length;m++)So.test(n.chars[m].uchar)&&l?c++:(text+=n.chars[m].uchar,l=!1);n.cueStartTime=e,e===t&&(t+=1e-4),c>=16?c--:c++;var y=os(text.trim()),k=ds(e,t,y);null!=track&&null!=(v=track.cues)&&v.getCueById(k)||((o=new d(e,t,y)).id=k,o.line=f+1,o.align="left",o.position=10+Math.min(80,10*Math.floor(8*c/32)),h.push(o))}return track&&h.length&&(h.sort((function(e,t){return"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line})),h.forEach((function(e){return gr(track,e)}))),h}},enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:Dn,subtitleTrackController:In,timelineController:Rs,audioStreamController:Rn,audioTrackController:bn,emeController:_s,cmcdController:co,contentSteeringController:ho});function Ao(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');var r=Ro(e),n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((function(e){var o="".concat("level"===e?"playlist":e,"LoadPolicy"),l=void 0===t[o],c=[];n.forEach((function(n){var h="".concat(e,"Loading").concat(n),d=t[h];if(void 0!==d&&l){c.push(h);var f=r[o].default;switch(t[o]={default:f},n){case"TimeOut":f.maxLoadTimeMs=d,f.maxTimeToFirstByteMs=d;break;case"MaxRetry":f.errorRetry.maxNumRetry=d,f.timeoutRetry.maxNumRetry=d;break;case"RetryDelay":f.errorRetry.retryDelayMs=d,f.timeoutRetry.retryDelayMs=d;break;case"MaxRetryTimeout":f.errorRetry.maxRetryDelayMs=d,f.timeoutRetry.maxRetryDelayMs=d}}})),c.length&&$.warn('hls.js config: "'.concat(c.join('", "'),'" setting(s) are deprecated, use "').concat(o,'": ').concat(JSON.stringify(t[o])))})),O(O({},r),t)}function Ro(e){return e&&"object"===_(e)?Array.isArray(e)?e.map(Ro):Object.keys(e).reduce((function(t,r){return t[r]=Ro(e[r]),t}),{}):e}function bo(e){var t=e.loader;t!==po&&t!==mo?($.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}()&&(e.loader=po,e.progressive=!0,e.enableSoftwareAES=!0,$.log("[config]: Progressive streaming enabled, using FetchLoader"))}var Do=function(e){y(r,e);var t=E(r);function r(e,n){var o;return D(this,r),(o=t.call(this,e,"[level-controller]"))._levels=[],o._firstLevel=-1,o._maxAutoLevel=-1,o._startLevel=void 0,o.currentLevel=null,o.currentLevelIndex=-1,o.manualLevelIndex=-1,o.steering=void 0,o.onParsedComplete=void 0,o.steering=n,o._registerListeners(),o}return I(r,[{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(V.LEVEL_LOADED,this.onLevelLoaded,this),e.on(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this),e.on(V.ERROR,this.onError,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(V.LEVEL_LOADED,this.onLevelLoaded,this),e.off(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this),e.off(V.ERROR,this.onError,this)}},{key:"destroy",value:function(){this._unregisterListeners(),this.steering=null,this.resetLevels(),d(A(r.prototype),"destroy",this).call(this)}},{key:"stopLoad",value:function(){this._levels.forEach((function(e){e.loadError=0,e.fragmentError=0})),d(A(r.prototype),"stopLoad",this).call(this)}},{key:"resetLevels",value:function(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}},{key:"onManifestLoading",value:function(e,data){this.resetLevels()}},{key:"onManifestLoaded",value:function(e,data){var t=this.hls.config.preferManagedMediaSource,r=[],n={},o={},l=!1,c=!1,h=!1;data.levels.forEach((function(e){var d,f,v=e.attrs,m=e.audioCodec,y=e.videoCodec;-1!==(null==(d=m)?void 0:d.indexOf("mp4a.40.34"))&&(Eo||(Eo=/chrome|firefox/i.test(navigator.userAgent)),Eo&&(e.audioCodec=m=void 0)),m&&(e.audioCodec=m=Kt(m,t)),0===(null==(f=y)?void 0:f.indexOf("avc1"))&&(y=e.videoCodec=function(e){for(var t=e.split(","),i=0;i<t.length;i++){var r=t[i].split(".");if(r.length>2){var n=r.shift()+".";n+=parseInt(r.shift()).toString(16),n+=("000"+parseInt(r.shift()).toString(16)).slice(-4),t[i]=n}}return t.join(",")}(y));var k=e.width,E=e.height,T=e.unknownCodecs;if(l||(l=!(!k||!E)),c||(c=!!y),h||(h=!!m),!(null!=T&&T.length||m&&!Pt(m,"audio",t)||y&&!Pt(y,"video",t))){var S=v.CODECS,L=v["FRAME-RATE"],A=v["HDCP-LEVEL"],R=v["PATHWAY-ID"],D=v.RESOLUTION,w=v["VIDEO-RANGE"],I="".concat(R||".","-"),C="".concat(I).concat(e.bitrate,"-").concat(D,"-").concat(L,"-").concat(S,"-").concat(w,"-").concat(A);if(n[C])if(n[C].uri===e.url||e.attrs["PATHWAY-ID"])n[C].addGroupId("audio",v.AUDIO),n[C].addGroupId("text",v.SUBTITLES);else{var _=o[C]+=1;e.attrs["PATHWAY-ID"]=new Array(_+1).join(".");var x=new Or(e);n[C]=x,r.push(x)}else{var P=new Or(e);n[C]=P,o[C]=1,r.push(P)}}})),this.filterAndSortMediaOptions(r,data,l,c,h)}},{key:"filterAndSortMediaOptions",value:function(e,data,t,r,n){var o=this,l=[],c=[],h=e;if((t||r)&&n&&(h=h.filter((function(e){var t,r=e.videoCodec,n=e.videoRange,o=e.width,l=e.height;return(!!r||!(!o||!l))&&(!!(t=n)&&Cr.indexOf(t)>-1)}))),0!==h.length){if(data.audioTracks){var d=this.hls.config.preferManagedMediaSource;wo(l=data.audioTracks.filter((function(track){return!track.audioCodec||Pt(track.audioCodec,"audio",d)})))}data.subtitles&&wo(c=data.subtitles);var f=h.slice(0);h.sort((function(a,b){if(a.attrs["HDCP-LEVEL"]!==b.attrs["HDCP-LEVEL"])return(a.attrs["HDCP-LEVEL"]||"")>(b.attrs["HDCP-LEVEL"]||"")?1:-1;if(t&&a.height!==b.height)return a.height-b.height;if(a.frameRate!==b.frameRate)return a.frameRate-b.frameRate;if(a.videoRange!==b.videoRange)return Cr.indexOf(a.videoRange)-Cr.indexOf(b.videoRange);if(a.videoCodec!==b.videoCodec){var e=Ot(a.videoCodec),r=Ot(b.videoCodec);if(e!==r)return r-e}if(a.uri===b.uri&&a.codecSet!==b.codecSet){var n=Nt(a.codecSet),o=Nt(b.codecSet);if(n!==o)return o-n}return a.averageBitrate!==b.averageBitrate?a.averageBitrate-b.averageBitrate:0}));var v=f[0];if(this.steering&&(h=this.steering.filterParsedLevels(h)).length!==f.length)for(var i=0;i<f.length;i++)if(f[i].pathwayId===h[0].pathwayId){v=f[i];break}this._levels=h;for(var m=0;m<h.length;m++)if(h[m]===v){var y;this._firstLevel=m;var k=v.bitrate,E=this.hls.bandwidthEstimate;if(this.log("manifest loaded, ".concat(h.length," level(s) found, first bitrate: ").concat(k)),void 0===(null==(y=this.hls.userConfig)?void 0:y.abrEwmaDefaultEstimate)){var T=Math.min(k,this.hls.config.abrEwmaDefaultEstimateMax);T>E&&E===Lo.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=T)}break}var S=n&&!r,L={levels:h,audioTracks:l,subtitleTracks:c,sessionData:data.sessionData,sessionKeys:data.sessionKeys,firstLevel:this._firstLevel,stats:data.stats,audio:n,video:r,altAudio:!S&&l.some((function(e){return!!e.url}))};this.hls.trigger(V.MANIFEST_PARSED,L),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else Promise.resolve().then((function(){if(o.hls){data.levels.length&&o.warn("One or more CODECS in variant not supported: ".concat(JSON.stringify(data.levels[0].attrs)));var e=new Error("no level with compatible codecs found in manifest");o.hls.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:data.url,error:e,reason:e.message})}}))}},{key:"levels",get:function(){return 0===this._levels.length?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(e){var t=this._levels;if(0!==t.length){if(e<0||e>=t.length){var r=new Error("invalid level idx"),n=e<0;if(this.hls.trigger(V.ERROR,{type:Y.OTHER_ERROR,details:j.LEVEL_SWITCH_ERROR,level:e,fatal:n,error:r,reason:r.message}),n)return;e=Math.min(e,t.length-1)}var o=this.currentLevelIndex,l=this.currentLevel,c=l?l.attrs["PATHWAY-ID"]:void 0,h=t[e],d=h.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=h,o!==e||!h.details||!l||c!==d){this.log("Switching to level ".concat(e," (").concat(h.height?h.height+"p ":"").concat(h.videoRange?h.videoRange+" ":"").concat(h.codecSet?h.codecSet+" ":"","@").concat(h.bitrate,")").concat(d?" with Pathway "+d:""," from level ").concat(o).concat(c?" with Pathway "+c:""));var f={level:e,attrs:h.attrs,details:h.details,bitrate:h.bitrate,averageBitrate:h.averageBitrate,maxBitrate:h.maxBitrate,realBitrate:h.realBitrate,width:h.width,height:h.height,codecSet:h.codecSet,audioCodec:h.audioCodec,videoCodec:h.videoCodec,audioGroups:h.audioGroups,subtitleGroups:h.subtitleGroups,loaded:h.loaded,loadError:h.loadError,fragmentError:h.fragmentError,name:h.name,id:h.id,uri:h.uri,url:h.url,urlId:0,audioGroupIds:h.audioGroupIds,textGroupIds:h.textGroupIds};this.hls.trigger(V.LEVEL_SWITCHING,f);var v=h.details;if(!v||v.live){var m=this.switchParams(h.uri,null==l?void 0:l.details,v);this.loadPlaylist(m)}}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(e){this._firstLevel=e}},{key:"startLevel",get:function(){if(void 0===this._startLevel){var e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel},set:function(e){this._startLevel=e}},{key:"onError",value:function(e,data){!data.fatal&&data.context&&data.context.type===ar&&data.context.level===this.level&&this.checkRetry(data)}},{key:"onFragBuffered",value:function(e,t){var r=t.frag;if(void 0!==r&&r.type===or){var n=r.elementaryStreams;if(!Object.keys(n).some((function(e){return!!n[e]})))return;var o=this._levels[r.level];null!=o&&o.loadError&&(this.log("Resetting level error count of ".concat(o.loadError," on frag buffered")),o.loadError=0)}}},{key:"onLevelLoaded",value:function(e,data){var t,r,n=data.level,details=data.details,o=this._levels[n];if(!o)return this.warn("Invalid level index ".concat(n)),void(null!=(r=data.deliveryDirectives)&&r.skip&&(details.deltaUpdateFailed=!0));n===this.currentLevelIndex?(0===o.fragmentError&&(o.loadError=0),this.playlistLoaded(n,data,o.details)):null!=(t=data.deliveryDirectives)&&t.skip&&(details.deltaUpdateFailed=!0)}},{key:"loadPlaylist",value:function(e){d(A(r.prototype),"loadPlaylist",this).call(this);var t=this.currentLevelIndex,n=this.currentLevel;if(n&&this.shouldLoadPlaylist(n)){var o=n.uri;if(e)try{o=e.addDirectives(o)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(e))}var l=n.attrs["PATHWAY-ID"];this.log("Loading level index ".concat(t).concat(void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""," with").concat(l?" Pathway "+l:""," ").concat(o)),this.clearTimer(),this.hls.trigger(V.LEVEL_LOADING,{url:o,level:t,pathwayId:n.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}},{key:"nextLoadLevel",get:function(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}},{key:"removeLevel",value:function(e){var t,r=this,n=this._levels.filter((function(t,n){return n!==e||(r.steering&&r.steering.removeLevel(t),t===r.currentLevel&&(r.currentLevel=null,r.currentLevelIndex=-1,t.details&&t.details.fragments.forEach((function(e){return e.level=-1}))),!1)}));jr(n),this._levels=n,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(V.LEVELS_UPDATED,{levels:n})}},{key:"onLevelsUpdated",value:function(e,t){var r=t.levels;this._levels=r}},{key:"checkMaxAutoUpdated",value:function(){var e=this.hls,t=e.autoLevelCapping,r=e.maxAutoLevel,n=e.maxHdcpLevel;this._maxAutoLevel!==r&&(this._maxAutoLevel=r,this.hls.trigger(V.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:r,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}}]),r}(hi);function wo(e){var t={};e.forEach((function(track){var e=track.groupId||"";track.id=t[e]=t[e]||0,t[e]++}))}var Io=function(){function e(t){D(this,e),this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}return I(e,[{key:"abort",value:function(e){for(var t in this.keyUriToKeyInfo){var r=this.keyUriToKeyInfo[t].loader;if(r){var n;if(e&&e!==(null==(n=r.context)?void 0:n.frag.type))return;r.abort()}}}},{key:"detach",value:function(){for(var e in this.keyUriToKeyInfo){var t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}},{key:"destroy",value:function(){for(var e in this.detach(),this.keyUriToKeyInfo){var t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}},{key:"createKeyLoadError",value:function(e){var details=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j.KEY_LOAD_ERROR,t=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;return new Yi({type:Y.NETWORK_ERROR,details:details,fatal:!1,frag:e,response:n,error:t,networkDetails:r})}},{key:"loadClear",value:function(e,t){var r=this;if(this.emeController&&this.config.emeEnabled)for(var n=e.sn,o=e.cc,l=function(i){var e=t[i];if(o<=e.cc&&("initSegment"===n||"initSegment"===e.sn||n<e.sn))return r.emeController.selectKeySystemFormat(e).then((function(t){e.setKeyFormat(t)})),"break"},i=0;i<t.length;i++){if("break"===l(i))break}}},{key:"load",value:function(e){var t=this;return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then((function(r){return t.loadInternal(e,r)})):this.loadInternal(e)}},{key:"loadInternal",value:function(e,t){var r,n;t&&e.setKeyFormat(t);var o=e.decryptdata;if(!o){var l=new Error(t?"Expected frag.decryptdata to be defined after setting format ".concat(t):"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,j.KEY_LOAD_ERROR,l))}var c=o.uri;if(!c)return Promise.reject(this.createKeyLoadError(e,j.KEY_LOAD_ERROR,new Error('Invalid key URI: "'.concat(c,'"'))));var h,d=this.keyUriToKeyInfo[c];if(null!=(r=d)&&r.decryptdata.key)return o.key=d.decryptdata.key,Promise.resolve({frag:e,keyInfo:d});if(null!=(n=d)&&n.keyLoadPromise)switch(null==(h=d.mediaKeySessionContext)?void 0:h.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return d.keyLoadPromise.then((function(t){return o.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:d}}))}switch(d=this.keyUriToKeyInfo[c]={decryptdata:o,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},o.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===o.keyFormat?this.loadKeyHTTP(d,e):this.loadKeyEME(d,e);case"AES-128":return this.loadKeyHTTP(d,e);default:return Promise.reject(this.createKeyLoadError(e,j.KEY_LOAD_ERROR,new Error('Key supplied with unsupported METHOD: "'.concat(o.method,'"'))))}}},{key:"loadKeyEME",value:function(e,t){var r={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var n=this.emeController.loadKey(r);if(n)return(e.keyLoadPromise=n.then((function(t){return e.mediaKeySessionContext=t,r}))).catch((function(t){throw e.keyLoadPromise=null,t}))}return Promise.resolve(r)}},{key:"loadKeyHTTP",value:function(e,t){var r=this,n=this.config,o=new(0,n.loader)(n);return t.keyLoader=e.loader=o,e.keyLoadPromise=new Promise((function(l,c){var h={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},d=n.keyLoadPolicy.default,f={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},v={onSuccess:function(e,t,n,o){var h=n.frag,d=n.keyInfo,f=n.url;if(!h.decryptdata||d!==r.keyUriToKeyInfo[f])return c(r.createKeyLoadError(h,j.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),o));d.decryptdata.key=h.decryptdata.key=new Uint8Array(e.data),h.keyLoader=null,d.loader=null,l({frag:h,keyInfo:d})},onError:function(e,n,o,l){r.resetLoader(n),c(r.createKeyLoadError(t,j.KEY_LOAD_ERROR,new Error("HTTP Error ".concat(e.code," loading key ").concat(e.text)),o,O({url:h.url,data:void 0},e)))},onTimeout:function(e,n,o){r.resetLoader(n),c(r.createKeyLoadError(t,j.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),o))},onAbort:function(e,n,o){r.resetLoader(n),c(r.createKeyLoadError(t,j.INTERNAL_ABORTED,new Error("key loading aborted"),o))}};o.load(h,f,v)}))}},{key:"resetLoader",value:function(e){var t=e.frag,r=e.keyInfo,n=e.url,o=r.loader;t.keyLoader===o&&(t.keyLoader=null,r.loader=null),delete this.keyUriToKeyInfo[n],o&&o.destroy()}}]),e}();function Co(){return self.SourceBuffer||self.WebKitSourceBuffer}function _o(){if(!_t())return!1;var e=Co();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}var xo=function(){function e(t,r,n,o){D(this,e),this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=r,this.fragmentTracker=n,this.hls=o}return I(e,[{key:"destroy",value:function(){this.media=null,this.hls=this.fragmentTracker=null}},{key:"poll",value:function(e,t){var r=this.config,n=this.media,o=this.stalled;if(null!==n){var l=n.currentTime,c=n.seeking,h=this.seeking&&!c,d=!this.seeking&&c;if(this.seeking=c,l===e)if(d||h)this.stalled=null;else if(n.paused&&!c||n.ended||0===n.playbackRate||!Pi.getBuffered(n).length)this.nudgeRetry=0;else{var f=Pi.bufferInfo(n,l,0),v=f.nextStart||0;if(c){var m=f.len>2,y=!v||t&&t.start<=l||v-l>2&&!this.fragmentTracker.getPartialFragment(l);if(m||y)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var k;if(!(f.len>0)&&!v)return;var E=Math.max(v,f.start||0)-l,T=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,S=(null==T||null==(k=T.details)?void 0:k.live)?2*T.details.targetduration:2,L=this.fragmentTracker.getPartialFragment(l);if(E>0&&(E<=S||L))return void(n.paused||this._trySkipBufferHole(L))}var A=self.performance.now();if(null!==o){var R=A-o;if(c||!(R>=250)||(this._reportStall(f),this.media)){var D=Pi.bufferInfo(n,l,r.maxBufferHole);this._tryFixBufferStall(D,R)}}else this.stalled=A}else if(this.moved=!0,c||(this.nudgeRetry=0),null!==o){if(this.stallReported){var w=self.performance.now()-o;$.warn("playback not stuck anymore @".concat(l,", after ").concat(Math.round(w),"ms")),this.stallReported=!1}this.stalled=null}}}},{key:"_tryFixBufferStall",value:function(e,t){var r=this.config,n=this.fragmentTracker,o=this.media;if(null!==o){var l=o.currentTime,c=n.getPartialFragment(l);if(c)if(this._trySkipBufferHole(c)||!this.media)return;(e.len>r.maxBufferHole||e.nextStart&&e.nextStart-l<r.maxBufferHole)&&t>1e3*r.highBufferWatchdogPeriod&&($.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}}},{key:"_reportStall",value:function(e){var t=this.hls,r=this.media;if(!this.stallReported&&r){this.stallReported=!0;var n=new Error("Playback stalling at @".concat(r.currentTime," due to low buffer (").concat(JSON.stringify(e),")"));$.warn(n.message),t.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_STALLED_ERROR,fatal:!1,error:n,buffer:e.len})}}},{key:"_trySkipBufferHole",value:function(e){var t=this.config,r=this.hls,n=this.media;if(null===n)return 0;var o=n.currentTime,l=Pi.bufferInfo(n,o,0),c=o<l.start?l.start:l.nextStart;if(c){var h=l.len<=t.maxBufferHole,d=l.len>0&&l.len<1&&n.readyState<3,f=c-o;if(f>0&&(h||d)){if(f>t.maxBufferHole){var v=this.fragmentTracker,m=!1;if(0===o){var y=v.getAppendedFrag(0,or);y&&c<y.end&&(m=!0)}if(!m){var k=e||v.getAppendedFrag(o,or);if(k){for(var E=!1,T=k.end;T<c;){var S=v.getPartialFragment(T);if(!S){E=!0;break}T+=S.duration}if(E)return 0}}}var L=Math.max(c+.05,o+.1);if($.warn("skipping hole, adjusting currentTime from ".concat(o," to ").concat(L)),this.moved=!0,this.stalled=null,n.currentTime=L,e&&!e.gap){var A=new Error("fragment loaded with buffer holes, seeking from ".concat(o," to ").concat(L));r.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:A,reason:A.message,frag:e})}return L}}return 0}},{key:"_tryNudgeBuffer",value:function(){var e=this.config,t=this.hls,r=this.media,n=this.nudgeRetry;if(null!==r){var o=r.currentTime;if(this.nudgeRetry++,n<e.nudgeMaxRetry){var l=o+(n+1)*e.nudgeOffset,c=new Error("Nudging 'currentTime' from ".concat(o," to ").concat(l));$.warn(c.message),r.currentTime=l,t.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1})}else{var h=new Error("Playhead still not moving while enough data buffered @".concat(o," after ").concat(e.nudgeMaxRetry," nudges"));$.error(h.message),t.trigger(V.ERROR,{type:Y.MEDIA_ERROR,details:j.BUFFER_STALLED_ERROR,error:h,fatal:!0})}}}}]),e}(),Po=function(e){y(r,e);var t=E(r);function r(e,n,o){var l;return D(this,r),(l=t.call(this,e,n,o,"[stream-controller]",or)).audioCodecSwap=!1,l.gapController=null,l.level=-1,l._forceStartLoad=!1,l.altAudio=!1,l.audioOnly=!1,l.fragPlaying=null,l.onvplaying=null,l.onvseeked=null,l.fragLastKbps=0,l.couldBacktrack=!1,l.backtrackFragment=null,l.audioCodecSwitch=!1,l.videoBuffer=null,l._registerListeners(),l}return I(r,[{key:"_registerListeners",value:function(){var e=this.hls;e.on(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(V.MANIFEST_LOADING,this.onManifestLoading,this),e.on(V.MANIFEST_PARSED,this.onManifestParsed,this),e.on(V.LEVEL_LOADING,this.onLevelLoading,this),e.on(V.LEVEL_LOADED,this.onLevelLoaded,this),e.on(V.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(V.ERROR,this.onError,this),e.on(V.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(V.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(V.BUFFER_CREATED,this.onBufferCreated,this),e.on(V.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"_unregisterListeners",value:function(){var e=this.hls;e.off(V.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(V.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(V.MANIFEST_LOADING,this.onManifestLoading,this),e.off(V.MANIFEST_PARSED,this.onManifestParsed,this),e.off(V.LEVEL_LOADED,this.onLevelLoaded,this),e.off(V.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(V.ERROR,this.onError,this),e.off(V.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(V.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(V.BUFFER_CREATED,this.onBufferCreated,this),e.off(V.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(V.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(V.FRAG_BUFFERED,this.onFragBuffered,this)}},{key:"onHandlerDestroying",value:function(){this._unregisterListeners(),d(A(r.prototype),"onHandlerDestroying",this).call(this)}},{key:"startLoad",value:function(e){if(this.levels){var t=this.lastCurrentTime,r=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){var n=r.startLevel;-1===n&&(r.config.testBandwidth&&this.levels.length>1?(n=0,this.bitrateTest=!0):n=r.firstAutoLevel),r.nextLoadLevel=n,this.level=r.loadLevel,this.loadedmetadata=!1}t>0&&-1===e&&(this.log("Override startPosition with lastCurrentTime @".concat(t.toFixed(3))),e=t),this.state=Ji,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=Qi}},{key:"stopLoad",value:function(){this._forceStartLoad=!1,d(A(r.prototype),"stopLoad",this).call(this)}},{key:"doTick",value:function(){switch(this.state){case oa:var e=this.levels,t=this.level,r=null==e?void 0:e[t],details=null==r?void 0:r.details;if(details&&(!details.live||this.levelLastLoaded===r)){if(this.waitForCdnTuneIn(details))break;this.state=Ji;break}if(this.hls.nextLoadLevel!==this.level){this.state=Ji;break}break;case ea:var n,o=self.performance.now(),l=this.retryDate;if(!l||o>=l||null!=(n=this.media)&&n.seeking){var c=this.levels,h=this.level,d=null==c?void 0:c[h];this.resetStartWhenNotLoaded(d||null),this.state=Ji}}this.state===Ji&&this.doTickIdle(),this.onTickEnd()}},{key:"onTickEnd",value:function(){d(A(r.prototype),"onTickEnd",this).call(this),this.checkBuffer(),this.checkFragmentChanged()}},{key:"doTickIdle",value:function(){var e=this.hls,t=this.levelLastLoaded,r=this.levels,n=this.media;if(null!==t&&(n||!this.startFragRequested&&e.config.startFragPrefetch)&&(!this.altAudio||!this.audioOnly)){var o=e.nextLoadLevel;if(null!=r&&r[o]){var l=r[o],c=this.getMainFwdBufferInfo();if(null!==c){var h=this.getLevelDetails();if(h&&this._streamEnded(c,h)){var data={};return this.altAudio&&(data.type="video"),this.hls.trigger(V.BUFFER_EOS,data),void(this.state=aa)}e.loadLevel!==o&&-1===e.manualLevel&&this.log("Adapting to level ".concat(o," from level ").concat(this.level)),this.level=e.nextLoadLevel=o;var d=l.details;if(!d||this.state===oa||d.live&&this.levelLastLoaded!==l)return this.level=o,void(this.state=oa);var f=c.len,v=this.getMaxBufferLength(l.maxBitrate);if(!(f>=v)){this.backtrackFragment&&this.backtrackFragment.start>c.end&&(this.backtrackFragment=null);var m=this.backtrackFragment?this.backtrackFragment.start:c.end,y=this.getNextFragment(m,d);if(this.couldBacktrack&&!this.fragPrevious&&y&&"initSegment"!==y.sn&&this.fragmentTracker.getState(y)!==wi){var k,E=(null!=(k=this.backtrackFragment)?k:y).sn-d.startSN,T=d.fragments[E-1];T&&y.cc===T.cc&&(y=T,this.fragmentTracker.removeFragment(T))}else this.backtrackFragment&&c.len&&(this.backtrackFragment=null);if(y&&this.isLoopLoading(y,m)){if(!y.gap){var S=this.audioOnly&&!this.altAudio?ne:se,L=(S===se?this.videoBuffer:this.mediaBuffer)||this.media;L&&this.afterBufferFlushed(L,S,or)}y=this.getNextFragmentLoopLoading(y,d,c,or,v)}y&&(!y.initSegment||y.initSegment.data||this.bitrateTest||(y=y.initSegment),this.loadFragment(y,l,m))}}}}}},{key:"loadFragment",value:function(e,t,n){var o=this.fragmentTracker.getState(e);this.fragCurrent=e,o===Ri||o===Di?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log("Fragment ".concat(e.sn," of level ").concat(e.level," is being downloaded to test bitrate and will not be buffered")),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,d(A(r.prototype),"loadFragment",this).call(this,e,t,n)):this.clearTrackerIfNeeded(e)}},{key:"getBufferedFrag",value:function(e){return this.fragmentTracker.getBufferedFrag(e,or)}},{key:"followingBufferedFrag",value:function(e){return e?this.getBufferedFrag(e.end+.5):null}},{key:"immediateLevelSwitch",value:function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}},{key:"nextLevelSwitch",value:function(){var e=this.levels,t=this.media;if(null!=t&&t.readyState){var r,n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);var o=this.getLevelDetails();if(null!=o&&o.live){var l=this.getMainFwdBufferInfo();if(!l||l.len<2*o.targetduration)return}if(!t.paused&&e){var c=e[this.hls.nextLoadLevel],h=this.fragLastKbps;r=h&&this.fragCurrent?this.fragCurrent.duration*c.maxBitrate/(1e3*h)+1:0}else r=0;var d=this.getBufferedFrag(t.currentTime+r);if(d){var f=this.followingBufferedFrag(d);if(f){this.abortCurrentFrag();var v=f.maxStartPTS?f.maxStartPTS:f.start,m=f.duration,y=Math.max(d.end,v+Math.min(Math.max(m-this.config.maxFragLookUpTolerance,m*(this.couldBacktrack?.5:.125)),m*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(y,Number.POSITIVE_INFINITY)}}}}},{key:"abortCurrentFrag",value:function(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case $i:case Zi:case ea:case ra:case ia:this.state=Ji}this.nextLoadPosition=this.getLoadPosition()}},{key:"flushMainBuffer",value:function(e,t){d(A(r.prototype),"flushMainBuffer",this).call(this,e,t,this.altAudio?"video":null)}},{key:"onMediaAttached",value:function(e,data){d(A(r.prototype),"onMediaAttached",this).call(this,e,data);var t=data.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),t.addEventListener("playing",this.onvplaying),t.addEventListener("seeked",this.onvseeked),this.gapController=new xo(this.config,t,this.fragmentTracker,this.hls)}},{key:"onMediaDetaching",value:function(){var e=this.media;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),d(A(r.prototype),"onMediaDetaching",this).call(this)}},{key:"onMediaPlaying",value:function(){this.tick()}},{key:"onMediaSeeked",value:function(){var e=this.media,t=e?e.currentTime:null;G(t)&&this.log("Media seeked to ".concat(t.toFixed(3)));var r=this.getMainFwdBufferInfo();null!==r&&0!==r.len?this.tick():this.warn('Main forward buffer length on "seeked" event '.concat(r?r.len:"empty",")"))}},{key:"onManifestLoading",value:function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(V.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}},{key:"onManifestParsed",value:function(e,data){var t,r,n=!1,o=!1;data.levels.forEach((function(e){var t=e.audioCodec;t&&(n=n||-1!==t.indexOf("mp4a.40.2"),o=o||-1!==t.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=n&&o&&!("function"==typeof(null==(r=Co())||null==(t=r.prototype)?void 0:t.changeType)),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=data.levels,this.startFragRequested=!1}},{key:"onLevelLoading",value:function(e,data){var t=this.levels;if(t&&this.state===Ji){var r=t[data.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=oa)}}},{key:"onLevelLoaded",value:function(e,data){var t,r=this.levels,n=data.level,o=data.details,l=o.totalduration;if(r){this.log("Level ".concat(n," loaded [").concat(o.startSN,",").concat(o.endSN,"]").concat(o.lastPartSn?"[part-".concat(o.lastPartSn,"-").concat(o.lastPartIndex,"]"):"",", cc [").concat(o.startCC,", ").concat(o.endCC,"] duration:").concat(l));var c=r[n],h=this.fragCurrent;!h||this.state!==Zi&&this.state!==ea||h.level!==data.level&&h.loader&&this.abortCurrentFrag();var d=0;if(o.live||null!=(t=c.details)&&t.live){var f;if(this.checkLiveUpdate(o),o.deltaUpdateFailed)return;d=this.alignPlaylists(o,c.details,null==(f=this.levelLastLoaded)?void 0:f.details)}if(c.details=o,this.levelLastLoaded=c,this.hls.trigger(V.LEVEL_UPDATED,{details:o,level:n}),this.state===oa){if(this.waitForCdnTuneIn(o))return;this.state=Ji}this.startFragRequested?o.live&&this.synchronizeToLiveEdge(o):this.setStartPosition(o,d),this.tick()}else this.warn("Levels were reset while loading level ".concat(n))}},{key:"_handleFragmentLoadProgress",value:function(data){var e,t=data.frag,r=data.part,n=data.payload,o=this.levels;if(o){var l=o[t.level],details=l.details;if(!details)return this.warn("Dropping fragment ".concat(t.sn," of level ").concat(t.level," after level details were reset")),void this.fragmentTracker.removeFragment(t);var c=l.videoCodec,h=details.PTSKnown||!details.live,d=null==(e=t.initSegment)?void 0:e.data,f=this._getAudioCodec(l),v=this.transmuxer=this.transmuxer||new Tn(this.hls,or,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=r?r.index:-1,y=-1!==m,k=new Fi(t.level,t.sn,t.stats.chunkCount,n.byteLength,m,y),E=this.initPTS[t.cc];v.push(n,d,f,c,t,r,details.totalduration,h,k,E)}else this.warn("Levels were reset while fragment load was in progress. Fragment ".concat(t.sn," of level ").concat(t.level," will not be buffered"))}},{key:"onAudioTrackSwitching",value:function(e,data){var t=this.altAudio;if(!!!data.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var r=this.fragCurrent;r&&(this.log("Switching to main audio track, cancel main fragment load"),r.abortRequests(),this.fragmentTracker.removeFragment(r)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var n=this.hls;t&&(n.trigger(V.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),n.trigger(V.AUDIO_TRACK_SWITCHED,data)}}},{key:"onAudioTrackSwitched",value:function(e,data){var t=data.id,r=!!this.hls.audioTracks[t].url;if(r){var n=this.videoBuffer;n&&this.mediaBuffer!==n&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=n)}this.altAudio=r,this.tick()}},{key:"onBufferCreated",value:function(e,data){var t,r,n=data.tracks,o=!1;for(var l in n){var track=n[l];if("main"===track.id){if(r=l,t=track,"video"===l){var c=n[l];c&&(this.videoBuffer=c.buffer)}}else o=!0}o&&t?(this.log("Alternate track found, use ".concat(r,".buffered to schedule main fragment loading")),this.mediaBuffer=t.buffer):this.mediaBuffer=this.media}},{key:"onFragBuffered",value:function(e,data){var t=data.frag,r=data.part;if(!t||t.type===or){if(this.fragContextChanged(t))return this.warn("Fragment ".concat(t.sn).concat(r?" p: "+r.index:""," of level ").concat(t.level," finished buffering, but was aborted. state: ").concat(this.state)),void(this.state===ia&&(this.state=Ji));var n=r?r.stats:t.stats;this.fragLastKbps=Math.round(8*n.total/(n.buffering.end-n.loading.first)),"initSegment"!==t.sn&&(this.fragPrevious=t),this.fragBufferedComplete(t,r)}}},{key:"onError",value:function(e,data){var t;if(data.fatal)this.state=na;else switch(data.details){case j.FRAG_GAP:case j.FRAG_PARSING_ERROR:case j.FRAG_DECRYPT_ERROR:case j.FRAG_LOAD_ERROR:case j.FRAG_LOAD_TIMEOUT:case j.KEY_LOAD_ERROR:case j.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(or,data);break;case j.LEVEL_LOAD_ERROR:case j.LEVEL_LOAD_TIMEOUT:case j.LEVEL_PARSING_ERROR:data.levelRetry||this.state!==oa||(null==(t=data.context)?void 0:t.type)!==ar||(this.state=Ji);break;case j.BUFFER_APPEND_ERROR:case j.BUFFER_FULL_ERROR:if(!data.parent||"main"!==data.parent)return;if(data.details===j.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(data)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case j.INTERNAL_EXCEPTION:this.recoverWorkerError(data)}}},{key:"checkBuffer",value:function(){var e=this.media,t=this.gapController;if(e&&t&&e.readyState){if(this.loadedmetadata||!Pi.getBuffered(e).length){var r=this.state!==Ji?this.fragCurrent:null;t.poll(this.lastCurrentTime,r)}this.lastCurrentTime=e.currentTime}}},{key:"onFragLoadEmergencyAborted",value:function(){this.state=Ji,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}},{key:"onBufferFlushed",value:function(e,t){var r=t.type;if(r!==ne||this.audioOnly&&!this.altAudio){var n=(r===se?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(n,r,or),this.tick()}}},{key:"onLevelsUpdated",value:function(e,data){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=data.levels}},{key:"swapAudioCodec",value:function(){this.audioCodecSwap=!this.audioCodecSwap}},{key:"seekToStartPos",value:function(){var e=this.media;if(e){var t=e.currentTime,r=this.startPosition;if(r>=0&&t<r){if(e.seeking)return void this.log("could not seek to ".concat(r,", already seeking at ").concat(t));var n=Pi.getBuffered(e),o=(n.length?n.start(0):0)-r;o>0&&(o<this.config.maxBufferHole||o<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by ".concat(o," to match buffer start")),r+=o,this.startPosition=r),this.log("seek to target start position ".concat(r," from current time ").concat(t)),e.currentTime=r}}}},{key:"_getAudioCodec",value:function(e){var t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}},{key:"_loadBitrateTestFrag",value:function(e,t){var r=this;e.bitrateTest=!0,this._doFragLoad(e,t).then((function(data){var n=r.hls;if(data&&!r.fragContextChanged(e)){t.fragmentError=0,r.state=Ji,r.startFragRequested=!1,r.bitrateTest=!1;var o=e.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),n.trigger(V.FRAG_LOADED,data),e.bitrateTest=!1}}))}},{key:"_handleTransmuxComplete",value:function(e){var t,r="main",n=this.hls,o=e.remuxResult,l=e.chunkMeta,c=this.getCurrentContext(l);if(c){var h=c.frag,d=c.part,f=c.level,video=o.video,text=o.text,v=o.id3,m=o.initSegment,details=f.details,audio=this.altAudio?void 0:o.audio;if(this.fragContextChanged(h))this.fragmentTracker.removeFragment(h);else{if(this.state=ra,m){if(null!=m&&m.tracks){var y=h.initSegment||h;this._bufferInitSegment(f,m.tracks,y,l),n.trigger(V.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:r,tracks:m.tracks})}var k=m.initPTS,E=m.timescale;G(k)&&(this.initPTS[h.cc]={baseTime:k,timescale:E},n.trigger(V.INIT_PTS_FOUND,{frag:h,id:r,initPTS:k,timescale:E}))}if(video&&details&&"initSegment"!==h.sn){var T=details.fragments[h.sn-1-details.startSN],S=h.sn===details.startSN,L=!T||h.cc>T.cc;if(!1!==o.independent){var A=video.startPTS,R=video.endPTS,D=video.startDTS,w=video.endDTS;if(d)d.elementaryStreams[video.type]={startPTS:A,endPTS:R,startDTS:D,endDTS:w};else if(video.firstKeyFrame&&video.independent&&1===l.id&&!L&&(this.couldBacktrack=!0),video.dropped&&video.independent){var I=this.getMainFwdBufferInfo(),C=(I?I.end:this.getLoadPosition())+this.config.maxBufferHole,_=video.firstKeyFramePTS?video.firstKeyFramePTS:A;if(!S&&C<_-this.config.maxBufferHole&&!L)return void this.backtrack(h);L&&(h.gap=!0),h.setElementaryStreamInfo(video.type,h.start,R,h.start,w,!0)}else S&&A>2&&(h.gap=!0);h.setElementaryStreamInfo(video.type,A,R,D,w),this.backtrackFragment&&(this.backtrackFragment=h),this.bufferFragmentData(video,h,d,l,S||L)}else{if(!S&&!L)return void this.backtrack(h);h.gap=!0}}if(audio){var x=audio.startPTS,P=audio.endPTS,F=audio.startDTS,M=audio.endDTS;d&&(d.elementaryStreams[ne]={startPTS:x,endPTS:P,startDTS:F,endDTS:M}),h.setElementaryStreamInfo(ne,x,P,F,M),this.bufferFragmentData(audio,h,d,l)}if(details&&null!=v&&null!=(t=v.samples)&&t.length){var O={id:r,frag:h,details:details,samples:v.samples};n.trigger(V.FRAG_PARSING_METADATA,O)}if(details&&text){var N={id:r,frag:h,details:details,samples:text.samples};n.trigger(V.FRAG_PARSING_USERDATA,N)}}}else this.resetWhenMissingContext(l)}},{key:"_bufferInitSegment",value:function(e,t,r,n){var o=this;if(this.state===ra){this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;var audio=t.audio,video=t.video,l=t.audiovideo;if(audio){var c=e.audioCodec,h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){c&&(c=-1!==c.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");var d=audio.metadata;d&&"channelCount"in d&&1!==(d.channelCount||1)&&-1===h.indexOf("firefox")&&(c="mp4a.40.5")}c&&-1!==c.indexOf("mp4a.40.5")&&-1!==h.indexOf("android")&&"audio/mpeg"!==audio.container&&(c="mp4a.40.2",this.log("Android: force audio codec to ".concat(c))),e.audioCodec&&e.audioCodec!==c&&this.log('Swapping manifest audio codec "'.concat(e.audioCodec,'" for "').concat(c,'"')),audio.levelCodec=c,audio.id="main",this.log("Init audio buffer, container:".concat(audio.container,", codecs[selected/level/parsed]=[").concat(c||"","/").concat(e.audioCodec||"","/").concat(audio.codec,"]"))}video&&(video.levelCodec=e.videoCodec,video.id="main",this.log("Init video buffer, container:".concat(video.container,", codecs[level/parsed]=[").concat(e.videoCodec||"","/").concat(video.codec,"]"))),l&&this.log("Init audiovideo buffer, container:".concat(l.container,", codecs[level/parsed]=[").concat(e.codecs,"/").concat(l.codec,"]")),this.hls.trigger(V.BUFFER_CODECS,t),Object.keys(t).forEach((function(e){var l=t[e].initSegment;null!=l&&l.byteLength&&o.hls.trigger(V.BUFFER_APPENDING,{type:e,data:l,frag:r,part:null,chunkMeta:n,parent:r.type})})),this.tickImmediate()}}},{key:"getMainFwdBufferInfo",value:function(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,or)}},{key:"backtrack",value:function(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Ji}},{key:"checkFragmentChanged",value:function(){var video=this.media,e=null;if(video&&video.readyState>1&&!1===video.seeking){var t=video.currentTime;if(Pi.isBuffered(video,t)?e=this.getAppendedFrag(t):Pi.isBuffered(video,t+.1)&&(e=this.getAppendedFrag(t+.1)),e){this.backtrackFragment=null;var r=this.fragPlaying,n=e.level;r&&e.sn===r.sn&&r.level===n||(this.fragPlaying=e,this.hls.trigger(V.FRAG_CHANGED,{frag:e}),r&&r.level===n||this.hls.trigger(V.LEVEL_SWITCHED,{level:n}))}}}},{key:"nextLevel",get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function(){var e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}},{key:"currentProgramDateTime",get:function(){var e=this.media;if(e){var t=e.currentTime,r=this.currentFrag;if(r&&G(t)&&G(r.programDateTime)){var n=r.programDateTime+1e3*(t-r.start);return new Date(n)}}return null}},{key:"currentLevel",get:function(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),r}(la),Fo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};D(this,e),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new En,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,J(t.debug||!1,"Hls instance");var r=this.config=Ao(e.DefaultConfig,t);this.userConfig=t,r.progressive&&bo(r);var n=r.abrController,o=r.bufferController,l=r.capLevelController,c=r.errorController,h=r.fpsController,d=new c(this),f=this.abrController=new n(this),v=this.bufferController=new o(this),m=this.capLevelController=new l(this),y=new h(this),k=new fr(this),E=new Dr(this),T=r.contentSteeringController,S=T?new T(this):null,L=this.levelController=new Do(this,S),A=new Ii(this),R=new Io(this.config),w=this.streamController=new Po(this,A,R);m.setStreamController(w),y.setStreamController(w);var I=[k,L,w];S&&I.splice(1,0,S),this.networkControllers=I;var C=[f,v,m,y,E,A];this.audioTrackController=this.createController(r.audioTrackController,I);var _=r.audioStreamController;_&&I.push(new _(this,A,R)),this.subtitleTrackController=this.createController(r.subtitleTrackController,I);var x=r.subtitleStreamController;x&&I.push(new x(this,A,R)),this.createController(r.timelineController,C),R.emeController=this.emeController=this.createController(r.emeController,C),this.cmcdController=this.createController(r.cmcdController,C),this.latencyController=this.createController(wr,C),this.coreComponents=C,I.push(d);var P=d.onErrorOut;"function"==typeof P&&this.on(V.ERROR,P,d)}return I(e,[{key:"createController",value:function(e,t){if(e){var r=new e(this);return t&&t.push(r),r}return null}},{key:"on",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this;this._emitter.on(e,t,r)}},{key:"once",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this;this._emitter.once(e,t,r)}},{key:"removeAllListeners",value:function(e){this._emitter.removeAllListeners(e)}},{key:"off",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this,n=arguments.length>3?arguments[3]:void 0;this._emitter.off(e,t,r,n)}},{key:"listeners",value:function(e){return this._emitter.listeners(e)}},{key:"emit",value:function(e,t,r){return this._emitter.emit(e,t,r)}},{key:"trigger",value:function(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if($.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;var r=e===V.ERROR;this.trigger(V.ERROR,{type:Y.OTHER_ERROR,details:j.INTERNAL_EXCEPTION,fatal:r,event:e,error:t}),this.triggeringException=!1}}return!1}},{key:"listenerCount",value:function(e){return this._emitter.listenerCount(e)}},{key:"destroy",value:function(){$.log("destroy"),this.trigger(V.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((function(component){return component.destroy()})),this.networkControllers.length=0,this.coreComponents.forEach((function(component){return component.destroy()})),this.coreComponents.length=0;var e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}},{key:"attachMedia",value:function(e){$.log("attachMedia"),this._media=e,this.trigger(V.MEDIA_ATTACHING,{media:e})}},{key:"detachMedia",value:function(){$.log("detachMedia"),this.trigger(V.MEDIA_DETACHING,void 0),this._media=null}},{key:"loadSource",value:function(e){this.stopLoad();var t=this.media,r=this.url,n=this.url=F.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,$.log("loadSource:".concat(n)),t&&r&&(r!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(V.MANIFEST_LOADING,{url:e})}},{key:"startLoad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;$.log("startLoad(".concat(e,")")),this.started=!0,this.networkControllers.forEach((function(t){t.startLoad(e)}))}},{key:"stopLoad",value:function(){$.log("stopLoad"),this.started=!1,this.networkControllers.forEach((function(e){e.stopLoad()}))}},{key:"resumeBuffering",value:function(){this.started&&this.networkControllers.forEach((function(e){"fragmentLoader"in e&&e.startLoad(-1)}))}},{key:"pauseBuffering",value:function(){this.networkControllers.forEach((function(e){"fragmentLoader"in e&&e.stopLoad()}))}},{key:"swapAudioCodec",value:function(){$.log("swapAudioCodec"),this.streamController.swapAudioCodec()}},{key:"recoverMediaError",value:function(){$.log("recoverMediaError");var e=this._media;this.detachMedia(),e&&this.attachMedia(e)}},{key:"removeLevel",value:function(e){this.levelController.removeLevel(e)}},{key:"levels",get:function(){var e=this.levelController.levels;return e||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(e){$.log("set currentLevel:".concat(e)),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(e){$.log("set nextLevel:".concat(e)),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(e){$.log("set loadLevel:".concat(e)),this.levelController.manualLevel=e}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(e){this.levelController.nextLoadLevel=e}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(e){$.log("set firstLevel:".concat(e)),this.levelController.firstLevel=e}},{key:"startLevel",get:function(){var e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e},set:function(e){$.log("set startLevel:".concat(e)),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(e){var t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(e){this._autoLevelCapping!==e&&($.log("set autoLevelCapping:".concat(e)),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}},{key:"bandwidthEstimate",get:function(){var e=this.abrController.bwEstimator;return e?e.getEstimate():NaN},set:function(e){this.abrController.resetEstimator(e)}},{key:"ttfbEstimate",get:function(){var e=this.abrController.bwEstimator;return e?e.getEstimateTTFB():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(e){(function(e){return Ir.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}},{key:"autoLevelEnabled",get:function(){return-1===this.levelController.manualLevel}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var e=this.levels,t=this.config.minAutoBitrate;if(!e)return 0;for(var r=e.length,i=0;i<r;i++)if(e[i].maxBitrate>=t)return i;return 0}},{key:"maxAutoLevel",get:function(){var e,t=this.levels,r=this.autoLevelCapping,n=this.maxHdcpLevel;if(e=-1===r&&null!=t&&t.length?t.length-1:r,n)for(var i=e;i--;){var o=t[i].attrs["HDCP-LEVEL"];if(o&&o<=n)return i}return e}},{key:"firstAutoLevel",get:function(){return this.abrController.firstAutoLevel}},{key:"nextAutoLevel",get:function(){return this.abrController.nextAutoLevel},set:function(e){this.abrController.nextAutoLevel=e}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"setAudioOption",value:function(e){var t;return null==(t=this.audioTrackController)?void 0:t.setAudioOption(e)}},{key:"setSubtitleOption",value:function(e){var t;return null==(t=this.subtitleTrackController)||t.setSubtitleOption(e),null}},{key:"allAudioTracks",get:function(){var e=this.audioTrackController;return e?e.allAudioTracks:[]}},{key:"audioTracks",get:function(){var e=this.audioTrackController;return e?e.audioTracks:[]}},{key:"audioTrack",get:function(){var e=this.audioTrackController;return e?e.audioTrack:-1},set:function(e){var t=this.audioTrackController;t&&(t.audioTrack=e)}},{key:"allSubtitleTracks",get:function(){var e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}},{key:"subtitleTracks",get:function(){var e=this.subtitleTrackController;return e?e.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var e=this.subtitleTrackController;return e?e.subtitleTrack:-1},set:function(e){var t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var e=this.subtitleTrackController;return!!e&&e.subtitleDisplay},set:function(e){var t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(e){this.config.lowLatencyMode=e}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.5.17"}},{key:"isMSESupported",value:function(){return _o()}},{key:"isSupported",value:function(){return function(){if(!_o())return!1;var e=_t();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((function(t){return e.isTypeSupported(Mt(t,"video"))}))||["mp4a.40.2","fLaC"].some((function(t){return e.isTypeSupported(Mt(t,"audio"))})))}()}},{key:"getMediaSource",value:function(){return _t()}},{key:"Events",get:function(){return V}},{key:"ErrorTypes",get:function(){return Y}},{key:"ErrorDetails",get:function(){return j}},{key:"DefaultConfig",get:function(){return e.defaultConfig?e.defaultConfig:Lo},set:function(t){e.defaultConfig=t}}]),e}();Fo.defaultConfig=void 0}}]);