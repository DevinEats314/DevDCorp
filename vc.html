<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js';
  import { getDatabase, ref, set, remove, onChildAdded } from 'https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js';
  import { getStorage } from 'https://www.gstatic.com/firebasejs/9.0.2/firebase-storage.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBi0ofcvlq9W2MmZ-D2EzqalqgzknfJAGk",
    authDomain: "groupchat-5a13b.firebaseapp.com",
    databaseURL: "https://groupchat-5a13b-default-rtdb.firebaseio.com",
    projectId: "groupchat-5a13b",
    storageBucket: "groupchat-5a13b.firebasestorage.app",
    messagingSenderId: "223221913801",
    appId: "1:223221913801:web:7e651c2dcc436608bd1518",
    measurementId: "G-SHC0GXX7MH"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  let mediaRecorder;
  let audioChunks = [];

  // Example user ID (this should be dynamically set in a real application)
  const userId = 'user123'; // Change this to represent the current user's ID

  // Check if MediaRecorder is supported
  if (!window.MediaRecorder) {
    alert("Your browser does not support the MediaRecorder API.");
  }

  document.addEventListener('DOMContentLoaded', () => {
    const startRecordingButton = document.getElementById('start-recording');
    const audioPlayer = document.getElementById('audio-player');
    
    let isRecording = false;

    // Request microphone access
    async function requestMicrophoneAccess() {
      try {
        console.log('Requesting microphone access...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log('Microphone access granted');
      } catch (err) {
        console.error('Error requesting microphone access:', err);
        alert('Microphone access is required to record audio.');
      }
    }

    requestMicrophoneAccess();

    startRecordingButton.addEventListener('mousedown', async () => {
      if (isRecording) return;
      isRecording = true;

      try {
        console.log('Starting recording...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
          console.log('Audio data available:', event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const reader = new FileReader();
          reader.onloadend = () => {
            const audioBase64 = reader.result.split(',')[1]; // Base64 encoded audio
            console.log('Audio encoding complete:', audioBase64);
            uploadAudioToFirebase(audioBase64);
          };
          reader.readAsDataURL(audioBlob);
        };

        mediaRecorder.start();
        console.log('Recording started');
        startRecordingButton.textContent = 'Recording...';
        startRecordingButton.style.backgroundColor = 'red';
      } catch (err) {
        console.error('Error starting recording:', err);
        alert('Microphone access is required to record audio.');
      }
    });

    startRecordingButton.addEventListener('mouseup', () => {
      if (!isRecording) return;
      mediaRecorder.stop();
      console.log('Recording stopped');
      isRecording = false;
      startRecordingButton.textContent = 'Start Recording';
      startRecordingButton.style.backgroundColor = '';
    });

    startRecordingButton.addEventListener('mouseout', () => {
      if (isRecording) {
        mediaRecorder.stop();
        console.log('Recording stopped');
        isRecording = false;
        startRecordingButton.textContent = 'Start Recording';
        startRecordingButton.style.backgroundColor = '';
      }
    });

    function uploadAudioToFirebase(audioBase64) {
      const audioRef = ref(database, 'audio/');
      const newAudioRef = ref(database, 'audio/' + new Date().getTime());
      set(newAudioRef, { audioData: audioBase64, uploadedBy: userId })
        .then(() => {
          console.log('Audio uploaded successfully');
        })
        .catch(error => {
          console.error('Error uploading audio:', error);
        });
    }

    function fetchAndPlayAudio() {
      const audioRef = ref(database, 'audio/');
      onChildAdded(audioRef, (snapshot) => {
        const audioBase64 = snapshot.val().audioData;
        const uploadedBy = snapshot.val().uploadedBy; // Get who uploaded the audio

        // Skip playing if the uploader is the current user
        if (uploadedBy === userId) return;

        const audioBlob = new Blob([new Uint8Array(atob(audioBase64).split("").map(char => char.charCodeAt(0)))], { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        
        audioPlayer.src = audioUrl;
        audioPlayer.play();
        audioPlayer.removeAttribute('controls');

        audioPlayer.onended = () => {
          console.log('Audio playback finished');
          deleteAudioFromFirebase(snapshot.key);
        };
      });
    }

    function deleteAudioFromFirebase(audioKey) {
      const audioRef = ref(database, 'audio/' + audioKey);
      remove(audioRef)
        .then(() => {
          console.log('Audio deleted from Firebase');
        })
        .catch((error) => {
          console.error('Error deleting audio:', error);
        });
    }

    fetchAndPlayAudio();
  });
</script>
